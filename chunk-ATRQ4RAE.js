import{v as g}from"./chunk-SVQ7HZAZ.js";import{M as m,S as p,h as r,n as d}from"./chunk-YIZ2QXS6.js";import{a as l,b as c,i as s}from"./chunk-ODN5LVDJ.js";var _=class o{supabase=p(g);registrarEventoCirugia(i){return r(this.registrarEventoCirugiaAsync(i))}registrarEventoCirugiaAsync(i){return s(this,null,function*(){let a=yield this.supabase.client.auth.getUser(),{data:t,error:e}=yield this.supabase.client.from("cirugia_trazabilidad").insert(c(l({},i),{usuario_id:a.data.user?.id})).select(`
        *,
        usuario:profiles(id, full_name, role, email),
        cirugia:cirugias(id, numero_cirugia, estado)
      `).single();if(e)throw e;return t})}registrarEventoKit(i){return r(this.registrarEventoKitAsync(i))}registrarEventoKitAsync(i){return s(this,null,function*(){let a=yield this.supabase.client.auth.getUser(),{data:t,error:e}=yield this.supabase.client.from("kit_trazabilidad").insert(c(l({},i),{usuario_id:a.data.user?.id})).select(`
        *,
        usuario:profiles(id, full_name, role, email),
        kit:kits_cirugia(id, numero_kit, estado)
      `).single();if(e)throw e;return t})}getTrazabilidadCirugia(i){return r(this.supabase.client.from("cirugia_trazabilidad").select(`
          *,
          usuario:profiles(id, full_name, role, email),
          cirugia:cirugias(id, numero_cirugia, estado)
        `).eq("cirugia_id",i).order("timestamp",{ascending:!1})).pipe(d(({data:a,error:t})=>{if(t)throw t;return a||[]}))}getTrazabilidadKit(i){return r(this.supabase.client.from("kit_trazabilidad").select(`
          *,
          usuario:profiles(id, full_name, role, email),
          kit:kits_cirugia(id, numero_kit, estado)
        `).eq("kit_id",i).order("timestamp",{ascending:!1})).pipe(d(({data:a,error:t})=>{if(t)throw t;return a||[]}))}getTrazabilidadCompleta(i){return r(this.getTrazabilidadCompletaAsync(i))}getTrazabilidadCompletaAsync(i){return s(this,null,function*(){let a=this.supabase.client.from("trazabilidad_completa").select("*");i?.tipo_entidad&&(a=a.eq("tipo_entidad",i.tipo_entidad)),i?.referencia_id&&(a=a.eq("referencia_id",i.referencia_id)),i?.usuario_id&&(a=a.eq("usuario_id",i.usuario_id)),i?.accion&&(a=a.eq("accion",i.accion)),i?.fecha_desde&&(a=a.gte("timestamp",i.fecha_desde)),i?.fecha_hasta&&(a=a.lte("timestamp",i.fecha_hasta)),a=a.order("timestamp",{ascending:!1}).limit(100);let{data:t,error:e}=yield a;if(e)throw e;return t||[]})}getEstadisticas(i){return r(this.getEstadisticasAsync(i))}getEstadisticasAsync(i){return s(this,null,function*(){let a=yield this.getTrazabilidadCompletaAsync(i),t={total_eventos:a.length,eventos_por_tipo:{cirugia:a.filter(e=>e.tipo_entidad==="cirugia").length,kit:a.filter(e=>e.tipo_entidad==="kit").length},eventos_por_accion:{},ultimos_eventos:a.slice(0,10)};return a.forEach(e=>{t.eventos_por_accion[e.accion]=(t.eventos_por_accion[e.accion]||0)+1}),t})}getUltimoEvento(i,a){return r(this.supabase.client.from("trazabilidad_completa").select("*").eq("tipo_entidad",i).eq("referencia_id",a).order("timestamp",{ascending:!1}).limit(1).single()).pipe(d(({data:t,error:e})=>{if(e&&e.code!=="PGRST116")throw e;return t||null}))}buscarPorFechas(i,a,t){return this.getTrazabilidadCompleta({fecha_desde:i,fecha_hasta:a,tipo_entidad:t})}getTimelineCirugia(i){return r(this.getTimelineCirugiaAsync(i))}getTimelineCirugiaAsync(i){return s(this,null,function*(){let{data:a,error:t}=yield this.supabase.client.from("trazabilidad_completa").select("*").eq("tipo_entidad","cirugia").eq("referencia_id",i).order("timestamp",{ascending:!1});if(t)throw t;let{data:e,error:u}=yield this.supabase.client.from("kits_cirugia").select("id").eq("cirugia_id",i);if(u)throw u;if(!e||e.length===0)return a||[];let f=e.map(n=>n.id),{data:T,error:b}=yield this.supabase.client.from("trazabilidad_completa").select("*").eq("tipo_entidad","kit").in("referencia_id",f).order("timestamp",{ascending:!1});if(b)throw b;return[...a||[],...T||[]].sort((n,z)=>new Date(z.timestamp).getTime()-new Date(n.timestamp).getTime())})}static \u0275fac=function(a){return new(a||o)};static \u0275prov=m({token:o,factory:o.\u0275fac,providedIn:"root"})};export{_ as a};
