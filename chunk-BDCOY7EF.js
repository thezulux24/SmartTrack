import{a as Q}from"./chunk-PZ7IRRMX.js";import"./chunk-WUZJU462.js";import{a as $,c as N,g as z,x as G}from"./chunk-G7P72S2E.js";import{j as A,n as P,p as B,v as H}from"./chunk-WKDYGGS7.js";import{$ as _,Ab as M,Db as O,Eb as R,Fb as U,Ia as s,S as w,Sa as F,Wb as D,Xa as g,Y as C,Z as x,_ as p,cb as y,gb as b,hb as m,kb as k,la as f,lb as j,mb as o,nb as r,ob as u,pb as E,sb as v,tb as l,ub as T,vb as I,wb as V,yb as c,zb as h}from"./chunk-D2JNWC2G.js";import"./chunk-X5YLR3NI.js";import{i as L}from"./chunk-ODN5LVDJ.js";var W=["messagesContainer"],Y=["fileInput"],q=(n,t)=>t.id;function J(n,t){if(n&1&&(o(0,"div",9)(1,"h1",15),c(2),r(),o(3,"p",16),c(4),r()()),n&2){let e=l();s(2),h(e.cirugiaInfo().numero_cirugia),s(2),h(e.cirugiaInfo().medico_cirujano)}}function X(n,t){if(n&1&&(o(0,"span"),c(1),r()),n&2){let e=t.$implicit,i=l(2);b("px-3 py-1 rounded-full text-xs font-medium ",i.getRolColor(e.rol),""),s(),M(" ",e.nombre," ")}}function Z(n,t){if(n&1&&(o(0,"div",11),k(1,X,2,4,"span",17,q),r()),n&2){let e=l();s(),j(e.participantes())}}function ee(n,t){n&1&&(o(0,"div",12)(1,"div",18),u(2,"div",19),o(3,"p",20),c(4,"Cargando chat..."),r()()())}function te(n,t){if(n&1&&(o(0,"div",13)(1,"div",21),p(),o(2,"svg",22),u(3,"path",23),r(),_(),o(4,"h3",24),c(5,"Error"),r(),o(6,"p",25),c(7),r()()()),n&2){let e=l();s(7),h(e.error())}}function ie(n,t){n&1&&(o(0,"div",27),p(),o(1,"svg",42),u(2,"path",43),r(),_(),o(3,"p",44),c(4,"No hay mensajes a\xFAn"),r(),o(5,"p",45),c(6,"S\xE9 el primero en escribir"),r()())}function ne(n,t){if(n&1&&(o(0,"div",47)(1,"span",50),c(2),r(),o(3,"span"),c(4),r()()),n&2){let e=l().$implicit,i=l(2);s(2),h(i.getNombreUsuario(e)),s(),b("px-2 py-0.5 rounded-full text-xs ",i.getRolColor((e.usuario==null?null:e.usuario.role)||""),""),s(),M(" ",i.getRolUsuario(e)," ")}}function oe(n,t){if(n&1&&(o(0,"p",48),c(1),r()),n&2){let e=l().$implicit;s(),h(e.mensaje)}}function ae(n,t){if(n&1){let e=E();o(0,"div")(1,"p",51),c(2),r(),o(3,"button",52),v("click",function(){C(e);let a=l().$implicit,d=l(2);return x(d.verEnMapa(a.metadata==null?null:a.metadata.latitud,a.metadata==null?null:a.metadata.longitud))}),p(),o(4,"svg",53),u(5,"path",35)(6,"path",36),r(),_(),o(7,"span",54),c(8,"Ver en mapa"),r()()()}if(n&2){let e=l().$implicit;s(2),h(e.mensaje)}}function re(n,t){if(n&1&&(o(0,"p",57),c(1),r()),n&2){let e=l(2).$implicit;s(),h(e.metadata==null?null:e.metadata.titulo)}}function se(n,t){if(n&1&&(o(0,"div",49),p(),o(1,"svg",55),u(2,"path",56),r(),_(),o(3,"div"),g(4,re,2,1,"p",57),o(5,"p",58),c(6),r()()()),n&2){let e=l().$implicit;s(4),m(e.metadata!=null&&e.metadata.titulo?4:-1),s(2),h(e.mensaje)}}function le(n,t){if(n&1&&(o(0,"div")(1,"div",46),g(2,ne,5,5,"div",47),o(3,"div"),g(4,oe,2,1,"p",48)(5,ae,9,1,"div")(6,se,7,2,"div",49),r(),o(7,"p"),c(8),r()()()),n&2){let e=t.$implicit,i=l(2);b("flex ",i.esMiMensaje(e)?"justify-end":"justify-start",""),s(2),m(i.esMiMensaje(e)?-1:2),s(),b("",i.esMiMensaje(e)?"bg-[#C8D900] text-[#10284C] rounded-2xl rounded-tr-sm":"bg-white/10 text-white rounded-2xl rounded-tl-sm"," px-4 py-3 backdrop-blur-sm"),s(),m(e.tipo==="texto"?4:-1),s(),m(e.tipo==="ubicacion"&&(e.metadata!=null&&e.metadata.latitud)&&(e.metadata!=null&&e.metadata.longitud)?5:-1),s(),m(e.tipo==="alerta"?6:-1),s(),b("text-xs ",i.esMiMensaje(e)?"text-right":"text-left"," mt-1 px-2 text-white/40"),s(),M(" ",i.formatearFecha(e.created_at)," ")}}function ce(n,t){n&1&&u(0,"div",40)}function de(n,t){n&1&&(p(),o(0,"svg",7),u(1,"path",59),r())}function me(n,t){if(n&1){let e=E();o(0,"div",14)(1,"div",26,0),g(3,ie,7,0,"div",27),k(4,le,9,14,"div",17,q),r(),o(6,"div",28)(7,"div",29)(8,"div",30)(9,"button",31),v("click",function(){C(e);let a=l();return x(a.abrirArchivos())}),p(),o(10,"svg",32),u(11,"path",33),r()(),_(),o(12,"button",34),v("click",function(){C(e);let a=l();return x(a.enviarUbicacion())}),p(),o(13,"svg",32),u(14,"path",35)(15,"path",36),r()()(),_(),o(16,"div",37)(17,"textarea",38),U("ngModelChange",function(a){C(e);let d=l();return R(d.nuevoMensaje,a)||(d.nuevoMensaje=a),x(a)}),v("keypress",function(a){C(e);let d=l();return x(d.onKeyPress(a))}),r(),o(18,"button",39),v("click",function(){C(e);let a=l();return x(a.enviarMensaje())}),g(19,ce,1,0,"div",40)(20,de,2,0,":svg:svg",7),r()()(),o(21,"input",41,1),v("change",function(a){C(e);let d=l();return x(d.onFileSelected(a))}),r()()()}if(n&2){let e=l();s(3),m(e.mensajes().length===0?3:-1),s(),j(e.mensajes()),s(13),O("ngModel",e.nuevoMensaje),y("disabled",e.enviando()),s(),y("disabled",!e.nuevoMensaje().trim()||e.enviando()),s(),m(e.enviando()?19:20)}}var K=class n{messagesContainer;fileInput;chatService=w(Q);supabaseService=w(H);router=w(B);route=w(P);chat=f(null);mensajes=f([]);loading=f(!0);error=f(null);enviando=f(!1);nuevoMensaje=f("");currentUserId=f(null);cirugiaInfo=D(()=>this.chat()?.cirugia);participantes=D(()=>this.chat()?.participantes||[]);ngOnInit(){this.route.params.subscribe(t=>{let e=t.id;e&&(this.cargarChat(e),this.suscribirMensajes(e))}),this.getCurrentUser()}ngOnDestroy(){let t=this.route.snapshot.params.id;t&&this.chatService.desuscribirMensajes(t)}getCurrentUser(){return L(this,null,function*(){let t=yield this.supabaseService.getSession();this.currentUserId.set(t?.user?.id||null)})}cargarChat(t){this.loading.set(!0),this.error.set(null),this.chatService.getChatCompleto(t).subscribe({next:e=>{this.chat.set(e),this.mensajes.set(e.mensajes),this.loading.set(!1),this.chatService.marcarComoLeido(t).subscribe(),setTimeout(()=>this.scrollToBottom(),100)},error:e=>{console.error("Error al cargar chat:",e),this.error.set("Error al cargar el chat"),this.loading.set(!1)}})}suscribirMensajes(t){console.log("\u{1F4AC} ChatComponent: Subscribing to messages for cirugia",t),this.chatService.suscribirMensajes(t,e=>{console.log("\u{1F4E8} ChatComponent: Received new message via callback:",e),console.log("\u{1F4E8} Message ID:",e.id),console.log("\u{1F4E8} From user:",e.usuario_id),console.log("\u{1F4E8} Current user:",this.currentUserId());let i=this.mensajes(),a=i.some(d=>d.id===e.id);console.log("\u{1F4E8} Message already exists?",a),console.log("\u{1F4E8} Current messages count:",i.length),a?console.log("\u26A0\uFE0F ChatComponent: Message already exists, skipping"):(console.log("\u2705 ChatComponent: Adding new message to list"),this.mensajes.update(d=>[...d,e]),console.log("\u2705 New messages count:",this.mensajes().length),setTimeout(()=>this.scrollToBottom(),100)),e.usuario_id!==this.currentUserId()?(console.log("\u{1F4D6} ChatComponent: Marking as read (not my message)"),this.chatService.marcarComoLeido(t).subscribe()):console.log("\u270B ChatComponent: Not marking as read (my own message)")}),console.log("\u2705 ChatComponent: Subscription callback registered")}enviarMensaje(){let t=this.nuevoMensaje().trim();if(!t||this.enviando())return;let e=this.route.snapshot.params.id;e&&(console.log("\u{1F4E4} ChatComponent: Sending message:",t),console.log("\u{1F4E4} To cirugia:",e),this.enviando.set(!0),this.chatService.enviarMensaje({cirugia_id:e,mensaje:t,tipo:"texto"}).subscribe({next:i=>{console.log("\u2705 ChatComponent: Message sent successfully:",i),console.log("\u2705 Message ID:",i.id),this.mensajes().some(S=>S.id===i.id)?console.log("\u26A0\uFE0F ChatComponent: Sent message already in list (via Realtime?)"):(console.log("\u2795 ChatComponent: Adding sent message to local list"),this.mensajes.update(S=>[...S,i])),this.nuevoMensaje.set(""),this.enviando.set(!1),setTimeout(()=>this.scrollToBottom(),100)},error:i=>{console.error("\u274C ChatComponent: Error sending message:",i),alert("Error al enviar mensaje"),this.enviando.set(!1)}}))}onKeyPress(t){t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.enviarMensaje())}scrollToBottom(){try{if(this.messagesContainer){let t=this.messagesContainer.nativeElement;t.scrollTop=t.scrollHeight}}catch(t){console.error("Error scrolling:",t)}}esMiMensaje(t){return t.usuario_id===this.currentUserId()}getNombreUsuario(t){return t.usuario?.full_name||"Usuario"}getRolUsuario(t){let e=t.usuario?.role||"";return{comercial:"Comercial",tecnico:"T\xE9cnico",logistica:"Log\xEDstica",admin:"Admin"}[e]||e}getRolColor(t){return{comercial:"bg-blue-500/20 text-blue-300",tecnico:"bg-green-500/20 text-green-300",logistica:"bg-purple-500/20 text-purple-300",admin:"bg-red-500/20 text-red-300"}[t]||"bg-gray-500/20 text-gray-300"}formatearFecha(t){let e=new Date(t),i=new Date,a=new Date(i);a.setDate(a.getDate()-1);let d=e.toLocaleTimeString("es-CO",{hour:"2-digit",minute:"2-digit"});return e.toDateString()===i.toDateString()?`Hoy ${d}`:e.toDateString()===a.toDateString()?`Ayer ${d}`:e.toLocaleDateString("es-CO",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"})}volver(){this.router.navigate(["/internal"])}abrirArchivos(){this.fileInput.nativeElement.click()}onFileSelected(t){let e=t.target;e.files&&e.files[0]&&(console.log("Archivo seleccionado:",e.files[0]),alert("Funci\xF3n de archivos en desarrollo"))}enviarUbicacion(){navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{let e=this.route.snapshot.params.id;this.enviando.set(!0),this.chatService.enviarMensaje({cirugia_id:e,mensaje:"\u{1F4CD} Ubicaci\xF3n compartida",tipo:"ubicacion",metadata:{latitud:t.coords.latitude,longitud:t.coords.longitude}}).subscribe({next:i=>{this.mensajes.update(a=>[...a,i]),this.enviando.set(!1),setTimeout(()=>this.scrollToBottom(),100)},error:i=>{console.error("Error al enviar ubicaci\xF3n:",i),alert("Error al compartir ubicaci\xF3n"),this.enviando.set(!1)}})},t=>{console.error("Error obteniendo ubicaci\xF3n:",t),alert("No se pudo obtener la ubicaci\xF3n")}):alert("Geolocalizaci\xF3n no disponible")}verEnMapa(t,e){t&&e&&window.open(`https://www.google.com/maps?q=${t},${e}`,"_blank")}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=F({type:n,selectors:[["app-chat-cirugia"]],viewQuery:function(e,i){if(e&1&&(T(W,5),T(Y,5)),e&2){let a;I(a=V())&&(i.messagesContainer=a.first),I(a=V())&&(i.fileInput=a.first)}},decls:13,vars:5,consts:[["messagesContainer",""],["fileInput",""],[1,"min-h-screen","bg-gradient-to-br","from-[#10284C]","via-[#0e1f3a]","to-[#0a1628]","pb-safe"],[1,"sticky","top-0","z-50","bg-[#10284C]/95","backdrop-blur-md","border-b","border-white/10","shadow-xl"],[1,"px-4","py-4"],[1,"flex","items-center","justify-between","mb-3"],[1,"p-2","rounded-lg","bg-white/10","hover:bg-white/20","text-white","transition-colors",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M10 19l-7-7m0 0l7-7m-7 7h18"],[1,"flex-1","text-center"],[1,"w-10"],[1,"flex","items-center","justify-center","gap-2","flex-wrap"],[1,"flex","items-center","justify-center","h-96"],[1,"p-4"],[1,"flex","flex-col","h-[calc(100vh-180px)]"],[1,"text-xl","font-bold","text-white"],[1,"text-sm","text-white/60"],[3,"class"],[1,"text-center"],[1,"w-12","h-12","border-4","border-[#C8D900]","border-t-transparent","rounded-full","animate-spin","mx-auto","mb-4"],[1,"text-white/70"],[1,"bg-red-500/20","border","border-red-500","rounded-xl","p-6","text-center"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-16","h-16","text-red-500","mx-auto","mb-4"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"text-xl","font-bold","text-red-500","mb-2"],[1,"text-white"],[1,"flex-1","overflow-y-auto","px-4","py-4","space-y-4"],[1,"text-center","py-12"],[1,"border-t","border-white/10","bg-[#10284C]/95","backdrop-blur-md","p-4"],[1,"flex","items-end","gap-2"],[1,"flex","flex-col","gap-2"],["title","Adjuntar archivo",1,"p-2","rounded-lg","bg-white/10","hover:bg-white/20","text-white","transition-colors",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"],["title","Compartir ubicaci\xF3n",1,"p-2","rounded-lg","bg-white/10","hover:bg-white/20","text-white","transition-colors",3,"click"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M15 11a3 3 0 11-6 0 3 3 0 016 0z"],[1,"flex-1","flex","items-end","gap-2"],["placeholder","Escribe un mensaje...","rows","1",1,"flex-1","px-4","py-3","bg-white/10","border","border-white/20","rounded-xl","text-white","placeholder-white/40","focus:outline-none","focus:ring-2","focus:ring-[#C8D900]","focus:border-transparent","resize-none","max-h-32",3,"ngModelChange","keypress","ngModel","disabled"],[1,"p-3","rounded-xl","bg-[#C8D900]","hover:bg-[#b5c500]","text-[#10284C]","transition-colors","disabled:opacity-50","disabled:cursor-not-allowed","flex-shrink-0",3,"click","disabled"],[1,"w-6","h-6","border-2","border-[#10284C]","border-t-transparent","rounded-full","animate-spin"],["type","file","accept","image/*,.pdf,.doc,.docx",1,"hidden",3,"change"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-20","h-20","text-white/20","mx-auto","mb-4"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"],[1,"text-white/50","text-sm"],[1,"text-white/30","text-xs","mt-2"],[1,"max-w-[80%]"],[1,"flex","items-center","gap-2","mb-1","ml-2"],[1,"text-sm","break-words","whitespace-pre-wrap"],[1,"flex","items-start","gap-2"],[1,"text-xs","font-medium","text-white/70"],[1,"text-sm","font-medium","mb-2"],[1,"flex","items-center","gap-2","px-3","py-2","bg-white/20","hover:bg-white/30","rounded-lg","transition-colors",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4"],[1,"text-xs"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5","flex-shrink-0"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"],[1,"font-bold","text-sm","mb-1"],[1,"text-sm"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 19l9 2-9-18-9 18 9-2zm0 0v-8"]],template:function(e,i){e&1&&(o(0,"div",2)(1,"header",3)(2,"div",4)(3,"div",5)(4,"button",6),v("click",function(){return i.volver()}),p(),o(5,"svg",7),u(6,"path",8),r()(),g(7,J,5,2,"div",9),_(),u(8,"div",10),r(),g(9,Z,3,0,"div",11),r()(),g(10,ee,5,0,"div",12)(11,te,8,1,"div",13)(12,me,23,5,"div",14),r()),e&2&&(s(7),m(i.cirugiaInfo()?7:-1),s(2),m(i.participantes().length>0?9:-1),s(),m(i.loading()?10:-1),s(),m(i.error()&&!i.loading()?11:-1),s(),m(!i.loading()&&!i.error()?12:-1))},dependencies:[A,G,$,N,z],styles:["[_nghost-%COMP%]     .overflow-y-auto{scroll-behavior:smooth}[_nghost-%COMP%]     .overflow-y-auto::-webkit-scrollbar{width:6px}[_nghost-%COMP%]     .overflow-y-auto::-webkit-scrollbar-track{background:#ffffff1a;border-radius:3px}[_nghost-%COMP%]     .overflow-y-auto::-webkit-scrollbar-thumb{background:#c8d90080;border-radius:3px}[_nghost-%COMP%]     .overflow-y-auto::-webkit-scrollbar-thumb:hover{background:#c8d900b3}textarea[_ngcontent-%COMP%]{min-height:45px;max-height:120px}@keyframes _ngcontent-%COMP%_slideIn{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.animate-slide-in[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_slideIn .3s ease-out}"]})};export{K as ChatCirugiaComponent};
