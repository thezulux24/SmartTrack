# üöÄ Gu√≠a R√°pida de Uso - FASE 5

## ‚ö° Inicio R√°pido

### 1. Preparaci√≥n (Una sola vez)
```sql
-- En Supabase SQL Editor, ejecutar:
-- Ubicaci√≥n: fase5_devolucion_limpieza_schema.sql
```

### 2. Acceder a los M√≥dulos

#### üë®‚Äçüîß Como T√©cnico
1. Ir al dashboard t√©cnico: `/internal/tecnico`
2. Secci√≥n **"Kits Devueltos"** (naranja)
3. Clic en **"Procesar Devoluci√≥n"**

#### üßº Como Personal de Limpieza
1. Ir a: `/internal/limpieza`
2. Ver kits en proceso de limpieza
3. Clic en kit para ver detalles
4. Marcar productos: Pendiente ‚Üí En Proceso ‚Üí Esterilizado

#### ‚úÖ Como Supervisor
1. Ir a: `/internal/limpieza/aprobacion`
2. Ver kits con productos esterilizados
3. Ajustar cantidades si necesario
4. Clic **"Aprobar y Finalizar Kit"**

---

## üéÆ Flujo de Usuario - Paso a Paso

### Escenario: Kit devuelto despu√©s de cirug√≠a

#### PASO 1: T√©cnico Procesa Devoluci√≥n

**Navegaci√≥n:**
```
/internal/tecnico ‚Üí Secci√≥n "Kits Devueltos" ‚Üí "Procesar Devoluci√≥n"
```

**Acciones:**
1. Ver lista de productos con cantidades
2. Para cada producto decidir:
   - **Reutilizable** ‚ôªÔ∏è ‚Üí Ajustar cantidad a recuperar
   - **Desechable** üóëÔ∏è ‚Üí Toggle al rojo
3. Agregar notas si necesario
4. Clic **"Confirmar y Enviar a Limpieza"**

**Resultado:**
- Kit pasa a estado `en_limpieza`
- Productos reutilizables aparecen en m√≥dulo de limpieza

---

#### PASO 2: Personal de Limpieza Procesa

**Navegaci√≥n:**
```
/internal/limpieza
```

**Acciones:**
1. Ver lista de kits en limpieza
2. Clic en un kit para abrir modal
3. Para cada producto:
   - Clic **"Iniciar Proceso"** (amarillo ‚Üí azul)
   - Agregar observaciones de limpieza
   - Clic **"Guardar"** (observaciones)
   - Clic **"Marcar como Esterilizado"** (azul ‚Üí verde)
4. Cerrar modal cuando todos est√©n esterilizados

**Resultado:**
- Productos pasan a `esterilizado`
- Kit aparece en m√≥dulo de aprobaci√≥n

---

#### PASO 3: Supervisor Aprueba

**Navegaci√≥n:**
```
/internal/limpieza/aprobacion
```

**Acciones:**
1. Ver kits listos para aprobaci√≥n
2. Clic en kit para revisar
3. Revisar cada producto:
   - Ver cantidad a recuperar
   - Ajustar con +/- si detecta da√±os
   - Revisar observaciones
4. Clic **"Aprobar y Finalizar Kit"**
5. Confirmar en el di√°logo

**Resultado:**
- Inventario actualizado con productos recuperados
- Kit marcado como `finalizado` ‚úÖ
- Ciclo de vida completo

---

## üí° Tips y Trucos

### Ajustar Cantidades
```
Bot√≥n [-]  : Reduce en 1
Bot√≥n [+]  : Aumenta en 1
M√≠nimo     : 0
M√°ximo     : cantidad_disponible/cantidad_a_recuperar
```

### Estados Visuales
```
üü° Amarillo  : Pendiente
üîµ Azul      : En Proceso
üü¢ Verde     : Esterilizado / Aprobado
üî¥ Rojo      : Desechable
üü† Naranja   : Kit Devuelto
üü£ Morado    : Kit en Limpieza
```

### Filtros Autom√°ticos
- Limpieza: Solo ve productos **reutilizables**
- Aprobaci√≥n: Solo ve productos **esterilizados**
- Desechables: No aparecen en limpieza/aprobaci√≥n

---

## ‚ö†Ô∏è Casos Especiales

### Kit 100% Desechable
Si todos los productos fueron marcados como desechables:
- No aparecer√° en limpieza (no hay nada que procesar)
- No aparecer√° en aprobaci√≥n
- **Soluci√≥n temporal:** Cambiar estado manualmente a `finalizado`
- **Mejora futura:** Bot√≥n "Finalizar Sin Recuperaci√≥n"

### Producto Da√±ado en Supervisi√≥n
Si el supervisor detecta da√±o en un producto esterilizado:
1. Usar botones [-] para reducir `cantidad_aprobada` a 0
2. Solo los productos con cantidad > 0 regresan al inventario
3. Kit se finaliza de todas formas

### Productos Parcialmente Usados
Si un producto tiene cantidad_utilizada menor que cantidad_enviada:
- `cantidad_disponible` = enviada - utilizada
- Por defecto, todo lo disponible se recupera
- T√©cnico puede ajustar si parte est√° da√±ada

---

## üîç Verificaciones

### Despu√©s de Procesar Devoluci√≥n
```sql
-- Verificar estado del kit
SELECT estado FROM kits_cirugia WHERE numero_kit = 'KIT-XXX';
-- Debe ser: en_limpieza

-- Verificar registros de limpieza
SELECT COUNT(*) FROM kit_productos_limpieza WHERE kit_id = 'uuid';
-- Debe ser > 0 si hay reutilizables
```

### Despu√©s de Aprobar
```sql
-- Verificar inventario actualizado
SELECT cantidad FROM inventario WHERE producto_id = 'uuid';
-- Debe haber aumentado

-- Verificar kit finalizado
SELECT estado FROM kits_cirugia WHERE id = 'uuid';
-- Debe ser: finalizado

-- Verificar movimiento registrado
SELECT * FROM movimientos_inventario 
WHERE motivo LIKE '%Recuperaci√≥n de kit%' 
ORDER BY fecha DESC LIMIT 1;
```

---

## üéØ KPIs Visuales

### Dashboard T√©cnico
```
[Cirug√≠as en Curso] [Pendientes Validaci√≥n] [Kits Validados]
        3                    5                   2

[Kits Devueltos]  ‚Üê Nueva secci√≥n naranja
      4
```

### Dashboard Limpieza
```
[Total Kits] [Pendientes] [En Proceso] [Esterilizados]
     4            12           8            15
```

### Dashboard Aprobaci√≥n
```
[Kits Listos] [Productos Esterilizados]
     2                 15
```

---

## üö® Troubleshooting R√°pido

### "No veo el bot√≥n Procesar Devoluci√≥n"
- Verificar que hay kits en estado `devuelto`
- Refrescar la p√°gina
- Verificar que el kit tiene `fecha_devolucion`

### "Kit no aparece en Limpieza"
- Verificar estado del kit: debe ser `en_limpieza`
- Verificar que hay productos con `es_desechable = false`
- Revisar tabla `kit_productos_limpieza`

### "No puedo aprobar el kit"
- Verificar que todos los productos est√°n en estado `esterilizado`
- Revisar permisos de usuario
- Verificar que `cantidad_aprobada` no sea mayor que `cantidad_a_recuperar`

### "Inventario no se actualiz√≥"
- Revisar logs de consola del navegador
- Verificar permisos en tabla `inventario`
- Verificar que `producto_id` existe

---

## üì± Accesos Directos

```
T√©cnico - Procesar:
/internal/tecnico/procesar-devolucion/:kitId

Limpieza - Dashboard:
/internal/limpieza

Supervisor - Aprobaci√≥n:
/internal/limpieza/aprobacion

Volver al Dashboard Principal:
/internal
```

---

## üéì Capacitaci√≥n de Usuarios

### Para T√©cnicos (5 min)
1. "Despu√©s de una cirug√≠a, el kit aparece aqu√≠" ‚Üí Mostrar secci√≥n naranja
2. "Haz clic en Procesar Devoluci√≥n"
3. "Decide qu√© se puede reutilizar y qu√© no"
4. "Confirma y el sistema lo env√≠a a limpieza"

### Para Limpieza (5 min)
1. "Aqu√≠ ves todos los kits que necesitan limpieza"
2. "Haz clic para ver detalles"
3. "Marca cuando empiezas el proceso"
4. "Cuando est√© esterilizado, m√°rcalo"

### Para Supervisores (5 min)
1. "Aqu√≠ ves kits listos para aprobar"
2. "Revisa las observaciones de limpieza"
3. "Ajusta cantidades si ves da√±os"
4. "Aprueba y autom√°ticamente regresa al inventario"

---

## ‚úÖ Checklist de Primera Vez

- [ ] Ejecut√© el migration SQL
- [ ] Prob√© crear un kit completo
- [ ] Finalic√© una cirug√≠a
- [ ] Proces√© la devoluci√≥n como t√©cnico
- [ ] Marqu√© productos como esterilizados
- [ ] Aprob√© el kit como supervisor
- [ ] Verifiqu√© que el inventario se actualiz√≥
- [ ] Confirm√© que el kit est√° en estado `finalizado`

---

## üéâ ¬°Listo para Usar!

**El sistema est√° completo y funcional. Cualquier duda:**
- Ver documentaci√≥n completa: `FASE5_DEVOLUCION_LIMPIEZA.md`
- Revisar resumen: `RESUMEN_FASE5.md`
- Consultar c√≥digo fuente en: `src/app/features/internal/limpieza/`

---

**√öltima actualizaci√≥n:** 2025-01-08  
**Versi√≥n:** 1.0  
**Estado:** ‚úÖ Listo para Uso
