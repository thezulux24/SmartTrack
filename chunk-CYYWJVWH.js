import"./chunk-BKJ6I3FY.js";import{a as U}from"./chunk-QUZ32NC3.js";import{a as W,c as J,g as K,x as Q}from"./chunk-DRTBTDHH.js";import{$ as p,E as g,F as M,Fa as q,G as o,Ha as R,J as V,Ja as B,N as _,Oa as G,Q as j,T as F,Ta as P,U as c,X as E,Y as y,Z as n,_ as a,aa as w,b as T,ba as S,ca as l,ha as r,ia as C,ja as m,ka as $,ma as N,na as H,oa as O,q as I,ta as z,u as f,ua as k,w as b,x as v,y as x,z as h}from"./chunk-IAYZCRTW.js";import"./chunk-LJ5XHLMQ.js";import{h as A}from"./chunk-FK42CRUA.js";var X=class t{scanResult=new T(null);isScanning=new T(!1);scanResult$=this.scanResult.asObservable();isScanning$=this.isScanning.asObservable();constructor(){}generarQrString(i){return JSON.stringify(i)}iniciarEscaneo(){this.isScanning.next(!0)}detenerEscaneo(){this.isScanning.next(!1)}procesarEscaneo(i){this.scanResult.next(i),this.detenerEscaneo()}limpiarResultado(){this.scanResult.next(null)}validarQrKit(i){return i.startsWith("KIT-")&&i.length>10}extraerInfoQr(i){try{if(i.startsWith("KIT-")){let d=i.split("-");return{tipo:"kit",timestamp:parseInt(d[1]),id:d[2]}}return JSON.parse(i)}catch{return{tipo:"unknown"}}}static \u0275fac=function(e){return new(e||t)};static \u0275prov=I({token:t,factory:t.\u0275fac,providedIn:"root"})};var Z=(t,i)=>i.id;function te(t,i){t&1&&(n(0,"div",21)(1,"div",22)(2,"div",33),p(3,"div",34),n(4,"p",35),r(5,"Cargando cirug\xEDas..."),a()()()())}function ie(t,i){t&1&&(n(0,"div",40)(1,"p",42),r(2,"No se encontraron cirug\xEDas"),a()())}function ne(t,i){if(t&1&&(n(0,"div",52)(1,"span"),r(2,"\u{1F4CD}"),a(),n(3,"span"),r(4),a()()),t&2){let e=l().$implicit;o(4),C(e.hospital==null?null:e.hospital.nombre)}}function ae(t,i){if(t&1){let e=w();n(0,"button",44),S("click",function(){let s=b(e).$implicit,u=l(4);return v(u.seleccionarCirugia(s))}),n(1,"div",45)(2,"div",46)(3,"h3",47),r(4),a(),n(5,"p",48),r(6),a(),n(7,"p",49),r(8),a()(),n(9,"div",50)(10,"span"),r(11),z(12,"titlecase"),a(),n(13,"p",51),r(14),a()()(),_(15,ne,5,1,"div",52),a()}if(t&2){let e=i.$implicit,d=l(4);o(4),m(" ",e.numero_cirugia," "),o(2),m(" ",d.obtenerNombreCliente(e)," "),o(2),m(" ",e.medico_cirujano," "),o(2),F("px-2 py-1 rounded-full text-xs font-semibold "+d.obtenerColorEstado(e.estado)),o(),m(" ",k(12,8,e.estado)," "),o(3),m(" ",d.formatearFecha(e.fecha_programada)," "),o(),c(e.hospital!=null&&e.hospital.nombre?15:-1)}}function oe(t,i){if(t&1&&(n(0,"div",41),E(1,ae,16,10,"button",43,Z),a()),t&2){let e=l(3);o(),y(e.cirugiasFiltradas)}}function re(t,i){if(t&1&&(n(0,"main",32)(1,"div",22)(2,"h2",36)(3,"span",37),x(),n(4,"svg",38),p(5,"path",39),a()(),r(6),a(),_(7,ie,3,0,"div",40)(8,oe,3,0,"div",41),a()()),t&2){let e=l(2);o(6),m(" Cirug\xEDas (",e.cirugiasFiltradas.length,") "),o(),c(e.cirugiasFiltradas.length===0?7:8)}}function le(t,i){if(t&1){let e=w();n(0,"header",12)(1,"div",13)(2,"div",14)(3,"div",15),p(4,"img",16),n(5,"span",17),r(6,"Trazabilidad"),a()()(),n(7,"div",18)(8,"h1",19),r(9,"Historial de Actividades"),a(),n(10,"p",20),r(11,"Selecciona una cirug\xEDa para ver su trazabilidad completa"),a()()()(),n(12,"div",21)(13,"div",22)(14,"div",23)(15,"button",24),S("click",function(){b(e);let s=l();return v(s.volverAlMenu())}),x(),n(16,"svg",25),p(17,"path",26),a(),h(),n(18,"span"),r(19,"Volver"),a()()(),n(20,"div",27)(21,"div",28)(22,"input",29),O("ngModelChange",function(s){b(e);let u=l();return H(u.busqueda,s)||(u.busqueda=s),v(s)}),a(),x(),n(23,"svg",30),p(24,"path",31),a()()()()(),_(25,te,6,0,"div",21)(26,re,9,2,"main",32)}if(t&2){let e=l();o(22),N("ngModel",e.busqueda),o(3),c(e.loading()?25:-1),o(),c(e.loading()?-1:26)}}function de(t,i){t&1&&(n(0,"div",21)(1,"div",22)(2,"div",33),p(3,"div",34),n(4,"p",35),r(5,"Cargando historial..."),a()()()())}function se(t,i){if(t&1&&(n(0,"div",54)(1,"div",22)(2,"div",55)(3,"p",56),r(4),a()()()()),t&2){let e=l(2);o(4),C(e.error())}}function ce(t,i){t&1&&(n(0,"div",61),x(),n(1,"svg",63),p(2,"path",60),a(),h(),n(3,"p",64),r(4,"No hay actividad registrada"),a()())}function me(t,i){if(t&1&&(n(0,"span",77),r(1),a(),n(2,"span",78),r(3,"\u2192"),a()),t&2){let e=l(2).$implicit;o(),m(" ",e.estado_anterior," ")}}function pe(t,i){if(t&1&&(n(0,"span",76),r(1),a()),t&2){let e=l(2).$implicit;o(),m(" ",e.estado_nuevo," ")}}function _e(t,i){if(t&1&&(n(0,"div",71),_(1,me,4,1)(2,pe,2,1,"span",76),a()),t&2){let e=l().$implicit;o(),c(e.estado_anterior?1:-1),o(),c(e.estado_nuevo?2:-1)}}function ue(t,i){if(t&1&&(n(0,"p",72),r(1),a()),t&2){let e=l().$implicit;o(),m(" \u{1F4AC} ",e.observaciones," ")}}function xe(t,i){if(t&1&&(n(0,"span",79),r(1),a()),t&2){let e=l(2).$implicit;o(),m(" ",e.usuario_rol," ")}}function ge(t,i){if(t&1&&(n(0,"div",73)(1,"span"),r(2,"\u{1F464}"),a(),n(3,"span"),r(4),a(),_(5,xe,2,1,"span",79),a()),t&2){let e=l().$implicit;o(4),C(e.usuario_nombre),o(),c(e.usuario_rol?5:-1)}}function Ce(t,i){if(t&1&&(n(0,"a",80),r(1," Ver en mapa "),a()),t&2){let e=l(2).$implicit;j("href","https://www.google.com/maps?q="+e.coordenadas_lat+","+e.coordenadas_lng,M)}}function be(t,i){if(t&1&&(n(0,"div",74)(1,"span"),r(2,"\u{1F4CD}"),a(),n(3,"span"),r(4),a(),_(5,Ce,2,1,"a",80),a()),t&2){let e=l().$implicit;o(4),C(e.ubicacion),o(),c(e.coordenadas_lat&&e.coordenadas_lng?5:-1)}}function ve(t,i){if(t&1&&(n(0,"details",75)(1,"summary",81),r(2," Ver detalles adicionales "),a(),n(3,"div",82)(4,"pre",83),r(5),z(6,"json"),a()()()),t&2){let e=l().$implicit;o(5),C(k(6,1,e.metadata))}}function he(t,i){if(t&1&&(n(0,"div",65)(1,"div",66)(2,"div",67),r(3),a(),n(4,"div",46)(5,"div",68)(6,"h4",69),r(7),a(),n(8,"span",70),r(9),a()(),_(10,_e,3,2,"div",71)(11,ue,2,1,"p",72)(12,ge,6,2,"div",73)(13,be,6,2,"div",74)(14,ve,7,3,"details",75),a()()()),t&2){let e=i.$implicit,d=l(4);o(3),C(d.obtenerIconoAccion(e.accion)),o(4),m(" ",d.obtenerTextoAccion(e.accion)," "),o(2),m(" ",d.formatearFecha(e.timestamp)," "),o(),c(e.estado_anterior||e.estado_nuevo?10:-1),o(),c(e.observaciones?11:-1),o(),c(e.usuario_nombre?12:-1),o(),c(e.ubicacion?13:-1),o(),c(e.metadata&&d.Object.keys(e.metadata).length>0?14:-1)}}function fe(t,i){if(t&1&&(n(0,"div",62),E(1,he,15,8,"div",65,Z),a()),t&2){let e=l(3);o(),y(e.eventos())}}function we(t,i){if(t&1&&(n(0,"main",21)(1,"div",22)(2,"div",57)(3,"h3",58)(4,"div",59),x(),n(5,"svg",38),p(6,"path",60),a()(),h(),n(7,"span"),r(8),a()(),_(9,ce,5,0,"div",61)(10,fe,3,0,"div",62),a()()()),t&2){let e=l(2);o(8),m("Historial de Actividad (",e.eventos().length,")"),o(),c(e.eventos().length===0?9:10)}}function Se(t,i){if(t&1){let e=w();n(0,"header",12)(1,"div",13)(2,"div",14)(3,"div",15),p(4,"img",16),n(5,"span",17),r(6,"Historial de Actividad"),a()()(),n(7,"div",18)(8,"h1",19),r(9),a(),n(10,"p",20),r(11),a()()()(),n(12,"div",53)(13,"div",22)(14,"button",24),S("click",function(){b(e);let s=l();return v(s.volver())}),x(),n(15,"svg",25),p(16,"path",26),a(),h(),n(17,"span"),r(18,"Volver"),a()()()(),_(19,de,6,0,"div",21)(20,se,5,1,"div",54)(21,we,11,2,"main",21)}if(t&2){let e,d,s=l();o(9),m(" Cirug\xEDa ",(e=s.cirugiaSeleccionada())==null?null:e.numero_cirugia," "),o(2),$(" ",s.obtenerNombreCliente(s.cirugiaSeleccionada())," \u2022 ",(d=s.cirugiaSeleccionada())==null?null:d.medico_cirujano," "),o(8),c(s.loading()?19:-1),o(),c(s.error()?20:-1),o(),c(!s.loading()&&!s.error()?21:-1)}}var Y=class t{trazabilidadService=f(U);supabase=f(P);router=f(G);Object=Object;vistaActual=g("seleccion");cirugiaSeleccionada=g(null);cirugias=g([]);eventos=g([]);loading=g(!1);error=g(null);busqueda=g("");ngOnInit(){this.cargarCirugias()}cargarCirugias(){return A(this,null,function*(){this.loading.set(!0);try{let{data:i,error:e}=yield this.supabase.client.from("cirugias").select(`
          id,
          numero_cirugia,
          fecha_programada,
          estado,
          medico_cirujano,
          cliente:clientes!inner(nombre, apellido),
          hospital:hospitales(nombre)
        `).order("fecha_programada",{ascending:!1}).limit(50);if(e)throw e;this.cirugias.set(i||[])}catch(i){console.error("Error al cargar cirug\xEDas:",i),this.error.set("Error al cargar las cirug\xEDas")}finally{this.loading.set(!1)}})}seleccionarCirugia(i){this.cirugiaSeleccionada.set(i),this.vistaActual.set("detalle"),this.cargarTrazabilidadCirugia(i.id)}cargarTrazabilidadCirugia(i){this.loading.set(!0),this.error.set(null),this.trazabilidadService.getTimelineCirugia(i).subscribe({next:e=>{this.eventos.set(e),this.loading.set(!1)},error:e=>{console.error("Error al cargar trazabilidad:",e),this.error.set("Error al cargar el historial"),this.loading.set(!1)}})}volver(){this.vistaActual.set("seleccion"),this.cirugiaSeleccionada.set(null),this.eventos.set([])}volverAlMenu(){this.router.navigate(["/internal"])}formatearFecha(i){if(!i)return"N/A";let e=new Date(i),s=new Date().getTime()-e.getTime(),u=Math.floor(s/6e4),D=Math.floor(s/36e5),L=Math.floor(s/864e5);return u<1?"Hace un momento":u<60?`Hace ${u} min`:D<24?`Hace ${D}h`:L<7?`Hace ${L}d`:e.toLocaleDateString("es-ES",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}obtenerIconoAccion(i){return{cirugia_creada:"\u2795",cirugia_iniciada:"\u25B6\uFE0F",cirugia_finalizada:"\u2705",cirugia_cancelada:"\u274C",kit_creado:"\u{1F4E6}",kit_aprobado:"\u2705",kit_rechazado:"\u274C",preparacion_iniciada:"\u{1F527}",producto_agregado:"\u2795",kit_listo:"\u2705",kit_despachado:"\u{1F69A}",kit_en_transito:"\u{1F69B}",kit_entregado:"\u{1F4CD}",kit_en_uso:"\u{1F52C}",kit_devuelto:"\u21A9\uFE0F",qr_escaneado:"\u{1F4F7}",estado_cambiado:"\u{1F504}",tecnico_asignado:"\u{1F464}",kit_asignado:"\u{1F4E6}",fecha_reprogramada:"\u{1F4C5}"}[i]||"\u{1F4C4}"}obtenerColorEstado(i){return{programada:"bg-[#0098A8] text-white",en_proceso:"bg-[#C8D900] text-[#10284C]",finalizada:"bg-[#C8D900] text-[#10284C]",cancelada:"bg-red-500 text-white",solicitado:"bg-[#C8D900] text-[#10284C]",preparando:"bg-[#0098A8] text-white",listo_envio:"bg-[#C8D900] text-[#10284C]",en_transito:"bg-[#0098A8] text-white",entregado:"bg-[#C8D900] text-[#10284C]",en_uso:"bg-[#0098A8] text-white",devuelto:"bg-white/20 text-white",finalizado:"bg-[#C8D900] text-[#10284C]"}[i]||"bg-white/20 text-white"}obtenerNombreCliente(i){return i.cliente?`${i.cliente.nombre} ${i.cliente.apellido}`:"N/A"}obtenerTextoAccion(i){return i.replace(/_/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}get cirugiasFiltradas(){let i=this.busqueda().toLowerCase();return i?this.cirugias().filter(e=>e.numero_cirugia.toLowerCase().includes(i)||e.medico_cirujano?.toLowerCase().includes(i)||this.obtenerNombreCliente(e).toLowerCase().includes(i)||e.hospital?.nombre?.toLowerCase().includes(i)):this.cirugias()}static \u0275fac=function(e){return new(e||t)};static \u0275cmp=V({type:t,selectors:[["app-trazabilidad-list"]],decls:14,vars:2,consts:[[1,"min-h-screen","bg-[#10284C]","relative","overflow-hidden"],[1,"absolute","inset-0","overflow-hidden","pointer-events-none"],["xmlns","http://www.w3.org/2000/svg",1,"absolute","w-full","h-full"],["cx","10%","cy","15%","r","120","fill","#0098A8","opacity","0.08"],["cx","85%","cy","25%","r","150","fill","#C8D900","opacity","0.06"],["cx","90%","cy","85%","r","100","fill","#0098A8","opacity","0.07"],["x1","0","y1","200","x2","400","y2","0","stroke","#0098A8","stroke-width","2","opacity","0.1"],["x1","100%","y1","300","x2","60%","y2","100","stroke","#C8D900","stroke-width","2","opacity","0.08"],["points","200,600 250,700 150,700","fill","#0098A8","opacity","0.06"],["points","900,400 950,500 850,500","fill","#C8D900","opacity","0.05"],["x","50","y","400","width","80","height","80","fill","#0098A8","opacity","0.07","transform","rotate(45 90 440)"],["x","80%","y","600","width","60","height","60","fill","#C8D900","opacity","0.06","transform","rotate(30 85% 630)"],[1,"relative","z-10","bg-gradient-to-br","from-[#10284C]/95","to-[#10284C]/60","backdrop-blur-md","border-b","border-white/10","shadow-2xl"],[1,"px-4","py-4"],[1,"flex","justify-center","items-center","mb-3"],[1,"flex","items-center","space-x-3"],["src","https://www.implameq.com/wp-content/uploads/logotipo-impla-300x78.png.webp","alt","Implameq",1,"h-8","brightness-0","invert"],[1,"text-lg","font-semibold","text-white"],[1,"text-center"],[1,"text-2xl","font-bold","mb-1","text-white"],[1,"text-[#C8D900]","text-sm"],[1,"relative","z-10","px-4","py-6"],[1,"max-w-lg","mx-auto"],[1,"mb-4"],["type","button",1,"w-full","bg-white/10","hover:bg-white/20","text-white","px-4","py-3","rounded-xl","font-medium","transition-all","duration-200","shadow-lg","backdrop-blur-sm","border","border-white/20","active:scale-95","flex","items-center","justify-center","space-x-2",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M10 19l-7-7m0 0l7-7m-7 7h18"],[1,"bg-[#0098A8]/20","backdrop-blur-md","rounded-2xl","shadow-xl","border","border-white/20","p-4","mb-4"],[1,"relative"],["type","text","placeholder","Buscar por n\xFAmero, cliente, m\xE9dico u hospital...",1,"w-full","px-4","py-3","pl-10","bg-[#10284C]/50","border","border-white/20","text-white","placeholder-white/50","rounded-xl","focus:ring-2","focus:ring-[#C8D900]","focus:border-transparent","transition","duration-200",3,"ngModelChange","ngModel"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"absolute","left-3","top-3.5","w-5","h-5","text-white/50"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"],[1,"relative","z-10","px-4","pb-6"],[1,"bg-[#0098A8]/20","backdrop-blur-md","rounded-2xl","border","border-white/20","shadow-xl","p-6","text-center"],[1,"w-12","h-12","border-4","border-[#C8D900]","border-t-transparent","rounded-full","animate-spin","mx-auto","mb-4"],[1,"text-sm","text-white/90"],[1,"text-lg","font-semibold","text-white","mb-4","flex","items-center"],[1,"w-8","h-8","bg-[#C8D900]","rounded-lg","flex","items-center","justify-center","mr-2"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4","text-[#10284C]"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"],[1,"bg-[#0098A8]/20","backdrop-blur-md","rounded-2xl","shadow-xl","border","border-white/20","p-6","text-center"],[1,"space-y-3"],[1,"text-white/70"],[1,"w-full","bg-[#0098A8]/20","backdrop-blur-md","rounded-2xl","shadow-xl","border","border-white/20","p-4","hover:bg-[#0098A8]/30","transition-all","duration-200","text-left","active:scale-98"],[1,"w-full","bg-[#0098A8]/20","backdrop-blur-md","rounded-2xl","shadow-xl","border","border-white/20","p-4","hover:bg-[#0098A8]/30","transition-all","duration-200","text-left","active:scale-98",3,"click"],[1,"flex","justify-between","items-start","mb-2"],[1,"flex-1"],[1,"font-semibold","text-white","text-lg"],[1,"text-sm","text-white/70"],[1,"text-xs","text-white/50","mt-1"],[1,"text-right"],[1,"text-xs","text-white/50","mt-2"],[1,"flex","items-center","gap-1","text-xs","text-white/60","mt-2"],[1,"relative","z-10","px-4","pt-6"],[1,"relative","z-10","px-4","py-4"],[1,"bg-red-500/20","backdrop-blur-md","border","border-red-400/30","rounded-2xl","shadow-xl","px-4","py-3"],[1,"text-sm","text-red-200"],[1,"bg-[#0098A8]/20","backdrop-blur-md","rounded-2xl","shadow-xl","border","border-white/20","p-6"],[1,"text-lg","font-semibold","text-white","mb-4","flex","items-center","space-x-2"],[1,"w-8","h-8","bg-[#C8D900]","rounded-lg","flex","items-center","justify-center","flex-shrink-0"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"text-center","py-8"],[1,"space-y-4"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-12","h-12","text-white/40","mx-auto","mb-4"],[1,"text-white/60"],[1,"border-l-4","border-[#C8D900]","pl-4","py-2","bg-white/5","backdrop-blur-sm","rounded-r-xl","hover:bg-white/10","transition","duration-200"],[1,"flex","items-start"],[1,"text-2xl","mr-3"],[1,"flex","justify-between","items-start","mb-1"],[1,"font-medium","text-white"],[1,"text-xs","text-white/50"],[1,"flex","items-center","gap-2","text-sm","my-2"],[1,"text-sm","text-white/70","mt-2","bg-[#10284C]/30","p-2","rounded"],[1,"flex","items-center","gap-2","mt-2","text-xs","text-white/50"],[1,"flex","items-center","gap-1","text-xs","text-white/50","mt-1"],[1,"mt-2"],[1,"px-2","py-1","bg-[#C8D900]","text-[#10284C]","rounded","text-xs","font-medium"],[1,"px-2","py-1","bg-white/10","rounded","text-xs","text-white/70"],[1,"text-white/50"],[1,"px-2","py-0.5","bg-white/10","rounded"],["target","_blank",1,"text-[#C8D900]","hover:text-[#C8D900]/80","hover:underline","ml-2",3,"href"],[1,"cursor-pointer","text-xs","text-white/60","hover:text-white/80"],[1,"mt-2","p-2","bg-[#10284C]/30","rounded","text-xs"],[1,"whitespace-pre-wrap","text-white/70"]],template:function(e,d){e&1&&(n(0,"div",0)(1,"div",1),x(),n(2,"svg",2),p(3,"circle",3)(4,"circle",4)(5,"circle",5)(6,"line",6)(7,"line",7)(8,"polygon",8)(9,"polygon",9)(10,"rect",10)(11,"rect",11),a()(),_(12,le,27,3)(13,Se,22,6),a()),e&2&&(o(12),c(d.vistaActual()==="seleccion"?12:-1),o(),c(d.vistaActual()==="detalle"?13:-1))},dependencies:[B,R,q,Q,W,J,K],encapsulation:2})};export{Y as TrazabilidadListComponent};
