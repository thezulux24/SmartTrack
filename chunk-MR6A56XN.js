import{a as f}from"./chunk-AF4TJ6YQ.js";import{b as t,d as n,f as s,i as d,m as u,p,s as m}from"./chunk-CV56RX3B.js";import{a as l,b as _}from"./chunk-FK42CRUA.js";var h=class g{constructor(i){this.supabase=i}getCirugias(){return t(this.supabase.client.from("cirugias").select(`
          *,
          cliente:clientes!cirugias_cliente_id_fkey(
            id,
            nombre,
            apellido,
            documento_tipo,
            documento_numero,
            telefono,
            email,
            ciudad
          ),
          tecnico_asignado:profiles!cirugias_tecnico_asignado_id_fkey(
            id,
            full_name,
            email,
            area
          ),
          hospital_data:hospitales!cirugias_hospital_id_fkey(
            id,
            nombre,
            direccion,
            ciudad,
            telefono,
            contacto_principal
          ),
          tipo_cirugia_data:tipos_cirugia!cirugias_tipo_cirugia_id_fkey(
            id,
            nombre,
            descripcion,
            duracion_promedio,
            especialidad
          )
        `).order("fecha_programada",{ascending:!0})).pipe(s(i=>{if(i.error)throw console.error("Error fetching cirugias:",i.error),new Error(i.error.message||"Error al cargar cirug\xEDas");return i.data||[]}),d(i=>(console.error("Service error:",i),n(()=>i))))}getCirugiaById(i){return t(this.supabase.client.from("cirugias").select(`
          *,
          cliente:clientes!cirugias_cliente_id_fkey(
            id,
            nombre,
            apellido,
            documento_tipo,
            documento_numero,
            telefono,
            email,
            ciudad
          ),
          tecnico_asignado:profiles!cirugias_tecnico_asignado_id_fkey(
            id,
            full_name,
            email,
            area
          ),
          hospital_data:hospitales!cirugias_hospital_id_fkey(
            id,
            nombre,
            direccion,
            ciudad,
            telefono,
            contacto_principal
          ),
          tipo_cirugia_data:tipos_cirugia!cirugias_tipo_cirugia_id_fkey(
            id,
            nombre,
            descripcion,
            duracion_promedio,
            especialidad
          )
        `).eq("id",i).single()).pipe(s(r=>{if(r.error)throw new Error(r.error.message||"Error al cargar cirug\xEDa");return r.data}),d(r=>(console.error("Error loading cirugia:",r),n(()=>r))))}createCirugia(i){return t(this.supabase.client.auth.getUser()).pipe(u(r=>{let o=r.data.user;if(!o)throw new Error("Usuario no autenticado");let e=_(l({},i),{usuario_creador_id:o.id});return t(this.supabase.client.from("cirugias").insert([e]).select(`
              *,
              tecnico_asignado:profiles!cirugias_tecnico_asignado_id_fkey(
                id,
                full_name,
                email
              ),
              hospital_data:hospitales!cirugias_hospital_id_fkey(
                id,
                nombre,
                ciudad
              ),
              tipo_cirugia_data:tipos_cirugia!cirugias_tipo_cirugia_id_fkey(
                id,
                nombre
              )
            `).single())}),s(r=>{if(r.error)throw console.error("Error creating cirugia:",r.error),new Error(r.error.message||"Error al crear cirug\xEDa");return r.data}),d(r=>(console.error("Service error creating cirugia:",r),n(()=>r))))}updateCirugia(i,r){let o=_(l({},r),{updated_at:new Date().toISOString()});return t(this.supabase.client.from("cirugias").update(o).eq("id",i).select(`
          *,
          tecnico_asignado:profiles!cirugias_tecnico_asignado_id_fkey(
            id,
            full_name,
            email
          ),
          hospital_data:hospitales!cirugias_hospital_id_fkey(
            id,
            nombre,
            ciudad
          ),
          tipo_cirugia_data:tipos_cirugia!cirugias_tipo_cirugia_id_fkey(
            id,
            nombre
          )
        `).single()).pipe(s(e=>{if(e.error)throw console.error("Error updating cirugia:",e.error),new Error(e.error.message||"Error al actualizar cirug\xEDa");return e.data}),d(e=>(console.error("Service error updating cirugia:",e),n(()=>e))))}updateEstado(i,r,o){return t(this.supabase.client.auth.getUser()).pipe(u(e=>{let a=e.data.user;return t(this.supabase.client.from("cirugias").select("estado").eq("id",i).single()).pipe(u(c=>{if(c.error)throw new Error("Error al obtener estado actual");let b=c.data.estado;return t(this.supabase.client.from("cirugias").update({estado:r,updated_at:new Date().toISOString()}).eq("id",i)).pipe(u(E=>{if(E.error)throw new Error("Error al actualizar estado");return t(this.supabase.client.from("cirugia_seguimiento").insert([{cirugia_id:i,estado_anterior:b,estado_nuevo:r,comentario:o||`Estado cambiado a ${r}`,usuario_id:a?.id||null}]))}))}))}),s(e=>{if(e.error)throw console.error("Error updating estado:",e.error),new Error(e.error.message||"Error al actualizar estado")}),d(e=>(console.error("Service error updating estado:",e),n(()=>e))))}deleteCirugia(i){return t(this.supabase.client.from("cirugias").delete().eq("id",i)).pipe(s(r=>{if(r.error)throw console.error("Error deleting cirugia:",r.error),new Error(r.error.message||"Error al eliminar cirug\xEDa")}),d(r=>(console.error("Service error deleting cirugia:",r),n(()=>r))))}getCirugiasByTecnico(i){return t(this.supabase.client.from("cirugias").select(`
          *,
          hospital_data:hospitales!cirugias_hospital_id_fkey(
            id,
            nombre,
            ciudad
          ),
          tipo_cirugia_data:tipos_cirugia!cirugias_tipo_cirugia_id_fkey(
            id,
            nombre
          )
        `).eq("tecnico_asignado_id",i).order("fecha_programada",{ascending:!0})).pipe(s(r=>{if(r.error)throw console.error("Error fetching cirugias by tecnico:",r.error),new Error(r.error.message||"Error al cargar cirug\xEDas del t\xE9cnico");return r.data||[]}),d(r=>(console.error("Service error loading tecnico cirugias:",r),n(()=>r))))}getCirugiasByDateRange(i,r){return t(this.supabase.client.from("cirugias").select(`
          *,
          tecnico_asignado:profiles!cirugias_tecnico_asignado_id_fkey(
            id,
            full_name,
            email
          ),
          hospital_data:hospitales!cirugias_hospital_id_fkey(
            id,
            nombre,
            ciudad
          ),
          tipo_cirugia_data:tipos_cirugia!cirugias_tipo_cirugia_id_fkey(
            id,
            nombre
          )
        `).gte("fecha_programada",i).lte("fecha_programada",r).order("fecha_programada",{ascending:!0})).pipe(s(o=>{if(o.error)throw console.error("Error fetching cirugias by date range:",o.error),new Error(o.error.message||"Error al cargar cirug\xEDas por fecha");return o.data||[]}),d(o=>(console.error("Service error loading date range cirugias:",o),n(()=>o))))}getSeguimientoCirugia(i){return t(this.supabase.client.from("cirugia_seguimiento").select(`
          *,
          usuario:profiles!cirugia_seguimiento_usuario_id_fkey(
            id,
            full_name
          )
        `).eq("cirugia_id",i).order("fecha_cambio",{ascending:!1})).pipe(s(r=>{if(r.error)throw console.error("Error fetching seguimiento:",r.error),new Error(r.error.message||"Error al cargar seguimiento");return r.data||[]}),d(r=>(console.error("Service error loading seguimiento:",r),n(()=>r))))}getCirugiasConKits(){return console.log("\u{1F50D} Ejecutando consulta getCirugiasConKits..."),t(this.supabase.client.from("cirugias").select(`
          id,
          numero_cirugia,
          fecha_programada,
          tecnico_asignado_id,
          estado,
          cliente:clientes!cirugias_cliente_id_fkey(
            id,
            nombre,
            apellido
          ),
          tecnico_asignado:profiles!cirugias_tecnico_asignado_id_fkey(
            id,
            full_name
          ),
          kits:kits_cirugia(
            id,
            numero_kit,
            estado,
            productos:kit_productos(
              id,
              producto_id,
              cantidad_solicitada,
              precio_unitario,
              observaciones,
              producto:productos(
                id,
                nombre,
                categoria,
                precio
              )
            )
          )
        `).order("fecha_programada",{ascending:!1}).limit(20)).pipe(s(i=>{if(console.log("\u{1F50D} Respuesta raw de Supabase:",i),i.error)throw console.error("\u274C Error en consulta Supabase:",i.error),new Error(i.error.message||"Error al cargar cirug\xEDas con kits");let r=i.data||[];console.log("\u{1F4CA} Datos raw recibidos:",r.length,"cirug\xEDas"),console.log("\u{1F4CA} Primera cirug\xEDa:",r[0]);let o=r.filter(a=>a.kits&&a.kits.length>0);console.log("\u{1F50D} Cirug\xEDas con kits:",o.length);let e=o.map(a=>({id:a.id,numero_cirugia:a.numero_cirugia,fecha_cirugia:a.fecha_programada,tecnico_asignado_id:a.tecnico_asignado_id,cliente:a.cliente,tecnico:{nombre:a.tecnico_asignado?.full_name?.split(" ")[0]||"Sin",apellido:a.tecnico_asignado?.full_name?.split(" ").slice(1).join(" ")||"Asignar"},kit:a.kits?.[0]?{nombre:`Kit ${a.kits[0].numero_kit}`,items:a.kits[0].productos?.map(c=>({id:c.producto?.id||c.id,nombre:c.producto?.nombre||"Producto sin nombre",categoria:this.mapCategoria(c.producto?.categoria||""),precio:c.precio_unitario||c.producto?.precio||0,cantidad_requerida:c.cantidad_solicitada||1,producto_id:c.producto_id}))||[]}:null})).filter(a=>a.kit&&a.kit.items.length>0);return console.log("\u2705 Datos transformados final:",e),e}),d(i=>(console.error("\u274C Service error loading cirugias con kits:",i),n(()=>i))))}mapCategoria(i){return{implantes:"productos",instrumentos:"productos",medicamentos:"productos",transporte:"transporte",otros:"otros"}[i]||"productos"}getCirugiaStats(){return t(this.supabase.client.from("cirugias").select("estado, prioridad, fecha_programada, tecnico_asignado_id")).pipe(s(i=>{if(i.error)throw new Error(i.error.message||"Error al cargar estad\xEDsticas");let r=i.data||[],o=new Date,e=new Date(o);return e.setDate(o.getDate()+1),{total:r.length,programadas:r.filter(a=>a.estado==="programada").length,en_curso:r.filter(a=>a.estado==="en_curso").length,completadas:r.filter(a=>a.estado==="completada").length,canceladas:r.filter(a=>a.estado==="cancelada").length,urgencias:r.filter(a=>a.estado==="urgencia"||a.prioridad==="urgencia").length,sin_tecnico:r.filter(a=>!a.tecnico_asignado_id&&a.estado==="programada").length,hoy:r.filter(a=>new Date(a.fecha_programada).toDateString()===o.toDateString()).length,manana:r.filter(a=>new Date(a.fecha_programada).toDateString()===e.toDateString()).length}}),d(i=>(console.error("Service error loading stats:",i),n(()=>i))))}static \u0275fac=function(r){return new(r||g)(m(f))};static \u0275prov=p({token:g,factory:g.\u0275fac,providedIn:"root"})};export{h as a};
