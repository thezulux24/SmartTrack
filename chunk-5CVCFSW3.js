import{a as Z,c as J,g as Q,x as X}from"./chunk-V2VKRV3B.js";import{g as B,j as K,n as O,p as U,v as W}from"./chunk-3OSVPALZ.js";import{$ as x,Ab as u,Bb as P,Cb as L,Eb as $,Fb as H,Gb as q,Ia as d,Nb as G,Pb as N,S as T,Sa as A,Xa as z,Y as f,Yb as k,Z as w,_ as h,cb as I,fb as V,ib as C,la as E,lb as j,mb as R,nb as t,ob as e,pb as p,qb as M,tb as S,ub as _,zb as n}from"./chunk-MBDN4FSM.js";import"./chunk-X5YLR3NI.js";import{i as F}from"./chunk-ODN5LVDJ.js";var te=(l,r)=>r.id;function ie(l,r){if(l&1&&(t(0,"div",9)(1,"div",13),n(2),e(),t(3,"div",14),n(4,"Kit ID"),e()()),l&2){let i,o=_();d(2),u((i=o.kit())==null?null:i.numero_kit)}}function ne(l,r){l&1&&(t(0,"div",10)(1,"div",15),p(2,"div",16),t(3,"p",17),n(4,"Cargando datos del kit..."),e()()())}function oe(l,r){if(l&1&&(t(0,"div",11)(1,"div",18),h(),t(2,"svg",19),p(3,"path",20),e(),x(),t(4,"h3",21),n(5,"Error"),e(),t(6,"p",22),n(7),e()()()),l&2){let i=_();d(7),u(i.error())}}function ae(l,r){if(l&1){let i=M();t(0,"div",69)(1,"button",71),S("click",function(){f(i);let a=_().$implicit,c=_(2);return w(c.ajustarCantidadRecuperar(a,-1))}),n(2," - "),e(),t(3,"span",72),n(4),e(),t(5,"button",73),S("click",function(){f(i);let a=_().$implicit,c=_(2);return w(c.ajustarCantidadRecuperar(a,1))}),n(6," + "),e()()}if(l&2){let i=_().$implicit;d(),I("disabled",i.cantidad_a_recuperar<=0),d(3),P(" ",i.cantidad_a_recuperar," "),d(),I("disabled",i.cantidad_a_recuperar>=i.cantidad_disponible)}}function re(l,r){l&1&&(t(0,"div",15)(1,"span",74),n(2,"-"),e()())}function de(l,r){if(l&1){let i=M();t(0,"tr",57)(1,"td",61)(2,"div",27),n(3),e(),t(4,"div",62),n(5),e()(),t(6,"td",63)(7,"span",27),n(8),e()(),t(9,"td",63)(10,"span",64),n(11),e()(),t(12,"td",63)(13,"span",65),n(14),e()(),t(15,"td",63)(16,"span",66),h(),t(17,"svg",67),p(18,"path",37),e(),n(19," A Limpieza "),e()(),x(),t(20,"td",63)(21,"button",68),S("click",function(){let a=f(i).$implicit,c=_(2);return w(c.toggleDesechable(a))}),n(22),e()(),t(23,"td",61),z(24,ae,7,3,"div",69)(25,re,3,0,"div",15),e(),t(26,"td",61)(27,"input",70),q("ngModelChange",function(a){let c=f(i).$implicit;return H(c.notas,a)||(c.notas=a),w(a)}),e()()()}if(l&2){let i=r.$implicit;d(3),u(i.nombre),d(2),u(i.codigo),d(3),u(i.cantidad_enviada),d(3),u(i.cantidad_utilizada),d(3),u(i.cantidad_disponible),d(7),V(i.es_desechable?"bg-red-500 border-red-600 text-white":"bg-green-500 border-green-600 text-white"),d(),P(" ",i.es_desechable?"\u{1F5D1}\uFE0F Desechable":"\u267B\uFE0F Reutilizable"," "),d(2),C(!i.es_desechable&&i.cantidad_disponible>0?24:25),d(3),$("ngModel",i.notas)}}function le(l,r){l&1&&(p(0,"div",75),t(1,"span"),n(2,"Procesando..."),e())}function ce(l,r){l&1&&(h(),t(0,"svg",43),p(1,"path",40),e(),x(),t(2,"span"),n(3,"Confirmar y Enviar a Limpieza"),e())}function se(l,r){if(l&1){let i=M();t(0,"div",12)(1,"div",23)(2,"h2",24),n(3,"Informaci\xF3n de la Cirug\xEDa"),e(),t(4,"div",25)(5,"div")(6,"div",26),n(7,"Hospital"),e(),t(8,"div",27),n(9),e()(),t(10,"div")(11,"div",26),n(12,"M\xE9dico"),e(),t(13,"div",27),n(14),e()(),t(15,"div")(16,"div",26),n(17,"Cliente"),e(),t(18,"div",27),n(19),e()(),t(20,"div")(21,"div",26),n(22,"Fecha Devoluci\xF3n"),e(),t(23,"div",27),n(24),G(25,"date"),e()()()(),t(26,"div",25)(27,"div",28)(28,"div",29)(29,"h3",30),n(30,"Total Productos"),e(),h(),t(31,"svg",31),p(32,"path",32),e()(),x(),t(33,"div",33),n(34),e()(),t(35,"div",34)(36,"div",29)(37,"h3",30),n(38,"Desechables"),e(),h(),t(39,"svg",31),p(40,"path",35),e()(),x(),t(41,"div",33),n(42),e()(),t(43,"div",36)(44,"div",29)(45,"h3",30),n(46,"A Limpieza"),e(),h(),t(47,"svg",31),p(48,"path",37),e()(),x(),t(49,"div",33),n(50),e(),t(51,"div",38),n(52,"Reutilizables"),e()(),t(53,"div",39)(54,"div",29)(55,"h3",30),n(56,"A Recuperar"),e(),h(),t(57,"svg",31),p(58,"path",40),e()(),x(),t(59,"div",33),n(60),e()()(),t(61,"div",41)(62,"h3",42),h(),t(63,"svg",43),p(64,"path",44),e(),n(65," Instrucciones "),e(),x(),t(66,"div",45)(67,"p")(68,"strong"),n(69,"1."),e(),n(70," Revisa cada producto y marca si es desechable o reutilizable"),e(),t(71,"p")(72,"strong"),n(73,"2."),e(),n(74," Para productos reutilizables, indica la cantidad a recuperar"),e(),t(75,"p")(76,"strong"),n(77,"3."),e(),n(78," Agrega notas si es necesario (da\xF1os, observaciones)"),e(),t(79,"p")(80,"strong"),n(81,"4."),e(),n(82," Todos los productos "),t(83,"strong",46),n(84,"reutilizables"),e(),n(85," pasar\xE1n por proceso de limpieza y esterilizaci\xF3n"),e()()(),t(86,"div",47)(87,"div",48)(88,"h2",49),n(89,"Productos del Kit"),e(),t(90,"p",50),n(91,"Clasifica cada producto seg\xFAn su disposici\xF3n"),e()(),t(92,"div",51)(93,"table",52)(94,"thead",53)(95,"tr")(96,"th",54),n(97,"Producto"),e(),t(98,"th",55),n(99,"Enviado"),e(),t(100,"th",55),n(101,"Utilizado"),e(),t(102,"th",55),n(103,"Disponible"),e(),t(104,"th",55),n(105,"Estado"),e(),t(106,"th",55),n(107,"Tipo"),e(),t(108,"th",55),n(109,"A Recuperar"),e(),t(110,"th",54),n(111,"Notas"),e()()(),t(112,"tbody",56),j(113,de,28,10,"tr",57,te),e()()()(),t(115,"div",58)(116,"button",59),S("click",function(){f(i);let a=_();return w(a.regresar())}),n(117," Cancelar "),e(),t(118,"button",60),S("click",function(){f(i);let a=_();return w(a.confirmarProcesamiento())}),z(119,le,3,0)(120,ce,4,0),e()()()}if(l&2){let i,o,a,c,s=_();d(9),u(((i=s.kit())==null||i.hospital==null?null:i.hospital.nombre)||"N/A"),d(5),u(((o=s.kit())==null?null:o.medico_cirujano)||"N/A"),d(5),L(" ",(a=s.kit())==null||a.cliente==null?null:a.cliente.nombre," ",((a=s.kit())==null||a.cliente==null?null:a.cliente.apellido)||""," "),d(5),P(" ",N(25,11,(c=s.kit())==null?null:c.fecha_devolucion,"dd/MM/yyyy HH:mm")," "),d(10),u(s.totalProductos()),d(8),u(s.totalDesechables()),d(8),u(s.totalALimpieza()),d(10),u(s.totalARecuperar()),d(53),R(s.productos()),d(5),I("disabled",s.procesando()||s.productos().length===0),d(),C(s.procesando()?119:120)}}var Y=class l{supabaseService=T(W);router=T(U);route=T(O);kitId=E("");kit=E(null);productos=E([]);cargando=E(!0);procesando=E(!1);error=E("");totalProductos=k(()=>this.productos().length);totalDesechables=k(()=>this.productos().filter(r=>r.es_desechable).length);totalReutilizables=k(()=>this.productos().filter(r=>!r.es_desechable).length);totalARecuperar=k(()=>this.productos().reduce((r,i)=>r+i.cantidad_a_recuperar,0));totalALimpieza=k(()=>this.productos().filter(r=>!r.es_desechable&&r.cantidad_a_recuperar>0).length);Math=Math;ngOnInit(){let r=this.route.snapshot.paramMap.get("kitId");r?(this.kitId.set(r),this.cargarDatosKit()):(this.error.set("ID de kit no encontrado"),this.cargando.set(!1))}cargarDatosKit(){return F(this,null,function*(){try{this.cargando.set(!0),this.error.set("");let r=this.supabaseService.supabaseClient,{data:i,error:o}=yield r.from("kits_cirugia").select(`
          id,
          numero_kit,
          cirugia_id,
          fecha_devolucion,
          estado,
          cirugias!inner(
            id,
            medico_cirujano,
            hospitales(nombre),
            clientes(nombre, apellido)
          )
        `).eq("id",this.kitId()).eq("estado","devuelto").single();if(o)throw o;if(!i)throw new Error("Kit no encontrado o no est\xE1 en estado devuelto");let a=i.cirugias;this.kit.set({id:i.id,numero_kit:i.numero_kit,cirugia_id:i.cirugia_id,fecha_devolucion:i.fecha_devolucion,hospital:a?.hospitales,medico_cirujano:a?.medico_cirujano,cliente:a?.clientes});let{data:c,error:s}=yield r.from("kit_productos").select(`
          id,
          producto_id,
          cantidad_enviada,
          cantidad_utilizada,
          productos!inner(
            id,
            nombre,
            codigo
          )
        `).eq("kit_id",this.kitId());if(s)throw s;let D=(c||[]).map(b=>{let y=b.productos,v=b.cantidad_enviada||0,m=b.cantidad_utilizada||0,g=v-m,ee=v;return{id:b.id,producto_id:b.producto_id,nombre:y.nombre,codigo:y.codigo,cantidad_enviada:b.cantidad_enviada||0,cantidad_utilizada:m,cantidad_disponible:g,es_desechable:!1,requiere_limpieza:!0,cantidad_a_recuperar:ee,notas:""}});this.productos.set(D)}catch(r){console.error("Error al cargar datos del kit:",r),this.error.set(r.message||"Error al cargar los datos")}finally{this.cargando.set(!1)}})}toggleDesechable(r){let i=this.productos(),o=i.findIndex(a=>a.id===r.id);o!==-1&&(i[o].es_desechable=!i[o].es_desechable,i[o].es_desechable?i[o].cantidad_a_recuperar=0:i[o].cantidad_a_recuperar=i[o].cantidad_disponible,this.productos.set([...i]))}ajustarCantidadRecuperar(r,i){let o=this.productos(),a=o.findIndex(c=>c.id===r.id);if(a!==-1&&!o[a].es_desechable){let c=o[a].requiere_limpieza?o[a].cantidad_utilizada:o[a].cantidad_disponible,s=Math.max(0,Math.min(c,o[a].cantidad_a_recuperar+i));o[a].cantidad_a_recuperar=s,this.productos.set([...o])}}confirmarProcesamiento(){return F(this,null,function*(){if(!(this.procesando()||!confirm(`\xBFConfirmar procesamiento de devoluci\xF3n?

Total productos: ${this.totalProductos()}
Desechables: ${this.totalDesechables()}
Reutilizables: ${this.totalReutilizables()}
  \u2192 A limpieza: ${this.totalALimpieza()}
Cantidad total a recuperar: ${this.totalARecuperar()}

Todos los productos reutilizables ser\xE1n enviados a limpieza y esterilizaci\xF3n.`)))try{this.procesando.set(!0),this.error.set("");let i=this.supabaseService.supabaseClient,o=(yield i.auth.getUser()).data.user?.id,a=this.productos().filter(m=>!m.es_desechable&&m.cantidad_a_recuperar>0);for(let m of this.productos()){let{error:g}=yield i.from("kit_productos").update({cantidad_recuperable:m.cantidad_a_recuperar,es_desechable:m.es_desechable,notas_devolucion:m.notas}).eq("id",m.id);g&&console.error("Error actualizando producto:",g)}for(let m of a){let{error:g}=yield i.from("kit_productos_limpieza").insert({kit_producto_id:m.id,kit_id:this.kitId(),producto_id:m.producto_id,cantidad_a_recuperar:m.cantidad_a_recuperar,cantidad_aprobada:0,es_desechable:!1,estado_limpieza:"pendiente",estado:"enviado_limpieza",notas:m.notas,procesado_por:o,fecha_inicio_proceso:new Date().toISOString()});g&&console.error("Error creando registro limpieza:",g)}let c="finalizado",s=null;a.length>0?c="en_limpieza":(c="finalizado",s=new Date().toISOString());let D={estado:c};c==="en_limpieza"?D.fecha_inicio_limpieza=new Date().toISOString():c==="finalizado"&&(D.fecha_fin_limpieza=s);let{error:b}=yield i.from("kits_cirugia").update(D).eq("id",this.kitId());if(b)throw b;let{error:y}=yield i.from("cirugia_trazabilidad").insert({cirugia_id:this.kit()?.cirugia_id,accion:"devolucion_procesada",estado_anterior:"devuelto",estado_nuevo:c,usuario_id:o,observaciones:`Devoluci\xF3n procesada: ${this.totalReutilizables()} productos reutilizables, ${this.totalDesechables()} desechables. Total a recuperar: ${this.totalARecuperar()}. Todos los reutilizables enviados a limpieza: ${a.length}`,metadata:{kit_id:this.kitId(),total_productos:this.totalProductos(),total_desechables:this.totalDesechables(),total_reutilizables:this.totalReutilizables(),total_a_limpieza:a.length,cantidad_a_recuperar:this.totalARecuperar(),productos:this.productos().map(m=>({nombre:m.nombre,codigo:m.codigo,es_desechable:m.es_desechable,requiere_limpieza:m.requiere_limpieza,cantidad_a_recuperar:m.cantidad_a_recuperar}))}});y&&console.error("Error en trazabilidad:",y);let v=`\u2705 Devoluci\xF3n procesada exitosamente

`;a.length>0&&(v+=`\u2713 ${a.length} producto(s) enviado(s) a limpieza y esterilizaci\xF3n
`),this.totalDesechables()>0&&(v+=`\u2713 ${this.totalDesechables()} producto(s) marcado(s) como desechables
`),v+=`
Kit ${this.kit()?.numero_kit}: ${c==="finalizado"?"FINALIZADO":"EN PROCESO DE LIMPIEZA"}`,alert(v),this.router.navigate(["/internal/tecnico"])}catch(i){console.error("Error al procesar devoluci\xF3n:",i),this.error.set(i.message||"Error al procesar la devoluci\xF3n")}finally{this.procesando.set(!1)}})}regresar(){this.router.navigate(["/internal/tecnico"])}static \u0275fac=function(i){return new(i||l)};static \u0275cmp=A({type:l,selectors:[["app-tecnico-procesar-devolucion"]],decls:17,vars:4,consts:[[1,"min-h-screen","bg-gradient-to-br","from-[#10284C]","via-[#0d1f3a]","to-[#0a1829]","p-6"],[1,"max-w-7xl","mx-auto","mb-8"],[1,"mb-6","flex","items-center","gap-2","text-white","hover:text-[#C8D900]","transition-colors",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M15 19l-7-7 7-7"],[1,"font-medium"],[1,"flex","items-center","justify-between"],[1,"text-4xl","font-bold","text-white","mb-2"],[1,"text-gray-300"],[1,"bg-[#FF8C00]/10","border","border-[#FF8C00]","rounded-lg","px-4","py-2"],[1,"flex","items-center","justify-center","py-20"],[1,"max-w-7xl","mx-auto"],[1,"max-w-7xl","mx-auto","space-y-6"],[1,"text-[#FF8C00]","font-bold","text-lg"],[1,"text-gray-300","text-sm"],[1,"text-center"],[1,"animate-spin","rounded-full","h-16","w-16","border-t-2","border-b-2","border-[#C8D900]","mx-auto","mb-4"],[1,"text-white","text-lg"],[1,"bg-red-500/10","border","border-red-500","rounded-lg","p-6","text-center"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-16","h-16","text-red-500","mx-auto","mb-4"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"text-xl","font-bold","text-red-500","mb-2"],[1,"text-white"],[1,"bg-white/5","backdrop-blur-sm","border","border-white/10","rounded-lg","p-6"],[1,"text-xl","font-bold","text-white","mb-4"],[1,"grid","grid-cols-1","md:grid-cols-4","gap-4"],[1,"text-gray-400","text-sm","mb-1"],[1,"text-white","font-medium"],[1,"bg-gradient-to-br","from-blue-500","to-blue-600","rounded-lg","p-6","shadow-lg"],[1,"flex","items-center","justify-between","mb-2"],[1,"text-white/80","text-sm","font-medium"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-8","h-8","text-white/60"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"],[1,"text-white","text-4xl","font-bold"],[1,"bg-gradient-to-br","from-red-500","to-red-600","rounded-lg","p-6","shadow-lg"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"],[1,"bg-gradient-to-br","from-purple-500","to-purple-600","rounded-lg","p-6","shadow-lg"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"],[1,"text-white/70","text-xs","mt-1"],[1,"bg-gradient-to-br","from-[#C8D900]","to-[#a0b300]","rounded-lg","p-6","shadow-lg"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"bg-yellow-500/10","border","border-yellow-500","rounded-lg","p-6"],[1,"text-yellow-500","font-bold","text-lg","mb-3","flex","items-center","gap-2"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"text-white","space-y-2"],[1,"text-purple-400"],[1,"bg-white/5","backdrop-blur-sm","border","border-white/10","rounded-lg","overflow-hidden"],[1,"p-6","border-b","border-white/10"],[1,"text-2xl","font-bold","text-white"],[1,"text-gray-300","mt-1"],[1,"overflow-x-auto"],[1,"w-full"],[1,"bg-white/5"],[1,"px-6","py-4","text-left","text-sm","font-semibold","text-white"],[1,"px-6","py-4","text-center","text-sm","font-semibold","text-white"],[1,"divide-y","divide-white/10"],[1,"hover:bg-white/5","transition-colors"],[1,"flex","items-center","justify-between","gap-4"],[1,"px-6","py-3","bg-gray-600","hover:bg-gray-700","text-white","rounded-lg","font-medium","transition-colors",3,"click"],[1,"px-8","py-3","bg-gradient-to-r","from-[#C8D900]","to-[#0098A8]","hover:opacity-90","disabled:opacity-50","disabled:cursor-not-allowed","text-[#10284C]","rounded-lg","font-bold","text-lg","transition-opacity","flex","items-center","gap-2",3,"click","disabled"],[1,"px-6","py-4"],[1,"text-gray-400","text-sm"],[1,"px-6","py-4","text-center"],[1,"text-yellow-500","font-medium"],[1,"text-green-500","font-bold","text-lg"],[1,"inline-flex","items-center","gap-1","px-3","py-1","rounded-full","text-xs","font-medium","bg-purple-500/20","text-purple-400","border","border-purple-500/30"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-3","h-3"],[1,"px-4","py-2","rounded-lg","font-medium","border-2","hover:opacity-80","transition-opacity","min-w-[130px]",3,"click"],[1,"flex","items-center","justify-center","gap-2"],["type","text","placeholder","Observaciones...",1,"w-full","px-3","py-2","bg-white/5","border","border-white/10","rounded-lg","text-white","placeholder-gray-500","focus:outline-none","focus:border-[#C8D900]",3,"ngModelChange","ngModel"],[1,"w-8","h-8","bg-red-500","hover:bg-red-600","disabled:bg-gray-600","disabled:cursor-not-allowed","text-white","rounded-lg","font-bold","transition-colors",3,"click","disabled"],[1,"text-white","font-bold","text-lg","min-w-[40px]","text-center"],[1,"w-8","h-8","bg-green-500","hover:bg-green-600","disabled:bg-gray-600","disabled:cursor-not-allowed","text-white","rounded-lg","font-bold","transition-colors",3,"click","disabled"],[1,"text-gray-500","font-medium"],[1,"animate-spin","rounded-full","h-5","w-5","border-t-2","border-b-2","border-[#10284C]"]],template:function(i,o){i&1&&(t(0,"div",0)(1,"div",1)(2,"button",2),S("click",function(){return o.regresar()}),h(),t(3,"svg",3),p(4,"path",4),e(),x(),t(5,"span",5),n(6,"Volver al Dashboard"),e()(),t(7,"div",6)(8,"div")(9,"h1",7),n(10,"Procesar Devoluci\xF3n"),e(),t(11,"p",8),n(12,"Clasifica productos y env\xEDa a limpieza"),e()(),z(13,ie,5,1,"div",9),e()(),z(14,ne,5,0,"div",10)(15,oe,8,1,"div",11)(16,se,121,14,"div",12),e()),i&2&&(d(13),C(o.kit()?13:-1),d(),C(o.cargando()?14:-1),d(),C(o.error()&&!o.cargando()?15:-1),d(),C(!o.cargando()&&!o.error()&&o.kit()?16:-1))},dependencies:[K,B,X,Z,J,Q],encapsulation:2})};export{Y as TecnicoProcesamDevolucionComponent};
