import{x as N}from"./chunk-V2VKRV3B.js";import{g as O,j as q,p as B,v as G}from"./chunk-3OSVPALZ.js";import{$ as v,Ab as b,Bb as y,Ia as d,Ib as H,Nb as j,Pb as F,S as D,Sa as P,Xa as z,Y as k,Yb as $,Z as w,_ as g,cb as L,ib as E,la as S,lb as T,mb as V,nb as e,ob as t,pb as x,qb as I,tb as h,ub as _,zb as o}from"./chunk-MBDN4FSM.js";import"./chunk-X5YLR3NI.js";import{a as K,i as M}from"./chunk-ODN5LVDJ.js";var Y=()=>[],Z=(a,n)=>n.id;function U(a,n){a&1&&(e(0,"div",9)(1,"div",13),x(2,"div",14),e(3,"p",15),o(4,"Cargando kits listos para aprobaci\xF3n..."),t()()())}function J(a,n){if(a&1&&(e(0,"div",10)(1,"div",16),g(),e(2,"svg",17),x(3,"path",18),t(),v(),e(4,"h3",19),o(5,"Error"),t(),e(6,"p",20),o(7),t()()()),a&2){let i=_();d(7),b(i.error())}}function Q(a,n){a&1&&(e(0,"div",36),g(),e(1,"svg",38),x(2,"path",30),t(),v(),e(3,"h3",39),o(4,"No hay kits pendientes de aprobaci\xF3n"),t(),e(5,"p",40),o(6,"Los kits con productos esterilizados aparecer\xE1n aqu\xED"),t()())}function W(a,n){if(a&1){let i=I();e(0,"div",42),h("click",function(){let r=k(i).$implicit,c=_(3);return w(c.seleccionarKit(r))}),e(1,"div",43)(2,"div")(3,"h3",44),o(4),t(),e(5,"p",45),o(6),j(7,"date"),t()(),e(8,"div",46)(9,"span",47),o(10,"\u2713 ESTERILIZADO"),t()()(),e(11,"div",48)(12,"div",49),g(),e(13,"svg",50),x(14,"path",51),t(),v(),e(15,"p",52),o(16),t()()(),e(17,"div",53)(18,"span",45),o(19),t(),e(20,"button",54),o(21," Revisar y Aprobar \u2192 "),t()()()}if(a&2){let i=n.$implicit;d(4),b(i.numero_kit),d(2),b(F(7,4,i.fecha_inicio_limpieza,"dd/MM/yyyy HH:mm")),d(10),b((i.hospital==null?null:i.hospital.nombre)||"N/A"),d(3),y("",i.productos.length," productos listos")}}function X(a,n){if(a&1&&(e(0,"div",37),T(1,W,22,7,"div",41,Z),t()),a&2){let i=_(2);d(),V(i.kitsListos())}}function ee(a,n){if(a&1&&(e(0,"div",11)(1,"div",21)(2,"div",22)(3,"div",23)(4,"h3",24),o(5,"Kits Listos"),t(),g(),e(6,"svg",25),x(7,"path",26),t()(),v(),e(8,"div",27),o(9),t(),e(10,"p",28),o(11,"Pendientes de aprobaci\xF3n"),t()(),e(12,"div",29)(13,"div",23)(14,"h3",24),o(15,"Productos Esterilizados"),t(),g(),e(16,"svg",25),x(17,"path",30),t()(),v(),e(18,"div",27),o(19),t(),e(20,"p",28),o(21,"Listos para inventario"),t()()(),e(22,"div",31)(23,"h3",32),g(),e(24,"svg",33),x(25,"path",34),t(),o(26," Proceso de Aprobaci\xF3n "),t(),v(),e(27,"div",35)(28,"p")(29,"strong"),o(30,"1."),t(),o(31," Revisa los productos esterilizados y sus observaciones"),t(),e(32,"p")(33,"strong"),o(34,"2."),t(),o(35," Ajusta las cantidades aprobadas si es necesario"),t(),e(36,"p")(37,"strong"),o(38,"3."),t(),o(39," Al aprobar: los productos regresan al inventario y el kit se marca como FINALIZADO"),t(),e(40,"p")(41,"strong"),o(42,"4."),t(),o(43," El ciclo de vida del kit quir\xFArgico est\xE1 completo"),t()()(),z(44,Q,7,0,"div",36)(45,X,3,0,"div",37),t()),a&2){let i=_();d(9),b(i.totalKits()),d(10),b(i.totalProductosListos()),d(25),E(i.kitsListos().length===0?44:-1),d(),E(i.kitsListos().length>0?45:-1)}}function te(a,n){if(a&1&&(e(0,"div",77)(1,"p",84)(2,"strong"),o(3,"Observaciones:"),t(),o(4),t()()),a&2){let i=_().$implicit;d(4),y(" ",i.observaciones_limpieza,"")}}function ie(a,n){if(a&1){let i=I();e(0,"div",70)(1,"div",74)(2,"div",75)(3,"h4",76),o(4),t(),e(5,"p",45),o(6),t()(),e(7,"div",46)(8,"span",47),o(9,"\u2713 Esterilizado"),t()()(),z(10,te,5,1,"div",77),e(11,"div",6)(12,"div",8)(13,"span",78),o(14,"Recuperable:"),t(),e(15,"span",79),o(16),t()(),e(17,"div",80)(18,"span",67),o(19,"Cantidad a Aprobar:"),t(),e(20,"div",49)(21,"button",81),h("click",function(){let r=k(i).$implicit,c=_(2);return w(c.ajustarCantidadAprobada(r,-1))}),o(22," - "),t(),e(23,"span",82),o(24),t(),e(25,"button",83),h("click",function(){let r=k(i).$implicit,c=_(2);return w(c.ajustarCantidadAprobada(r,1))}),o(26," + "),t()()()()()}if(a&2){let i=n.$implicit;d(4),b(i.producto_nombre),d(2),b(i.producto_codigo),d(4),E(i.observaciones_limpieza?10:-1),d(6),b(i.cantidad_a_recuperar),d(5),L("disabled",i.cantidad_aprobada<=0),d(3),y(" ",i.cantidad_aprobada," "),d(),L("disabled",i.cantidad_aprobada>=i.cantidad_a_recuperar)}}function oe(a,n){a&1&&(x(0,"div",85),e(1,"span"),o(2,"Procesando..."),t())}function ne(a,n){a&1&&(g(),e(0,"svg",33),x(1,"path",30),t(),v(),e(2,"span"),o(3,"Aprobar y Finalizar Kit"),t())}function re(a,n){if(a&1){let i=I();e(0,"div",55),h("click",function(){k(i);let r=_();return w(r.cerrarDetalle())}),e(1,"div",56),h("click",function(r){return k(i),w(r.stopPropagation())}),e(2,"div",57)(3,"div",6)(4,"div")(5,"h2",58),o(6),t(),e(7,"p",59),o(8,"Revisar productos y actualizar inventario"),t()(),e(9,"button",60),h("click",function(){k(i);let r=_();return w(r.cerrarDetalle())}),g(),e(10,"svg",61),x(11,"path",62),t()()()(),v(),e(12,"div",63)(13,"div",64)(14,"div",65)(15,"div")(16,"div",66),o(17,"Hospital"),t(),e(18,"div",67),o(19),t()(),e(20,"div")(21,"div",66),o(22,"M\xE9dico"),t(),e(23,"div",67),o(24),t()(),e(25,"div")(26,"div",66),o(27,"Inicio Limpieza"),t(),e(28,"div",67),o(29),j(30,"date"),t()()()(),e(31,"div",68)(32,"h3",69),o(33,"Productos Esterilizados"),t(),T(34,ie,27,7,"div",70,Z),t()(),e(36,"div",71)(37,"button",72),h("click",function(){k(i);let r=_();return w(r.cerrarDetalle())}),o(38," Cancelar "),t(),e(39,"button",73),h("click",function(){k(i);let r=_();return w(r.aprobarYFinalizarKit())}),z(40,oe,3,0)(41,ne,4,0),t()()()()}if(a&2){let i,l,r,c,m,p=_();d(6),y("Aprobar Kit ",(i=p.kitSeleccionado())==null?null:i.numero_kit,""),d(13),b(((l=p.kitSeleccionado())==null||l.hospital==null?null:l.hospital.nombre)||"N/A"),d(5),b(((r=p.kitSeleccionado())==null?null:r.medico_cirujano)||"N/A"),d(5),b(F(30,6,(c=p.kitSeleccionado())==null?null:c.fecha_inicio_limpieza,"dd/MM/yyyy HH:mm")),d(5),V(((m=p.kitSeleccionado())==null?null:m.productos)||H(9,Y)),d(5),L("disabled",p.procesando()),d(),E(p.procesando()?40:41)}}var R=class a{supabaseService=D(G);router=D(B);kitsListos=S([]);kitSeleccionado=S(null);cargando=S(!0);procesando=S(!1);error=S("");usuarioId=S("");totalKits=$(()=>this.kitsListos().length);totalProductosListos=$(()=>this.kitsListos().reduce((n,i)=>n+i.productos.filter(l=>l.estado_limpieza==="esterilizado").length,0));Math=Math;ngOnInit(){this.cargarDatos()}cargarDatos(){return M(this,null,function*(){try{this.cargando.set(!0),this.error.set("");let n=this.supabaseService.supabaseClient,{data:{user:i}}=yield n.auth.getUser();i&&this.usuarioId.set(i.id);let{data:l,error:r}=yield n.from("kits_cirugia").select(`
          id,
          numero_kit,
          cirugia_id,
          estado,
          fecha_inicio_limpieza,
          cirugias!inner(
            id,
            medico_cirujano,
            hospitales(nombre),
            clientes(nombre, apellido)
          )
        `).eq("estado","en_limpieza").order("fecha_inicio_limpieza",{ascending:!0});if(r)throw r;let c=[];for(let m of l||[]){let p=m.cirugias,{data:s,error:f}=yield n.from("kit_productos_limpieza").select(`
            id,
            kit_producto_id,
            producto_id,
            cantidad_a_recuperar,
            cantidad_aprobada,
            estado_limpieza,
            observaciones_limpieza,
            productos!inner(
              nombre,
              codigo
            )
          `).eq("kit_id",m.id).eq("estado_limpieza","esterilizado");if(f){console.error("Error cargando productos:",f);continue}if(s&&s.length>0){let A=s.map(u=>({id:u.id,kit_producto_id:u.kit_producto_id,producto_id:u.producto_id,producto_nombre:u.productos.nombre,producto_codigo:u.productos.codigo,cantidad_a_recuperar:u.cantidad_a_recuperar||0,cantidad_aprobada:u.cantidad_aprobada||u.cantidad_a_recuperar||0,estado_limpieza:u.estado_limpieza,observaciones_limpieza:u.observaciones_limpieza||""}));c.push({id:m.id,numero_kit:m.numero_kit,cirugia_id:m.cirugia_id,fecha_inicio_limpieza:m.fecha_inicio_limpieza,estado:m.estado,hospital:p?.hospitales,medico_cirujano:p?.medico_cirujano,cliente:p?.clientes,productos:A})}}this.kitsListos.set(c)}catch(n){console.error("Error al cargar datos:",n),this.error.set(n.message||"Error al cargar los datos")}finally{this.cargando.set(!1)}})}seleccionarKit(n){this.kitSeleccionado.set(n)}cerrarDetalle(){this.kitSeleccionado.set(null)}ajustarCantidadAprobada(n,i){let l=this.kitSeleccionado();if(!l)return;let r=l.productos.findIndex(c=>c.id===n.id);if(r!==-1){let c=Math.max(0,Math.min(n.cantidad_a_recuperar,n.cantidad_aprobada+i));l.productos[r].cantidad_aprobada=c,this.kitSeleccionado.set(K({},l))}}aprobarYFinalizarKit(){return M(this,null,function*(){let n=this.kitSeleccionado();if(!n||this.procesando())return;let i=n.productos.reduce((r,c)=>r+c.cantidad_aprobada,0);if(confirm(`\xBFConfirmar aprobaci\xF3n y finalizaci\xF3n del kit?

Kit: ${n.numero_kit}
Productos aprobados: ${n.productos.length}
Cantidad total a recuperar: ${i}

Esto actualizar\xE1 el inventario y marcar\xE1 el kit como FINALIZADO.`))try{this.procesando.set(!0),this.error.set("");let r=this.supabaseService.supabaseClient,c=[];for(let s of n.productos){let{error:f}=yield r.from("kit_productos_limpieza").update({estado_limpieza:"aprobado",cantidad_aprobada:s.cantidad_aprobada,aprobado_por:this.usuarioId(),fecha_aprobacion:new Date().toISOString()}).eq("id",s.id);f&&(console.error("Error actualizando producto limpieza:",f),c.push(`Error en ${s.producto_nombre}`))}for(let s of n.productos)if(s.cantidad_aprobada>0){let{data:f,error:A}=yield r.from("inventario").select("id, cantidad").eq("producto_id",s.producto_id).eq("estado","disponible").maybeSingle();if(A){console.error("Error buscando inventario:",A),c.push(`Error buscando inventario para ${s.producto_nombre}`);continue}if(f){let{error:C}=yield r.from("inventario").update({cantidad:f.cantidad+s.cantidad_aprobada,updated_at:new Date().toISOString()}).eq("id",f.id);C&&(console.error("Error actualizando inventario:",C),c.push(`Error actualizando inventario de ${s.producto_nombre}`))}else{let{error:C}=yield r.from("inventario").insert({producto_id:s.producto_id,cantidad:s.cantidad_aprobada,ubicacion:"BODEGA_PRINCIPAL",estado:"disponible",fecha_vencimiento:null});C&&(console.error("Error creando inventario:",C),c.push(`Error creando inventario para ${s.producto_nombre}`))}let{error:u}=yield r.from("movimientos_inventario").insert({producto_id:s.producto_id,tipo:"entrada",cantidad:s.cantidad_aprobada,motivo:`Recuperaci\xF3n de kit ${n.numero_kit} - Limpieza aprobada`,usuario_id:this.usuarioId(),fecha:new Date().toISOString()});u&&console.error("Error registrando movimiento:",u)}let{error:m}=yield r.from("kits_cirugia").update({estado:"finalizado",fecha_fin_limpieza:new Date().toISOString(),limpieza_aprobada_por:this.usuarioId(),fecha_aprobacion_limpieza:new Date().toISOString()}).eq("id",n.id);m&&(console.error("Error finalizando kit:",m),c.push("Error al finalizar el kit"));let{error:p}=yield r.from("cirugia_trazabilidad").insert({cirugia_id:n.cirugia_id,accion:"limpieza_aprobada_kit_finalizado",descripcion:`Kit ${n.numero_kit} finalizado. ${n.productos.length} productos aprobados, ${i} unidades recuperadas e ingresadas al inventario.`,realizado_por:this.usuarioId(),metadata:{kit_id:n.id,total_productos:n.productos.length,cantidad_recuperada:i,productos:n.productos.map(s=>({nombre:s.producto_nombre,codigo:s.producto_codigo,cantidad_aprobada:s.cantidad_aprobada}))}});p&&console.error("Error en trazabilidad:",p),c.length>0?alert(`\u26A0\uFE0F Kit procesado con algunos errores:

`+c.join(`
`)+`

Revise los logs para m\xE1s detalles.`):alert(`\u2705 Kit finalizado exitosamente

Kit ${n.numero_kit} ha sido marcado como FINALIZADO.
${i} productos han sido recuperados y agregados al inventario.

El ciclo de vida del kit est\xE1 completo.`),this.cerrarDetalle(),yield this.cargarDatos()}catch(r){console.error("Error al aprobar kit:",r),this.error.set(r.message||"Error al aprobar el kit"),alert("\u274C Error al procesar la aprobaci\xF3n")}finally{this.procesando.set(!1)}})}regresar(){this.router.navigate(["/internal"])}static \u0275fac=function(i){return new(i||a)};static \u0275cmp=P({type:a,selectors:[["app-aprobacion-limpieza"]],decls:17,vars:4,consts:[[1,"min-h-screen","bg-gradient-to-br","from-[#10284C]","via-[#0d1f3a]","to-[#0a1829]","p-6"],[1,"max-w-7xl","mx-auto","mb-8"],[1,"mb-6","flex","items-center","gap-2","text-white","hover:text-[#C8D900]","transition-colors",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M15 19l-7-7 7-7"],[1,"font-medium"],[1,"flex","items-center","justify-between"],[1,"text-4xl","font-bold","text-white","mb-2"],[1,"text-gray-300"],[1,"flex","items-center","justify-center","py-20"],[1,"max-w-7xl","mx-auto"],[1,"max-w-7xl","mx-auto","space-y-6"],[1,"fixed","inset-0","bg-black/70","backdrop-blur-sm","flex","items-center","justify-center","p-6","z-50"],[1,"text-center"],[1,"animate-spin","rounded-full","h-16","w-16","border-t-2","border-b-2","border-[#C8D900]","mx-auto","mb-4"],[1,"text-white","text-lg"],[1,"bg-red-500/10","border","border-red-500","rounded-lg","p-6","text-center"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-16","h-16","text-red-500","mx-auto","mb-4"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"text-xl","font-bold","text-red-500","mb-2"],[1,"text-white"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-6"],[1,"bg-gradient-to-br","from-purple-500","to-purple-600","rounded-lg","p-6","shadow-lg"],[1,"flex","items-center","justify-between","mb-2"],[1,"text-white/80","text-sm","font-medium"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-8","h-8","text-white/60"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"],[1,"text-white","text-4xl","font-bold"],[1,"text-white/70","text-sm","mt-2"],[1,"bg-gradient-to-br","from-green-500","to-green-600","rounded-lg","p-6","shadow-lg"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"bg-blue-500/10","border","border-blue-500","rounded-lg","p-6"],[1,"text-blue-300","font-bold","text-lg","mb-3","flex","items-center","gap-2"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"text-white","space-y-2"],[1,"bg-white/5","backdrop-blur-sm","border","border-white/10","rounded-lg","p-12","text-center"],[1,"grid","grid-cols-1","lg:grid-cols-2","gap-6"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-24","h-24","text-gray-500","mx-auto","mb-4"],[1,"text-2xl","font-bold","text-white","mb-2"],[1,"text-gray-400"],[1,"bg-white/5","backdrop-blur-sm","border","border-white/10","rounded-lg","p-6","hover:border-[#C8D900]","transition-colors","cursor-pointer"],[1,"bg-white/5","backdrop-blur-sm","border","border-white/10","rounded-lg","p-6","hover:border-[#C8D900]","transition-colors","cursor-pointer",3,"click"],[1,"flex","items-center","justify-between","mb-4"],[1,"text-xl","font-bold","text-white"],[1,"text-gray-400","text-sm"],[1,"bg-green-500/20","border","border-green-500","rounded-lg","px-3","py-1"],[1,"text-green-300","font-medium","text-sm"],[1,"space-y-2","mb-4"],[1,"flex","items-center","gap-2"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4","text-gray-400"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"],[1,"text-gray-300","text-sm"],[1,"flex","items-center","justify-between","pt-4","border-t","border-white/10"],[1,"text-[#C8D900]","hover:text-[#a0b300]","font-medium","text-sm","transition-colors"],[1,"fixed","inset-0","bg-black/70","backdrop-blur-sm","flex","items-center","justify-center","p-6","z-50",3,"click"],[1,"bg-[#10284C]","border","border-white/20","rounded-xl","max-w-5xl","w-full","max-h-[90vh]","overflow-hidden",3,"click"],[1,"bg-gradient-to-r","from-purple-600","to-green-600","p-6","border-b","border-white/20"],[1,"text-2xl","font-bold","text-white","mb-1"],[1,"text-gray-200"],[1,"text-white","hover:text-gray-300","transition-colors",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-8","h-8"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M6 18L18 6M6 6l12 12"],[1,"p-6","overflow-y-auto","max-h-[calc(90vh-200px)]"],[1,"bg-white/5","rounded-lg","p-4","mb-6"],[1,"grid","grid-cols-3","gap-4"],[1,"text-gray-400","text-sm","mb-1"],[1,"text-white","font-medium"],[1,"space-y-4","mb-6"],[1,"text-xl","font-bold","text-white","mb-4"],[1,"bg-white/5","border","border-white/10","rounded-lg","p-4"],[1,"bg-white/5","border-t","border-white/10","p-6","flex","items-center","justify-between"],[1,"px-6","py-3","bg-gray-600","hover:bg-gray-700","text-white","rounded-lg","font-medium","transition-colors",3,"click"],[1,"px-8","py-3","bg-gradient-to-r","from-green-500","to-purple-600","hover:opacity-90","disabled:opacity-50","disabled:cursor-not-allowed","text-white","rounded-lg","font-bold","text-lg","transition-opacity","flex","items-center","gap-2",3,"click","disabled"],[1,"flex","items-center","justify-between","mb-3"],[1,"flex-1"],[1,"text-white","font-bold"],[1,"bg-blue-500/10","border","border-blue-500/30","rounded","p-2","mb-3"],[1,"text-sm"],[1,"font-bold","ml-2"],[1,"flex","items-center","gap-4"],[1,"w-8","h-8","bg-red-500","hover:bg-red-600","disabled:bg-gray-600","disabled:cursor-not-allowed","text-white","rounded-lg","font-bold","transition-colors",3,"click","disabled"],[1,"text-[#C8D900]","font-bold","text-xl","min-w-[40px]","text-center"],[1,"w-8","h-8","bg-green-500","hover:bg-green-600","disabled:bg-gray-600","disabled:cursor-not-allowed","text-white","rounded-lg","font-bold","transition-colors",3,"click","disabled"],[1,"text-blue-200","text-sm"],[1,"animate-spin","rounded-full","h-5","w-5","border-t-2","border-b-2","border-white"]],template:function(i,l){i&1&&(e(0,"div",0)(1,"div",1)(2,"button",2),h("click",function(){return l.regresar()}),g(),e(3,"svg",3),x(4,"path",4),t(),v(),e(5,"span",5),o(6,"Volver al Dashboard"),t()(),e(7,"div",6)(8,"div")(9,"h1",7),o(10,"Aprobaci\xF3n y Finalizaci\xF3n"),t(),e(11,"p",8),o(12,"Aprobar kits limpios y actualizar inventario"),t()()()(),z(13,U,5,0,"div",9)(14,J,8,1,"div",10)(15,ee,46,4,"div",11)(16,re,42,10,"div",12),t()),i&2&&(d(13),E(l.cargando()?13:-1),d(),E(l.error()&&!l.cargando()?14:-1),d(),E(!l.cargando()&&!l.error()?15:-1),d(),E(l.kitSeleccionado()?16:-1))},dependencies:[q,O,N],encapsulation:2})};export{R as AprobacionLimpiezaComponent};
