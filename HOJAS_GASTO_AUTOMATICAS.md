# GENERACI√ìN AUTOM√ÅTICA DE HOJAS DE GASTO

## üìã Descripci√≥n General

Al finalizar una cirug√≠a, el sistema ahora crea autom√°ticamente una **Hoja de Gasto** pre-poblada con todos los productos que fueron realmente utilizados durante el procedimiento quir√∫rgico.

---

## üéØ Objetivo

- **Automatizar** la creaci√≥n de hojas de gasto basadas en consumo real
- **Eliminar** la necesidad de transcripci√≥n manual de productos utilizados
- **Facilitar** el trabajo del operador log√≠stico, quien solo necesita agregar gastos adicionales (transporte, etc.)
- **Garantizar** que solo los productos efectivamente consumidos se facturen

---

## ‚ö° Flujo de Trabajo

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    EJECUCI√ìN DE CIRUG√çA                          ‚îÇ
‚îÇ  - T√©cnico registra consumo en tiempo real                      ‚îÇ
‚îÇ  - cantidad_utilizada se actualiza por cada producto            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ             T√âCNICO: Finalizar Cirug√≠a (Bot√≥n)                  ‚îÇ
‚îÇ  - Confirma que la cirug√≠a ha terminado                         ‚îÇ
‚îÇ  - Sistema pregunta: "¬øFinalizar cirug√≠a?"                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    PROCESO AUTOM√ÅTICO                            ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  1Ô∏è‚É£ Cirug√≠a ‚Üí estado: 'completada'                               ‚îÇ
‚îÇ  2Ô∏è‚É£ Kit ‚Üí estado: 'devuelto'                                     ‚îÇ
‚îÇ  3Ô∏è‚É£ ‚≠ê CREAR HOJA DE GASTO AUTOM√ÅTICA ‚≠ê                          ‚îÇ
‚îÇ     ‚Ä¢ Filtrar productos con cantidad_utilizada > 0              ‚îÇ
‚îÇ     ‚Ä¢ Obtener precio de cada producto desde BD                  ‚îÇ
‚îÇ     ‚Ä¢ Crear hoja_gasto con estado: 'borrador'                   ‚îÇ
‚îÇ     ‚Ä¢ Insertar hoja_gasto_items (categor√≠a: 'productos')        ‚îÇ
‚îÇ  4Ô∏è‚É£ Registrar trazabilidad                                       ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          OPERADOR LOG√çSTICO: Completar Hoja de Gasto            ‚îÇ
‚îÇ  - Ve hoja de gasto en estado 'borrador'                        ‚îÇ
‚îÇ  - Productos utilizados ya est√°n registrados ‚úÖ                  ‚îÇ
‚îÇ  - Agrega gastos adicionales:                                   ‚îÇ
‚îÇ    * Transporte (categoria: 'transporte')                       ‚îÇ
‚îÇ    * Otros gastos (categoria: 'otros')                          ‚îÇ
‚îÇ  - Cambia estado a 'revision' cuando est√© completa              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              SUPERVISOR: Aprobar Hoja de Gasto                  ‚îÇ
‚îÇ  - Revisa todos los √≠tems                                       ‚îÇ
‚îÇ  - Cambia estado a 'aprobada'                                   ‚îÇ
‚îÇ  - Lista para facturaci√≥n                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üíª Implementaci√≥n T√©cnica

### Ubicaci√≥n del C√≥digo
**Archivo**: `cirugia-ejecucion.component.ts`  
**Funci√≥n**: `finalizarCirugia()`

### Imports Necesarios
```typescript
import { HojaGastoService } from '../../hojas-gasto/data-access/hoja-gasto.service';
import { CreateHojaGastoRequest, HojaGastoItem } from '../../hojas-gasto/data-access/hoja-gasto.model';
```

### Inyecci√≥n del Servicio
```typescript
private hojaGastoService = inject(HojaGastoService);
```

### L√≥gica Principal

#### 1. Filtrar Productos Utilizados
```typescript
const productosUtilizados = this.productos().filter(p => p.cantidad_utilizada > 0);
```

**Regla de Negocio**: Solo productos con `cantidad_utilizada > 0` se incluyen en la hoja de gasto.

#### 2. Obtener Precios desde Base de Datos
```typescript
const productosConPrecio: Omit<HojaGastoItem, 'hoja_gasto_id'>[] = await Promise.all(
  productosUtilizados.map(async (producto) => {
    const { data: productoData } = await this.supabase.client
      .from('productos')
      .select('precio')
      .eq('id', producto.producto_id)
      .single();

    const precio = productoData?.precio || 0;
    
    return {
      producto_id: producto.producto_id,
      categoria: 'productos' as const,
      descripcion: `${producto.nombre} (${producto.codigo})`,
      cantidad: producto.cantidad_utilizada,
      precio_unitario: precio,
      precio_total: precio * producto.cantidad_utilizada,
      observaciones: `Lote: ${producto.lote || 'N/A'}${producto.fecha_vencimiento ? ' - Venc: ' + producto.fecha_vencimiento : ''}`
    };
  })
);
```

**Caracter√≠sticas**:
- Consulta precio actual del producto en la tabla `productos`
- Calcula `precio_total = precio_unitario * cantidad`
- Incluye informaci√≥n de lote y fecha de vencimiento en observaciones

#### 3. Crear Request de Hoja de Gasto
```typescript
const createHojaGastoRequest: CreateHojaGastoRequest = {
  cirugia_id: cirugia.id,
  tecnico_id: currentUserId,
  fecha_cirugia: new Date(cirugia.fecha_programada).toISOString().split('T')[0],
  observaciones: `Hoja de gasto generada autom√°ticamente al finalizar la cirug√≠a ${cirugia.numero_cirugia}`,
  items: productosConPrecio as HojaGastoItem[]
};
```

#### 4. Llamar al Servicio (Observable)
```typescript
this.hojaGastoService.createHojaGasto(createHojaGastoRequest).subscribe({
  next: (hojaCreada) => {
    console.log('‚úÖ Hoja de gasto creada autom√°ticamente:', hojaCreada);
  },
  error: (error) => {
    console.error('‚ö†Ô∏è Error al crear hoja de gasto autom√°tica:', error);
    // No detenemos el proceso por un error en la hoja de gasto
  }
});
```

**Nota Importante**: La creaci√≥n de la hoja de gasto no es bloqueante. Si falla, la cirug√≠a se marca como completada de todos modos.

---

## üìä Estructura de la Hoja de Gasto Creada

### Tabla: `hojas_gasto`

| Campo | Valor |
|-------|-------|
| `numero_hoja` | Auto-generado (ej: "HG-2025-001") |
| `cirugia_id` | ID de la cirug√≠a |
| `tecnico_id` | ID del usuario que finaliz√≥ la cirug√≠a |
| `fecha_cirugia` | Fecha programada de la cirug√≠a |
| `estado` | `'borrador'` |
| `total_productos` | Suma de precios de productos utilizados |
| `total_transporte` | `0` (se completar√° por log√≠stica) |
| `total_otros` | `0` (se completar√° por log√≠stica) |
| `total_general` | `total_productos` (se actualizar√°) |
| `observaciones` | "Hoja de gasto generada autom√°ticamente..." |

### Tabla: `hoja_gasto_items`

Para cada producto utilizado:

| Campo | Valor |
|-------|-------|
| `hoja_gasto_id` | ID de la hoja creada |
| `producto_id` | ID del producto |
| `categoria` | `'productos'` |
| `descripcion` | "Nombre del Producto (CODIGO)" |
| `cantidad` | `cantidad_utilizada` |
| `precio_unitario` | Precio desde tabla `productos` |
| `precio_total` | `cantidad * precio_unitario` |
| `observaciones` | "Lote: XXX - Venc: YYYY-MM-DD" |

---

## üé® Mensaje al Usuario

Cuando la cirug√≠a se finaliza exitosamente:

```
‚úÖ Cirug√≠a finalizada correctamente

üìã Hoja de gasto creada autom√°ticamente con 5 producto(s) utilizado(s)

üì¶ Pr√≥ximos pasos:
1. Validar devoluci√≥n del kit
2. Separar productos usados/sin usar
3. Enviar productos reutilizables a limpieza/esterilizaci√≥n
4. Actualizar inventario

El personal log√≠stico puede agregar gastos adicionales (transporte, etc.) 
en el m√≥dulo de Hojas de Gasto.
```

---

## üîç Validaciones y Casos Especiales

### Caso 1: No hay productos utilizados
```typescript
if (productosUtilizados.length > 0) {
  // Crear hoja de gasto
} else {
  console.log('‚ö†Ô∏è No hay productos utilizados, no se crear√° hoja de gasto');
}
```

**Resultado**: No se crea hoja de gasto si todos los productos tienen `cantidad_utilizada = 0`.

### Caso 2: Error al crear hoja de gasto
```typescript
error: (error) => {
  console.error('‚ö†Ô∏è Error al crear hoja de gasto autom√°tica:', error);
  // No detenemos el proceso por un error en la hoja de gasto
}
```

**Resultado**: La cirug√≠a se completa exitosamente aunque falle la creaci√≥n de la hoja. Se registra el error en consola.

### Caso 3: Ya existe hoja de gasto para la cirug√≠a

El servicio `HojaGastoService` valida esto autom√°ticamente:

```typescript
const { data: existingHoja, error: checkError } = await this.supabase.client
  .from('hojas_gasto')
  .select('id, numero_hoja, estado')
  .eq('cirugia_id', request.cirugia_id)
  .limit(1);

if (existingHoja && existingHoja.length > 0) {
  throw new Error(`Ya existe una hoja de gasto (${hojaExistente.numero_hoja}) para esta cirug√≠a.`);
}
```

**Resultado**: No se permite crear hojas de gasto duplicadas para la misma cirug√≠a.

---

## üìà Trazabilidad

Se registra en `cirugia_trazabilidad`:

```typescript
{
  cirugia_id: cirugia.id,
  accion: 'finalizacion_cirugia',
  estado_anterior: 'en_curso',
  estado_nuevo: 'completada',
  usuario_id: currentUserId,
  observaciones: `Cirug√≠a finalizada - Kit listo para devoluci√≥n - Hoja de gasto creada autom√°ticamente con ${productosUtilizados.length} productos utilizados`,
  metadata: {
    kit_id: cirugia.kit.id,
    productos_utilizados: this.productosUtilizados(),
    total_productos: this.totalProductos(),
    hoja_gasto_creada: productosUtilizados.length > 0 // ‚≠ê Nuevo campo
  }
}
```

---

## üéØ Beneficios

### Para el T√©cnico Quir√∫rgico
‚úÖ No necesita crear manualmente la hoja de gasto  
‚úÖ Proceso de finalizaci√≥n m√°s r√°pido  
‚úÖ Menos posibilidad de olvidos

### Para el Operador Log√≠stico
‚úÖ Recibe hoja pre-poblada con productos utilizados  
‚úÖ Solo necesita agregar gastos de transporte y otros  
‚úÖ Informaci√≥n de lote y vencimiento ya incluida  
‚úÖ Precios actualizados autom√°ticamente

### Para la Organizaci√≥n
‚úÖ Registro preciso del consumo real  
‚úÖ Trazabilidad completa desde cirug√≠a hasta facturaci√≥n  
‚úÖ Reducci√≥n de errores de transcripci√≥n  
‚úÖ Aceleraci√≥n del proceso de facturaci√≥n

---

## üß™ Testing Checklist

- [ ] **Caso 1**: Cirug√≠a con 5 productos utilizados ‚Üí Hoja de gasto con 5 √≠tems
- [ ] **Caso 2**: Cirug√≠a con 0 productos utilizados ‚Üí No se crea hoja de gasto
- [ ] **Caso 3**: Cirug√≠a con productos mixtos (3 usados, 2 sin usar) ‚Üí Hoja con 3 √≠tems
- [ ] **Caso 4**: Verificar que precios se obtienen correctamente desde tabla `productos`
- [ ] **Caso 5**: Verificar c√°lculo correcto de `precio_total`
- [ ] **Caso 6**: Verificar que observaciones incluyen lote y fecha de vencimiento
- [ ] **Caso 7**: Verificar que hoja se crea con estado `'borrador'`
- [ ] **Caso 8**: Verificar que `total_productos` se calcula correctamente
- [ ] **Caso 9**: Intentar finalizar la misma cirug√≠a dos veces ‚Üí Error de duplicaci√≥n
- [ ] **Caso 10**: Verificar que error en hoja de gasto no detiene finalizaci√≥n de cirug√≠a
- [ ] **Caso 11**: Log√≠stica puede agregar items de transporte a la hoja creada
- [ ] **Caso 12**: Trazabilidad registra `hoja_gasto_creada: true/false`

---

## üîó Archivos Modificados

### TypeScript:
- **`cirugia-ejecucion.component.ts`**
  - Imports: `HojaGastoService`, `CreateHojaGastoRequest`, `HojaGastoItem`
  - Inyecci√≥n: `private hojaGastoService = inject(HojaGastoService)`
  - Funci√≥n modificada: `finalizarCirugia()` - Agrega l√≥gica de creaci√≥n autom√°tica

### Sin cambios en:
- HTML (la UI ya existente funciona correctamente)
- Modelos (se reutilizan los existentes)
- Servicios de hojas de gasto (funcionan sin modificaci√≥n)

---

## üìã Pr√≥ximos Pasos Sugeridos

1. **Notificaciones**: Agregar notificaci√≥n al operador log√≠stico cuando se crea una nueva hoja de gasto
2. **Dashboard**: Mostrar hojas de gasto en estado "borrador" en un widget del dashboard log√≠stico
3. **Reportes**: Incluir estad√≠sticas de hojas de gasto generadas autom√°ticamente vs manuales
4. **Validaciones**: Agregar regla de negocio que no permita finalizar cirug√≠a sin registrar al menos 1 producto utilizado (si es necesario)

---

**Fecha de Implementaci√≥n**: Enero 2025  
**Versi√≥n**: FASE 4 - Ejecuci√≥n Quir√∫rgica con Hojas de Gasto Autom√°ticas  
**Estado**: ‚úÖ Implementado y Listo para Testing
