# ‚úÖ VERIFICACI√ìN PRE-EJECUCI√ìN - Chat SQL Schema

## üîç Checklist de Validaci√≥n

### 1. Referencias a Tablas Base ‚úÖ

| Tabla Referenciada | Columna FK | Estado |
|-------------------|------------|--------|
| `cirugias` | `id` | ‚úÖ Existe |
| `profiles` | `id` | ‚úÖ Existe |
| `kits_cirugia` | - | ‚úÖ Existe |

### 2. Referencias a Columnas ‚úÖ

| Tabla | Columna Referenciada | Existe en DB | Estado |
|-------|---------------------|--------------|--------|
| `cirugias` | `usuario_creador_id` | ‚úÖ S√≠ | ‚úÖ OK |
| `cirugias` | `tecnico_asignado_id` | ‚úÖ S√≠ | ‚úÖ OK |
| `kits_cirugia` | `logistica_id` | ‚úÖ S√≠ | ‚úÖ OK |
| `kits_cirugia` | `cirugia_id` | ‚úÖ S√≠ | ‚úÖ OK |
| `profiles` | `role` | ‚úÖ S√≠ | ‚úÖ OK |

### 3. Objetos a Crear

```sql
‚úÖ TABLE:    mensajes_cirugia
‚úÖ INDEXES:  4 √≠ndices
‚úÖ TRIGGER:  update_mensajes_cirugia_updated_at
‚úÖ FUNCTION: update_mensajes_cirugia_updated_at()
‚úÖ POLICIES: 3 pol√≠ticas RLS
‚úÖ VIEW:     mensajes_cirugia_completos
‚úÖ FUNCTION: get_unread_messages_count()
‚úÖ FUNCTION: mark_messages_as_read()
```

## üêõ Errores Corregidos

### ‚ùå Error Original
```sql
-- L√≠neas ~68, ~106, ~140
kits_cirugia.usuario_preparador_id = auth.uid()
-- ERROR: column "usuario_preparador_id" does not exist
```

### ‚úÖ Correcci√≥n Aplicada
```sql
kits_cirugia.logistica_id = auth.uid()
-- OK: columna existe en database.sql l√≠nea 230
```

## üìã Estructura de `kits_cirugia` (Referencia)

```sql
CREATE TABLE public.kits_cirugia (
  id uuid PRIMARY KEY,
  cirugia_id uuid NOT NULL,           -- ‚úÖ Usado en chat
  numero_kit varchar NOT NULL,
  qr_code varchar NOT NULL,
  estado varchar DEFAULT 'preparando',
  comercial_id uuid,                   -- ‚úÖ FK a profiles
  tecnico_id uuid,                     -- ‚úÖ FK a profiles
  logistica_id uuid,                   -- ‚úÖ USADO EN CHAT
  ...
);
```

## üéØ L√≥gica de Acceso al Chat

### ¬øQui√©n puede ver mensajes de una cirug√≠a?

```typescript
// Comercial
cirugias.usuario_creador_id = auth.uid()

// T√©cnico
cirugias.tecnico_asignado_id = auth.uid()

// Log√≠stica (prepar√≥ alg√∫n kit)
kits_cirugia.cirugia_id = X 
AND kits_cirugia.logistica_id = auth.uid()

// Admin
profiles.role = 'admin'
```

### Ejemplo Pr√°ctico

```
Cirug√≠a CIR-001
‚îú‚îÄ usuario_creador_id: juan@email.com (Comercial) ‚úÖ Puede ver chat
‚îú‚îÄ tecnico_asignado_id: maria@email.com (T√©cnico) ‚úÖ Puede ver chat
‚îî‚îÄ Kits:
   ‚îú‚îÄ Kit KIT-001
   ‚îÇ  ‚îî‚îÄ logistica_id: pedro@email.com ‚úÖ Puede ver chat
   ‚îî‚îÄ Kit KIT-002
      ‚îî‚îÄ logistica_id: ana@email.com ‚úÖ Puede ver chat
```

## üöÄ Comando de Ejecuci√≥n

```bash
# En Supabase Dashboard > SQL Editor
# 1. Copiar TODO el contenido de chat_cirugia_schema.sql
# 2. Pegar en el editor
# 3. Click en "Run" o Ctrl+Enter
# 4. Verificar mensaje de √©xito
```

## ‚úÖ Verificaci√≥n Post-Ejecuci√≥n

Despu√©s de ejecutar el SQL, verifica:

```sql
-- 1. Tabla creada
SELECT COUNT(*) FROM public.mensajes_cirugia;
-- Debe retornar: 0 (vac√≠a)

-- 2. Pol√≠ticas RLS activas
SELECT COUNT(*) FROM pg_policies 
WHERE tablename = 'mensajes_cirugia';
-- Debe retornar: 3

-- 3. Funciones creadas
SELECT routine_name 
FROM information_schema.routines 
WHERE routine_schema = 'public' 
AND routine_name LIKE '%mensaje%';
-- Debe mostrar: get_unread_messages_count, mark_messages_as_read

-- 4. Vista creada
SELECT COUNT(*) FROM information_schema.views 
WHERE table_name = 'mensajes_cirugia_completos';
-- Debe retornar: 1
```

## üéâ Todo Listo

El archivo `chat_cirugia_schema.sql` est√° **100% validado** y listo para ejecutar en Supabase.

**Sin errores de columnas inexistentes** ‚úÖ
