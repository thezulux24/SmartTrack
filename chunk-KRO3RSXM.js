import"./chunk-IUIUXTL6.js";import{a as U}from"./chunk-UWG3XYI3.js";import{a as W,c as J,g as K,v as Q}from"./chunk-EAN4GLH2.js";import{a as P}from"./chunk-KXFMV5OZ.js";import{$ as g,Ba as B,Da as O,E as x,F as M,Fa as R,G as r,J as j,Ja as G,N as p,Q as V,T as $,U as c,X as w,Y as S,Z as n,_ as a,aa as y,b as k,ba as T,ca as l,ea as o,fa as u,ga as m,ha as A,ja as N,ka as H,la as q,pa as E,q as F,qa as z,u as C,w as v,x as f,y as b,z as h}from"./chunk-6SF67QVY.js";import"./chunk-LJ5XHLMQ.js";import{h as D}from"./chunk-FK42CRUA.js";var X=class t{scanResult=new k(null);isScanning=new k(!1);scanResult$=this.scanResult.asObservable();isScanning$=this.isScanning.asObservable();constructor(){}generarQrString(i){return JSON.stringify(i)}iniciarEscaneo(){this.isScanning.next(!0)}detenerEscaneo(){this.isScanning.next(!1)}procesarEscaneo(i){this.scanResult.next(i),this.detenerEscaneo()}limpiarResultado(){this.scanResult.next(null)}validarQrKit(i){return i.startsWith("KIT-")&&i.length>10}extraerInfoQr(i){try{if(i.startsWith("KIT-")){let d=i.split("-");return{tipo:"kit",timestamp:parseInt(d[1]),id:d[2]}}return JSON.parse(i)}catch{return{tipo:"unknown"}}}static \u0275fac=function(e){return new(e||t)};static \u0275prov=F({token:t,factory:t.\u0275fac,providedIn:"root"})};var Z=(t,i)=>i.id;function te(t,i){t&1&&(n(0,"div",15)(1,"div",10)(2,"div",17),g(3,"div",18),n(4,"p",19),o(5,"Cargando cirug\xEDas..."),a()()()())}function ie(t,i){t&1&&(n(0,"div",24)(1,"p",26),o(2,"No se encontraron cirug\xEDas"),a()())}function ne(t,i){if(t&1&&(n(0,"div",36)(1,"span"),o(2,"\u{1F4CD}"),a(),n(3,"span"),o(4),a()()),t&2){let e=l().$implicit;r(4),u(e.hospital==null?null:e.hospital.nombre)}}function ae(t,i){if(t&1){let e=y();n(0,"button",28),T("click",function(){let s=v(e).$implicit,_=l(4);return f(_.seleccionarCirugia(s))}),n(1,"div",29)(2,"div",30)(3,"h3",31),o(4),a(),n(5,"p",32),o(6),a(),n(7,"p",33),o(8),a()(),n(9,"div",34)(10,"span"),o(11),E(12,"titlecase"),a(),n(13,"p",35),o(14),a()()(),p(15,ne,5,1,"div",36),a()}if(t&2){let e=i.$implicit,d=l(4);r(4),m(" ",e.numero_cirugia," "),r(2),m(" ",d.obtenerNombreCliente(e)," "),r(2),m(" ",e.medico_cirujano," "),r(2),$("px-2 py-1 rounded-full text-xs font-semibold "+d.obtenerColorEstado(e.estado)),r(),m(" ",z(12,8,e.estado)," "),r(3),m(" ",d.formatearFecha(e.fecha_programada)," "),r(),c(e.hospital!=null&&e.hospital.nombre?15:-1)}}function re(t,i){if(t&1&&(n(0,"div",25),w(1,ae,16,10,"button",27,Z),a()),t&2){let e=l(3);r(),S(e.cirugiasFiltradas)}}function oe(t,i){if(t&1&&(n(0,"main",16)(1,"div",10)(2,"h2",20)(3,"span",21),b(),n(4,"svg",22),g(5,"path",23),a()(),o(6),a(),p(7,ie,3,0,"div",24)(8,re,3,0,"div",25),a()()),t&2){let e=l(2);r(6),m(" Cirug\xEDas (",e.cirugiasFiltradas.length,") "),r(),c(e.cirugiasFiltradas.length===0?7:8)}}function le(t,i){if(t&1){let e=y();n(0,"header",1)(1,"div",2)(2,"div",3)(3,"div",4),g(4,"img",5),n(5,"span",6),o(6,"Trazabilidad"),a()()(),n(7,"div",7)(8,"h1",8),o(9,"\u{1F4CB} Historial de Actividades"),a(),n(10,"p",9),o(11,"Selecciona una cirug\xEDa para ver su trazabilidad completa"),a()()()(),n(12,"div",2)(13,"div",10)(14,"div",11)(15,"input",12),q("ngModelChange",function(s){v(e);let _=l();return H(_.busqueda,s)||(_.busqueda=s),f(s)}),a(),b(),n(16,"svg",13),g(17,"path",14),a()()()(),p(18,te,6,0,"div",15)(19,oe,9,2,"main",16)}if(t&2){let e=l();r(15),N("ngModel",e.busqueda),r(3),c(e.loading()?18:-1),r(),c(e.loading()?-1:19)}}function de(t,i){t&1&&(n(0,"div",15)(1,"div",10)(2,"div",17),g(3,"div",18),n(4,"p",19),o(5,"Cargando historial..."),a()()()())}function se(t,i){if(t&1&&(n(0,"div",2)(1,"div",10)(2,"div",40)(3,"p",41),o(4),a()()()()),t&2){let e=l(2);r(4),u(e.error())}}function ce(t,i){t&1&&(n(0,"div",46),b(),n(1,"svg",48),g(2,"path",45),a(),h(),n(3,"p",26),o(4,"No hay actividad registrada"),a()())}function me(t,i){if(t&1&&(n(0,"span",61),o(1),a(),n(2,"span"),o(3,"\u2192"),a()),t&2){let e=l(2).$implicit;r(),m(" ",e.estado_anterior," ")}}function pe(t,i){if(t&1&&(n(0,"span",60),o(1),a()),t&2){let e=l(2).$implicit;r(),m(" ",e.estado_nuevo," ")}}function ge(t,i){if(t&1&&(n(0,"div",55),p(1,me,4,1)(2,pe,2,1,"span",60),a()),t&2){let e=l().$implicit;r(),c(e.estado_anterior?1:-1),r(),c(e.estado_nuevo?2:-1)}}function _e(t,i){if(t&1&&(n(0,"p",56),o(1),a()),t&2){let e=l().$implicit;r(),m(" \u{1F4AC} ",e.observaciones," ")}}function xe(t,i){if(t&1&&(n(0,"span",62),o(1),a()),t&2){let e=l(2).$implicit;r(),m(" ",e.usuario_rol," ")}}function ue(t,i){if(t&1&&(n(0,"div",57)(1,"span"),o(2,"\u{1F464}"),a(),n(3,"span"),o(4),a(),p(5,xe,2,1,"span",62),a()),t&2){let e=l().$implicit;r(4),u(e.usuario_nombre),r(),c(e.usuario_rol?5:-1)}}function be(t,i){if(t&1&&(n(0,"a",63),o(1," Ver en mapa "),a()),t&2){let e=l(2).$implicit;V("href","https://www.google.com/maps?q="+e.coordenadas_lat+","+e.coordenadas_lng,M)}}function Ce(t,i){if(t&1&&(n(0,"div",58)(1,"span"),o(2,"\u{1F4CD}"),a(),n(3,"span"),o(4),a(),p(5,be,2,1,"a",63),a()),t&2){let e=l().$implicit;r(4),u(e.ubicacion),r(),c(e.coordenadas_lat&&e.coordenadas_lng?5:-1)}}function ve(t,i){if(t&1&&(n(0,"details",59)(1,"summary",64),o(2," Ver detalles adicionales "),a(),n(3,"div",65)(4,"pre",66),o(5),E(6,"json"),a()()()),t&2){let e=l().$implicit;r(5),u(z(6,1,e.metadata))}}function fe(t,i){if(t&1&&(n(0,"div",49)(1,"div",50)(2,"div",51),o(3),a(),n(4,"div",30)(5,"div",52)(6,"h4",53),o(7),a(),n(8,"span",54),o(9),a()(),p(10,ge,3,2,"div",55)(11,_e,2,1,"p",56)(12,ue,6,2,"div",57)(13,Ce,6,2,"div",58)(14,ve,7,3,"details",59),a()()()),t&2){let e=i.$implicit,d=l(4);r(3),u(d.obtenerIconoAccion(e.accion)),r(4),m(" ",d.obtenerTextoAccion(e.accion)," "),r(2),m(" ",d.formatearFecha(e.timestamp)," "),r(),c(e.estado_anterior||e.estado_nuevo?10:-1),r(),c(e.observaciones?11:-1),r(),c(e.usuario_nombre?12:-1),r(),c(e.ubicacion?13:-1),r(),c(e.metadata&&d.Object.keys(e.metadata).length>0?14:-1)}}function he(t,i){if(t&1&&(n(0,"div",47),w(1,fe,15,8,"div",49,Z),a()),t&2){let e=l(3);r(),S(e.eventos())}}function ye(t,i){if(t&1&&(n(0,"main",15)(1,"div",10)(2,"div",42)(3,"h3",43)(4,"div",44),b(),n(5,"svg",22),g(6,"path",45),a()(),h(),n(7,"span"),o(8),a()(),p(9,ce,5,0,"div",46)(10,he,3,0,"div",47),a()()()),t&2){let e=l(2);r(8),m("Historial de Actividad (",e.eventos().length,")"),r(),c(e.eventos().length===0?9:10)}}function ke(t,i){if(t&1){let e=y();n(0,"header",1)(1,"div",2)(2,"div",3)(3,"div",4),g(4,"img",5),n(5,"span",6),o(6,"Historial de Actividad"),a()(),n(7,"button",37),T("click",function(){v(e);let s=l();return f(s.volver())}),b(),n(8,"svg",38),g(9,"path",39),a(),o(10," Volver "),a()(),h(),n(11,"div",7)(12,"h1",8),o(13),a(),n(14,"p",9),o(15),a()()()(),p(16,de,6,0,"div",15)(17,se,5,1,"div",2)(18,ye,11,2,"main",15)}if(t&2){let e,d,s=l();r(13),m(" Cirug\xEDa ",(e=s.cirugiaSeleccionada())==null?null:e.numero_cirugia," "),r(2),A(" ",s.obtenerNombreCliente(s.cirugiaSeleccionada())," \u2022 ",(d=s.cirugiaSeleccionada())==null?null:d.medico_cirujano," "),r(),c(s.loading()?16:-1),r(),c(s.error()?17:-1),r(),c(!s.loading()&&!s.error()?18:-1)}}var Y=class t{trazabilidadService=C(U);supabase=C(P);router=C(G);Object=Object;vistaActual=x("seleccion");cirugiaSeleccionada=x(null);cirugias=x([]);eventos=x([]);loading=x(!1);error=x(null);busqueda=x("");ngOnInit(){this.cargarCirugias()}cargarCirugias(){return D(this,null,function*(){this.loading.set(!0);try{let{data:i,error:e}=yield this.supabase.client.from("cirugias").select(`
          id,
          numero_cirugia,
          fecha_programada,
          estado,
          medico_cirujano,
          cliente:clientes!inner(nombre, apellido),
          hospital:hospitales(nombre)
        `).order("fecha_programada",{ascending:!1}).limit(50);if(e)throw e;this.cirugias.set(i||[])}catch(i){console.error("Error al cargar cirug\xEDas:",i),this.error.set("Error al cargar las cirug\xEDas")}finally{this.loading.set(!1)}})}seleccionarCirugia(i){this.cirugiaSeleccionada.set(i),this.vistaActual.set("detalle"),this.cargarTrazabilidadCirugia(i.id)}cargarTrazabilidadCirugia(i){this.loading.set(!0),this.error.set(null),this.trazabilidadService.getTimelineCirugia(i).subscribe({next:e=>{this.eventos.set(e),this.loading.set(!1)},error:e=>{console.error("Error al cargar trazabilidad:",e),this.error.set("Error al cargar el historial"),this.loading.set(!1)}})}volver(){this.vistaActual.set("seleccion"),this.cirugiaSeleccionada.set(null),this.eventos.set([])}formatearFecha(i){if(!i)return"N/A";let e=new Date(i),s=new Date().getTime()-e.getTime(),_=Math.floor(s/6e4),L=Math.floor(s/36e5),I=Math.floor(s/864e5);return _<1?"Hace un momento":_<60?`Hace ${_} min`:L<24?`Hace ${L}h`:I<7?`Hace ${I}d`:e.toLocaleDateString("es-ES",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}obtenerIconoAccion(i){return{cirugia_creada:"\u2795",cirugia_iniciada:"\u25B6\uFE0F",cirugia_finalizada:"\u2705",cirugia_cancelada:"\u274C",kit_creado:"\u{1F4E6}",kit_aprobado:"\u2705",kit_rechazado:"\u274C",preparacion_iniciada:"\u{1F527}",producto_agregado:"\u2795",kit_listo:"\u2705",kit_despachado:"\u{1F69A}",kit_en_transito:"\u{1F69B}",kit_entregado:"\u{1F4CD}",kit_en_uso:"\u{1F52C}",kit_devuelto:"\u21A9\uFE0F",qr_escaneado:"\u{1F4F7}",estado_cambiado:"\u{1F504}",tecnico_asignado:"\u{1F464}",kit_asignado:"\u{1F4E6}",fecha_reprogramada:"\u{1F4C5}"}[i]||"\u{1F4C4}"}obtenerColorEstado(i){return{programada:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",en_proceso:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200",finalizada:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200",cancelada:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200",solicitado:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200",preparando:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",listo_envio:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200",en_transito:"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200",entregado:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200",en_uso:"bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200",devuelto:"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200",finalizado:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"}[i]||"bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200"}obtenerNombreCliente(i){return i.cliente?`${i.cliente.nombre} ${i.cliente.apellido}`:"N/A"}obtenerTextoAccion(i){return i.replace(/_/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")}get cirugiasFiltradas(){let i=this.busqueda().toLowerCase();return i?this.cirugias().filter(e=>e.numero_cirugia.toLowerCase().includes(i)||e.medico_cirujano?.toLowerCase().includes(i)||this.obtenerNombreCliente(e).toLowerCase().includes(i)||e.hospital?.nombre?.toLowerCase().includes(i)):this.cirugias()}static \u0275fac=function(e){return new(e||t)};static \u0275cmp=j({type:t,selectors:[["app-trazabilidad-list"]],decls:3,vars:2,consts:[[1,"bg-gray-50","dark:bg-gray-900","min-h-screen"],[1,"bg-gradient-to-r","from-green-600","to-emerald-700","text-white","shadow-lg"],[1,"px-4","py-4"],[1,"flex","justify-between","items-center","mb-3"],[1,"flex","items-center","space-x-3"],["src","https://www.implameq.com/wp-content/uploads/logotipo-impla-300x78.png.webp","alt","Implameq",1,"h-8","brightness-0","invert"],[1,"text-lg","font-semibold"],[1,"text-center"],[1,"text-2xl","font-bold","mb-1"],[1,"text-green-100","text-sm"],[1,"max-w-lg","mx-auto"],[1,"relative"],["type","text","placeholder","Buscar por n\xFAmero, cliente, m\xE9dico u hospital...",1,"w-full","px-4","py-3","pl-10","border","border-gray-300","dark:border-gray-600","rounded-lg","focus:ring-2","focus:ring-green-500","dark:bg-gray-800","dark:text-white",3,"ngModelChange","ngModel"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"absolute","left-3","top-3.5","w-5","h-5","text-gray-400"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"],[1,"px-4","py-6"],[1,"px-4","pb-6"],[1,"bg-white","rounded-xl","shadow-md","dark:bg-gray-800","p-6","text-center"],[1,"animate-spin","rounded-full","h-12","w-12","border-b-2","border-green-600","mx-auto","mb-4"],[1,"text-sm","text-gray-500"],[1,"text-lg","font-semibold","text-gray-900","dark:text-white","mb-4","flex","items-center"],[1,"w-8","h-8","bg-gradient-to-br","from-purple-400","to-purple-600","rounded-lg","flex","items-center","justify-center","mr-2"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4","text-white"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"],[1,"bg-white","dark:bg-gray-800","rounded-xl","shadow-md","p-6","text-center"],[1,"space-y-3"],[1,"text-gray-500","dark:text-gray-400"],[1,"w-full","bg-white","dark:bg-gray-800","rounded-xl","shadow-md","p-4","hover:shadow-lg","transition-all","duration-200","border","border-gray-200","dark:border-gray-700","text-left"],[1,"w-full","bg-white","dark:bg-gray-800","rounded-xl","shadow-md","p-4","hover:shadow-lg","transition-all","duration-200","border","border-gray-200","dark:border-gray-700","text-left",3,"click"],[1,"flex","justify-between","items-start","mb-2"],[1,"flex-1"],[1,"font-semibold","text-gray-900","dark:text-white","text-lg"],[1,"text-sm","text-gray-600","dark:text-gray-400"],[1,"text-xs","text-gray-500","dark:text-gray-500","mt-1"],[1,"text-right"],[1,"text-xs","text-gray-500","dark:text-gray-400","mt-2"],[1,"flex","items-center","gap-1","text-xs","text-gray-600","dark:text-gray-400","mt-2"],[1,"bg-white/20","hover:bg-white/30","text-white","px-3","py-2","rounded-lg","text-sm","font-medium","transition","duration-200","shadow-md","backdrop-blur-sm",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4","inline","mr-1"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M10 19l-7-7m0 0l7-7m-7 7h18"],[1,"bg-red-50","border","border-red-200","text-red-700","px-4","py-3","rounded-xl","shadow-md"],[1,"text-sm"],[1,"bg-white","rounded-xl","shadow-md","dark:bg-gray-800","dark:border","dark:border-gray-700","p-6"],[1,"text-lg","font-semibold","text-gray-900","dark:text-white","mb-4","flex","items-center","space-x-2"],[1,"w-8","h-8","bg-gradient-to-br","from-purple-400","to-purple-600","rounded-lg","flex","items-center","justify-center","flex-shrink-0"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"text-center","py-8"],[1,"space-y-4"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-12","h-12","text-gray-400","mx-auto","mb-4"],[1,"border-l-4","border-green-500","pl-4","py-2","bg-gray-50","dark:bg-gray-700","rounded-r-lg"],[1,"flex","items-start"],[1,"text-2xl","mr-3"],[1,"flex","justify-between","items-start","mb-1"],[1,"font-medium","text-gray-900","dark:text-white"],[1,"text-xs","text-gray-500","dark:text-gray-400"],[1,"flex","items-center","gap-2","text-sm","my-2"],[1,"text-sm","text-gray-600","dark:text-gray-300","mt-2","bg-white","dark:bg-gray-800","p-2","rounded"],[1,"flex","items-center","gap-2","mt-2","text-xs","text-gray-500","dark:text-gray-400"],[1,"flex","items-center","gap-1","text-xs","text-gray-500","dark:text-gray-400","mt-1"],[1,"mt-2"],[1,"px-2","py-1","bg-green-100","dark:bg-green-900","text-green-800","dark:text-green-200","rounded","text-xs","font-medium"],[1,"px-2","py-1","bg-gray-200","dark:bg-gray-600","rounded","text-xs"],[1,"px-2","py-0.5","bg-gray-200","dark:bg-gray-600","rounded"],["target","_blank",1,"text-green-600","hover:text-green-700","hover:underline","ml-2",3,"href"],[1,"cursor-pointer","text-xs","text-gray-600","dark:text-gray-400","hover:text-gray-800","dark:hover:text-gray-200"],[1,"mt-2","p-2","bg-white","dark:bg-gray-800","rounded","text-xs"],[1,"whitespace-pre-wrap","text-gray-700","dark:text-gray-300"]],template:function(e,d){e&1&&(n(0,"section",0),p(1,le,20,3)(2,ke,19,6),a()),e&2&&(r(),c(d.vistaActual()==="seleccion"?1:-1),r(),c(d.vistaActual()==="detalle"?2:-1))},dependencies:[R,O,B,Q,W,J,K],encapsulation:2})};export{Y as TrazabilidadListComponent};
