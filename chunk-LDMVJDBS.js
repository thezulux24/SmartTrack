import{a as E}from"./chunk-YGGYEX66.js";import{v}from"./chunk-3OSVPALZ.js";import{M as w,S as m,h as u,i as H,n as b,v as G}from"./chunk-MBDN4FSM.js";import{a as f,i as p}from"./chunk-ODN5LVDJ.js";var y=class j{supabase=m(v);notificationService=m(E);getHojasGasto(o){return u(this.fetchHojasGasto(o))}getHojaGasto(o){return u(this.fetchHojaGasto(o))}createHojaGasto(o){return u(this.insertHojaGasto(o))}updateHojaGasto(o,a){return u(this.updateHojaGastoData(o,a))}cambiarEstado(o,a){return u(this.updateEstado(o,a))}deleteHojaGasto(o){return u(this.removeHojaGasto(o))}existeHojaGastoPorCirugia(o){return u(this.supabase.client.from("hojas_gasto").select("id").eq("cirugia_id",o).limit(1)).pipe(b(({data:a,error:t})=>t?(console.error("Error verificando hoja de gasto existente:",t),!1):a!==null&&a.length>0))}getHojaGastoPorCirugia(o){return u(this.supabase.client.from("hojas_gasto").select(`
          *,
          hoja_gasto_items(*)
        `).eq("cirugia_id",o).single()).pipe(b(({data:a,error:t})=>{if(t){if(t.code==="PGRST116")return null;throw console.error("Error obteniendo hoja de gasto por cirug\xEDa:",t),t}return this.mapToHojaGasto(a)}),G(a=>(console.error("Error in getHojaGastoPorCirugia:",a),H(null))))}recalcularTotales(o){let a={total_productos:0,total_transporte:0,total_otros:0,total_general:0};return(o.items||o.hoja_gasto_items||[]).forEach(r=>{let s=r.subtotal||r.precio_total||r.cantidad*r.precio_unitario;switch(a.total_general+=s,r.categoria){case"productos":a.total_productos+=s;break;case"transporte":a.total_transporte+=s;break;case"otros":a.total_otros+=s;break}}),f(f({},o),a)}fetchHojasGasto(o){return p(this,null,function*(){try{let a=this.supabase.client.from("hojas_gasto").select(`
          *,
          hoja_gasto_items(*),
          tecnico:profiles!hojas_gasto_tecnico_id_fkey(id, full_name, email),
          cirugia:cirugias!hojas_gasto_cirugia_id_fkey(
            id,
            numero_cirugia,
            medico_cirujano,
            fecha_programada,
            cliente:clientes(nombre, apellido),
            hospital:hospitales(nombre)
          )
        `);o?.estado&&(a=a.eq("estado",o.estado)),o?.fecha_desde&&(a=a.gte("fecha_cirugia",o.fecha_desde)),o?.fecha_hasta&&(a=a.lte("fecha_cirugia",o.fecha_hasta)),o?.tecnico_id&&(a=a.eq("tecnico_id",o.tecnico_id));let{data:t,error:r}=yield a.order("created_at",{ascending:!1});if(r)throw console.error("Error fetching hojas gasto:",r),r;return this.mapToHojasGasto(t||[])}catch(a){throw console.error("Error in fetchHojasGasto:",a),a}})}fetchHojaGasto(o){return p(this,null,function*(){try{let{data:a,error:t}=yield this.supabase.client.from("hojas_gasto").select(`
          *,
          hoja_gasto_items(*),
          tecnico:profiles!hojas_gasto_tecnico_id_fkey(id, full_name, email),
          cirugia:cirugias!hojas_gasto_cirugia_id_fkey(
            id,
            numero_cirugia,
            medico_cirujano,
            fecha_programada,
            cliente:clientes(nombre, apellido),
            hospital:hospitales(nombre)
          )
        `).eq("id",o).single();if(t){if(t.code==="PGRST116")return null;throw console.error("Error fetching hoja gasto:",t),t}return this.mapToHojaGasto(a)}catch(a){throw console.error("Error in fetchHojaGasto:",a),a}})}insertHojaGasto(o){return p(this,null,function*(){try{let{data:a,error:t}=yield this.supabase.client.from("hojas_gasto").select("id, numero_hoja, estado").eq("cirugia_id",o.cirugia_id).limit(1);if(t)throw console.error("\u274C Error verificando hoja existente:",t),t;if(a&&a.length>0){let e=a[0];throw console.warn("\u26A0\uFE0F Ya existe una hoja de gasto para esta cirug\xEDa:",e),new Error(`Ya existe una hoja de gasto (${e.numero_hoja}) para esta cirug\xEDa. No se pueden crear hojas duplicadas.`)}let r=yield this.generateNumeroHoja(),s=0,_=0,c=0,l=0;o.items&&o.items.length>0&&o.items.forEach(e=>{let i=(e.cantidad_usada||e.cantidad||0)*e.precio_unitario;switch(l+=i,e.categoria){case"productos":s+=i;break;case"transporte":_+=i;break;case"otros":c+=i;break}});let n={numero_hoja:r,cirugia_id:o.cirugia_id,tecnico_id:o.tecnico_id,fecha_cirugia:o.fecha_cirugia,estado:"borrador",total_productos:s,total_transporte:_,total_otros:c,total_general:l,observaciones:o.observaciones||null},{data:h,error:d}=yield this.supabase.client.from("hojas_gasto").insert(n).select().single();if(d)throw d;if(o.items&&o.items.length>0){let e=o.items.map(i=>({hoja_gasto_id:h.id,producto_id:i.producto_id,categoria:i.categoria,descripcion:i.descripcion||i.nombre_producto||"",cantidad:i.cantidad||i.cantidad_usada||0,precio_unitario:i.precio_unitario,precio_total:(i.cantidad||i.cantidad_usada||0)*i.precio_unitario,fecha_gasto:i.fecha_gasto,comprobante_url:i.comprobante_url,observaciones:i.observaciones})),{error:g}=yield this.supabase.client.from("hoja_gasto_items").insert(e);if(g)throw console.error("Error inserting hoja gasto items:",g),yield this.supabase.client.from("hojas_gasto").delete().eq("id",h.id),g}return yield this.fetchHojaGasto(h.id)}catch(a){throw console.error("Error in insertHojaGasto:",a),a}})}updateHojaGastoData(o,a){return p(this,null,function*(){try{let t=0,r=0,s=0,_=0;a.items&&a.items.length>0&&a.items.forEach(n=>{let d=(n.cantidad_usada||n.cantidad||0)*n.precio_unitario;switch(_+=d,n.categoria){case"productos":t+=d;break;case"transporte":r+=d;break;case"otros":s+=d;break}});let c={updated_at:new Date().toISOString()};a.estado&&(c.estado=a.estado),a.observaciones!==void 0&&(c.observaciones=a.observaciones),a.items&&a.items.length>0&&(c.total_productos=t,c.total_transporte=r,c.total_otros=s,c.total_general=_);let{error:l}=yield this.supabase.client.from("hojas_gasto").update(c).eq("id",o);if(l)throw console.error("Error updating hoja gasto:",l),l;if(a.items&&a.items.length>0){let{error:n}=yield this.supabase.client.from("hoja_gasto_items").delete().eq("hoja_gasto_id",o);if(n)throw console.error("Error deleting existing items:",n),n;let h=a.items.map(e=>({hoja_gasto_id:o,producto_id:e.producto_id,categoria:e.categoria,descripcion:e.descripcion||e.nombre_producto||"",cantidad:e.cantidad||e.cantidad_usada||0,precio_unitario:e.precio_unitario,precio_total:(e.cantidad||e.cantidad_usada||0)*e.precio_unitario,fecha_gasto:e.fecha_gasto,comprobante_url:e.comprobante_url,observaciones:e.observaciones})),{error:d}=yield this.supabase.client.from("hoja_gasto_items").insert(h);if(d)throw console.error("Error inserting updated items:",d),d}return yield this.fetchHojaGasto(o)}catch(t){throw console.error("Error in updateHojaGastoData:",t),t}})}updateEstado(o,a){return p(this,null,function*(){try{let t=yield this.fetchHojaGasto(o);if(!t)throw new Error("Hoja de gasto no encontrada");let r=t.estado,{error:s}=yield this.supabase.client.from("hojas_gasto").update({estado:a,updated_at:new Date().toISOString()}).eq("id",o);if(s)throw console.error("Error updating estado:",s),s;let{data:_}=yield this.supabase.client.auth.getUser(),c=_?.user?.email||"Sistema";if(yield this.notificationService.notifyHojaGastoStatusChange(o,t.numero_hoja,t.tecnico_id,r,a,c,void 0).catch(l=>console.error("Error enviando notificaci\xF3n de cambio estado:",l)),a==="revision"&&r!=="revision"){let{data:l}=yield this.supabase.client.from("cirugias").select("numero_cirugia").eq("id",t.cirugia_id).single(),{data:n}=yield this.supabase.client.from("profiles").select("full_name").eq("id",t.tecnico_id).single();yield this.notificationService.notifyHojaGastoNeedsApproval(o,t.numero_hoja,n?.full_name||"T\xE9cnico",t.total_general,l?.numero_cirugia).catch(h=>console.error("Error enviando notificaci\xF3n de aprobaci\xF3n pendiente:",h))}return yield this.fetchHojaGasto(o)}catch(t){throw console.error("Error in updateEstado:",t),t}})}removeHojaGasto(o){return p(this,null,function*(){try{yield this.supabase.client.from("hoja_gasto_items").delete().eq("hoja_gasto_id",o);let{error:a}=yield this.supabase.client.from("hojas_gasto").delete().eq("id",o);if(a)throw console.error("Error deleting hoja gasto:",a),a;return!0}catch(a){throw console.error("Error in removeHojaGasto:",a),a}})}generateNumeroHoja(){return p(this,null,function*(){let o=new Date().getFullYear(),a=String(new Date().getMonth()+1).padStart(2,"0"),{data:t,error:r}=yield this.supabase.client.from("hojas_gasto").select("numero_hoja").like("numero_hoja",`HG-${o}${a}-%`).order("numero_hoja",{ascending:!1}).limit(1),s=1;if(t&&t.length>0){let _=t[0].numero_hoja.split("-")[2];s=parseInt(_)+1}return`HG-${o}${a}-${String(s).padStart(3,"0")}`})}mapToHojasGasto(o){return o.map(a=>this.mapToHojaGasto(a))}mapToHojaGasto(o){return{id:o.id,numero_hoja:o.numero_hoja,cirugia_id:o.cirugia_id,tecnico_id:o.tecnico_id,fecha_cirugia:o.fecha_cirugia,fecha_creacion:o.fecha_creacion||o.created_at,estado:o.estado,total_productos:o.total_productos||0,total_transporte:o.total_transporte||0,total_otros:o.total_otros||0,total_general:o.total_general||0,observaciones:o.observaciones,created_at:o.created_at,updated_at:o.updated_at,created_by:o.created_by,updated_by:o.updated_by,tecnico:o.tecnico?{id:o.tecnico.id,full_name:o.tecnico.full_name,email:o.tecnico.email}:void 0,cirugia:o.cirugia?{id:o.cirugia.id,numero_cirugia:o.cirugia.numero_cirugia,medico_cirujano:o.cirugia.medico_cirujano,fecha_programada:o.cirugia.fecha_programada,cliente:o.cirugia.cliente?{nombre:o.cirugia.cliente.nombre,apellido:o.cirugia.cliente.apellido}:void 0,hospital:o.cirugia.hospital?{nombre:o.cirugia.hospital.nombre}:void 0}:void 0,items:o.hoja_gasto_items?.map(a=>({id:a.id,hoja_gasto_id:a.hoja_gasto_id,producto_id:a.producto_id,categoria:a.categoria,descripcion:a.descripcion,cantidad:a.cantidad,precio_unitario:a.precio_unitario,precio_total:a.precio_total,fecha_gasto:a.fecha_gasto,comprobante_url:a.comprobante_url,observaciones:a.observaciones,created_at:a.created_at,updated_at:a.updated_at,nombre_producto:a.descripcion,cantidad_usada:a.cantidad,subtotal:a.precio_total}))||[],hoja_gasto_items:o.hoja_gasto_items?.map(a=>({id:a.id,hoja_gasto_id:a.hoja_gasto_id,producto_id:a.producto_id,categoria:a.categoria,descripcion:a.descripcion,cantidad:a.cantidad,precio_unitario:a.precio_unitario,precio_total:a.precio_total,fecha_gasto:a.fecha_gasto,comprobante_url:a.comprobante_url,observaciones:a.observaciones,created_at:a.created_at,updated_at:a.updated_at}))||[]}}static \u0275fac=function(a){return new(a||j)};static \u0275prov=w({token:j,factory:j.\u0275fac,providedIn:"root"})};export{y as a};
