import{a as b}from"./chunk-C4VFUW4K.js";import{v as C}from"./chunk-3OSVPALZ.js";import{H as d,J as h,M as f,S as m,f as p,h as c,n as g}from"./chunk-MBDN4FSM.js";import{i as l}from"./chunk-ODN5LVDJ.js";var v=class _{supabase=m(C);notificationService=m(b);activeChannels=new Map;unreadCountsSubject=new p(new Map);unreadCounts$=this.unreadCountsSubject.asObservable();getMensajesCirugia(e){return c(this.supabase.client.from("mensajes_cirugia").select(`
          *,
          usuario:profiles(id, full_name, role, email)
        `).eq("cirugia_id",e).order("created_at",{ascending:!0})).pipe(g(({data:i,error:a})=>{if(a)throw a;return i||[]}))}enviarMensaje(e){return c(this.supabase.getSession()).pipe(d(i=>{if(!i?.user?.id)throw new Error("Usuario no autenticado");return c(this.supabase.client.from("mensajes_cirugia").insert({cirugia_id:e.cirugia_id,usuario_id:i.user.id,mensaje:e.mensaje,tipo:e.tipo||"texto",metadata:e.metadata||{}}).select(`
              *,
              usuario:profiles(id, full_name, role, email)
            `).single())}),g(({data:i,error:a})=>{if(a)throw a;return i}),h(i=>l(this,null,function*(){yield this.notifyParticipants(i)})))}notifyParticipants(e){return l(this,null,function*(){try{console.log("\u{1F4AC} ChatService: notifyParticipants called for message",e.id);let i=yield this.supabase.getSession();if(!i?.user?.id){console.warn("\u26A0\uFE0F ChatService: No session, skipping notifications");return}console.log("\u{1F4AC} ChatService: Current user is",i.user.id);let{data:a}=yield this.supabase.client.from("cirugias").select(`
          id,
          numero_cirugia,
          usuario_creador_id,
          tecnico_asignado_id
        `).eq("id",e.cirugia_id).single();if(!a){console.warn("\u26A0\uFE0F ChatService: Cirugia not found");return}console.log("\u{1F4AC} ChatService: Cirugia info",a);let{data:o}=yield this.supabase.client.from("kits_cirugia").select("logistica_id").eq("cirugia_id",e.cirugia_id).limit(1);console.log("\u{1F4AC} ChatService: Kits info",o);let r=new Set;if(a.usuario_creador_id&&a.usuario_creador_id!==i.user.id&&(r.add(a.usuario_creador_id),console.log("\u{1F4AC} ChatService: Added creator to participants",a.usuario_creador_id)),a.tecnico_asignado_id&&a.tecnico_asignado_id!==i.user.id&&(r.add(a.tecnico_asignado_id),console.log("\u{1F4AC} ChatService: Added tecnico to participants",a.tecnico_asignado_id)),o&&o.length>0&&o[0].logistica_id&&o[0].logistica_id!==i.user.id&&(r.add(o[0].logistica_id),console.log("\u{1F4AC} ChatService: Added logistics to participants",o[0].logistica_id)),console.log("\u{1F4AC} ChatService: Total participants to notify:",r.size),r.size>0){let s=e.usuario?.full_name||"Usuario",t=e.tipo==="texto"?e.mensaje:e.tipo==="ubicacion"?"\u{1F4CD} Comparti\xF3 ubicaci\xF3n":"\u{1F4CE} Envi\xF3 un archivo";console.log("\u{1F4AC} ChatService: Calling notifyNewMessage with:",{participantIds:Array.from(r),cirugia:a.numero_cirugia,remitente:s,preview:t}),yield this.notificationService.notifyNewMessage(Array.from(r),e.cirugia_id,a.numero_cirugia,s,t),console.log("\u2705 ChatService: Notifications sent successfully")}else console.log("\u2139\uFE0F ChatService: No participants to notify (you are the only one)")}catch(i){console.error("\u274C ChatService: Error notifying participants:",i)}})}marcarComoLeido(e){return c(this.supabase.getSession()).pipe(d(i=>{if(!i?.user?.id)throw new Error("Usuario no autenticado");return c(this.supabase.client.rpc("mark_messages_as_read",{p_cirugia_id:e,p_user_id:i.user.id}))}),g(({error:i})=>{if(i)throw i}))}getUnreadCount(e){return c(this.supabase.getSession()).pipe(d(i=>i?.user?.id?c(this.supabase.client.rpc("get_unread_messages_count",{p_user_id:i.user.id,p_cirugia_id:e})):c(Promise.resolve(0))),g(i=>i.error?(console.error("Error getting unread count:",i.error),0):i.data||0))}getChatList(){return c(this.supabase.getSession()).pipe(d(e=>l(this,null,function*(){if(!e?.user?.id)throw new Error("Usuario no autenticado");let{data:i}=yield this.supabase.client.from("profiles").select("role").eq("id",e.user.id).single(),a=[];if(i?.role==="logistica"||i?.role==="admin"){let{data:s,error:t}=yield this.supabase.client.from("cirugias").select(`
              id,
              numero_cirugia,
              estado,
              usuario_creador_id,
              tecnico_asignado_id
            `).order("fecha_programada",{ascending:!1});if(t)throw t;a=s||[]}else{let{data:s,error:t}=yield this.supabase.client.from("cirugias").select(`
              id,
              numero_cirugia,
              estado,
              usuario_creador_id,
              tecnico_asignado_id
            `).or(`usuario_creador_id.eq.${e.user.id},tecnico_asignado_id.eq.${e.user.id}`);if(t)throw t;a=s||[]}if((a?.map(s=>s.id)||[]).length===0)return[];let r=[];for(let s of a||[]){let{data:t}=yield this.supabase.client.from("mensajes_cirugia").select(`
              mensaje,
              created_at,
              usuario:profiles(full_name)
            `).eq("cirugia_id",s.id).order("created_at",{ascending:!1}).limit(1),u=t&&t.length>0?t[0]:null;if(!u)continue;let{data:n}=yield this.supabase.client.rpc("get_unread_messages_count",{p_user_id:e.user.id,p_cirugia_id:s.id});r.push({cirugia_id:s.id,numero_cirugia:s.numero_cirugia,ultimo_mensaje:u.mensaje,ultimo_mensaje_fecha:u.created_at,ultimo_mensaje_usuario:u.usuario?.full_name||"Desconocido",mensajes_no_leidos:n||0,participantes_count:2,estado_cirugia:s.estado})}return r.sort((s,t)=>new Date(t.ultimo_mensaje_fecha).getTime()-new Date(s.ultimo_mensaje_fecha).getTime())})))}getChatCompleto(e){return c(this.supabase.getSession()).pipe(d(i=>l(this,null,function*(){if(!i?.user?.id)throw new Error("Usuario no autenticado");let{data:a,error:o}=yield this.supabase.client.from("cirugias").select(`
            id,
            numero_cirugia,
            estado,
            fecha_programada,
            medico_cirujano,
            usuario_creador_id,
            tecnico_asignado_id,
            cliente:clientes(nombre, apellido),
            hospital:hospitales(nombre)
          `).eq("id",e).single();if(o)throw o;let r=[];if(a.usuario_creador_id){let{data:n}=yield this.supabase.client.from("profiles").select("id, full_name, role, email").eq("id",a.usuario_creador_id).single();n&&r.push({id:n.id,nombre:n.full_name,rol:n.role,email:n.email})}if(a.tecnico_asignado_id){let{data:n}=yield this.supabase.client.from("profiles").select("id, full_name, role, email").eq("id",a.tecnico_asignado_id).single();n&&r.push({id:n.id,nombre:n.full_name,rol:n.role,email:n.email})}let{data:s,error:t}=yield this.supabase.client.from("mensajes_cirugia").select(`
            *,
            usuario:profiles(id, full_name, role, email)
          `).eq("cirugia_id",e).order("created_at",{ascending:!0});if(t)throw t;let{data:u}=yield this.supabase.client.rpc("get_unread_messages_count",{p_user_id:i.user.id,p_cirugia_id:e});return{cirugia:{id:a.id,numero_cirugia:a.numero_cirugia,estado:a.estado,fecha_programada:a.fecha_programada,medico_cirujano:a.medico_cirujano,cliente:Array.isArray(a.cliente)?a.cliente[0]:a.cliente,hospital:Array.isArray(a.hospital)?a.hospital[0]:a.hospital},participantes:r,mensajes:s||[],mensajes_no_leidos:u||0}})))}suscribirMensajes(e,i){console.log("\u{1F4AC} ChatService: Subscribing to messages for cirugia",e),this.desuscribirMensajes(e);let a=`chat_${e}`;console.log("\u{1F4E1} ChatService: Creating channel:",a);let o=this.supabase.client.channel(a).on("postgres_changes",{event:"INSERT",schema:"public",table:"mensajes_cirugia",filter:`cirugia_id=eq.${e}`},r=>l(this,null,function*(){console.log("\u{1F4EC} ChatService: \u2728 NEW MESSAGE RECEIVED VIA REALTIME! \u2728"),console.log("\u{1F4EC} Payload:",r);let s=r.new.id;console.log("\u{1F4EC} Fetching full message data for ID:",s);let{data:t,error:u}=yield this.supabase.client.from("mensajes_cirugia").select(`
              *,
              usuario:profiles(id, full_name, role, email)
            `).eq("id",s).single();if(u){console.error("\u274C ChatService: Error fetching message:",u);return}t?(console.log("\u2705 ChatService: Message data fetched:",t),console.log("\u{1F4E4} ChatService: Calling callback with message"),i(t)):console.warn("\u26A0\uFE0F ChatService: No data returned for message",s)})).subscribe((r,s)=>{console.log("\u{1F50C} ChatService: Subscription status:",r),s&&console.error("\u274C ChatService: Subscription error:",s),r==="SUBSCRIBED"&&(console.log("\u2705 ChatService: Successfully subscribed to chat messages!"),console.log("\u23F3 Waiting for new messages in cirugia",e)),r==="CHANNEL_ERROR"&&console.error("\u274C ChatService: Channel error - Check if Realtime is enabled for mensajes_cirugia"),r==="TIMED_OUT"&&console.error("\u274C ChatService: Subscription timed out")});this.activeChannels.set(e,o),console.log("\u{1F4BE} ChatService: Channel stored in activeChannels")}desuscribirMensajes(e){let i=this.activeChannels.get(e);i&&(this.supabase.client.removeChannel(i),this.activeChannels.delete(e))}limpiarSuscripciones(){this.activeChannels.forEach(e=>{this.supabase.client.removeChannel(e)}),this.activeChannels.clear()}actualizarUnreadCounts(){return l(this,null,function*(){let e=yield this.supabase.getSession();if(!e?.user?.id)return;let{data:i}=yield this.supabase.client.from("cirugias").select("id").or(`usuario_creador_id.eq.${e.user.id},tecnico_asignado_id.eq.${e.user.id}`);if(!i)return;let a=new Map;for(let o of i){let{data:r}=yield this.supabase.client.rpc("get_unread_messages_count",{p_user_id:e.user.id,p_cirugia_id:o.id});r&&r>0&&a.set(o.id,r)}this.unreadCountsSubject.next(a)})}static \u0275fac=function(i){return new(i||_)};static \u0275prov=f({token:_,factory:_.\u0275fac,providedIn:"root"})};export{v as a};
