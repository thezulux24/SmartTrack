import{a as E}from"./chunk-WUZJU462.js";import{v}from"./chunk-WKDYGGS7.js";import{M as w,S as m,h as g,i as H,n as b,v as G}from"./chunk-D2JNWC2G.js";import{a as f,i as h}from"./chunk-ODN5LVDJ.js";var y=class j{supabase=m(v);notificationService=m(E);getHojasGasto(a){return g(this.fetchHojasGasto(a))}getHojaGasto(a){return g(this.fetchHojaGasto(a))}createHojaGasto(a){return g(this.insertHojaGasto(a))}updateHojaGasto(a,o){return g(this.updateHojaGastoData(a,o))}cambiarEstado(a,o){return g(this.updateEstado(a,o))}deleteHojaGasto(a){return g(this.removeHojaGasto(a))}existeHojaGastoPorCirugia(a){return g(this.supabase.client.from("hojas_gasto").select("id").eq("cirugia_id",a).limit(1)).pipe(b(({data:o,error:t})=>t?(console.error("Error verificando hoja de gasto existente:",t),!1):o!==null&&o.length>0))}getHojaGastoPorCirugia(a){return g(this.supabase.client.from("hojas_gasto").select(`
          *,
          hoja_gasto_items(*)
        `).eq("cirugia_id",a).single()).pipe(b(({data:o,error:t})=>{if(t){if(t.code==="PGRST116")return null;throw console.error("Error obteniendo hoja de gasto por cirug\xEDa:",t),t}return this.mapToHojaGasto(o)}),G(o=>(console.error("Error in getHojaGastoPorCirugia:",o),H(null))))}recalcularTotales(a){let o={total_productos:0,total_transporte:0,total_otros:0,total_general:0};return(a.items||a.hoja_gasto_items||[]).forEach(r=>{let i=r.subtotal||r.precio_total||r.cantidad*r.precio_unitario;switch(o.total_general+=i,r.categoria){case"productos":o.total_productos+=i;break;case"transporte":o.total_transporte+=i;break;case"otros":o.total_otros+=i;break}}),f(f({},a),o)}fetchHojasGasto(a){return h(this,null,function*(){try{let o=this.supabase.client.from("hojas_gasto").select(`
          *,
          hoja_gasto_items(*),
          tecnico:profiles!hojas_gasto_tecnico_id_fkey(id, full_name, email),
          cirugia:cirugias!hojas_gasto_cirugia_id_fkey(
            id,
            numero_cirugia,
            medico_cirujano,
            fecha_programada,
            cliente:clientes(nombre, apellido),
            hospital:hospitales(nombre)
          )
        `);a?.estado&&(o=o.eq("estado",a.estado)),a?.fecha_desde&&(o=o.gte("fecha_cirugia",a.fecha_desde)),a?.fecha_hasta&&(o=o.lte("fecha_cirugia",a.fecha_hasta)),a?.tecnico_id&&(o=o.eq("tecnico_id",a.tecnico_id));let{data:t,error:r}=yield o.order("created_at",{ascending:!1});if(r)throw console.error("Error fetching hojas gasto:",r),r;return this.mapToHojasGasto(t||[])}catch(o){throw console.error("Error in fetchHojasGasto:",o),o}})}fetchHojaGasto(a){return h(this,null,function*(){try{let{data:o,error:t}=yield this.supabase.client.from("hojas_gasto").select(`
          *,
          hoja_gasto_items(*),
          tecnico:profiles!hojas_gasto_tecnico_id_fkey(id, full_name, email),
          cirugia:cirugias!hojas_gasto_cirugia_id_fkey(
            id,
            numero_cirugia,
            medico_cirujano,
            fecha_programada,
            cliente:clientes(nombre, apellido),
            hospital:hospitales(nombre)
          )
        `).eq("id",a).single();if(t){if(t.code==="PGRST116")return null;throw console.error("Error fetching hoja gasto:",t),t}return this.mapToHojaGasto(o)}catch(o){throw console.error("Error in fetchHojaGasto:",o),o}})}insertHojaGasto(a){return h(this,null,function*(){try{console.log("\u{1F4DD} Creando hoja de gasto con request:",a);let{data:o,error:t}=yield this.supabase.client.from("hojas_gasto").select("id, numero_hoja, estado").eq("cirugia_id",a.cirugia_id).limit(1);if(t)throw console.error("\u274C Error verificando hoja existente:",t),t;if(o&&o.length>0){let e=o[0];throw console.warn("\u26A0\uFE0F Ya existe una hoja de gasto para esta cirug\xEDa:",e),new Error(`Ya existe una hoja de gasto (${e.numero_hoja}) para esta cirug\xEDa. No se pueden crear hojas duplicadas.`)}console.log("\u2705 No hay hojas de gasto existentes para esta cirug\xEDa, continuando...");let r=yield this.generateNumeroHoja();console.log("\u{1F522} N\xFAmero de hoja generado:",r);let i=0,_=0,c=0,l=0;a.items&&a.items.length>0&&a.items.forEach(e=>{let s=(e.cantidad_usada||e.cantidad||0)*e.precio_unitario;switch(l+=s,e.categoria){case"productos":i+=s;break;case"transporte":_+=s;break;case"otros":c+=s;break}}),console.log("\u{1F4B0} Totales calculados:",{total_productos:i,total_transporte:_,total_otros:c,total_general:l});let n={numero_hoja:r,cirugia_id:a.cirugia_id,tecnico_id:a.tecnico_id,fecha_cirugia:a.fecha_cirugia,estado:"borrador",total_productos:i,total_transporte:_,total_otros:c,total_general:l,observaciones:a.observaciones||null};console.log("\u{1F4E4} Datos EXACTOS a insertar (SIN alojamiento):",n),console.log("\u{1F50D} Verificando que NO existe total_alojamiento:",Object.keys(n));let{data:u,error:d}=yield this.supabase.client.from("hojas_gasto").insert(n).select().single();if(d)throw console.error("\u274C Error inserting hoja gasto:",d),console.error("\u{1F4CB} Error details:",JSON.stringify(d,null,2)),d;if(console.log("\u2705 Hoja de gasto creada:",u),a.items&&a.items.length>0){let e=a.items.map(s=>({hoja_gasto_id:u.id,producto_id:s.producto_id,categoria:s.categoria,descripcion:s.descripcion||s.nombre_producto||"",cantidad:s.cantidad||s.cantidad_usada||0,precio_unitario:s.precio_unitario,precio_total:(s.cantidad||s.cantidad_usada||0)*s.precio_unitario,fecha_gasto:s.fecha_gasto,comprobante_url:s.comprobante_url,observaciones:s.observaciones})),{error:p}=yield this.supabase.client.from("hoja_gasto_items").insert(e);if(p)throw console.error("Error inserting hoja gasto items:",p),yield this.supabase.client.from("hojas_gasto").delete().eq("id",u.id),p}return yield this.fetchHojaGasto(u.id)}catch(o){throw console.error("Error in insertHojaGasto:",o),o}})}updateHojaGastoData(a,o){return h(this,null,function*(){try{let t=0,r=0,i=0,_=0;o.items&&o.items.length>0&&o.items.forEach(n=>{let d=(n.cantidad_usada||n.cantidad||0)*n.precio_unitario;switch(_+=d,n.categoria){case"productos":t+=d;break;case"transporte":r+=d;break;case"otros":i+=d;break}});let c={updated_at:new Date().toISOString()};o.estado&&(c.estado=o.estado),o.observaciones!==void 0&&(c.observaciones=o.observaciones),o.items&&o.items.length>0&&(c.total_productos=t,c.total_transporte=r,c.total_otros=i,c.total_general=_),console.log("\u{1F4E4} Update data EXACTOS (SIN alojamiento):",c),console.log("\u{1F50D} Verificando keys de update:",Object.keys(c));let{error:l}=yield this.supabase.client.from("hojas_gasto").update(c).eq("id",a);if(l)throw console.error("Error updating hoja gasto:",l),l;if(o.items&&o.items.length>0){let{error:n}=yield this.supabase.client.from("hoja_gasto_items").delete().eq("hoja_gasto_id",a);if(n)throw console.error("Error deleting existing items:",n),n;let u=o.items.map(e=>({hoja_gasto_id:a,producto_id:e.producto_id,categoria:e.categoria,descripcion:e.descripcion||e.nombre_producto||"",cantidad:e.cantidad||e.cantidad_usada||0,precio_unitario:e.precio_unitario,precio_total:(e.cantidad||e.cantidad_usada||0)*e.precio_unitario,fecha_gasto:e.fecha_gasto,comprobante_url:e.comprobante_url,observaciones:e.observaciones})),{error:d}=yield this.supabase.client.from("hoja_gasto_items").insert(u);if(d)throw console.error("Error inserting updated items:",d),d}return yield this.fetchHojaGasto(a)}catch(t){throw console.error("Error in updateHojaGastoData:",t),t}})}updateEstado(a,o){return h(this,null,function*(){try{let t=yield this.fetchHojaGasto(a);if(!t)throw new Error("Hoja de gasto no encontrada");let r=t.estado,{error:i}=yield this.supabase.client.from("hojas_gasto").update({estado:o,updated_at:new Date().toISOString()}).eq("id",a);if(i)throw console.error("Error updating estado:",i),i;let{data:_}=yield this.supabase.client.auth.getUser(),c=_?.user?.email||"Sistema";if(yield this.notificationService.notifyHojaGastoStatusChange(a,t.numero_hoja,t.tecnico_id,r,o,c,void 0).catch(l=>console.error("Error enviando notificaci\xF3n de cambio estado:",l)),o==="revision"&&r!=="revision"){let{data:l}=yield this.supabase.client.from("cirugias").select("numero_cirugia").eq("id",t.cirugia_id).single(),{data:n}=yield this.supabase.client.from("profiles").select("full_name").eq("id",t.tecnico_id).single();yield this.notificationService.notifyHojaGastoNeedsApproval(a,t.numero_hoja,n?.full_name||"T\xE9cnico",t.total_general,l?.numero_cirugia).catch(u=>console.error("Error enviando notificaci\xF3n de aprobaci\xF3n pendiente:",u))}return yield this.fetchHojaGasto(a)}catch(t){throw console.error("Error in updateEstado:",t),t}})}removeHojaGasto(a){return h(this,null,function*(){try{yield this.supabase.client.from("hoja_gasto_items").delete().eq("hoja_gasto_id",a);let{error:o}=yield this.supabase.client.from("hojas_gasto").delete().eq("id",a);if(o)throw console.error("Error deleting hoja gasto:",o),o;return!0}catch(o){throw console.error("Error in removeHojaGasto:",o),o}})}generateNumeroHoja(){return h(this,null,function*(){let a=new Date().getFullYear(),o=String(new Date().getMonth()+1).padStart(2,"0"),{data:t,error:r}=yield this.supabase.client.from("hojas_gasto").select("numero_hoja").like("numero_hoja",`HG-${a}${o}-%`).order("numero_hoja",{ascending:!1}).limit(1),i=1;if(t&&t.length>0){let _=t[0].numero_hoja.split("-")[2];i=parseInt(_)+1}return`HG-${a}${o}-${String(i).padStart(3,"0")}`})}mapToHojasGasto(a){return a.map(o=>this.mapToHojaGasto(o))}mapToHojaGasto(a){return{id:a.id,numero_hoja:a.numero_hoja,cirugia_id:a.cirugia_id,tecnico_id:a.tecnico_id,fecha_cirugia:a.fecha_cirugia,fecha_creacion:a.fecha_creacion||a.created_at,estado:a.estado,total_productos:a.total_productos||0,total_transporte:a.total_transporte||0,total_otros:a.total_otros||0,total_general:a.total_general||0,observaciones:a.observaciones,created_at:a.created_at,updated_at:a.updated_at,created_by:a.created_by,updated_by:a.updated_by,tecnico:a.tecnico?{id:a.tecnico.id,full_name:a.tecnico.full_name,email:a.tecnico.email}:void 0,cirugia:a.cirugia?{id:a.cirugia.id,numero_cirugia:a.cirugia.numero_cirugia,medico_cirujano:a.cirugia.medico_cirujano,fecha_programada:a.cirugia.fecha_programada,cliente:a.cirugia.cliente?{nombre:a.cirugia.cliente.nombre,apellido:a.cirugia.cliente.apellido}:void 0,hospital:a.cirugia.hospital?{nombre:a.cirugia.hospital.nombre}:void 0}:void 0,items:a.hoja_gasto_items?.map(o=>({id:o.id,hoja_gasto_id:o.hoja_gasto_id,producto_id:o.producto_id,categoria:o.categoria,descripcion:o.descripcion,cantidad:o.cantidad,precio_unitario:o.precio_unitario,precio_total:o.precio_total,fecha_gasto:o.fecha_gasto,comprobante_url:o.comprobante_url,observaciones:o.observaciones,created_at:o.created_at,updated_at:o.updated_at,nombre_producto:o.descripcion,cantidad_usada:o.cantidad,subtotal:o.precio_total}))||[],hoja_gasto_items:a.hoja_gasto_items?.map(o=>({id:o.id,hoja_gasto_id:o.hoja_gasto_id,producto_id:o.producto_id,categoria:o.categoria,descripcion:o.descripcion,cantidad:o.cantidad,precio_unitario:o.precio_unitario,precio_total:o.precio_total,fecha_gasto:o.fecha_gasto,comprobante_url:o.comprobante_url,observaciones:o.observaciones,created_at:o.created_at,updated_at:o.updated_at}))||[]}}static \u0275fac=function(o){return new(o||j)};static \u0275prov=w({token:j,factory:j.\u0275fac,providedIn:"root"})};export{y as a};
