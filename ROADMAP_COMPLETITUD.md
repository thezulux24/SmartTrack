# üó∫Ô∏è ROADMAP DE COMPLETITUD - SmartTrack App

**Fecha de √öltima Actualizaci√≥n**: 13 de Octubre, 2025  
**Nivel de Completitud Actual**: ~85%  
**Tiempo Estimado para Completar**: 8-10 semanas

---

## üìä ESTADO ACTUAL DEL PROYECTO

### ‚úÖ **LO QUE YA EST√Å COMPLETO** (85%)

#### **Sistema Operacional - S√ìLIDO**
- ‚úÖ **RBAC completo** (roles, permisos, guards, role.guard.ts)
- ‚úÖ **Sistema de notificaciones** (17 tipos, integrado en 5 servicios)
  - Notificaciones para: cirug√≠as, env√≠os, hojas de gasto, inventario cr√≠tico
  - Realtime subscriptions con Supabase
  - Badge y panel de notificaciones
- ‚úÖ **CRUD completo**:
  - Cirug√≠as (programar, editar, cancelar, cambiar estado)
  - Clientes y Hospitales
  - Inventario con movimientos (entradas/salidas)
  - Hojas de gasto con aprobaci√≥n workflow
  - Tipos de cirug√≠a
- ‚úÖ **Gesti√≥n de kits quir√∫rgicos**:
  - Creaci√≥n desde agenda
  - Preparaci√≥n por log√≠stica
  - Validaci√≥n por t√©cnico
  - Devoluci√≥n y procesamiento
- ‚úÖ **Sistema de env√≠os**:
  - Asignaci√≥n de mensajeros
  - Seguimiento de estados (programado ‚Üí en_transito ‚Üí entregado)
  - QR codes para validaci√≥n p√∫blica
- ‚úÖ **Chat por cirug√≠a** con compartir ubicaci√≥n
- ‚úÖ **Trazabilidad completa** en `kit_trazabilidad` para todas las operaciones
- ‚úÖ **Dashboards b√°sicos**:
  - TecnicoDashboardComponent (kits pendientes, validados, en curso, devueltos)
  - LogisticaDashboardComponent (stats + alertas de urgencia)

---

## ‚ùå **LO QUE FALTA** (15%)

---

## üî¥ **PRIORIDAD CR√çTICA** (Semana 1-2)

### **1. Dashboard Comercial** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
- **Estado**: ‚ùå NO EXISTE
- **Impacto**: CR√çTICO - Vista principal del rol comercial
- **Complejidad**: MEDIA (3-4 d√≠as)
- **Ubicaci√≥n**: `src/app/features/internal/comercial/comercial-dashboard/`

**Funcionalidades requeridas:**
- [ ] Vista unificada de ventas y facturaci√≥n diarias
- [ ] KPIs principales:
  - [ ] Cirug√≠as programadas vs realizadas (tasa de cierre)
  - [ ] Cirug√≠as canceladas con an√°lisis de motivos
  - [ ] Tiempo promedio de respuesta a solicitudes
  - [ ] Estado financiero por cliente (facturaci√≥n pendiente)
  - [ ] Clientes activos vs inactivos
- [ ] Agenda consolidada con cambios en tiempo real
- [ ] Alertas de clientes inactivos o de bajo consumo
- [ ] Panel motivacional: "¬øC√≥mo voy hoy?"
- [ ] Acceso r√°pido a cotizaciones pendientes

**Justificaci√≥n**: Los 3 comerciales entrevistados lo pidieron como prioridad #1. Sin esto, no tienen visibilidad de su desempe√±o.

**Notas de implementaci√≥n**:
```typescript
// Estructura sugerida
src/app/features/internal/comercial/
‚îú‚îÄ‚îÄ comercial-dashboard/
‚îÇ   ‚îú‚îÄ‚îÄ comercial-dashboard.component.ts
‚îÇ   ‚îú‚îÄ‚îÄ comercial-dashboard.component.html
‚îÇ   ‚îî‚îÄ‚îÄ comercial-dashboard.component.css
‚îî‚îÄ‚îÄ comercial-routing.ts  // Actualizar con ruta al dashboard
```

---

### **2. Panel de KPIs para los 3 Roles** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê
- **Estado**: ‚ö†Ô∏è Dashboards b√°sicos existen, pero SIN m√©tricas de desempe√±o
- **Impacto**: CR√çTICO - Toma de decisiones estrat√©gicas
- **Complejidad**: MEDIA-ALTA (5-6 d√≠as)
- **Ubicaci√≥n**: `src/app/shared/components/kpi-dashboard/`

**Componente compartido**: `KpiDashboardComponent` con configuraci√≥n por rol

#### **KPIs por Rol**:

**COMERCIAL:**
- [ ] Tasa de cierre (cirug√≠as confirmadas / solicitadas) %
- [ ] Tasa de cancelaci√≥n con an√°lisis de causas
- [ ] Tiempo promedio de respuesta a solicitudes (horas/d√≠as)
- [ ] Valor promedio por cirug√≠a ($)
- [ ] Clientes activos vs inactivos (√∫ltimos 30 d√≠as)
- [ ] Cotizaciones: enviadas, aprobadas, rechazadas, conversi√≥n %

**LOG√çSTICA:**
- [ ] % Entregas a tiempo (< 24h desde asignaci√≥n)
- [ ] Tiempo promedio ciclo completo (despacho ‚Üí entrega ‚Üí facturaci√≥n)
- [ ] % Errores de despacho (incompletos/incorrectos)
- [ ] Utilizaci√≥n de mensajeros (activos/total, entregas por mensajero)
- [ ] Kits con alertas de urgencia (cirug√≠a < 24h)
- [ ] Stock cr√≠tico (productos bajo m√≠nimo)

**T√âCNICO:**
- [ ] Tiempo promedio en cirug√≠a (por tipo)
- [ ] % Cumplimiento de protocolos de validaci√≥n
- [ ] Incidencias reportadas vs resueltas
- [ ] Kits devueltos con observaciones vs sin observaciones
- [ ] Tiempo de respuesta a asignaciones (desde notificaci√≥n hasta validaci√≥n)
- [ ] Hojas de gasto: pendientes, aprobadas, rechazadas

**Justificaci√≥n**: Sin KPIs, no hay forma de medir eficiencia ni identificar problemas. Los 3 roles lo mencionaron como cr√≠tico.

**Notas de implementaci√≥n**:
```typescript
// Interface para configuraci√≥n por rol
interface KpiConfig {
  role: 'comercial' | 'logistica' | 'soporte_tecnico';
  kpis: KpiDefinition[];
}

interface KpiDefinition {
  id: string;
  label: string;
  value: number | string;
  unit: string;  // '%', '$', 'd√≠as', etc.
  trend?: 'up' | 'down' | 'neutral';
  trendValue?: number;
  target?: number;  // Meta
  color?: string;   // Para visualizaci√≥n
}

// Usar Chart.js o similar para gr√°ficas
```

---

### **3. M√≥dulo de Reportes e Indicadores** ‚≠ê‚≠ê‚≠ê‚≠ê
- **Estado**: ‚ùå NO EXISTE
- **Impacto**: ALTO - An√°lisis y mejora continua
- **Complejidad**: MEDIA (4-5 d√≠as)
- **Ubicaci√≥n**: `src/app/features/internal/reportes/`

**Funcionalidades requeridas:**
- [ ] Generaci√≥n de reportes por per√≠odo (diario, semanal, mensual, personalizado)
- [ ] Exportaci√≥n a Excel/PDF
- [ ] Reportes predefinidos:
  - [ ] **Resumen de cirug√≠as**: Por estado, hospital, t√©cnico, tipo de cirug√≠a
  - [ ] **Movimientos de inventario**: Entradas, salidas, stock actual, proyecciones
  - [ ] **Hojas de gasto**: Pendientes de aprobaci√≥n, aprobadas, rechazadas, totales
  - [ ] **Desempe√±o por t√©cnico**: Cirug√≠as atendidas, tiempos, incidencias
  - [ ] **Facturaci√≥n por cliente**: Total facturado, pendiente, mora
  - [ ] **Eficiencia log√≠stica**: Tiempos de entrega, errores, utilizaci√≥n de mensajeros
- [ ] Filtros avanzados por fecha, cliente, hospital, t√©cnico, estado
- [ ] Gr√°ficas interactivas (tendencias, comparativas)
- [ ] Guardar configuraciones de reportes favoritos

**Estructura sugerida**:
```
src/app/features/internal/reportes/
‚îú‚îÄ‚îÄ reportes-shell/
‚îÇ   ‚îî‚îÄ‚îÄ reportes-routing.ts
‚îú‚îÄ‚îÄ reportes-list/
‚îÇ   ‚îú‚îÄ‚îÄ reportes-list.component.ts      (seleccionar tipo de reporte)
‚îÇ   ‚îî‚îÄ‚îÄ reportes-list.component.html
‚îú‚îÄ‚îÄ reportes-cirugia/
‚îÇ   ‚îî‚îÄ‚îÄ reportes-cirugia.component.ts
‚îú‚îÄ‚îÄ reportes-inventario/
‚îÇ   ‚îî‚îÄ‚îÄ reportes-inventario.component.ts
‚îú‚îÄ‚îÄ reportes-hojas-gasto/
‚îÇ   ‚îî‚îÄ‚îÄ reportes-hojas-gasto.component.ts
‚îú‚îÄ‚îÄ reportes-facturacion/
‚îÇ   ‚îî‚îÄ‚îÄ reportes-facturacion.component.ts
‚îî‚îÄ‚îÄ data-access/
    ‚îî‚îÄ‚îÄ reportes.service.ts
```

**Justificaci√≥n**: Los coordinadores regionales necesitan reportes para tomar decisiones estrat√©gicas. Mencionado por todas las √°reas.

**Librer√≠as sugeridas**:
- **ExcelJS**: Exportaci√≥n a Excel
- **jsPDF + jsPDF-AutoTable**: Exportaci√≥n a PDF
- **Chart.js**: Gr√°ficas interactivas

---

## üü† **PRIORIDAD ALTA** (Semana 3-5)

### **4. M√≥dulo de Cotizaciones** ‚≠ê‚≠ê‚≠ê‚≠ê
- **Estado**: ‚ùå NO EXISTE (mencionado 5 veces en requerimientos.txt)
- **Impacto**: ALTO - Aumentar tasa de conversi√≥n comercial
- **Complejidad**: MEDIA-ALTA (5-6 d√≠as)
- **Ubicaci√≥n**: `src/app/features/internal/cotizaciones/`

**Funcionalidades requeridas:**
- [ ] CRUD completo de cotizaciones
- [ ] Crear cotizaci√≥n desde productos/kits predefinidos
- [ ] Estados del flujo:
  - `borrador`: En creaci√≥n
  - `enviada`: Enviada al cliente
  - `aprobada`: Cliente acept√≥
  - `rechazada`: Cliente rechaz√≥
  - `vencida`: Pas√≥ fecha de vencimiento sin respuesta
- [ ] Campo `motivo_rechazo` para an√°lisis
- [ ] Alertas de seguimiento (3 d√≠as sin respuesta)
- [ ] Convertir cotizaci√≥n aprobada en cirug√≠a autom√°ticamente
- [ ] Historial completo de cotizaciones por cliente
- [ ] Plantillas de cotizaci√≥n por tipo de cirug√≠a
- [ ] C√°lculo autom√°tico de subtotales, IVA, total
- [ ] Adjuntar t√©rminos y condiciones
- [ ] Exportar cotizaci√≥n a PDF para enviar

**Tablas necesarias**:
```sql
CREATE TABLE cotizaciones (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  numero_cotizacion TEXT UNIQUE NOT NULL,
  cliente_id UUID REFERENCES clientes(id) ON DELETE CASCADE,
  tipo_cirugia_id UUID REFERENCES tipos_cirugia(id),
  estado cotizacion_estado NOT NULL DEFAULT 'borrador',
  fecha_emision DATE NOT NULL DEFAULT CURRENT_DATE,
  fecha_vencimiento DATE NOT NULL,
  subtotal DECIMAL(12,2) NOT NULL,
  iva DECIMAL(12,2) NOT NULL DEFAULT 0,
  total DECIMAL(12,2) NOT NULL,
  observaciones TEXT,
  motivo_rechazo TEXT,
  terminos_condiciones TEXT,
  created_by UUID REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE cotizacion_estado AS ENUM (
  'borrador',
  'enviada',
  'aprobada',
  'rechazada',
  'vencida'
);

CREATE TABLE cotizacion_items (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  cotizacion_id UUID REFERENCES cotizaciones(id) ON DELETE CASCADE,
  producto_id UUID REFERENCES productos(id),
  descripcion TEXT NOT NULL,
  cantidad INTEGER NOT NULL CHECK (cantidad > 0),
  precio_unitario DECIMAL(12,2) NOT NULL,
  precio_total DECIMAL(12,2) NOT NULL,
  observaciones TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- √çndices
CREATE INDEX idx_cotizaciones_cliente ON cotizaciones(cliente_id);
CREATE INDEX idx_cotizaciones_estado ON cotizaciones(estado);
CREATE INDEX idx_cotizaciones_fecha_emision ON cotizaciones(fecha_emision);
CREATE INDEX idx_cotizacion_items_cotizacion ON cotizacion_items(cotizacion_id);

-- RLS Policies (ajustar seg√∫n roles)
ALTER TABLE cotizaciones ENABLE ROW LEVEL SECURITY;
ALTER TABLE cotizacion_items ENABLE ROW LEVEL SECURITY;

-- Funci√≥n para generar n√∫mero de cotizaci√≥n
CREATE OR REPLACE FUNCTION generate_numero_cotizacion()
RETURNS TRIGGER AS $$
BEGIN
  NEW.numero_cotizacion := 'COT-' || TO_CHAR(CURRENT_DATE, 'YYYY') || '-' || 
                           LPAD(NEXTVAL('cotizaciones_seq')::TEXT, 6, '0');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE SEQUENCE cotizaciones_seq START 1;
CREATE TRIGGER trigger_generate_numero_cotizacion
  BEFORE INSERT ON cotizaciones
  FOR EACH ROW
  EXECUTE FUNCTION generate_numero_cotizacion();
```

**Justificaci√≥n**: Comerciales pierden ventas por falta de seguimiento estructurado a cotizaciones. Sistema actual es manual y disperso.

---

### **5. Geolocalizaci√≥n en Tiempo Real** ‚≠ê‚≠ê‚≠ê‚≠ê
- **Estado**: ‚ö†Ô∏è Chat tiene compartir ubicaci√≥n puntual, pero NO tracking continuo
- **Impacto**: ALTO - Seguridad, confianza del cliente, trazabilidad
- **Complejidad**: ALTA (6-7 d√≠as + integraci√≥n Maps API)
- **Ubicaci√≥n**: `src/app/features/internal/logistica/mapa-envios/`

**Funcionalidades requeridas:**
- [ ] Tracking en tiempo real de mensajeros en ruta
- [ ] Mapa interactivo con todos los env√≠os activos
- [ ] Marcadores diferenciados por estado:
  - üü¢ Verde: Programado (pr√≥ximo a salir)
  - üîµ Azul: En tr√°nsito
  - ‚úÖ Verde check: Entregado
- [ ] ETA (tiempo estimado de llegada) calculado din√°micamente
- [ ] Alertas de desv√≠o de ruta no autorizado
- [ ] Historial de rutas realizadas (replay)
- [ ] Panel lateral con lista de env√≠os activos
- [ ] Click en marcador muestra detalle del env√≠o
- [ ] Actualizaci√≥n autom√°tica cada 30 segundos

**Tecnolog√≠as sugeridas**:
- **Leaflet.js** (open source, sin l√≠mites API) + OpenStreetMap
  - O **Google Maps API** (tiene costo pero mejor precisi√≥n)
- **Supabase Realtime** para actualizaci√≥n de ubicaciones
- **Geolocation API** del navegador para capturar ubicaci√≥n del mensajero

**Cambios en base de datos**:
```sql
-- Extender tabla envios
ALTER TABLE envios ADD COLUMN ubicacion_actual GEOGRAPHY(Point, 4326);
ALTER TABLE envios ADD COLUMN ultima_actualizacion_ubicacion TIMESTAMPTZ;

-- Tabla para historial de ubicaciones (opcional, para replay)
CREATE TABLE envio_ubicaciones_historial (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  envio_id UUID REFERENCES envios(id) ON DELETE CASCADE,
  ubicacion GEOGRAPHY(Point, 4326) NOT NULL,
  velocidad DECIMAL(5,2),  -- km/h
  timestamp TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_envio_ubicaciones_envio ON envio_ubicaciones_historial(envio_id);
CREATE INDEX idx_envio_ubicaciones_timestamp ON envio_ubicaciones_historial(timestamp);
```

**Componente principal**:
```typescript
src/app/features/internal/logistica/mapa-envios/
‚îú‚îÄ‚îÄ mapa-envios.component.ts       (vista tipo "aeropuerto" con mapa)
‚îú‚îÄ‚îÄ mapa-envios.component.html
‚îú‚îÄ‚îÄ mapa-envios.component.css
‚îî‚îÄ‚îÄ services/
    ‚îî‚îÄ‚îÄ geolocalizacion.service.ts  (tracking, c√°lculo ETA, alertas)
```

**Justificaci√≥n**: Los 3 log√≠sticos entrevistados lo mencionaron como cr√≠tico para:
- Reducir incidencias y reclamos de clientes
- Mejorar coordinaci√≥n en tiempo real
- Detectar desv√≠os o retrasos inmediatamente
- Aumentar confianza del cliente

---

### **6. Optimizaci√≥n de Rutas y Asignaci√≥n Inteligente** ‚≠ê‚≠ê‚≠ê
- **Estado**: ‚ùå NO EXISTE - Asignaci√≥n manual actual
- **Impacto**: MEDIO-ALTO - Eficiencia operativa, reducci√≥n de costos
- **Complejidad**: ALTA (7-8 d√≠as + algoritmo)
- **Ubicaci√≥n**: `src/app/shared/services/rutas.service.ts`

**Funcionalidades requeridas:**
- [ ] Algoritmo de asignaci√≥n inteligente de mensajeros
- [ ] Scoring autom√°tico considerando:
  - [ ] Distancia al punto de recogida (menor = mejor)
  - [ ] Carga actual de entregas pendientes (menor = mejor)
  - [ ] Urgencia de entregas actuales (cirug√≠a < 24h prioritaria)
  - [ ] Estado del mensajero (disponible > ocupado)
  - [ ] Zona de operaci√≥n preferencial
- [ ] Sugerencia de ruta √≥ptima para m√∫ltiples entregas
- [ ] Priorizaci√≥n autom√°tica (urgente < 24h primero)
- [ ] Visualizaci√≥n de ruta sugerida en mapa
- [ ] Posibilidad de override manual con justificaci√≥n

**Algoritmo sugerido** (Scoring System):
```typescript
interface MensajeroScore {
  mensajero_id: string;
  nombre: string;
  score: number;  // Mayor score = mejor opci√≥n
  factores: {
    distancia: number;      // 0-100 (invertido: menor distancia = mayor puntaje)
    carga: number;          // 0-100 (invertido: menos entregas = mayor puntaje)
    urgencia: number;       // 0-100 (considera urgencia de sus entregas actuales)
    disponibilidad: number; // 0 o 100 (disponible o no)
  };
}

// F√≥rmula de scoring (ajustable seg√∫n prioridades del negocio)
score = (distancia * 0.3) + (carga * 0.25) + (urgencia * 0.25) + (disponibilidad * 0.2)
```

**Justificaci√≥n**: Reduce tiempos de entrega, costos operativos y mejora experiencia del cliente. Mencionado por log√≠stica y coordinadores regionales.

---

## üü° **PRIORIDAD MEDIA** (Semana 6-8)

### **7. Registro de Tiempos Muertos** ‚≠ê‚≠ê‚≠ê
- **Estado**: ‚ùå NO EXISTE
- **Impacto**: MEDIO - Mejora de eficiencia t√©cnica, an√°lisis de causas
- **Complejidad**: BAJA (2-3 d√≠as)
- **Ubicaci√≥n**: Integrar en `CirugiaEjecucionComponent`

**Funcionalidades requeridas:**
- [ ] Formulario simple durante ejecuci√≥n de cirug√≠a
- [ ] Motivos predefinidos:
  - Espera de cliente/paciente
  - Falta de insumo/producto
  - Retraso en quir√≥fano
  - Problema t√©cnico/equipo
  - Otros (especificar)
- [ ] Timestamp inicio/fin autom√°tico
- [ ] C√°lculo autom√°tico de duraci√≥n
- [ ] Mostrar en hoja de gasto y reporte de cirug√≠a
- [ ] An√°lisis de causas m√°s frecuentes (para mejora continua)

**Tabla nueva**:
```sql
CREATE TABLE tiempos_muertos_cirugia (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  cirugia_id UUID REFERENCES cirugias(id) ON DELETE CASCADE,
  motivo tiempo_muerto_motivo NOT NULL,
  descripcion TEXT,
  timestamp_inicio TIMESTAMPTZ NOT NULL,
  timestamp_fin TIMESTAMPTZ,
  duracion_minutos INTEGER GENERATED ALWAYS AS 
    (EXTRACT(EPOCH FROM (timestamp_fin - timestamp_inicio)) / 60) STORED,
  reportado_por UUID REFERENCES profiles(id),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE tiempo_muerto_motivo AS ENUM (
  'espera_paciente',
  'falta_insumo',
  'retraso_quirofano',
  'problema_tecnico',
  'problema_equipo',
  'coordinacion_personal',
  'otro'
);

CREATE INDEX idx_tiempos_muertos_cirugia ON tiempos_muertos_cirugia(cirugia_id);
```

**Justificaci√≥n**: T√©cnicos y coordinadores necesitan medir tiempos muertos para identificar cuellos de botella y mejorar eficiencia.

---

### **8. Formulario de Eventualidades e Incidentes** ‚≠ê‚≠ê‚≠ê
- **Estado**: ‚ö†Ô∏è Parcial - hay observaciones en varias partes, falta estructura unificada
- **Impacto**: MEDIO - Trazabilidad de problemas, mejora continua
- **Complejidad**: BAJA-MEDIA (2-3 d√≠as)
- **Ubicaci√≥n**: `src/app/features/internal/eventualidades/`

**Funcionalidades requeridas:**
- [ ] Formulario estructurado de reporte de incidencias
- [ ] Categor√≠as:
  - Cancelaci√≥n de cirug√≠a
  - Retraso significativo (> 2 horas)
  - Problema con kit (incompleto, producto defectuoso)
  - Problema en quir√≥fano/hospital
  - Problema con cliente
  - Accidente/Seguridad
  - Otros
- [ ] Nivel de severidad: Baja, Media, Alta, Cr√≠tica
- [ ] Adjuntar fotos (opcional, √∫til para evidencia)
- [ ] Descripci√≥n detallada
- [ ] Acciones tomadas
- [ ] Notificaci√≥n autom√°tica a comercial + log√≠stica + admin
- [ ] Seguimiento de resoluci√≥n
- [ ] Historial de eventualidades por cirug√≠a/t√©cnico

**Tabla nueva**:
```sql
CREATE TABLE eventualidades (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  cirugia_id UUID REFERENCES cirugias(id) ON DELETE CASCADE,
  categoria eventualidad_categoria NOT NULL,
  severidad eventualidad_severidad NOT NULL,
  titulo TEXT NOT NULL,
  descripcion TEXT NOT NULL,
  acciones_tomadas TEXT,
  fotos_urls TEXT[],  -- Array de URLs a storage de Supabase
  estado eventualidad_estado DEFAULT 'reportada',
  reportado_por UUID REFERENCES profiles(id),
  resuelto_por UUID REFERENCES profiles(id),
  fecha_reporte TIMESTAMPTZ DEFAULT NOW(),
  fecha_resolucion TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TYPE eventualidad_categoria AS ENUM (
  'cancelacion',
  'retraso',
  'problema_kit',
  'problema_quirofano',
  'problema_cliente',
  'accidente',
  'otro'
);

CREATE TYPE eventualidad_severidad AS ENUM ('baja', 'media', 'alta', 'critica');
CREATE TYPE eventualidad_estado AS ENUM ('reportada', 'en_revision', 'resuelta', 'cerrada');

CREATE INDEX idx_eventualidades_cirugia ON eventualidades(cirugia_id);
CREATE INDEX idx_eventualidades_estado ON eventualidades(estado);
```

**Justificaci√≥n**: Permite identificar patrones de problemas y tomar acciones correctivas. Mencionado por t√©cnicos y coordinadores.

---

### **9. Proyecciones de Inventario** ‚≠ê‚≠ê‚≠ê
- **Estado**: ‚ùå NO EXISTE
- **Impacto**: MEDIO - Prevenci√≥n de quiebres, planificaci√≥n de compras
- **Complejidad**: MEDIA (4 d√≠as)
- **Ubicaci√≥n**: `src/app/features/internal/inventario/proyecciones-inventario/`

**Funcionalidades requeridas:**
- [ ] Proyecci√≥n de agotamiento basada en consumo hist√≥rico (√∫ltimos 30/60/90 d√≠as)
- [ ] Simular impacto de nuevos clientes/cirug√≠as en stock
- [ ] Alertas tempranas (15 d√≠as antes de agotamiento proyectado)
- [ ] Sugerencias de compra con cantidades recomendadas
- [ ] Considerar lead time de proveedores
- [ ] Proyecci√≥n por l√≠nea de producto
- [ ] Exportar proyecciones a Excel

**Justificaci√≥n**: Permite planificaci√≥n proactiva de compras y evita quiebres de stock que impactan cirug√≠as.

---

### **10. Confirmaci√≥n Autom√°tica de Recursos** ‚≠ê‚≠ê
- **Estado**: ‚ö†Ô∏è Parcial - validaci√≥n de stock existe en kit-builder, falta automatizaci√≥n en formulario cirug√≠a
- **Impacto**: BAJO-MEDIO - Reduce errores de programaci√≥n
- **Complejidad**: BAJA (1-2 d√≠as)
- **Ubicaci√≥n**: Integrar en `CirugiaFormComponent`

**Funcionalidades requeridas:**
- [ ] Al crear/editar cirug√≠a, validar autom√°ticamente:
  - [ ] Stock disponible para productos del tipo de cirug√≠a
  - [ ] Disponibilidad de t√©cnico asignado (no tiene otra cirug√≠a al mismo tiempo)
  - [ ] Ning√∫n conflicto de horario en el mismo hospital
- [ ] Mostrar alerta visual si alg√∫n recurso no est√° disponible
- [ ] Permitir override manual con justificaci√≥n obligatoria
- [ ] Sugerir fecha/hora alternativa si hay conflictos

**Justificaci√≥n**: Reduce cancelaciones de √∫ltimo momento por falta de recursos o conflictos de agenda.

---

### **11. Panel Motivacional Comercial** ‚≠ê‚≠ê
- **Estado**: ‚ùå NO EXISTE
- **Impacto**: BAJO - Engagement comercial, gamificaci√≥n
- **Complejidad**: BAJA (2 d√≠as)
- **Ubicaci√≥n**: Integrar en `ComercialDashboardComponent`

**Funcionalidades requeridas:**
- [ ] Metas del mes (configurables por admin)
- [ ] Progreso visual (circular gauge o barra de progreso)
- [ ] Ranking de vendedores (opcional, an√≥nimo o con nombres)
- [ ] Frases motivacionales rotativas
- [ ] Logros desbloqueados (gamificaci√≥n):
  - "Primera venta del mes"
  - "10 cirug√≠as cerradas"
  - "Cliente recuperado"
  - "Mes sin cancelaciones"
- [ ] Hist√≥rico de logros

**Justificaci√≥n**: Mencionado por comerciales como "nice to have" para mantener motivaci√≥n y competencia sana.

---

## üìÖ **ROADMAP DETALLADO DE IMPLEMENTACI√ìN**

### **Sprint 1: Dashboards & KPIs** (Semana 1-2)
**Objetivo**: Dar visibilidad de desempe√±o a los 3 roles

**Tareas**:
1. ‚úÖ **D√≠a 1-3**: Crear `ComercialDashboardComponent`
   - Vista unificada ventas/facturaci√≥n
   - KPIs b√°sicos calculados
   - Agenda consolidada con filtros
   - Panel "¬øC√≥mo voy hoy?" con progreso del d√≠a

2. ‚úÖ **D√≠a 4-7**: Crear `KpiDashboardComponent` compartido
   - Interface `KpiConfig` y `KpiDefinition`
   - C√°lculo de KPIs para 3 roles desde servicios
   - Gr√°ficas con Chart.js (line, bar, doughnut)
   - Filtros por per√≠odo (hoy, semana, mes, personalizado)

3. ‚úÖ **D√≠a 8**: Mejorar `TecnicoDashboardComponent`
   - Integrar KPIs de desempe√±o t√©cnico
   - Agregar m√©tricas de tiempo promedio
   - Mostrar incidencias reportadas

4. ‚úÖ **D√≠a 9**: Mejorar `LogisticaDashboardComponent`
   - Agregar KPIs log√≠sticos calculados
   - Panel tipo "aeropuerto" mejorado con m√°s info
   - Alertas priorizadas por urgencia

5. ‚úÖ **D√≠a 10**: Testing y ajustes

**Resultado**: Los 3 roles tienen dashboards completos con m√©tricas en tiempo real.

---

### **Sprint 2: Reportes** (Semana 3)
**Objetivo**: An√°lisis y exportaci√≥n de datos

**Tareas**:
1. ‚úÖ **D√≠a 1**: Crear estructura del m√≥dulo Reportes
   - Routing y shell component
   - Service base para reportes

2. ‚úÖ **D√≠a 2**: Implementar reportes de cirug√≠as
   - Filtros por per√≠odo, estado, hospital, t√©cnico
   - Gr√°ficas de tendencias
   - Exportaci√≥n Excel/PDF

3. ‚úÖ **D√≠a 3**: Implementar reportes de inventario
   - Movimientos (entradas/salidas)
   - Stock actual vs m√≠nimo
   - Proyecciones simples

4. ‚úÖ **D√≠a 4**: Implementar reportes de hojas de gasto y facturaci√≥n
   - Pendientes de aprobaci√≥n
   - Totales por per√≠odo
   - Desglose por cliente

5. ‚úÖ **D√≠a 5**: Integraci√≥n de librer√≠as de exportaci√≥n
   - ExcelJS para Excel
   - jsPDF para PDF
   - Testing y ajustes

**Resultado**: Coordinadores pueden generar reportes detallados para an√°lisis y toma de decisiones.

---

### **Sprint 3: Cotizaciones** (Semana 4-5)
**Objetivo**: Mejorar tasa de conversi√≥n comercial

**Tareas**:
1. ‚úÖ **D√≠a 1**: Crear tablas en base de datos
   - `cotizaciones` con todos los campos
   - `cotizacion_items` para detalle
   - Triggers y funciones para n√∫mero autom√°tico
   - RLS policies

2. ‚úÖ **D√≠a 2-3**: Crear m√≥dulo Cotizaciones
   - Routing y shell component
   - Models e interfaces TypeScript
   - Service con CRUD completo

3. ‚úÖ **D√≠a 4-5**: Implementar formulario de creaci√≥n/edici√≥n
   - Selecci√≥n de cliente y tipo de cirug√≠a
   - Agregar/quitar productos din√°micamente
   - C√°lculo autom√°tico de totales
   - Validaciones

4. ‚úÖ **D√≠a 6**: Implementar lista y detalle de cotizaciones
   - Vista de lista con filtros por estado
   - Vista de detalle con timeline de estados
   - Botones de acci√≥n seg√∫n estado

5. ‚úÖ **D√≠a 7**: Implementar flujo de aprobaci√≥n
   - Enviar cotizaci√≥n ‚Üí notificar cliente
   - Aprobar ‚Üí convertir a cirug√≠a
   - Rechazar ‚Üí registrar motivo
   - Alertas de seguimiento (3 d√≠as sin respuesta)

6. ‚úÖ **D√≠a 8**: Exportar cotizaci√≥n a PDF
   - Plantilla con logo y dise√±o corporativo
   - Incluir t√©rminos y condiciones

7. ‚úÖ **D√≠a 9-10**: Testing completo y ajustes

**Resultado**: Control completo de cotizaciones desde emisi√≥n hasta cierre o rechazo.

---

### **Sprint 4: Geolocalizaci√≥n** (Semana 6-7)
**Objetivo**: Tracking en tiempo real de env√≠os

**Tareas**:
1. ‚úÖ **D√≠a 1**: Configurar Leaflet.js
   - Instalar dependencias
   - Crear servicio de geolocalizaci√≥n
   - Configurar mapa base con OpenStreetMap

2. ‚úÖ **D√≠a 2-3**: Extender base de datos
   - Agregar campos de ubicaci√≥n a `envios`
   - Crear tabla `envio_ubicaciones_historial`
   - Funci√≥n para actualizar ubicaci√≥n desde app del mensajero

3. ‚úÖ **D√≠a 4-5**: Implementar `MapaEnviosComponent`
   - Mapa interactivo con marcadores por estado
   - Panel lateral con lista de env√≠os activos
   - Click en marcador muestra detalle

4. ‚úÖ **D√≠a 6-7**: Implementar tracking en tiempo real
   - Supabase Realtime subscription a ubicaciones
   - Actualizaci√≥n autom√°tica de marcadores cada 30s
   - C√°lculo de ETA din√°mico

5. ‚úÖ **D√≠a 8**: Implementar alertas de desv√≠o
   - Detectar si mensajero se aleja mucho de ruta
   - Notificar a log√≠stica

6. ‚úÖ **D√≠a 9**: Implementar historial de rutas (replay)
   - Reproducir ruta realizada
   - Analizar tiempos y paradas

7. ‚úÖ **D√≠a 10**: Testing en campo y ajustes

**Resultado**: Visibilidad completa de env√≠os en tr√°nsito con mapa en tiempo real.

---

### **Sprint 5: Optimizaci√≥n de Rutas** (Semana 8)
**Objetivo**: Asignaci√≥n inteligente de mensajeros

**Tareas**:
1. ‚úÖ **D√≠a 1-2**: Implementar servicio de rutas
   - Interface `MensajeroScore`
   - Algoritmo de scoring
   - C√°lculo de distancias (Haversine formula o API)

2. ‚úÖ **D√≠a 3-4**: Integrar en asignaci√≥n de mensajeros
   - Sugerir mejor mensajero autom√°ticamente
   - Mostrar scoring y factores
   - Permitir override manual

3. ‚úÖ **D√≠a 5-6**: Implementar optimizaci√≥n de ruta m√∫ltiple
   - Algoritmo TSP (Traveling Salesman Problem) simplificado
   - Sugerir orden √≥ptimo de entregas
   - Visualizar ruta sugerida en mapa

4. ‚úÖ **D√≠a 7**: Testing y ajustes del algoritmo

**Resultado**: Reducci√≥n de tiempos de entrega y costos operativos mediante asignaci√≥n inteligente.

---

### **Sprint 6: Funcionalidades Complementarias** (Semana 9-10)
**Objetivo**: Completar features menores

**Tareas**:
1. ‚úÖ **D√≠a 1-2**: Registro de tiempos muertos
   - Crear tabla y enum
   - Integrar formulario en `CirugiaEjecucionComponent`
   - Mostrar en reportes

2. ‚úÖ **D√≠a 3-4**: Formulario de eventualidades
   - Crear tabla y enums
   - M√≥dulo de eventualidades con CRUD
   - Upload de fotos a Supabase Storage
   - Notificaciones autom√°ticas

3. ‚úÖ **D√≠a 5-7**: Proyecciones de inventario
   - Algoritmo de proyecci√≥n basado en consumo hist√≥rico
   - Componente de visualizaci√≥n
   - Alertas tempranas
   - Sugerencias de compra

4. ‚úÖ **D√≠a 8**: Confirmaci√≥n autom√°tica de recursos
   - Validaciones en `CirugiaFormComponent`
   - Alertas visuales
   - Override con justificaci√≥n

5. ‚úÖ **D√≠a 9**: Panel motivacional
   - Componente con metas y progreso
   - Sistema de logros
   - Integrar en dashboard comercial

6. ‚úÖ **D√≠a 10**: Testing final y ajustes

**Resultado**: App 100% completa seg√∫n requerimientos especificados.

---

## üéØ **RESUMEN EJECUTIVO**

### **M√©tricas del Proyecto**
- **Tiempo Total Estimado**: 8-10 semanas (40-50 d√≠as laborables)
- **Nivel de Completitud Actual**: ~85%
- **Lo que Falta**: 15% (mayormente features anal√≠ticas y de optimizaci√≥n)
- **Esfuerzo Restante**: ~40 d√≠as-persona

### **Distribuci√≥n de Esfuerzo por Prioridad**
- üî¥ **CR√çTICO** (Sem 1-2): 30% del esfuerzo - Dashboards, KPIs, Reportes
- üü† **ALTO** (Sem 3-5): 45% del esfuerzo - Cotizaciones, Geolocalizaci√≥n, Rutas
- üü° **MEDIO** (Sem 6-10): 25% del esfuerzo - Features complementarias

### **Priorizaci√≥n Clara**
1. **CR√çTICO** (1-2 sem): Dashboard Comercial + KPIs para 3 roles + Reportes
2. **ALTO** (3-5 sem): Cotizaciones + Geolocalizaci√≥n + Optimizaci√≥n de Rutas
3. **MEDIO** (6-10 sem): Tiempos muertos + Eventualidades + Proyecciones + Features menores

### **Recomendaci√≥n Estrat√©gica**
**Enf√≥cate primero en los Dashboards y KPIs** (Sprint 1-2). Son los m√°s solicitados por los 3 roles y tienen mayor impacto inmediato en satisfacci√≥n de usuarios. Una vez que todos tengan visibilidad de su desempe√±o, contin√∫a con Reportes y Cotizaciones.

La geolocalizaci√≥n es importante pero puede esperar hasta semana 6 si recursos son limitados. Lo operacional (CRUD, notificaciones, trazabilidad) ya est√° **s√≥lido y funcional**.

### **Riesgos Identificados**
1. **Geolocalizaci√≥n**: Requiere pruebas en campo con conexi√≥n de datos real
2. **Optimizaci√≥n de rutas**: Algoritmo puede requerir ajustes seg√∫n uso real
3. **Reportes**: Exportaci√≥n a PDF puede tener problemas de formato con datos largos
4. **Cotizaciones**: Integraci√≥n con sistema de facturaci√≥n externo (si aplica)

### **Pr√≥ximos Pasos Inmediatos**
1. ‚úÖ Crear `ComercialDashboardComponent` (3 d√≠as)
2. ‚úÖ Implementar c√°lculo de KPIs b√°sicos en servicios existentes (2 d√≠as)
3. ‚úÖ Crear `KpiDashboardComponent` compartido con Chart.js (3 d√≠as)
4. ‚úÖ Mejorar dashboards de T√©cnico y Log√≠stica con KPIs (2 d√≠as)

---

## üìù **NOTAS Y CONSIDERACIONES**

### **Tecnolog√≠as Adicionales Necesarias**
- **Chart.js**: Gr√°ficas interactivas para KPIs y reportes
- **ExcelJS**: Exportaci√≥n de reportes a Excel
- **jsPDF + jsPDF-AutoTable**: Exportaci√≥n de reportes y cotizaciones a PDF
- **Leaflet.js**: Mapas interactivos para geolocalizaci√≥n
- **date-fns** o **Day.js**: Manipulaci√≥n avanzada de fechas para reportes

### **Consideraciones de Rendimiento**
- KPIs deben calcularse de forma eficiente (usar √≠ndices en BD, cachear si es posible)
- Reportes con muchos datos deben implementar paginaci√≥n
- Mapa con muchos marcadores debe usar clustering (Leaflet.markercluster)
- Realtime subscriptions deben limitarse solo a datos necesarios

### **Consideraciones de UX**
- Dashboards deben cargar r√°pido (< 2 segundos)
- Gr√°ficas deben ser responsive y legibles en m√≥vil
- Exportaciones deben mostrar progress indicator
- Mapas deben tener controles intuitivos (zoom, centrar, filtros)

### **Testing Recomendado**
- Unit tests para algoritmos (scoring, proyecciones, ETA)
- Integration tests para flujos cr√≠ticos (cotizaci√≥n ‚Üí cirug√≠a)
- E2E tests para dashboards y reportes
- Testing en campo para geolocalizaci√≥n con diferentes conexiones

---

## üîÑ **CONTROL DE CAMBIOS**

### **Versi√≥n 1.0** - 13 de Octubre, 2025
- ‚úÖ Documento inicial creado
- ‚úÖ An√°lisis completo de estado actual (85% completitud)
- ‚úÖ Identificaci√≥n de 11 funcionalidades faltantes
- ‚úÖ Priorizaci√≥n en 3 niveles (Cr√≠tica, Alta, Media)
- ‚úÖ Roadmap detallado en 6 sprints (8-10 semanas)
- ‚úÖ Estimaciones de esfuerzo y complejidad
- ‚úÖ Especificaciones t√©cnicas para cada funcionalidad
- ‚úÖ Recomendaciones estrat√©gicas de implementaci√≥n

### **Versi√≥n 1.1** - 13 de Octubre, 2025 (Mismo d√≠a)
- ‚úÖ **Correcci√≥n de permisos de navegaci√≥n para rol T√©cnico**:
  - Modificado `role-permissions.config.ts`: T√©cnicos ahora solo acceden a `/internal/agenda/mi-agenda` (NO a `/internal/agenda` general)
  - Modificado `internal-home.component.ts`: Men√∫ muestra "Mi Agenda" para t√©cnicos y "Agenda" para comercial/log√≠stica
  - **Justificaci√≥n**: Los t√©cnicos solo necesitan ver SUS cirug√≠as asignadas, no toda la agenda general
  - **Componente afectado**: `AgendaTecnicoComponent` (`/internal/agenda/mi-agenda`)
  - **Roles con acceso a agenda general**: `admin`, `comercial`, `logistica`
  - **Roles con acceso a "Mi Agenda"**: `soporte_tecnico`

### **Pr√≥ximas Actualizaciones**
- [ ] Versi√≥n 1.2: Actualizar estado despu√©s de Sprint 1 (dashboards)
- [ ] Versi√≥n 1.3: Actualizar estado despu√©s de Sprint 2 (reportes)
- [ ] Versi√≥n 1.4: Ajustar estimaciones seg√∫n avance real
- [ ] Versi√≥n 2.0: Revisi√≥n completa al finalizar implementaci√≥n

---

**Documento Vivo**: Este roadmap debe actualizarse semanalmente con el progreso real, ajustes de prioridades y nuevos hallazgos durante la implementaci√≥n.
