# FASE 2 - PREPARACI√ìN DE KIT QUIR√öRGICO

## üìã IMPLEMENTACI√ìN COMPLETA

### **Componente:** `kit-preparacion.component.ts`
**Ruta:** `/internal/logistica/kit-preparacion/:id`

---

## üéØ FUNCIONALIDADES IMPLEMENTADAS

### 1. **Carga de Datos del Kit**
- Obtiene kit completo con productos, cirug√≠a, hospital y cliente
- Carga inventarios disponibles por ubicaci√≥n para cada producto
- Calcula stock total disponible por producto
- Detecta autom√°ticamente alertas de stock y vencimiento

### 2. **Validaciones Autom√°ticas**

#### **Alerta de Stock Insuficiente**
```typescript
alertaStock = stockTotal < cantidad_solicitada
```
- ‚ö†Ô∏è Muestra badge rojo si no hay suficiente inventario
- Impide preparar m√°s de lo disponible

#### **Alerta de Vencimiento Pr√≥ximo**
```typescript
alertaVencimiento = diasRestantes <= 30
```
- ‚ö†Ô∏è Muestra badge naranja si el producto vence en menos de 30 d√≠as
- Alerta visual para productos pr√≥ximos a vencer

### 3. **Formulario de Preparaci√≥n (Picking)**

Por cada producto se captura:

| Campo | Tipo | Validaci√≥n | Descripci√≥n |
|-------|------|------------|-------------|
| `cantidad_preparada` | Number | 0 ‚â§ cantidad ‚â§ stock_disponible | Cantidad f√≠sica preparada |
| `ubicacion_seleccionada` | Select | Requerido | De qu√© bodega/ubicaci√≥n se toma |
| `lote` | Text | Opcional | C√≥digo del lote f√≠sico |
| `fecha_vencimiento` | Date | Opcional | Fecha de vencimiento del lote |
| `observaciones` | Textarea | Opcional | Notas sobre el producto |

**Validaci√≥n de cantidad:**
```typescript
validarCantidad(producto) {
  if (cantidad > stock_disponible) {
    cantidad = stock_disponible;
    alert('Stock insuficiente');
  }
}
```

### 4. **Proceso de Finalizaci√≥n**

Al hacer clic en "Finalizar Preparaci√≥n":

#### **Paso 1: Validaci√≥n**
- Verifica que al menos 1 producto tenga `cantidad_preparada > 0`
- Si hay productos incompletos ‚Üí muestra confirmaci√≥n

#### **Paso 2: Actualizar `kit_productos`**
```sql
UPDATE kit_productos SET
  cantidad_preparada = X,
  lote = 'LOTE-2025-001',
  fecha_vencimiento = '2026-05-15',
  observaciones = 'Notas...'
WHERE id = producto_id;
```

#### **Paso 3: Registrar Movimientos de Inventario**
Por cada producto preparado:
```sql
-- Movimiento de salida
INSERT INTO movimientos_inventario (
  inventario_id,
  producto_id,
  tipo,
  cantidad,
  motivo,
  usuario_id,
  ubicacion_origen,
  referencia,
  lote,
  fecha_vencimiento,
  observaciones
) VALUES (
  inv_id,
  prod_id,
  'salida',
  cantidad_preparada,
  'Kit quir√∫rgico',
  user_id,
  'bodega_principal',
  'KIT-001',
  'LOTE-XXX',
  '2026-05-15',
  'Kit KIT-001 - Preparaci√≥n para cirug√≠a'
);

-- Actualizar inventario
UPDATE inventario SET
  cantidad = cantidad - cantidad_preparada,
  estado = CASE 
    WHEN cantidad - cantidad_preparada <= 0 THEN 'agotado' 
    ELSE 'disponible' 
  END
WHERE id = inv_id;
```

#### **Paso 4: Generar QR √önico**
```typescript
// Formato: KIT-{numero_kit}-{random}-{timestamp}
qrCode = `KIT-${kit.numero_kit}-A7B2C3-1728394857000`;

// Guardar en tabla qr_codes
INSERT INTO qr_codes (
  codigo,
  tipo,
  referencia_id,
  kit_id,
  tipo_validacion,
  es_activo
) VALUES (
  qrCode,
  'kit',
  kit_id,
  kit_id,
  'entrega_cliente',
  true
);
```

#### **Paso 5: Cambiar Estado del Kit**
```sql
UPDATE kits_cirugia SET
  estado = 'listo_envio',
  fecha_preparacion = NOW(),
  logistica_id = user_id,
  qr_code = 'KIT-001-A7B2C3-...',
  ubicacion_actual = 'bodega_principal',
  observaciones = 'Observaciones generales...'
WHERE id = kit_id;
```

#### **Paso 6: Registrar Trazabilidad**
```sql
INSERT INTO kit_trazabilidad (
  kit_id,
  accion,
  estado_anterior,
  estado_nuevo,
  usuario_id,
  ubicacion,
  observaciones
) VALUES (
  kit_id,
  'Listo para despacho',
  'preparando',
  'listo_envio',
  user_id,
  'bodega_principal',
  'Observaciones...'
);
```

### 5. **Modal de Confirmaci√≥n con QR**

Al finalizar exitosamente:
- ‚úÖ Muestra modal con QR generado
- ‚úÖ C√≥digo QR visible (simulado con SVG)
- ‚úÖ Bot√≥n "Imprimir QR" (window.print())
- ‚úÖ Bot√≥n "Volver al Listado"

---

## üìä INTERFAZ DE USUARIO

### **Header**
- Logo Implameq
- Bot√≥n "Volver" a kits pendientes

### **Informaci√≥n del Kit**
Card con:
- N√∫mero de kit
- N√∫mero de cirug√≠a
- Hospital
- Fecha programada
- **Estad√≠sticas:** X/Y Productos Completos
- **Alertas:** Icono ‚ö†Ô∏è si hay problemas

### **Lista de Productos**
Por cada producto, card glassmorphism con:

**Header:**
- Nombre del producto (grande, bold)
- C√≥digo
- Badge de alerta (verde/naranja/rojo)
- Cantidad solicitada (grande, amarillo)

**Formulario:**
- Input de cantidad (con validaci√≥n en tiempo real)
- Select de ubicaci√≥n (muestra stock por ubicaci√≥n)
- Input de lote
- Input de fecha vencimiento
- Textarea de observaciones

**Colores:**
- ‚úÖ Verde: Stock suficiente, sin problemas
- ‚ö†Ô∏è Naranja: Producto pr√≥ximo a vencer (<30 d√≠as)
- ‚ùå Rojo: Stock insuficiente

### **Observaciones Generales**
Textarea grande para notas del kit completo

### **Bot√≥n Principal**
- Grande, amarillo (#C8D900)
- "Finalizar Preparaci√≥n"
- Loading state mientras procesa
- Disabled mientras est√° procesando

---

## üîÑ FLUJO COMPLETO

```mermaid
graph TD
    A[Log√≠stica aprueba kit] --> B[Kit estado: 'preparando']
    B --> C[Navega a /kit-preparacion/:id]
    C --> D[Carga kit y productos]
    D --> E[Muestra formulario de picking]
    E --> F[Log√≠stica completa cantidades]
    F --> G[Valida stock y fechas]
    G --> H[Click 'Finalizar Preparaci√≥n']
    H --> I{¬øProductos incompletos?}
    I -->|S√≠| J[Confirmar continuar]
    I -->|No| K[Procesar]
    J --> K
    K --> L[Actualizar kit_productos]
    L --> M[Registrar movimientos_inventario]
    M --> N[Actualizar inventario]
    N --> O[Generar QR √∫nico]
    O --> P[Cambiar estado a 'listo_envio']
    P --> Q[Registrar trazabilidad]
    Q --> R[Mostrar modal con QR]
    R --> S{Usuario elige}
    S -->|Imprimir| T[window.print]
    S -->|Volver| U[Navegar a kits-pendientes]
```

---

## üé® ESTILOS IMPLEMENTADOS

**Paleta Implameq:**
- Navy: `#10284C` (fondos)
- Turquoise: `#0098A8` (cards, acentos)
- Yellow-Green: `#C8D900` (botones primarios, t√≠tulos)

**Efectos:**
- Glassmorphism: `backdrop-blur-md` + `border-white/20`
- SVG backgrounds con formas geom√©tricas
- Transiciones suaves en hover
- Active states con `scale-95`

---

## üì± SIGUIENTE FASE: RECEPCI√ìN POR CLIENTE

### **Flujo del QR:**

1. **Kit preparado** ‚Üí QR impreso y pegado en kit f√≠sico
2. **Mensajero entrega** kit al hospital/cliente
3. **Cliente recibe** kit con QR visible
4. **Cliente escanea QR** desde su smartphone:
   - Abre app o web m√≥vil
   - Usa c√°mara para escanear
   - Sistema busca kit por `qr_codes.codigo`
5. **Cliente ve pantalla de validaci√≥n:**
   - Nombre del kit
   - Lista de productos con cantidades
   - Checkbox "He verificado el contenido"
   - Canvas para firma digital
   - Bot√≥n "Aprobar Recepci√≥n"
6. **Cliente firma y aprueba:**
   ```sql
   INSERT INTO qr_escaneos (
     qr_code_id,
     usuario_id,
     tipo_accion,
     validado_por_nombre,
     firma_digital,
     kit_id,
     ubicacion,
     resultado
   ) VALUES (
     qr_id,
     null, -- Cliente no tiene usuario
     'recepcion_kit',
     'Dr. Juan P√©rez',
     firma_base64,
     kit_id,
     'Hospital San Jos√©',
     'exitoso'
   );
   
   UPDATE kits_cirugia SET
     estado = 'entregado',
     fecha_recepcion = NOW(),
     cliente_receptor_nombre = 'Dr. Juan P√©rez',
     cliente_receptor_cedula = '1234567890',
     cliente_validacion_fecha = NOW(),
     cliente_validacion_qr = qr_code
   WHERE id = kit_id;
   ```

7. **Sistema registra:**
   - Timestamp de recepci√≥n
   - Nombre y c√©dula de quien recibi√≥
   - Firma digital (base64)
   - Ubicaci√≥n GPS (opcional)
   - Foto de evidencia (opcional)

---

## ‚úÖ CAMPOS DE BD UTILIZADOS

### **Tabla: `kit_productos`**
- ‚úÖ `cantidad_preparada` - Actualizado
- ‚úÖ `lote` - Actualizado
- ‚úÖ `fecha_vencimiento` - Actualizado
- ‚úÖ `observaciones` - Actualizado

### **Tabla: `kits_cirugia`**
- ‚úÖ `estado` - Cambiado a 'listo_envio'
- ‚úÖ `fecha_preparacion` - Timestamp
- ‚úÖ `logistica_id` - Usuario que prepar√≥
- ‚úÖ `qr_code` - QR generado
- ‚úÖ `ubicacion_actual` - 'bodega_principal'
- ‚úÖ `observaciones` - Notas generales

### **Tabla: `movimientos_inventario`**
- ‚úÖ Registra salida por cada producto
- ‚úÖ Tipo: 'salida'
- ‚úÖ Motivo: 'Kit quir√∫rgico'
- ‚úÖ Referencia: numero_kit

### **Tabla: `inventario`**
- ‚úÖ `cantidad` - Decrementada
- ‚úÖ `estado` - Cambiado a 'agotado' si cantidad = 0

### **Tabla: `kit_trazabilidad`**
- ‚úÖ Evento "Listo para despacho"
- ‚úÖ Estado anterior: 'preparando'
- ‚úÖ Estado nuevo: 'listo_envio'

### **Tabla: `qr_codes`**
- ‚úÖ Nuevo registro con c√≥digo √∫nico
- ‚úÖ Tipo: 'kit'
- ‚úÖ `tipo_validacion`: 'entrega_cliente'
- ‚úÖ `es_activo`: true

---

## üöÄ PR√ìXIMOS COMPONENTES A DESARROLLAR

### 1. **kit-despacho.component** (Opcional - para despu√©s)
- Lista de kits listos para env√≠o (`estado = 'listo_envio'`)
- Asignaci√≥n de mensajero
- Generaci√≥n de remisi√≥n PDF
- Cambio a estado `'en_transito'`

### 2. **kit-recepcion-cliente.component** (PRIORITARIO)
- Pantalla p√∫blica/m√≥vil para escaneo de QR
- Muestra productos del kit
- Canvas para firma digital
- Captura foto de evidencia
- Bot√≥n "Aprobar Recepci√≥n"
- Cambia estado a `'entregado'`

### 3. **cirugia-ejecucion.component** (T√©cnico)
- Iniciar cirug√≠a (estado `'en_uso'`)
- Registro de consumos en tiempo real
- Auto-guardar hoja de gastos
- Finalizar cirug√≠a

### 4. **kit-devolucion.component** (Log√≠stica)
- Escanear QR de devoluci√≥n
- Validar productos devueltos
- Procesos de lavado/esterilizaci√≥n
- Reposici√≥n a inventario

---

## üìù NOTAS T√âCNICAS

### **Performance:**
- Carga todos los datos en una sola query (con joins)
- Usa signals para reactividad eficiente
- Computed properties para estad√≠sticas

### **Validaciones:**
- Frontend: Validaci√≥n en tiempo real de cantidades
- Backend: Constraints en BD garantizan integridad

### **Trazabilidad:**
- Cada cambio de estado registra en `kit_trazabilidad`
- Cada movimiento de inventario queda documentado
- QR √∫nico garantiza autenticidad

### **Seguridad:**
- Usuario autenticado requerido
- Solo rol 'logistica' puede acceder
- Transacciones at√≥micas en BD

---

## üéØ ESTADO ACTUAL

‚úÖ **FASE 1 - Comercial:** Kit creado con estado 'solicitado'
‚úÖ **FASE 2 - Preparaci√≥n:** IMPLEMENTADA COMPLETAMENTE
‚è≥ **FASE 3 - Recepci√≥n:** Por implementar
‚è≥ **FASE 4 - Ejecuci√≥n:** Por implementar
‚è≥ **FASE 5 - Cierre:** Por implementar
‚è≥ **FASE 6 - Devoluci√≥n:** Por implementar
‚è≥ **FASE 7 - Facturaci√≥n:** Ya existe parcialmente

**Pr√≥ximo paso recomendado:** Implementar componente de recepci√≥n con escaneo de QR para clientes.
