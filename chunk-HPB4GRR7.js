import{a as Q}from"./chunk-ZMAGDCDG.js";import"./chunk-YGGYEX66.js";import{a as $,c as z,g as G,x as N}from"./chunk-V2VKRV3B.js";import{j as U,n as A,p as B,v as H}from"./chunk-3OSVPALZ.js";import{$ as _,Ab as g,Bb as M,Eb as O,Fb as P,Gb as R,Ia as s,S as w,Sa as F,Xa as h,Y as C,Yb as D,Z as x,_ as p,cb as j,gb as b,ib as m,la as f,lb as k,mb as y,nb as a,ob as o,pb as u,qb as E,tb as v,ub as l,vb as T,wb as I,xb as V,zb as c}from"./chunk-MBDN4FSM.js";import"./chunk-X5YLR3NI.js";import{i as L}from"./chunk-ODN5LVDJ.js";var W=["messagesContainer"],Y=["fileInput"],q=(i,t)=>t.id;function J(i,t){if(i&1&&(a(0,"div",9)(1,"h1",15),c(2),o(),a(3,"p",16),c(4),o()()),i&2){let e=l();s(2),g(e.cirugiaInfo().numero_cirugia),s(2),g(e.cirugiaInfo().medico_cirujano)}}function X(i,t){if(i&1&&(a(0,"span"),c(1),o()),i&2){let e=t.$implicit,n=l(2);b("px-3 py-1 rounded-full text-xs font-medium ",n.getRolColor(e.rol),""),s(),M(" ",e.nombre," ")}}function Z(i,t){if(i&1&&(a(0,"div",11),k(1,X,2,4,"span",17,q),o()),i&2){let e=l();s(),y(e.participantes())}}function ee(i,t){i&1&&(a(0,"div",12)(1,"div",18),u(2,"div",19),a(3,"p",20),c(4,"Cargando chat..."),o()()())}function te(i,t){if(i&1&&(a(0,"div",13)(1,"div",21),p(),a(2,"svg",22),u(3,"path",23),o(),_(),a(4,"h3",24),c(5,"Error"),o(),a(6,"p",25),c(7),o()()()),i&2){let e=l();s(7),g(e.error())}}function ie(i,t){i&1&&(a(0,"div",27),p(),a(1,"svg",42),u(2,"path",43),o(),_(),a(3,"p",44),c(4,"No hay mensajes a\xFAn"),o(),a(5,"p",45),c(6,"S\xE9 el primero en escribir"),o()())}function ne(i,t){if(i&1&&(a(0,"div",47)(1,"span",50),c(2),o(),a(3,"span"),c(4),o()()),i&2){let e=l().$implicit,n=l(2);s(2),g(n.getNombreUsuario(e)),s(),b("px-2 py-0.5 rounded-full text-xs ",n.getRolColor((e.usuario==null?null:e.usuario.role)||""),""),s(),M(" ",n.getRolUsuario(e)," ")}}function ae(i,t){if(i&1&&(a(0,"p",48),c(1),o()),i&2){let e=l().$implicit;s(),g(e.mensaje)}}function oe(i,t){if(i&1){let e=E();a(0,"div")(1,"p",51),c(2),o(),a(3,"button",52),v("click",function(){C(e);let r=l().$implicit,d=l(2);return x(d.verEnMapa(r.metadata==null?null:r.metadata.latitud,r.metadata==null?null:r.metadata.longitud))}),p(),a(4,"svg",53),u(5,"path",35)(6,"path",36),o(),_(),a(7,"span",54),c(8,"Ver en mapa"),o()()()}if(i&2){let e=l().$implicit;s(2),g(e.mensaje)}}function re(i,t){if(i&1&&(a(0,"p",57),c(1),o()),i&2){let e=l(2).$implicit;s(),g(e.metadata==null?null:e.metadata.titulo)}}function se(i,t){if(i&1&&(a(0,"div",49),p(),a(1,"svg",55),u(2,"path",56),o(),_(),a(3,"div"),h(4,re,2,1,"p",57),a(5,"p",58),c(6),o()()()),i&2){let e=l().$implicit;s(4),m(e.metadata!=null&&e.metadata.titulo?4:-1),s(2),g(e.mensaje)}}function le(i,t){if(i&1&&(a(0,"div")(1,"div",46),h(2,ne,5,5,"div",47),a(3,"div"),h(4,ae,2,1,"p",48)(5,oe,9,1,"div")(6,se,7,2,"div",49),o(),a(7,"p"),c(8),o()()()),i&2){let e=t.$implicit,n=l(2);b("flex ",n.esMiMensaje(e)?"justify-end":"justify-start",""),s(2),m(n.esMiMensaje(e)?-1:2),s(),b("",n.esMiMensaje(e)?"bg-[#C8D900] text-[#10284C] rounded-2xl rounded-tr-sm":"bg-white/10 text-white rounded-2xl rounded-tl-sm"," px-4 py-3 backdrop-blur-sm"),s(),m(e.tipo==="texto"?4:-1),s(),m(e.tipo==="ubicacion"&&(e.metadata!=null&&e.metadata.latitud)&&(e.metadata!=null&&e.metadata.longitud)?5:-1),s(),m(e.tipo==="alerta"?6:-1),s(),b("text-xs ",n.esMiMensaje(e)?"text-right":"text-left"," mt-1 px-2 text-white/40"),s(),M(" ",n.formatearFecha(e.created_at)," ")}}function ce(i,t){i&1&&u(0,"div",40)}function de(i,t){i&1&&(p(),a(0,"svg",7),u(1,"path",59),o())}function me(i,t){if(i&1){let e=E();a(0,"div",14)(1,"div",26,0),h(3,ie,7,0,"div",27),k(4,le,9,14,"div",17,q),o(),a(6,"div",28)(7,"div",29)(8,"div",30)(9,"button",31),v("click",function(){C(e);let r=l();return x(r.abrirArchivos())}),p(),a(10,"svg",32),u(11,"path",33),o()(),_(),a(12,"button",34),v("click",function(){C(e);let r=l();return x(r.enviarUbicacion())}),p(),a(13,"svg",32),u(14,"path",35)(15,"path",36),o()()(),_(),a(16,"div",37)(17,"textarea",38),R("ngModelChange",function(r){C(e);let d=l();return P(d.nuevoMensaje,r)||(d.nuevoMensaje=r),x(r)}),v("keypress",function(r){C(e);let d=l();return x(d.onKeyPress(r))}),o(),a(18,"button",39),v("click",function(){C(e);let r=l();return x(r.enviarMensaje())}),h(19,ce,1,0,"div",40)(20,de,2,0,":svg:svg",7),o()()(),a(21,"input",41,1),v("change",function(r){C(e);let d=l();return x(d.onFileSelected(r))}),o()()()}if(i&2){let e=l();s(3),m(e.mensajes().length===0?3:-1),s(),y(e.mensajes()),s(13),O("ngModel",e.nuevoMensaje),j("disabled",e.enviando()),s(),j("disabled",!e.nuevoMensaje().trim()||e.enviando()),s(),m(e.enviando()?19:20)}}var K=class i{messagesContainer;fileInput;chatService=w(Q);supabaseService=w(H);router=w(B);route=w(A);chat=f(null);mensajes=f([]);loading=f(!0);error=f(null);enviando=f(!1);nuevoMensaje=f("");currentUserId=f(null);cirugiaInfo=D(()=>this.chat()?.cirugia);participantes=D(()=>this.chat()?.participantes||[]);ngOnInit(){this.route.params.subscribe(t=>{let e=t.id;e&&(this.cargarChat(e),this.suscribirMensajes(e))}),this.getCurrentUser()}ngOnDestroy(){let t=this.route.snapshot.params.id;t&&this.chatService.desuscribirMensajes(t)}getCurrentUser(){return L(this,null,function*(){let t=yield this.supabaseService.getSession();this.currentUserId.set(t?.user?.id||null)})}cargarChat(t){this.loading.set(!0),this.error.set(null),this.chatService.getChatCompleto(t).subscribe({next:e=>{this.chat.set(e),this.mensajes.set(e.mensajes),this.loading.set(!1),this.chatService.marcarComoLeido(t).subscribe(),setTimeout(()=>this.scrollToBottom(),100)},error:e=>{console.error("Error al cargar chat:",e),this.error.set("Error al cargar el chat"),this.loading.set(!1)}})}suscribirMensajes(t){this.chatService.suscribirMensajes(t,e=>{this.mensajes().some(d=>d.id===e.id)||(this.mensajes.update(d=>[...d,e]),setTimeout(()=>this.scrollToBottom(),100)),e.usuario_id!==this.currentUserId()&&this.chatService.marcarComoLeido(t).subscribe()})}enviarMensaje(){let t=this.nuevoMensaje().trim();if(!t||this.enviando())return;let e=this.route.snapshot.params.id;e&&(this.enviando.set(!0),this.chatService.enviarMensaje({cirugia_id:e,mensaje:t,tipo:"texto"}).subscribe({next:n=>{this.mensajes().some(S=>S.id===n.id)||this.mensajes.update(S=>[...S,n]),this.nuevoMensaje.set(""),this.enviando.set(!1),setTimeout(()=>this.scrollToBottom(),100)},error:n=>{console.error("\u274C ChatComponent: Error sending message:",n),alert("Error al enviar mensaje"),this.enviando.set(!1)}}))}onKeyPress(t){t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.enviarMensaje())}scrollToBottom(){try{if(this.messagesContainer){let t=this.messagesContainer.nativeElement;t.scrollTop=t.scrollHeight}}catch(t){console.error("Error scrolling:",t)}}esMiMensaje(t){return t.usuario_id===this.currentUserId()}getNombreUsuario(t){return t.usuario?.full_name||"Usuario"}getRolUsuario(t){let e=t.usuario?.role||"";return{comercial:"Comercial",tecnico:"T\xE9cnico",logistica:"Log\xEDstica",admin:"Admin"}[e]||e}getRolColor(t){return{comercial:"bg-blue-500/20 text-blue-300",tecnico:"bg-green-500/20 text-green-300",logistica:"bg-purple-500/20 text-purple-300",admin:"bg-red-500/20 text-red-300"}[t]||"bg-gray-500/20 text-gray-300"}formatearFecha(t){let e=new Date(t),n=new Date,r=new Date(n);r.setDate(r.getDate()-1);let d=e.toLocaleTimeString("es-CO",{hour:"2-digit",minute:"2-digit"});return e.toDateString()===n.toDateString()?`Hoy ${d}`:e.toDateString()===r.toDateString()?`Ayer ${d}`:e.toLocaleDateString("es-CO",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"})}volver(){this.router.navigate(["/internal"])}abrirArchivos(){this.fileInput.nativeElement.click()}onFileSelected(t){let e=t.target;e.files&&e.files[0]&&(console.log("Archivo seleccionado:",e.files[0]),alert("Funci\xF3n de archivos en desarrollo"))}enviarUbicacion(){navigator.geolocation?navigator.geolocation.getCurrentPosition(t=>{let e=this.route.snapshot.params.id;this.enviando.set(!0),this.chatService.enviarMensaje({cirugia_id:e,mensaje:"\u{1F4CD} Ubicaci\xF3n compartida",tipo:"ubicacion",metadata:{latitud:t.coords.latitude,longitud:t.coords.longitude}}).subscribe({next:n=>{this.mensajes.update(r=>[...r,n]),this.enviando.set(!1),setTimeout(()=>this.scrollToBottom(),100)},error:n=>{console.error("Error al enviar ubicaci\xF3n:",n),alert("Error al compartir ubicaci\xF3n"),this.enviando.set(!1)}})},t=>{console.error("Error obteniendo ubicaci\xF3n:",t),alert("No se pudo obtener la ubicaci\xF3n")}):alert("Geolocalizaci\xF3n no disponible")}verEnMapa(t,e){t&&e&&window.open(`https://www.google.com/maps?q=${t},${e}`,"_blank")}static \u0275fac=function(e){return new(e||i)};static \u0275cmp=F({type:i,selectors:[["app-chat-cirugia"]],viewQuery:function(e,n){if(e&1&&(T(W,5),T(Y,5)),e&2){let r;I(r=V())&&(n.messagesContainer=r.first),I(r=V())&&(n.fileInput=r.first)}},decls:13,vars:5,consts:[["messagesContainer",""],["fileInput",""],[1,"min-h-screen","bg-gradient-to-br","from-[#10284C]","via-[#0e1f3a]","to-[#0a1628]","pb-safe"],[1,"sticky","top-0","z-50","bg-[#10284C]/95","backdrop-blur-md","border-b","border-white/10","shadow-xl"],[1,"px-4","py-4"],[1,"flex","items-center","justify-between","mb-3"],[1,"p-2","rounded-lg","bg-white/10","hover:bg-white/20","text-white","transition-colors",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M10 19l-7-7m0 0l7-7m-7 7h18"],[1,"flex-1","text-center"],[1,"w-10"],[1,"flex","items-center","justify-center","gap-2","flex-wrap"],[1,"flex","items-center","justify-center","h-96"],[1,"p-4"],[1,"flex","flex-col","h-[calc(100vh-180px)]"],[1,"text-xl","font-bold","text-white"],[1,"text-sm","text-white/60"],[3,"class"],[1,"text-center"],[1,"w-12","h-12","border-4","border-[#C8D900]","border-t-transparent","rounded-full","animate-spin","mx-auto","mb-4"],[1,"text-white/70"],[1,"bg-red-500/20","border","border-red-500","rounded-xl","p-6","text-center"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-16","h-16","text-red-500","mx-auto","mb-4"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"text-xl","font-bold","text-red-500","mb-2"],[1,"text-white"],[1,"flex-1","overflow-y-auto","px-4","py-4","space-y-4"],[1,"text-center","py-12"],[1,"border-t","border-white/10","bg-[#10284C]/95","backdrop-blur-md","p-4"],[1,"flex","items-end","gap-2"],[1,"flex","flex-col","gap-2"],["title","Adjuntar archivo",1,"p-2","rounded-lg","bg-white/10","hover:bg-white/20","text-white","transition-colors",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"],["title","Compartir ubicaci\xF3n",1,"p-2","rounded-lg","bg-white/10","hover:bg-white/20","text-white","transition-colors",3,"click"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M15 11a3 3 0 11-6 0 3 3 0 016 0z"],[1,"flex-1","flex","items-end","gap-2"],["placeholder","Escribe un mensaje...","rows","1",1,"flex-1","px-4","py-3","bg-white/10","border","border-white/20","rounded-xl","text-white","placeholder-white/40","focus:outline-none","focus:ring-2","focus:ring-[#C8D900]","focus:border-transparent","resize-none","max-h-32",3,"ngModelChange","keypress","ngModel","disabled"],[1,"p-3","rounded-xl","bg-[#C8D900]","hover:bg-[#b5c500]","text-[#10284C]","transition-colors","disabled:opacity-50","disabled:cursor-not-allowed","flex-shrink-0",3,"click","disabled"],[1,"w-6","h-6","border-2","border-[#10284C]","border-t-transparent","rounded-full","animate-spin"],["type","file","accept","image/*,.pdf,.doc,.docx",1,"hidden",3,"change"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-20","h-20","text-white/20","mx-auto","mb-4"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"],[1,"text-white/50","text-sm"],[1,"text-white/30","text-xs","mt-2"],[1,"max-w-[80%]"],[1,"flex","items-center","gap-2","mb-1","ml-2"],[1,"text-sm","break-words","whitespace-pre-wrap"],[1,"flex","items-start","gap-2"],[1,"text-xs","font-medium","text-white/70"],[1,"text-sm","font-medium","mb-2"],[1,"flex","items-center","gap-2","px-3","py-2","bg-white/20","hover:bg-white/30","rounded-lg","transition-colors",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4"],[1,"text-xs"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5","flex-shrink-0"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"],[1,"font-bold","text-sm","mb-1"],[1,"text-sm"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 19l9 2-9-18-9 18 9-2zm0 0v-8"]],template:function(e,n){e&1&&(a(0,"div",2)(1,"header",3)(2,"div",4)(3,"div",5)(4,"button",6),v("click",function(){return n.volver()}),p(),a(5,"svg",7),u(6,"path",8),o()(),h(7,J,5,2,"div",9),_(),u(8,"div",10),o(),h(9,Z,3,0,"div",11),o()(),h(10,ee,5,0,"div",12)(11,te,8,1,"div",13)(12,me,23,5,"div",14),o()),e&2&&(s(7),m(n.cirugiaInfo()?7:-1),s(2),m(n.participantes().length>0?9:-1),s(),m(n.loading()?10:-1),s(),m(n.error()&&!n.loading()?11:-1),s(),m(!n.loading()&&!n.error()?12:-1))},dependencies:[U,N,$,z,G],styles:["[_nghost-%COMP%]     .overflow-y-auto{scroll-behavior:smooth}[_nghost-%COMP%]     .overflow-y-auto::-webkit-scrollbar{width:6px}[_nghost-%COMP%]     .overflow-y-auto::-webkit-scrollbar-track{background:#ffffff1a;border-radius:3px}[_nghost-%COMP%]     .overflow-y-auto::-webkit-scrollbar-thumb{background:#c8d90080;border-radius:3px}[_nghost-%COMP%]     .overflow-y-auto::-webkit-scrollbar-thumb:hover{background:#c8d900b3}textarea[_ngcontent-%COMP%]{min-height:45px;max-height:120px}@keyframes _ngcontent-%COMP%_slideIn{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.animate-slide-in[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_slideIn .3s ease-out}"]})};export{K as ChatCirugiaComponent};
