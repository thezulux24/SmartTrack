import{x as O}from"./chunk-ZJDURMG7.js";import{$ as m,Aa as j,E as C,G as r,J as P,Ja as A,Ma as G,N as k,Oa as B,Q as M,R as H,U as f,Ua as N,X as F,Y as L,Z as e,_ as t,aa as D,ba as y,ca as h,ha as n,ia as p,ja as v,ka as U,u as z,w as E,x as S,y as g,z as x}from"./chunk-OA5U47VA.js";import"./chunk-LJ5XHLMQ.js";import{a as T,b as V,h as w}from"./chunk-FK42CRUA.js";var K=(o,a)=>a.id;function J(o,a){o&1&&(e(0,"div",1),m(1,"div",4),e(2,"p",5),n(3,"Cargando informaci\xF3n de la cirug\xEDa..."),t()())}function Q(o,a){if(o&1&&(e(0,"div",2),n(1),t()),o&2){let i=h();r(),v(" ",i.error()," ")}}function W(o,a){if(o&1&&(e(0,"p",52),n(1),t()),o&2){let i=h().$implicit;r(),v("Lote: ",i.lote,"")}}function X(o,a){o&1&&(e(0,"span",65),n(1," Completo "),t())}function Y(o,a){o&1&&(e(0,"span",66),n(1," En uso "),t())}function Z(o,a){o&1&&(e(0,"span",67),n(1," Sin usar "),t())}function ee(o,a){if(o&1){let i=D();e(0,"tr",48)(1,"td",51)(2,"div")(3,"p",22),n(4),t(),e(5,"p",37),n(6),t(),k(7,W,2,1,"p",52),t()(),e(8,"td",53)(9,"span",54),n(10),t()(),e(11,"td",51)(12,"div",55)(13,"button",56),y("click",function(){let d=E(i).$implicit,c=h(2);return S(c.actualizarConsumo(d,c.Math.max(0,d.cantidad_utilizada-1)))}),g(),e(14,"svg",57),m(15,"path",58),t()(),x(),e(16,"span",59),n(17),t(),e(18,"button",60),y("click",function(){let d=E(i).$implicit,c=h(2);return S(c.actualizarConsumo(d,c.Math.min(d.cantidad_enviada,d.cantidad_utilizada+1)))}),g(),e(19,"svg",61),m(20,"path",62),t()()()(),x(),e(21,"td",53)(22,"span",63),n(23),t()(),e(24,"td",51)(25,"div",64),k(26,X,2,0,"span",65)(27,Y,2,0,"span",66)(28,Z,2,0,"span",67),t()()()}if(o&2){let i=a.$implicit;r(4),p(i.nombre),r(2),p(i.codigo),r(),f(i.lote?7:-1),r(3),p(i.cantidad_enviada),r(3),M("disabled",i.cantidad_utilizada===0),r(4),v(" ",i.cantidad_utilizada," "),r(),M("disabled",i.cantidad_utilizada>=i.cantidad_enviada),r(5),v(" ",i.cantidad_enviada-i.cantidad_utilizada," "),r(3),f(i.cantidad_utilizada===i.cantidad_enviada?26:i.cantidad_utilizada>0?27:28)}}function te(o,a){o&1&&(m(0,"div",68),e(1,"span"),n(2,"Finalizando..."),t())}function ie(o,a){o&1&&(g(),e(0,"svg",69),m(1,"path",70),t(),x(),e(2,"span"),n(3,"Finalizar Cirug\xEDa"),t())}function ne(o,a){if(o&1){let i=D();e(0,"div",3)(1,"div",6)(2,"button",7),y("click",function(){E(i);let d=h();return S(d.regresar())}),g(),e(3,"svg",8),m(4,"path",9),t(),x(),e(5,"span",10),n(6,"Regresar"),t()(),e(7,"div",11)(8,"div",12)(9,"p",13),n(10,"Cirug\xEDa en Curso"),t()()()(),e(11,"div",14)(12,"h1",15),n(13),t(),e(14,"div",16)(15,"div",17)(16,"div",18),g(),e(17,"svg",19),m(18,"path",20),t()(),x(),e(19,"div")(20,"p",21),n(21,"M\xE9dico Cirujano"),t(),e(22,"p",22),n(23),t()()(),e(24,"div",17)(25,"div",23),g(),e(26,"svg",24),m(27,"path",25),t()(),x(),e(28,"div")(29,"p",21),n(30,"Hospital"),t(),e(31,"p",22),n(32),t(),e(33,"p",21),n(34),t()()(),e(35,"div",17)(36,"div",26),g(),e(37,"svg",27),m(38,"path",20),t()(),x(),e(39,"div")(40,"p",21),n(41,"Cliente"),t(),e(42,"p",22),n(43),t()()(),e(44,"div",17)(45,"div",28),g(),e(46,"svg",29),m(47,"path",30),t()(),x(),e(48,"div")(49,"p",21),n(50,"Kit"),t(),e(51,"p",22),n(52),t()()()()(),e(53,"div",14)(54,"div",31)(55,"h2",32),n(56,"Progreso de Consumo"),t(),e(57,"span",33),n(58),t()(),e(59,"div",34),m(60,"div",35),t(),e(61,"div",36)(62,"div")(63,"p",37),n(64,"Total Productos"),t(),e(65,"p",38),n(66),t()(),e(67,"div")(68,"p",37),n(69,"Utilizados"),t(),e(70,"p",39),n(71),t()(),e(72,"div")(73,"p",37),n(74,"Pendientes"),t(),e(75,"p",40),n(76),t()()()(),e(77,"div",14)(78,"h2",41),g(),e(79,"svg",19),m(80,"path",42),t(),n(81," Registro de Consumo "),t(),x(),e(82,"div",43)(83,"table",44)(84,"thead")(85,"tr",45)(86,"th",46),n(87,"Producto"),t(),e(88,"th",47),n(89,"Disponible"),t(),e(90,"th",47),n(91,"Utilizado"),t(),e(92,"th",47),n(93,"Restante"),t(),e(94,"th",47),n(95,"Acciones"),t()()(),e(96,"tbody"),F(97,ee,29,9,"tr",48,K),t()()()(),e(99,"div",49)(100,"button",50),y("click",function(){E(i);let d=h();return S(d.finalizarCirugia())}),k(101,te,3,0)(102,ie,4,0),t()()()}if(o&2){let i,l,d,c,u,b,s=h();r(13),v(" ",(i=s.cirugia())==null?null:i.numero_cirugia," "),r(10),p((l=s.cirugia())==null?null:l.medico_cirujano),r(9),p((d=s.cirugia())==null||d.hospital==null?null:d.hospital.nombre),r(2),p((c=s.cirugia())==null||c.hospital==null?null:c.hospital.ciudad),r(9),U("",(u=s.cirugia())==null||u.cliente==null?null:u.cliente.nombre," ",(u=s.cirugia())==null||u.cliente==null?null:u.cliente.apellido,""),r(9),p((b=s.cirugia())==null||b.kit==null?null:b.kit.numero_kit),r(6),v("",s.porcentajeProgreso(),"%"),r(2),H("width",s.porcentajeProgreso(),"%"),r(6),p(s.totalProductos()),r(5),p(s.productosUtilizados()),r(5),p(s.totalProductos()-s.productosUtilizados()),r(21),L(s.productos()),r(3),M("disabled",s.procesando()),r(),f(s.procesando()?101:102)}}var q=class o{router=z(B);route=z(G);supabase=z(N);cirugia=C(null);productos=C([]);cargando=C(!0);error=C(null);procesando=C(!1);cirugiaId=j(()=>this.route.snapshot.params.cirugiaId);totalProductos=j(()=>this.productos().length);productosUtilizados=j(()=>this.productos().filter(a=>a.cantidad_utilizada>0).length);porcentajeProgreso=j(()=>{let a=this.totalProductos();return a===0?0:Math.round(this.productosUtilizados()/a*100)});Math=Math;ngOnInit(){return w(this,null,function*(){yield this.cargarDatosCirugia()})}cargarDatosCirugia(){return w(this,null,function*(){this.cargando.set(!0),this.error.set(null);try{let a=this.cirugiaId(),{data:i,error:l}=yield this.supabase.client.from("cirugias").select(`
          id,
          numero_cirugia,
          medico_cirujano,
          fecha_programada,
          estado,
          hospitales (
            nombre,
            ciudad
          ),
          clientes (
            nombre,
            apellido
          )
        `).eq("id",a).single();if(l)throw l;let{data:d,error:c}=yield this.supabase.client.from("kits_cirugia").select("id, numero_kit, estado").eq("cirugia_id",a).single();if(c)throw c;let u=i.hospitales,b=i.clientes,s={id:i.id,numero_cirugia:i.numero_cirugia,medico_cirujano:i.medico_cirujano,fecha_programada:i.fecha_programada,estado:i.estado,hospital:{nombre:u?.nombre||"N/A",ciudad:u?.ciudad||"N/A"},cliente:{nombre:b?.nombre||"N/A",apellido:b?.apellido||""},kit:{id:d.id,numero_kit:d.numero_kit,estado:d.estado}};this.cirugia.set(s);let{data:R,error:I}=yield this.supabase.client.from("kit_productos").select(`
          id,
          producto_id,
          cantidad_preparada,
          cantidad_enviada,
          cantidad_utilizada,
          lote,
          fecha_vencimiento,
          productos (
            nombre,
            codigo
          )
        `).eq("kit_id",d.id).order("productos(nombre)");if(I)throw I;let $=(R||[]).map(_=>({id:_.id,producto_id:_.producto_id,nombre:_.productos?.nombre||"N/A",codigo:_.productos?.codigo||"N/A",cantidad_preparada:_.cantidad_preparada||0,cantidad_enviada:_.cantidad_enviada||0,cantidad_utilizada:_.cantidad_utilizada||0,lote:_.lote,fecha_vencimiento:_.fecha_vencimiento}));this.productos.set($)}catch(a){console.error("Error cargando datos de cirug\xEDa:",a),this.error.set("Error al cargar los datos de la cirug\xEDa")}finally{this.cargando.set(!1)}})}actualizarConsumo(a,i){return w(this,null,function*(){try{let{error:l}=yield this.supabase.client.from("kit_productos").update({cantidad_utilizada:i}).eq("id",a.id);if(l)throw l;let d=this.productos(),c=d.findIndex(u=>u.id===a.id);if(c!==-1){let u=[...d];u[c]=V(T({},u[c]),{cantidad_utilizada:i}),this.productos.set(u)}}catch(l){console.error("Error actualizando consumo:",l),alert("Error al actualizar el consumo")}})}finalizarCirugia(){return w(this,null,function*(){if(confirm(`\xBFFinalizar cirug\xEDa?

Esto marcar\xE1 la cirug\xEDa como completada y el kit quedar\xE1 listo para devoluci\xF3n.`)){this.procesando.set(!0);try{let a=yield this.supabase.getCurrentUserId();if(!a)throw new Error("Usuario no autenticado");let i=this.cirugia();if(!i)throw new Error("No hay datos de cirug\xEDa");let{error:l}=yield this.supabase.client.from("cirugias").update({estado:"completada",updated_at:new Date().toISOString()}).eq("id",i.id);if(l)throw l;let{error:d}=yield this.supabase.client.from("kits_cirugia").update({estado:"devuelto",fecha_devolucion:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",i.kit.id);if(d)throw d;let{error:c}=yield this.supabase.client.from("cirugia_trazabilidad").insert({cirugia_id:i.id,accion:"finalizacion_cirugia",estado_anterior:"en_curso",estado_nuevo:"completada",usuario_id:a,observaciones:"Cirug\xEDa finalizada - Kit listo para proceso de devoluci\xF3n",metadata:{kit_id:i.kit.id,productos_utilizados:this.productosUtilizados(),total_productos:this.totalProductos()}});if(c)throw c;alert(`\u2705 Cirug\xEDa finalizada correctamente

\u{1F4CB} Pr\xF3ximos pasos:
1. Validar devoluci\xF3n del kit
2. Separar productos usados/sin usar
3. Enviar productos reutilizables a limpieza/esterilizaci\xF3n
4. Actualizar inventario

El kit est\xE1 marcado como "DEVUELTO" y listo para proceso de devoluci\xF3n.`),this.router.navigate(["/internal/tecnico"])}catch(a){console.error("Error finalizando cirug\xEDa:",a),alert("Error al finalizar la cirug\xEDa: "+(a.message||"Error desconocido"))}finally{this.procesando.set(!1)}}})}regresar(){this.router.navigate(["/internal/tecnico"])}formatearFecha(a){return new Date(a).toLocaleDateString("es-CO",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}static \u0275fac=function(i){return new(i||o)};static \u0275cmp=P({type:o,selectors:[["app-cirugia-ejecucion"]],decls:4,vars:3,consts:[[1,"min-h-screen","bg-gradient-to-br","from-[#10284C]","via-[#1a3a5c]","to-[#0f1f38]","p-4","md:p-8"],[1,"text-center","py-12"],[1,"bg-red-500/20","border","border-red-500","text-red-100","p-4","rounded-lg","text-center","mb-8"],[1,"space-y-6"],[1,"inline-block","animate-spin","rounded-full","h-12","w-12","border-4","border-[#C8D900]","border-t-transparent"],[1,"text-white","mt-4"],[1,"flex","items-center","justify-between","mb-6"],[1,"group","flex","items-center","gap-2","px-4","py-2","bg-white/10","hover:bg-white/20","rounded-lg","transition-all","border","border-white/20","hover:border-[#C8D900]/50",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5","text-white","group-hover:text-[#C8D900]","transition-colors"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M10 19l-7-7m0 0l7-7m-7 7h18"],[1,"text-white","group-hover:text-[#C8D900]","transition-colors","font-medium"],[1,"flex","items-center","gap-3"],[1,"px-4","py-2","bg-blue-500/20","border","border-blue-500","rounded-lg"],[1,"text-blue-300","text-sm","font-medium"],[1,"bg-white/5","backdrop-blur-sm","rounded-2xl","border","border-white/10","p-6"],[1,"text-3xl","font-bold","text-white","mb-6"],[1,"grid","grid-cols-1","md:grid-cols-2","lg:grid-cols-4","gap-6"],[1,"flex","items-start","gap-3"],[1,"w-10","h-10","bg-[#C8D900]/20","rounded-lg","flex","items-center","justify-center","flex-shrink-0"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6","text-[#C8D900]"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"],[1,"text-gray-400","text-xs"],[1,"text-white","font-medium"],[1,"w-10","h-10","bg-[#0098A8]/20","rounded-lg","flex","items-center","justify-center","flex-shrink-0"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6","text-[#0098A8]"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"],[1,"w-10","h-10","bg-purple-500/20","rounded-lg","flex","items-center","justify-center","flex-shrink-0"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6","text-purple-400"],[1,"w-10","h-10","bg-green-500/20","rounded-lg","flex","items-center","justify-center","flex-shrink-0"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6","text-green-400"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"],[1,"flex","items-center","justify-between","mb-4"],[1,"text-xl","font-bold","text-white"],[1,"text-2xl","font-bold","text-[#C8D900]"],[1,"w-full","bg-white/10","rounded-full","h-4","mb-4"],[1,"bg-gradient-to-r","from-[#C8D900]","to-[#d4e820]","h-4","rounded-full","transition-all","duration-500"],[1,"grid","grid-cols-3","gap-4","text-center"],[1,"text-gray-400","text-sm"],[1,"text-white","text-2xl","font-bold"],[1,"text-[#C8D900]","text-2xl","font-bold"],[1,"text-yellow-400","text-2xl","font-bold"],[1,"text-2xl","font-bold","text-white","mb-6","flex","items-center","gap-2"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"],[1,"overflow-x-auto"],[1,"w-full"],[1,"border-b","border-white/20"],[1,"text-left","text-gray-400","font-medium","py-3","px-4"],[1,"text-center","text-gray-400","font-medium","py-3","px-4"],[1,"border-b","border-white/10","hover:bg-white/5","transition-colors"],[1,"flex","justify-end"],[1,"px-8","py-4","bg-gradient-to-r","from-red-500","to-red-600","hover:from-red-600","hover:to-red-700","text-white","rounded-lg","font-bold","text-lg","flex","items-center","gap-3","disabled:opacity-50","disabled:cursor-not-allowed","transition-all","hover:shadow-lg","hover:shadow-red-500/50",3,"click","disabled"],[1,"py-4","px-4"],[1,"text-gray-500","text-xs"],[1,"py-4","px-4","text-center"],[1,"text-white","font-bold","text-lg"],[1,"flex","items-center","justify-center","gap-2"],[1,"w-8","h-8","bg-red-500/20","hover:bg-red-500/30","disabled:opacity-50","disabled:cursor-not-allowed","rounded-lg","flex","items-center","justify-center","transition-colors",3,"click","disabled"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4","text-red-400"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M20 12H4"],[1,"text-[#C8D900]","font-bold","text-xl","min-w-[40px]","text-center"],[1,"w-8","h-8","bg-green-500/20","hover:bg-green-500/30","disabled:opacity-50","disabled:cursor-not-allowed","rounded-lg","flex","items-center","justify-center","transition-colors",3,"click","disabled"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4","text-green-400"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 4v16m8-8H4"],[1,"text-gray-300","font-medium"],[1,"flex","justify-center"],[1,"px-3","py-1","bg-green-500/20","text-green-300","rounded-full","text-xs","font-medium"],[1,"px-3","py-1","bg-yellow-500/20","text-yellow-300","rounded-full","text-xs","font-medium"],[1,"px-3","py-1","bg-gray-500/20","text-gray-400","rounded-full","text-xs","font-medium"],[1,"w-5","h-5","border-2","border-white","border-t-transparent","rounded-full","animate-spin"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"]],template:function(i,l){i&1&&(e(0,"div",0),k(1,J,4,0,"div",1)(2,Q,2,1,"div",2)(3,ne,103,15,"div",3),t()),i&2&&(r(),f(l.cargando()?1:-1),r(),f(l.error()?2:-1),r(),f(!l.cargando()&&!l.error()&&l.cirugia()?3:-1))},dependencies:[A,O],encapsulation:2})};export{q as CirugiaEjecucionComponent};
