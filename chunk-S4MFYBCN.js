import{a as me,b as pe}from"./chunk-JZTCV5A7.js";import{a as _e}from"./chunk-K54T7AD4.js";import{a as ge}from"./chunk-SDITOA2G.js";import{a as ue}from"./chunk-PMF4DKDM.js";import{a as ce}from"./chunk-335KBBID.js";import"./chunk-6ATMWDJW.js";import{a as se}from"./chunk-SB6QUOBG.js";import{a as Y,b as g,c as W,d as X,h as Z,i as ee,k as ie,n as te,o as ne,p as oe,q as re,s as ae,w as le,y as de}from"./chunk-LKZ4XIWW.js";import{a as Q}from"./chunk-SKWGQ3GK.js";import{d as R,f as J,g as U,l as N}from"./chunk-U6NWDCIK.js";import{q as P}from"./chunk-KK7RVAAD.js";import{$ as C,Ab as w,Bb as $,Hb as L,Ia as a,M as z,R as B,S as f,Sa as K,Xa as _,Y as E,Z as S,_ as p,cb as h,fb as x,h as D,hb as u,i as G,j as V,kb as y,la as v,lb as F,mb as t,n as A,nb as n,ob as d,pb as k,sb as b,tb as c,v as M,yb as r,zb as m}from"./chunk-D2JNWC2G.js";import"./chunk-X5YLR3NI.js";import{i as q}from"./chunk-ODN5LVDJ.js";var j=class o{constructor(i){this.supabase=i}getTecnicos(){return D(this.supabase.client.from("profiles").select("id, full_name, email, area, phone").eq("role","soporte_tecnico").eq("is_active",!0).order("full_name",{ascending:!0})).pipe(A(i=>{if(i.error)throw console.error("Error fetching tecnicos:",i.error),new Error(i.error.message||"Error al cargar t\xE9cnicos");return i.data||[]}),M(i=>(console.error("Service error loading tecnicos:",i),V(()=>i))))}getTecnicoById(i){return D(this.supabase.client.from("profiles").select("id, full_name, email, area, phone").eq("id",i).eq("role","soporte_tecnico").single()).pipe(A(e=>{if(e.error)throw new Error(e.error.message||"Error al cargar t\xE9cnico");return e.data}),M(e=>(console.error("Service error loading tecnico:",e),V(()=>e))))}getTecnicosDisponibles(i){return D(this.supabase.client.from("profiles").select(`
          id, 
          full_name, 
          email, 
          area,
          agenda_tecnicos!inner(*)
        `).eq("role","soporte_tecnico").eq("is_active",!0).eq("agenda_tecnicos.fecha",i).eq("agenda_tecnicos.disponible",!0).order("full_name",{ascending:!0})).pipe(A(e=>{if(e.error)throw console.error("Error fetching tecnicos disponibles:",e.error),new Error(e.error.message||"Error al cargar t\xE9cnicos disponibles");return e.data||[]}),M(e=>(console.error("Service error loading tecnicos disponibles:",e),V(()=>e))))}static \u0275fac=function(e){return new(e||o)(B(N))};static \u0275prov=z({token:o,factory:o.\u0275fac,providedIn:"root"})};var xe=()=>["/internal/agenda"],be=()=>["/internal/agenda/calendario"],H=(o,i)=>i.value,O=(o,i)=>i.id;function Ee(o,i){o&1&&(t(0,"div",21)(1,"div",23)(2,"div",24)(3,"div",25),d(4,"div",26)(5,"div",27)(6,"div",28),n(),t(7,"p",29),r(8,"Cargando datos..."),n()()()())}function Se(o,i){if(o&1){let e=k();t(0,"div",30)(1,"div",23)(2,"div",32)(3,"div",8),p(),t(4,"svg",33),d(5,"path",34),n(),C(),t(6,"div",35)(7,"p",36),r(8),n()()(),t(9,"button",37),b("click",function(){E(e);let s=c(2);return S(s.loadInitialData())}),r(10," Reintentar "),n()()()()}if(o&2){let e=c(2);a(8),m(e.error())}}function we(o,i){if(o&1&&(t(0,"div",30)(1,"div",23)(2,"div",38)(3,"div",8),p(),t(4,"svg",39),d(5,"path",40),n(),C(),t(6,"p",36),r(7),n()()()()()),o&2){let e=c(2);a(7),m(e.success())}}function ye(o,i){if(o&1){let e=k();t(0,"div",21)(1,"div",23)(2,"div",41)(3,"div",42),p(),t(4,"svg",43),d(5,"path",40),n(),C(),t(6,"h3",44),r(7,"\xA1Cirug\xEDa creada exitosamente!"),n(),t(8,"p",45)(9,"span",46),r(10),n()(),t(11,"p",47),r(12),n()(),t(13,"div",48)(14,"p",49),r(15," \xBFQu\xE9 te gustar\xEDa hacer ahora? "),n(),t(16,"div",50)(17,"button",51),b("click",function(){E(e);let s=c(2);return S(s.onCrearKit())}),p(),t(18,"svg",52),d(19,"path",53),n(),r(20," Crear Kit Quir\xFArgico "),n(),C(),t(21,"button",54),b("click",function(){E(e);let s=c(2);return S(s.onVolverAgenda())}),p(),t(22,"svg",52),d(23,"path",55),n(),r(24," Volver a la Agenda "),n()()()()()()}if(o&2){let e,l,s=c(2);a(10),m((e=s.cirugiaCreada())==null?null:e.numero_cirugia),a(2),$(" ",s.getClienteNombreCreada()," - ",(l=s.cirugiaCreada())==null?null:l.medico_cirujano," ")}}function Fe(o,i){if(o&1){let e=k();t(0,"div",30)(1,"div",23)(2,"div",56)(3,"div",57),p(),t(4,"svg",58),d(5,"path",59),n(),C(),t(6,"div",35)(7,"h3",60),r(8,"Esta cirug\xEDa no tiene kit asignado"),n(),t(9,"p",61),r(10," Para completar la preparaci\xF3n, puedes crear un kit quir\xFArgico con los productos necesarios. "),n(),t(11,"button",62),b("click",function(){E(e);let s=c(2);return S(s.onCrearKit())}),p(),t(12,"svg",63),d(13,"path",53),n(),r(14," Crear Kit Quir\xFArgico "),n()()()()()()}}function Te(o,i){o&1&&(t(0,"div",30)(1,"div",23)(2,"div",64)(3,"div",8),p(),t(4,"svg",39),d(5,"path",40),n(),C(),t(6,"div")(7,"p",65),r(8,"Kit quir\xFArgico creado"),n(),t(9,"p",66),r(10,"Esta cirug\xEDa ya tiene su kit asignado"),n()()()()()())}function ke(o,i){o&1&&(t(0,"div",74)(1,"div",113),p(),t(2,"svg",114),d(3,"path",40),n(),C(),t(4,"span",115),r(5,"Cliente encontrado en el sistema"),n()()())}function Ie(o,i){if(o&1&&(t(0,"option",78),r(1),n()),o&2){let e=i.$implicit;h("value",e.value),a(),m(e.label)}}function De(o,i){o&1&&(t(0,"span",80),r(1,"\u{1F50D}"),n())}function Ve(o,i){if(o&1&&(t(0,"p",82),r(1),n()),o&2){let e=c(3);a(),m(e.getFieldError("documento_numero"))}}function Ae(o,i){if(o&1&&(t(0,"p",82),r(1),n()),o&2){let e=c(3);a(),m(e.getFieldError("nombre"))}}function Me(o,i){if(o&1&&(t(0,"p",82),r(1),n()),o&2){let e=c(3);a(),m(e.getFieldError("apellido"))}}function Ne(o,i){if(o&1&&(t(0,"p",82),r(1),n()),o&2){let e=c(3);a(),m(e.getFieldError("email"))}}function je(o,i){if(o&1&&r(0),o&2){let e=c().$implicit;w(" - ",e.ciudad," ")}}function Le(o,i){if(o&1&&(t(0,"option",78),r(1),_(2,je,1,1),n()),o&2){let e=i.$implicit;h("value",e.id),a(),m(e.nombre),a(),u(e.ciudad?2:-1)}}function He(o,i){if(o&1&&(t(0,"p",82),r(1),n()),o&2){let e=c(3);a(),m(e.getFieldError("hospital_id"))}}function Oe(o,i){if(o&1&&(t(0,"option",78),r(1),n()),o&2){let e=i.$implicit;h("value",e.id),a(),m(e.nombre)}}function qe(o,i){if(o&1&&(t(0,"p",82),r(1),n()),o&2){let e=c(3);a(),m(e.getFieldError("tipo_cirugia_id"))}}function Ge(o,i){if(o&1&&(t(0,"p",82),r(1),n()),o&2){let e=c(3);a(),m(e.getFieldError("medico_cirujano"))}}function ze(o,i){if(o&1&&(t(0,"p",82),r(1),n()),o&2){let e=c(3);a(),m(e.getFieldError("fecha_programada"))}}function Be(o,i){if(o&1&&(t(0,"p",82),r(1),n()),o&2){let e=c(3);a(),m(e.getFieldError("duracion_estimada"))}}function Ke(o,i){if(o&1&&(t(0,"option",78),r(1),n()),o&2){let e=i.$implicit;h("value",e.value),a(),m(e.label)}}function $e(o,i){if(o&1&&(t(0,"option",78),r(1),n()),o&2){let e=i.$implicit;h("value",e.value),a(),m(e.label)}}function Pe(o,i){if(o&1&&(t(0,"option",78),r(1),n()),o&2){let e=i.$implicit;h("value",e.id),a(),m(e.full_name)}}function Re(o,i){o&1&&d(0,"div",108)}function Je(o,i){o&1&&(p(),t(0,"svg",109),d(1,"path",40),n())}function Ue(o,i){if(o&1){let e=k();t(0,"div",31)(1,"form",67),b("ngSubmit",function(){E(e);let s=c(2);return S(s.onSubmit())}),t(2,"div",68)(3,"div",69)(4,"div",70)(5,"div",71),p(),t(6,"svg",16),d(7,"path",72),n()(),C(),t(8,"h2",73),r(9,"Informaci\xF3n del Cliente"),n()()(),_(10,ke,6,0,"div",74),t(11,"div",48)(12,"div",75)(13,"div")(14,"label",76),r(15," Tipo Doc * "),n(),t(16,"select",77),y(17,Ie,2,2,"option",78,H),n()(),t(19,"div",79)(20,"label",76),r(21," N\xFAmero de Documento * "),_(22,De,2,0,"span",80),n(),t(23,"input",81),b("input",function(){E(e);let s=c(2);return S(s.onDocumentoChange())}),n(),_(24,Ve,2,1,"p",82),n()(),t(25,"div",83)(26,"div")(27,"label",76),r(28," Nombres * "),n(),d(29,"input",84),_(30,Ae,2,1,"p",82),n(),t(31,"div")(32,"label",76),r(33," Apellidos * "),n(),d(34,"input",85),_(35,Me,2,1,"p",82),n()(),t(36,"div",83)(37,"div")(38,"label",76),r(39," Tel\xE9fono "),n(),d(40,"input",86),n(),t(41,"div")(42,"label",76),r(43," Email "),n(),d(44,"input",87),_(45,Ne,2,1,"p",82),n()()()(),t(46,"div",68)(47,"div",69)(48,"div",70)(49,"div",71),p(),t(50,"svg",16),d(51,"path",88),n()(),C(),t(52,"h2",73),r(53,"Informaci\xF3n de la Cirug\xEDa"),n()()(),t(54,"div",89)(55,"div")(56,"label",76),r(57," Hospital/Cl\xEDnica * "),t(58,"span",90),r(59),n()(),t(60,"select",91)(61,"option",92),r(62,"Seleccionar hospital..."),n(),y(63,Le,3,3,"option",78,O),n(),_(65,He,2,1,"p",82),n(),t(66,"div")(67,"label",76),r(68," Tipo de Cirug\xEDa * "),t(69,"span",90),r(70),n()(),t(71,"select",93),b("change",function(s){E(e);let T=c(2);return S(T.onTipoCirugiaChange(s))}),t(72,"option",92),r(73,"Seleccionar tipo..."),n(),y(74,Oe,2,2,"option",78,O),n(),_(76,qe,2,1,"p",82),n(),t(77,"div")(78,"label",76),r(79," M\xE9dico Cirujano * "),n(),d(80,"input",94),_(81,Ge,2,1,"p",82),n()()(),t(82,"div",68)(83,"div",69)(84,"div",70)(85,"div",71),p(),t(86,"svg",16),d(87,"path",95),n()(),C(),t(88,"h2",73),r(89,"Programaci\xF3n"),n()()(),t(90,"div",89)(91,"div")(92,"label",76),r(93," Fecha Programada * "),n(),d(94,"input",96),_(95,ze,2,1,"p",82),n(),t(96,"div")(97,"label",76),r(98," Hora de Inicio * "),n(),d(99,"input",97),n(),t(100,"div")(101,"label",76),r(102," Duraci\xF3n "),t(103,"span",90),r(104,"(min)"),n()(),d(105,"input",98),_(106,Be,2,1,"p",82),n()()(),t(107,"div",68)(108,"div",69)(109,"div",70)(110,"div",71),p(),t(111,"svg",16),d(112,"path",99),n()(),C(),t(113,"h2",73),r(114,"Estado y Asignaci\xF3n"),n()()(),t(115,"div",89)(116,"div")(117,"label",76),r(118," Estado * "),n(),t(119,"select",100),y(120,Ke,2,2,"option",78,H),n()(),t(122,"div")(123,"label",76),r(124," Prioridad * "),n(),t(125,"select",101),y(126,$e,2,2,"option",78,H),n()(),t(128,"div")(129,"label",76),r(130," T\xE9cnico Asignado "),t(131,"span",90),r(132),n()(),t(133,"select",102)(134,"option",92),r(135,"Sin asignar"),n(),y(136,Pe,2,2,"option",78,O),n()()()(),t(138,"div",68)(139,"div",69)(140,"div",70)(141,"div",71),p(),t(142,"svg",16),d(143,"path",103),n()(),C(),t(144,"h2",73),r(145,"Observaciones"),n()()(),t(146,"div",104)(147,"label",76),r(148," Notas Adicionales "),n(),d(149,"textarea",105),n()(),t(150,"div",106)(151,"button",107),_(152,Re,1,0,"div",108)(153,Je,2,0,":svg:svg",109),t(154,"span",110),r(155),n()(),t(156,"button",111),b("click",function(){E(e);let s=c(2);return S(s.onCancel())}),r(157," Cancelar "),n()()(),d(158,"div",112),n()}if(o&2){let e=c(2);a(),h("formGroup",e.cirugiaForm),a(9),u(e.clienteEncontrado()?10:-1),a(7),F(e.documentoTipoOptions),a(5),u(e.buscandoCliente()?22:-1),a(),x("w-full px-3 py-2 bg-gray-100 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0098A8] focus:border-transparent "+(e.isFieldInvalid("documento_numero")?"border-red-300":"border-gray-300")),a(),u(e.isFieldInvalid("documento_numero")?24:-1),a(5),x("w-full px-3 py-2 bg-gray-100 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0098A8] focus:border-transparent "+(e.isFieldInvalid("nombre")?"border-red-300":"border-gray-300")),a(),u(e.isFieldInvalid("nombre")?30:-1),a(4),x("w-full px-3 py-2 bg-gray-100 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0098A8] focus:border-transparent "+(e.isFieldInvalid("apellido")?"border-red-300":"border-gray-300")),a(),u(e.isFieldInvalid("apellido")?35:-1),a(9),x("w-full px-3 py-2 bg-gray-100 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0098A8] focus:border-transparent "+(e.isFieldInvalid("email")?"border-red-300":"border-gray-300")),a(),u(e.isFieldInvalid("email")?45:-1),a(14),w("(",e.hospitales().length," disponibles)"),a(),x("w-full px-3 py-2 bg-gray-100 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0098A8] focus:border-transparent "+(e.isFieldInvalid("hospital_id")?"border-red-300":"border-gray-300")),a(3),F(e.hospitales()),a(2),u(e.isFieldInvalid("hospital_id")?65:-1),a(5),w("(",e.tiposCirugia().length," disponibles)"),a(),x("w-full px-3 py-2 bg-gray-100 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0098A8] focus:border-transparent "+(e.isFieldInvalid("tipo_cirugia_id")?"border-red-300":"border-gray-300")),a(3),F(e.tiposCirugia()),a(2),u(e.isFieldInvalid("tipo_cirugia_id")?76:-1),a(4),x("w-full px-3 py-2 bg-gray-100 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0098A8] focus:border-transparent "+(e.isFieldInvalid("medico_cirujano")?"border-red-300":"border-gray-300")),a(),u(e.isFieldInvalid("medico_cirujano")?81:-1),a(13),x("w-full px-3 py-2 bg-gray-100 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0098A8] focus:border-transparent "+(e.isFieldInvalid("fecha_programada")?"border-red-300":"border-gray-300")),a(),u(e.isFieldInvalid("fecha_programada")?95:-1),a(10),x("w-full px-3 py-2 bg-gray-100 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0098A8] focus:border-transparent "+(e.isFieldInvalid("duracion_estimada")?"border-red-300":"border-gray-300")),a(),u(e.isFieldInvalid("duracion_estimada")?106:-1),a(14),F(e.estadosOptions),a(6),F(e.prioridadOptions),a(6),w("(",e.tecnicos().length," disponibles)"),a(4),F(e.tecnicos()),a(15),h("disabled",e.loading()||e.cirugiaForm.invalid),a(),u(e.loading()?152:153),a(3),w("",e.isEditing?"Actualizar":"Crear"," Cirug\xEDa")}}function Qe(o,i){if(o&1&&_(0,Se,11,1,"div",30)(1,we,8,1,"div",30)(2,ye,25,3,"div",21)(3,Fe,15,0,"div",30)(4,Te,11,0,"div",30)(5,Ue,159,36,"div",31),o&2){let e=c();u(e.error()?0:-1),a(),u(e.success()&&!e.cirugiaCreada()?1:-1),a(),u(e.cirugiaCreada()?2:-1),a(),u(e.isEditing&&e.cirugiaEditada()&&!e.tieneKit()?3:-1),a(),u(e.isEditing&&e.cirugiaEditada()&&e.tieneKit()?4:-1),a(),u(e.cirugiaCreada()?-1:5)}}var Ce=class o{fb=f(le);router=f(J);route=f(R);cirugiasService=f(ce);hospitalesService=f(me);tiposCirugiaService=f(pe);tecnicosService=f(j);kitService=f(ue);clientesService=f(ge);notificationService=f(se);authService=f(Q);supabaseService=f(N);loading=v(!1);error=v(null);success=v(null);cirugiaCreada=v(null);cirugiaEditada=v(null);tieneKit=v(!1);clienteEncontrado=v(null);buscandoCliente=v(!1);showSuccessDialog=v(!1);successDialogTitle=v("");successDialogAction=v(null);hospitales=v([]);tiposCirugia=v([]);tecnicos=v([]);cirugiaForm;isEditing=!1;cirugiaId=null;documentoTipoOptions=[{value:"cedula",label:"C\xE9dula"},{value:"pasaporte",label:"Pasaporte"},{value:"tarjeta_identidad",label:"Tarjeta de Identidad"}];estadosOptions=[{value:"programada",label:"Programada"},{value:"en_curso",label:"En Curso"},{value:"completada",label:"Completada"},{value:"cancelada",label:"Cancelada"},{value:"urgencia",label:"Urgencia"}];prioridadOptions=[{value:"baja",label:"Baja"},{value:"normal",label:"Normal"},{value:"alta",label:"Alta"},{value:"urgencia",label:"Urgencia"}];constructor(){this.cirugiaForm=this.fb.group({documento_numero:["",[g.required,g.minLength(6)]],documento_tipo:["cedula",g.required],nombre:["",[g.required,g.minLength(2)]],apellido:["",[g.required,g.minLength(2)]],telefono:[""],email:["",[g.email]],hospital_id:["",g.required],tipo_cirugia_id:["",g.required],medico_cirujano:["",[g.required,g.minLength(2)]],fecha_programada:["",g.required],hora_inicio:[""],duracion_estimada:[null,[g.min(15)]],estado:["programada",g.required],prioridad:["normal",g.required],tecnico_asignado_id:[""],notas:[""]})}ngOnInit(){console.log("\u{1F680} CirugiaFormComponent iniciando..."),this.loadInitialData(),this.checkEditMode()}loadInitialData(){console.log("\u{1F4CA} Cargando datos iniciales..."),this.loading.set(!0),this.error.set(null),console.log("\u{1F3E5} Iniciando carga de hospitales..."),this.hospitalesService.getHospitales().subscribe({next:i=>{console.log("\u2705 Hospitales cargados:",i),this.hospitales.set(i),console.log("\u2695\uFE0F Iniciando carga de tipos de cirug\xEDa..."),this.tiposCirugiaService.getTiposCirugia().subscribe({next:e=>{console.log("\u2705 Tipos de cirug\xEDa cargados:",e),this.tiposCirugia.set(e),console.log("\u{1F468}\u200D\u2695\uFE0F Iniciando carga de t\xE9cnicos..."),this.tecnicosService.getTecnicos().subscribe({next:l=>{console.log("\u2705 T\xE9cnicos cargados:",l),this.tecnicos.set(l),this.loading.set(!1)},error:l=>{console.error("\u274C Error loading tecnicos:",l),console.error("\u274C Error details:",{message:l?.message,code:l?.code,details:l?.details,hint:l?.hint}),this.error.set("Error al cargar t\xE9cnicos: "+(l?.message||JSON.stringify(l))),this.loading.set(!1)}})},error:e=>{console.error("\u274C Error loading tipos cirugia:",e),console.error("\u274C Error details:",{message:e?.message,code:e?.code,details:e?.details,hint:e?.hint}),this.error.set("Error al cargar tipos de cirug\xEDa: "+(e?.message||JSON.stringify(e))),this.loading.set(!1)}})},error:i=>{console.error("\u274C Error loading hospitales:",i),console.error("\u274C Error details:",{message:i?.message,code:i?.code,details:i?.details,hint:i?.hint}),this.error.set("Error al cargar hospitales: "+(i?.message||JSON.stringify(i))),this.loading.set(!1)}})}checkEditMode(){this.cirugiaId=this.route.snapshot.paramMap.get("id"),this.cirugiaId&&(this.isEditing=!0,this.loadCirugia())}loadCirugia(){this.cirugiaId&&(console.log("\u{1F4CB} Cargando cirug\xEDa para edici\xF3n:",this.cirugiaId),this.loading.set(!0),this.cirugiasService.getCirugiaById(this.cirugiaId).subscribe({next:i=>{console.log("\u2705 Cirug\xEDa cargada:",i),this.populateForm(i),this.cirugiaEditada.set(i),this.cirugiaId&&this.verificarKit(this.cirugiaId),this.loading.set(!1)},error:i=>{console.error("\u274C Error loading cirugia:",i),this.error.set("Error al cargar la cirug\xEDa: "+(i?.message||i)),this.loading.set(!1)}}))}populateForm(i){let e=new Date(i.fecha_programada).toISOString().split("T")[0];this.cirugiaForm.patchValue({hospital_id:i.hospital_id,tipo_cirugia_id:i.tipo_cirugia_id,medico_cirujano:i.medico_cirujano,fecha_programada:e,hora_inicio:i.hora_inicio,duracion_estimada:i.duracion_estimada,estado:i.estado,prioridad:i.prioridad,tecnico_asignado_id:i.tecnico_asignado_id,notas:i.notas}),i.cliente&&(this.clienteEncontrado.set(i.cliente),this.llenarCamposCliente(i.cliente),this.cirugiaForm.patchValue({documento_numero:i.cliente.documento_numero}))}onDocumentoChange(){let i=this.cirugiaForm.get("documento_numero")?.value;i&&i.length>=6?this.buscarClientePorDocumento(i):(this.clienteEncontrado.set(null),this.limpiarCamposCliente())}buscarClientePorDocumento(i){this.buscandoCliente.set(!0),this.clientesService.buscarPorDocumento(i).subscribe({next:e=>{e?(console.log("\u2705 Cliente encontrado:",e),this.clienteEncontrado.set(e),this.llenarCamposCliente(e)):(console.log("\u2139\uFE0F Cliente no encontrado"),this.clienteEncontrado.set(null)),this.buscandoCliente.set(!1)},error:e=>{console.error("\u274C Error buscando cliente:",e),this.clienteEncontrado.set(null),this.buscandoCliente.set(!1)}})}llenarCamposCliente(i){this.cirugiaForm.patchValue({documento_tipo:i.documento_tipo,nombre:i.nombre,apellido:i.apellido,telefono:i.telefono,email:i.email})}limpiarCamposCliente(){this.cirugiaForm.patchValue({nombre:"",apellido:"",telefono:"",email:""})}onTipoCirugiaChange(i){let l=i.target.value;console.log("\u{1F504} Tipo de cirug\xEDa seleccionado:",l);let s=this.tiposCirugia().find(T=>T.id===l);console.log("\u{1F4CB} Tipo encontrado:",s),s?.duracion_promedio&&(console.log("\u23F1\uFE0F Actualizando duraci\xF3n estimada:",s.duracion_promedio),this.cirugiaForm.patchValue({duracion_estimada:s.duracion_promedio}))}onSubmit(){if(console.log("\u{1F4DD} Enviando formulario..."),console.log("\u{1F50D} Form v\xE1lido:",this.cirugiaForm.valid),console.log("\u{1F4CA} Form values:",this.cirugiaForm.value),this.cirugiaForm.invalid){console.log("\u26A0\uFE0F Formulario inv\xE1lido, marcando campos..."),this.markFormGroupTouched();return}this.loading.set(!0),this.error.set(null);let i=this.cirugiaForm.value;this.procesarCliente(i).subscribe({next:e=>{console.log("\u2705 Cliente procesado:",e),this.crearCirugiaConCliente(i,e)},error:e=>{console.error("\u274C Error procesando cliente:",e),this.error.set("Error al procesar informaci\xF3n del cliente"),this.loading.set(!1)}})}procesarCliente(i){let e={nombre:i.nombre,apellido:i.apellido,documento_tipo:i.documento_tipo,documento_numero:i.documento_numero,telefono:i.telefono,email:i.email};return this.clienteEncontrado()?G(this.clienteEncontrado()):this.clientesService.buscarOCrear(e)}crearCirugiaConCliente(i,e){if(!e.id)throw new Error("El cliente no tiene un ID v\xE1lido");let l={numero_cirugia:this.isEditing?i.numero_cirugia:this.generateNumeroCirugia(),cliente_id:e.id,hospital_id:i.hospital_id,tipo_cirugia_id:i.tipo_cirugia_id,medico_cirujano:i.medico_cirujano,fecha_programada:new Date(i.fecha_programada).toISOString(),hora_inicio:i.hora_inicio,duracion_estimada:i.duracion_estimada,estado:i.estado,prioridad:i.prioridad,tecnico_asignado_id:i.tecnico_asignado_id,notas:i.notas};console.log("\u{1F4BE} Datos de cirug\xEDa a enviar:",l),this.isEditing&&this.cirugiaId?this.updateCirugia(l):this.createCirugia(l)}createCirugia(i){console.log("\u2795 Creando nueva cirug\xEDa..."),this.cirugiasService.createCirugia(i).subscribe({next:e=>q(this,null,function*(){console.log("\u2705 Cirug\xEDa creada exitosamente:",e),this.cirugiaCreada.set(e);try{let{data:l}=yield this.authService.session(),s=l?.session?.user?.id,T="Un comercial";if(s){let{data:I}=yield this.supabaseService.supabaseClient.from("profiles").select("full_name").eq("id",s).single();I?.full_name&&(T=I.full_name)}let ve=this.hospitales().find(I=>I.id===i.hospital_id)?.nombre||"Hospital no especificado",fe=new Date(i.fecha_programada).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"});yield this.notificationService.notifyNewCirugia(i.tecnico_asignado_id||null,e.id,e.numero_cirugia,i.medico_cirujano,fe,ve,T),console.log("\u2705 Notificaciones de nueva cirug\xEDa enviadas")}catch(l){console.error("\u274C Error al enviar notificaciones:",l)}this.loading.set(!1),this.successDialogTitle.set(`La cirug\xEDa se ha programado
exitosamente`),this.successDialogAction.set("create"),this.showSuccessDialog.set(!0)}),error:e=>{console.error("\u274C Error creating cirugia:",e),this.error.set("Error al crear la cirug\xEDa: "+(e?.message||e)),this.loading.set(!1)}})}updateCirugia(i){this.cirugiaId&&(console.log("\u{1F4DD} Actualizando cirug\xEDa..."),this.cirugiasService.updateCirugia(this.cirugiaId,i).subscribe({next:e=>{console.log("\u2705 Cirug\xEDa actualizada exitosamente:",e),this.cirugiaEditada.set(e),this.loading.set(!1),this.successDialogTitle.set(`La cirug\xEDa se ha actualizado
exitosamente`),this.successDialogAction.set("update"),this.showSuccessDialog.set(!0)},error:e=>{console.error("\u274C Error updating cirugia:",e),this.error.set("Error al actualizar la cirug\xEDa: "+(e?.message||e)),this.loading.set(!1)}}))}generateNumeroCirugia(){let i=new Date().getFullYear(),e=Date.now().toString().slice(-6);return`CIR-${i}-${e}`}markFormGroupTouched(){Object.keys(this.cirugiaForm.controls).forEach(i=>{this.cirugiaForm.get(i)?.markAsTouched()})}isFieldInvalid(i){let e=this.cirugiaForm.get(i);return!!(e&&e.invalid&&(e.dirty||e.touched))}getFieldError(i){let e=this.cirugiaForm.get(i);if(e?.errors){if(e.errors.required)return"Este campo es requerido";if(e.errors.minlength)return`Debe tener al menos ${e.errors.minlength.requiredLength} caracteres`;if(e.errors.min)return`Debe ser mayor a ${e.errors.min.min}`}return""}onCancel(){this.router.navigate(["/internal/agenda"])}verificarKit(i){this.kitService.tieneKit(i).subscribe({next:e=>{this.tieneKit.set(e)},error:e=>{console.error("Error verificando kit:",e),this.tieneKit.set(!1)}})}onCrearKit(){let i=this.cirugiaCreada()||this.cirugiaEditada();i&&this.router.navigate(["/internal/agenda/kit-builder",i.id])}onVolverAgenda(){this.router.navigate(["/internal/agenda"])}onSuccessDialogClose(){this.showSuccessDialog.set(!1),this.router.navigate(["/internal/agenda"])}onVerDetalles(){this.showSuccessDialog.set(!1);let i=this.cirugiaCreada()||this.cirugiaEditada();i&&(console.log("\u{1F50D} Navegando a detalles de cirug\xEDa:",i.id),this.router.navigate(["/internal/agenda/detalle",i.id]))}onAgendarOtraCirugia(){this.showSuccessDialog.set(!1),this.cirugiaCreada.set(null),this.cirugiaEditada.set(null),this.cirugiaForm.reset({documento_tipo:"cedula",estado:"programada",prioridad:"normal"}),this.clienteEncontrado.set(null),console.log("\u{1F4DD} Formulario reseteado para nueva cirug\xEDa")}debugHospitales(){console.log("\u{1F3E5} Debug Hospitales:",this.hospitales())}debugTipos(){console.log("\u2695\uFE0F Debug Tipos:",this.tiposCirugia())}debugTecnicos(){console.log("\u{1F468}\u200D\u2695\uFE0F Debug T\xE9cnicos:",this.tecnicos())}getClienteNombreCreada(){let i=this.cirugiaCreada();return i?.cliente?`${i.cliente.nombre} ${i.cliente.apellido}`.trim():"Sin informaci\xF3n"}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=K({type:o,selectors:[["app-cirugia-form"]],decls:26,vars:11,consts:[[1,"min-h-screen","bg-white","relative"],[1,"fixed","inset-0","z-0"],["src","02.jpg","alt","Background",1,"absolute","inset-0","w-full","h-full","object-cover"],[1,"absolute","inset-0","bg-white/90"],[1,"relative","z-10"],[1,"bg-white","shadow-md"],[1,"max-w-lg","mx-auto","px-4","py-4"],[1,"flex","justify-between","items-center"],[1,"flex","items-center","space-x-3"],[1,"bg-white","rounded-lg","px-3","py-2"],["src","https://www.implameq.com/wp-content/uploads/logotipo-impla-300x78.png.webp","alt","Implameq",1,"h-6"],[1,"flex","items-center","space-x-2","sm:space-x-3"],[1,"w-10","h-10","bg-[#10284C]","rounded-lg","flex","items-center","justify-center","active:scale-95","transition-transform",3,"routerLink"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5","text-white"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"],[1,"w-10","h-10","bg-[#C8D900]","rounded-lg","flex","items-center","justify-center","active:scale-95","transition-transform",3,"routerLink"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5","text-[#10284C]"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"],[1,"max-w-lg","mx-auto","px-4","py-6","text-center"],[1,"text-2xl","sm:text-3xl","font-bold","text-[#10284C]","mb-2"],[1,"text-[#10284C]/70","text-sm"],[1,"px-4","py-6"],[3,"close","verDetalles","agendarOtra","isOpen","title","showDetailsButton","showAgendarButton"],[1,"max-w-lg","mx-auto"],[1,"bg-white","rounded-xl","shadow-md","dark:bg-gray-800","p-6","text-center"],[1,"animate-pulse","space-y-4"],[1,"h-4","bg-gray-200","rounded","w-3/4","mx-auto"],[1,"h-4","bg-gray-200","rounded","w-1/2","mx-auto"],[1,"h-4","bg-gray-200","rounded","w-2/3","mx-auto"],[1,"text-sm","text-gray-500","mt-4"],[1,"px-4","py-4"],[1,"max-w-lg","mx-auto","px-4","pb-8"],[1,"bg-red-50","border","border-red-200","text-red-700","px-4","py-3","rounded-xl","shadow-md"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5","text-red-500","flex-shrink-0"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"],[1,"flex-1"],[1,"text-sm"],[1,"mt-3","w-full","bg-red-600","hover:bg-red-700","text-white","px-4","py-2","rounded-lg","text-sm","font-medium","transition","duration-200",3,"click"],[1,"bg-green-50","border","border-green-200","text-green-700","px-4","py-3","rounded-xl","shadow-md"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5","text-green-500","flex-shrink-0"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M5 13l4 4L19 7"],[1,"bg-green-50","border","border-green-200","rounded-xl","shadow-md","p-6","text-center"],[1,"mb-4"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-12","h-12","text-green-500","mx-auto","mb-3"],[1,"text-lg","font-semibold","text-green-800","mb-2"],[1,"text-green-700","text-sm","mb-1"],[1,"font-medium"],[1,"text-green-600","text-sm"],[1,"space-y-3"],[1,"text-sm","text-gray-700","mb-4"],[1,"space-y-2"],["type","button",1,"w-full","bg-blue-600","hover:bg-blue-700","text-white","px-4","py-3","rounded-lg","font-medium","transition","duration-200","shadow-md",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5","inline","mr-2"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"],["type","button",1,"w-full","bg-gray-100","hover:bg-gray-200","text-gray-700","border","border-gray-300","px-4","py-3","rounded-lg","font-medium","transition","duration-200",3,"click"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M10 19l-7-7m0 0l7-7m-7 7h18"],[1,"bg-blue-50","border","border-blue-200","rounded-xl","shadow-md","p-4"],[1,"flex","items-start","space-x-3"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6","text-blue-500","flex-shrink-0","mt-0.5"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"text-sm","font-medium","text-blue-800","mb-1"],[1,"text-sm","text-blue-700","mb-3"],["type","button",1,"bg-blue-600","hover:bg-blue-700","text-white","px-4","py-2","rounded-lg","text-sm","font-medium","transition","duration-200","shadow-md",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4","inline","mr-2"],[1,"bg-green-50","border","border-green-200","rounded-xl","shadow-md","p-4"],[1,"text-sm","font-medium","text-green-800"],[1,"text-xs","text-green-600"],[1,"space-y-4",3,"ngSubmit","formGroup"],[1,"bg-white/50","rounded-2xl","border-2","border-[#0098A8]","overflow-hidden","shadow-sm"],[1,"bg-white/50","px-4","py-3","border-b-2","border-[#0098A8]"],[1,"flex","items-center","space-x-2"],[1,"w-8","h-8","bg-[#C8D900]","rounded-lg","flex","items-center","justify-center","flex-shrink-0"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"],[1,"text-lg","font-bold","text-[#10284C]"],[1,"mb-3","p-2.5","bg-green-100","border","border-green-200","rounded-lg"],[1,"grid","grid-cols-3","gap-3"],[1,"block","text-sm","font-medium","text-[#10284C]","mb-1"],["formControlName","documento_tipo",1,"w-full","px-3","py-2","bg-gray-100","border","border-gray-300","rounded-lg","focus:outline-none","focus:ring-2","focus:ring-[#0098A8]","focus:border-transparent"],[3,"value"],[1,"col-span-2"],[1,"text-blue-600","text-xs","ml-1"],["type","text","formControlName","documento_numero","placeholder","12345678",3,"input"],[1,"mt-1","text-xs","text-red-600"],[1,"grid","grid-cols-2","gap-3"],["type","text","formControlName","nombre","placeholder","Juan Carlos"],["type","text","formControlName","apellido","placeholder","P\xE9rez Garc\xEDa"],["type","tel","formControlName","telefono","placeholder","3001234567",1,"w-full","px-3","py-2","bg-gray-100","border","border-gray-300","rounded-lg","focus:outline-none","focus:ring-2","focus:ring-[#0098A8]","focus:border-transparent"],["type","email","formControlName","email","placeholder","cliente@email.com"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"],[1,"p-4","space-y-3"],[1,"text-xs","text-gray-500"],["formControlName","hospital_id"],["value",""],["formControlName","tipo_cirugia_id",3,"change"],["type","text","formControlName","medico_cirujano","placeholder","Dr. Roberto Silva"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"],["type","date","formControlName","fecha_programada"],["type","time","formControlName","hora_inicio",1,"w-full","px-3","py-2","bg-gray-100","border","border-gray-300","rounded-lg","focus:outline-none","focus:ring-2","focus:ring-[#0098A8]","focus:border-transparent"],["type","number","formControlName","duracion_estimada","placeholder","120","min","15"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"],["formControlName","estado",1,"w-full","px-3","py-2","bg-gray-100","border","border-gray-300","rounded-lg","focus:outline-none","focus:ring-2","focus:ring-[#0098A8]","focus:border-transparent"],["formControlName","prioridad",1,"w-full","px-3","py-2","bg-gray-100","border","border-gray-300","rounded-lg","focus:outline-none","focus:ring-2","focus:ring-[#0098A8]","focus:border-transparent"],["formControlName","tecnico_asignado_id",1,"w-full","px-3","py-2","bg-gray-100","border","border-gray-300","rounded-lg","focus:outline-none","focus:ring-2","focus:ring-[#0098A8]","focus:border-transparent"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"],[1,"p-4"],["formControlName","notas","rows","4","placeholder","Informaci\xF3n adicional sobre la cirug\xEDa...",1,"w-full","px-3","py-2","bg-gray-100","border","border-gray-300","rounded-lg","focus:outline-none","focus:ring-2","focus:ring-[#0098A8]","focus:border-transparent","resize-none"],[1,"space-y-3","pt-2"],["type","submit",1,"w-full","bg-[#C8D900]","hover:bg-[#B8C900]","active:bg-[#B8C900]","disabled:bg-gray-400","disabled:cursor-not-allowed","text-[#10284C]","font-bold","py-4","rounded-2xl","shadow-lg","transition-all","active:scale-95","flex","items-center","justify-center","space-x-3",3,"disabled"],[1,"animate-spin","rounded-full","h-5","w-5","border-b-2","border-[#10284C]"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5"],[1,"text-lg"],["type","button",1,"w-full","bg-[#10284C]","hover:bg-[#10284C]/90","active:bg-[#10284C]/90","text-[#C8D900]","font-bold","py-3","rounded-2xl","transition-all","active:scale-95",3,"click"],[1,"h-6"],[1,"flex","items-center","text-green-800"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4","mr-2","flex-shrink-0"],[1,"text-xs","sm:text-sm","font-medium"]],template:function(e,l){e&1&&(t(0,"div",0)(1,"div",1),d(2,"img",2)(3,"div",3),n(),t(4,"div",4)(5,"div",5)(6,"div",6)(7,"div",7)(8,"div",8)(9,"div",9),d(10,"img",10),n()(),t(11,"div",11)(12,"button",12),p(),t(13,"svg",13),d(14,"path",14),n()(),C(),t(15,"button",15),p(),t(16,"svg",16),d(17,"path",17),n()()()()()(),C(),t(18,"div",18)(19,"h1",19),r(20),n(),t(21,"p",20),r(22),n()(),_(23,Ee,9,0,"div",21)(24,Qe,6,6),n(),t(25,"app-success-dialog",22),b("close",function(){return l.onSuccessDialogClose()})("verDetalles",function(){return l.onVerDetalles()})("agendarOtra",function(){return l.onAgendarOtraCirugia()}),n()()),e&2&&(a(12),h("routerLink",L(9,xe)),a(3),h("routerLink",L(10,be)),a(5),w(" ",l.isEditing?"Editar Cirug\xEDa":"Programa Nueva Cirug\xEDa"," "),a(2),w(" ",l.isEditing?"Actualiza la informaci\xF3n de la cirug\xEDa":"Completa los datos para programar la cirug\xEDa"," "),a(),u(l.loading()?23:24),a(2),h("isOpen",l.showSuccessDialog())("title",l.successDialogTitle())("showDetailsButton",!0)("showAgendarButton",l.successDialogAction()==="create"))},dependencies:[P,de,Z,oe,re,Y,ee,ne,W,X,ae,ie,te,U,_e],encapsulation:2})};export{Ce as CirugiaFormComponent};
