import{a as E}from"./chunk-KXFMV5OZ.js";import{c as l,d as m,g as f,j as G,q as H,u as v}from"./chunk-6SF67QVY.js";import{a as b,h as g}from"./chunk-FK42CRUA.js";var w=class j{supabase=v(E);getHojasGasto(a){return l(this.fetchHojasGasto(a))}getHojaGasto(a){return l(this.fetchHojaGasto(a))}createHojaGasto(a){return l(this.insertHojaGasto(a))}updateHojaGasto(a,o){return l(this.updateHojaGastoData(a,o))}cambiarEstado(a,o){return l(this.updateEstado(a,o))}deleteHojaGasto(a){return l(this.removeHojaGasto(a))}existeHojaGastoPorCirugia(a){return l(this.supabase.client.from("hojas_gasto").select("id").eq("cirugia_id",a).limit(1)).pipe(f(({data:o,error:t})=>t?(console.error("Error verificando hoja de gasto existente:",t),!1):o!==null&&o.length>0))}getHojaGastoPorCirugia(a){return l(this.supabase.client.from("hojas_gasto").select(`
          *,
          hoja_gasto_items(*)
        `).eq("cirugia_id",a).single()).pipe(f(({data:o,error:t})=>{if(t){if(t.code==="PGRST116")return null;throw console.error("Error obteniendo hoja de gasto por cirug\xEDa:",t),t}return this.mapToHojaGasto(o)}),G(o=>(console.error("Error in getHojaGastoPorCirugia:",o),m(null))))}recalcularTotales(a){let o={total_productos:0,total_transporte:0,total_otros:0,total_general:0};return(a.items||a.hoja_gasto_items||[]).forEach(s=>{let i=s.subtotal||s.precio_total||s.cantidad*s.precio_unitario;switch(o.total_general+=i,s.categoria){case"productos":o.total_productos+=i;break;case"transporte":o.total_transporte+=i;break;case"otros":o.total_otros+=i;break}}),b(b({},a),o)}fetchHojasGasto(a){return g(this,null,function*(){try{let o=this.supabase.client.from("hojas_gasto").select(`
          *,
          hoja_gasto_items(*)
        `);a?.estado&&(o=o.eq("estado",a.estado)),a?.fecha_desde&&(o=o.gte("fecha_cirugia",a.fecha_desde)),a?.fecha_hasta&&(o=o.lte("fecha_cirugia",a.fecha_hasta)),a?.tecnico_id&&(o=o.eq("tecnico_id",a.tecnico_id));let{data:t,error:s}=yield o.order("created_at",{ascending:!1});if(s)throw console.error("Error fetching hojas gasto:",s),s;return this.mapToHojasGasto(t||[])}catch(o){throw console.error("Error in fetchHojasGasto:",o),o}})}fetchHojaGasto(a){return g(this,null,function*(){try{let{data:o,error:t}=yield this.supabase.client.from("hojas_gasto").select(`
          *,
          hoja_gasto_items(*)
        `).eq("id",a).single();if(t){if(t.code==="PGRST116")return null;throw console.error("Error fetching hoja gasto:",t),t}return this.mapToHojaGasto(o)}catch(o){throw console.error("Error in fetchHojaGasto:",o),o}})}insertHojaGasto(a){return g(this,null,function*(){try{console.log("\u{1F4DD} Creando hoja de gasto con request:",a);let{data:o,error:t}=yield this.supabase.client.from("hojas_gasto").select("id, numero_hoja, estado").eq("cirugia_id",a.cirugia_id).limit(1);if(t)throw console.error("\u274C Error verificando hoja existente:",t),t;if(o&&o.length>0){let r=o[0];throw console.warn("\u26A0\uFE0F Ya existe una hoja de gasto para esta cirug\xEDa:",r),new Error(`Ya existe una hoja de gasto (${r.numero_hoja}) para esta cirug\xEDa. No se pueden crear hojas duplicadas.`)}console.log("\u2705 No hay hojas de gasto existentes para esta cirug\xEDa, continuando...");let s=yield this.generateNumeroHoja();console.log("\u{1F522} N\xFAmero de hoja generado:",s);let i=0,_=0,n=0,u=0;a.items&&a.items.length>0&&a.items.forEach(r=>{let e=(r.cantidad_usada||r.cantidad||0)*r.precio_unitario;switch(u+=e,r.categoria){case"productos":i+=e;break;case"transporte":_+=e;break;case"otros":n+=e;break}}),console.log("\u{1F4B0} Totales calculados:",{total_productos:i,total_transporte:_,total_otros:n,total_general:u});let d={numero_hoja:s,cirugia_id:a.cirugia_id,tecnico_id:a.tecnico_id,fecha_cirugia:a.fecha_cirugia,estado:"borrador",total_productos:i,total_transporte:_,total_otros:n,total_general:u,observaciones:a.observaciones||null};console.log("\u{1F4E4} Datos EXACTOS a insertar (SIN alojamiento):",d),console.log("\u{1F50D} Verificando que NO existe total_alojamiento:",Object.keys(d));let{data:p,error:c}=yield this.supabase.client.from("hojas_gasto").insert(d).select().single();if(c)throw console.error("\u274C Error inserting hoja gasto:",c),console.error("\u{1F4CB} Error details:",JSON.stringify(c,null,2)),c;if(console.log("\u2705 Hoja de gasto creada:",p),a.items&&a.items.length>0){let r=a.items.map(e=>({hoja_gasto_id:p.id,producto_id:e.producto_id,categoria:e.categoria,descripcion:e.descripcion||e.nombre_producto||"",cantidad:e.cantidad||e.cantidad_usada||0,precio_unitario:e.precio_unitario,precio_total:(e.cantidad||e.cantidad_usada||0)*e.precio_unitario,fecha_gasto:e.fecha_gasto,comprobante_url:e.comprobante_url,observaciones:e.observaciones})),{error:h}=yield this.supabase.client.from("hoja_gasto_items").insert(r);if(h)throw console.error("Error inserting hoja gasto items:",h),yield this.supabase.client.from("hojas_gasto").delete().eq("id",p.id),h}return yield this.fetchHojaGasto(p.id)}catch(o){throw console.error("Error in insertHojaGasto:",o),o}})}updateHojaGastoData(a,o){return g(this,null,function*(){try{let t=0,s=0,i=0,_=0;o.items&&o.items.length>0&&o.items.forEach(d=>{let c=(d.cantidad_usada||d.cantidad||0)*d.precio_unitario;switch(_+=c,d.categoria){case"productos":t+=c;break;case"transporte":s+=c;break;case"otros":i+=c;break}});let n={updated_at:new Date().toISOString()};o.estado&&(n.estado=o.estado),o.observaciones!==void 0&&(n.observaciones=o.observaciones),o.items&&o.items.length>0&&(n.total_productos=t,n.total_transporte=s,n.total_otros=i,n.total_general=_),console.log("\u{1F4E4} Update data EXACTOS (SIN alojamiento):",n),console.log("\u{1F50D} Verificando keys de update:",Object.keys(n));let{error:u}=yield this.supabase.client.from("hojas_gasto").update(n).eq("id",a);if(u)throw console.error("Error updating hoja gasto:",u),u;if(o.items&&o.items.length>0){let{error:d}=yield this.supabase.client.from("hoja_gasto_items").delete().eq("hoja_gasto_id",a);if(d)throw console.error("Error deleting existing items:",d),d;let p=o.items.map(r=>({hoja_gasto_id:a,producto_id:r.producto_id,categoria:r.categoria,descripcion:r.descripcion||r.nombre_producto||"",cantidad:r.cantidad||r.cantidad_usada||0,precio_unitario:r.precio_unitario,precio_total:(r.cantidad||r.cantidad_usada||0)*r.precio_unitario,fecha_gasto:r.fecha_gasto,comprobante_url:r.comprobante_url,observaciones:r.observaciones})),{error:c}=yield this.supabase.client.from("hoja_gasto_items").insert(p);if(c)throw console.error("Error inserting updated items:",c),c}return yield this.fetchHojaGasto(a)}catch(t){throw console.error("Error in updateHojaGastoData:",t),t}})}updateEstado(a,o){return g(this,null,function*(){try{let{error:t}=yield this.supabase.client.from("hojas_gasto").update({estado:o,updated_at:new Date().toISOString()}).eq("id",a);if(t)throw console.error("Error updating estado:",t),t;return yield this.fetchHojaGasto(a)}catch(t){throw console.error("Error in updateEstado:",t),t}})}removeHojaGasto(a){return g(this,null,function*(){try{yield this.supabase.client.from("hoja_gasto_items").delete().eq("hoja_gasto_id",a);let{error:o}=yield this.supabase.client.from("hojas_gasto").delete().eq("id",a);if(o)throw console.error("Error deleting hoja gasto:",o),o;return!0}catch(o){throw console.error("Error in removeHojaGasto:",o),o}})}generateNumeroHoja(){return g(this,null,function*(){let a=new Date().getFullYear(),o=String(new Date().getMonth()+1).padStart(2,"0"),{data:t,error:s}=yield this.supabase.client.from("hojas_gasto").select("numero_hoja").like("numero_hoja",`HG-${a}${o}-%`).order("numero_hoja",{ascending:!1}).limit(1),i=1;if(t&&t.length>0){let _=t[0].numero_hoja.split("-")[2];i=parseInt(_)+1}return`HG-${a}${o}-${String(i).padStart(3,"0")}`})}mapToHojasGasto(a){return a.map(o=>this.mapToHojaGasto(o))}mapToHojaGasto(a){return{id:a.id,numero_hoja:a.numero_hoja,cirugia_id:a.cirugia_id,tecnico_id:a.tecnico_id,fecha_cirugia:a.fecha_cirugia,fecha_creacion:a.fecha_creacion||a.created_at,estado:a.estado,total_productos:a.total_productos||0,total_transporte:a.total_transporte||0,total_otros:a.total_otros||0,total_general:a.total_general||0,observaciones:a.observaciones,created_at:a.created_at,updated_at:a.updated_at,created_by:a.created_by,updated_by:a.updated_by,items:a.hoja_gasto_items?.map(o=>({id:o.id,hoja_gasto_id:o.hoja_gasto_id,producto_id:o.producto_id,categoria:o.categoria,descripcion:o.descripcion,cantidad:o.cantidad,precio_unitario:o.precio_unitario,precio_total:o.precio_total,fecha_gasto:o.fecha_gasto,comprobante_url:o.comprobante_url,observaciones:o.observaciones,created_at:o.created_at,updated_at:o.updated_at,nombre_producto:o.descripcion,cantidad_usada:o.cantidad,subtotal:o.precio_total}))||[],hoja_gasto_items:a.hoja_gasto_items?.map(o=>({id:o.id,hoja_gasto_id:o.hoja_gasto_id,producto_id:o.producto_id,categoria:o.categoria,descripcion:o.descripcion,cantidad:o.cantidad,precio_unitario:o.precio_unitario,precio_total:o.precio_total,fecha_gasto:o.fecha_gasto,comprobante_url:o.comprobante_url,observaciones:o.observaciones,created_at:o.created_at,updated_at:o.updated_at}))||[]}}static \u0275fac=function(o){return new(o||j)};static \u0275prov=H({token:j,factory:j.\u0275fac,providedIn:"root"})};var T={borrador:{label:"Borrador",color:"bg-gray-100 text-gray-800",descripcion:"En proceso"},revision:{label:"En Revisi\xF3n",color:"bg-yellow-100 text-yellow-800",descripcion:"Revisi\xF3n"},aprobada:{label:"Aprobada",color:"bg-green-100 text-green-800",descripcion:"Aprobada"},rechazada:{label:"Rechazada",color:"bg-red-100 text-red-800",descripcion:"Rechazada"}},k={productos:{label:"Productos M\xE9dicos",color:"bg-blue-100 text-blue-800",icon:""},transporte:{label:"Transporte",color:"bg-green-100 text-green-800",icon:""},otros:{label:"Otros Gastos",color:"bg-gray-100 text-gray-800",icon:""}};export{w as a,T as b,k as c};
