# Fix para Error: kits_cirugia_estado_check Constraint Violation

## üî¥ Problema
```
ERROR: 23514: check constraint "kits_cirugia_estado_check" 
of relation "kits_cirugia" is violated by some row
```

## üîç Causa Ra√≠z
1. **Constraint Existe en Supabase pero NO en schema local**: El archivo `database.sql` no ten√≠a definida la restricci√≥n CHECK para el campo `estado`
2. **Valores Inv√°lidos**: Alguna fila en `kits_cirugia` tiene un valor de `estado` que no est√° en la lista permitida por el constraint
3. **Aplicaci√≥n Accidental**: Mencionaste aplicar algo dos veces - probablemente aplicaste un ALTER TABLE que agreg√≥ el constraint y ahora los datos existentes lo violan

## ‚úÖ Soluci√≥n

### Paso 1: Ejecutar el Script de Correcci√≥n
Ejecuta el archivo `fix_kits_cirugia_estado_constraint.sql` en Supabase SQL Editor paso por paso:

```sql
-- 1. Ver qu√© valores de estado existen actualmente
SELECT DISTINCT estado, COUNT(*) as cantidad
FROM public.kits_cirugia
GROUP BY estado
ORDER BY estado;
```

**Analiza el resultado**: ¬øHay valores como `'en_preparacion'`, `'pendiente'`, `'enviado'`, o NULL?

```sql
-- 2. Eliminar el constraint problem√°tico
ALTER TABLE public.kits_cirugia
DROP CONSTRAINT IF EXISTS kits_cirugia_estado_check;
```

```sql
-- 3. Ver filas con valores inv√°lidos
SELECT id, numero_kit, estado
FROM public.kits_cirugia
WHERE estado IS NULL OR estado NOT IN (
  'solicitado', 'preparando', 'listo_envio', 'en_transito',
  'entregado', 'en_uso', 'devuelto', 'finalizado', 'cancelado'
);
```

```sql
-- 4. Corregir valores inv√°lidos (ajusta seg√∫n lo que encontraste)
-- Ejemplo: convertir NULL a 'preparando'
UPDATE public.kits_cirugia
SET estado = 'preparando'
WHERE estado IS NULL;

-- Ejemplo: convertir 'en_preparacion' a 'preparando'
UPDATE public.kits_cirugia
SET estado = 'preparando'
WHERE estado = 'en_preparacion';

-- Ejemplo: convertir 'enviado' a 'en_transito'
UPDATE public.kits_cirugia
SET estado = 'en_transito'
WHERE estado = 'enviado';
```

```sql
-- 5. Recrear el constraint con los valores correctos
ALTER TABLE public.kits_cirugia
ADD CONSTRAINT kits_cirugia_estado_check 
CHECK (estado IN (
  'solicitado',      -- FASE 1: Kit solicitado por comercial
  'preparando',      -- FASE 2: Log√≠stica preparando el kit
  'listo_envio',     -- FASE 2: Kit listo para enviar
  'en_transito',     -- FASE 3: Kit en camino al cliente/hospital
  'entregado',       -- FASE 3: Kit entregado y validado por cliente
  'en_uso',          -- FASE 4: Kit en uso durante cirug√≠a
  'devuelto',        -- FASE 5-6: Kit devuelto a log√≠stica
  'finalizado',      -- FASE 7: Proceso completo, listo para facturaci√≥n
  'cancelado'        -- Cualquier fase: Kit/cirug√≠a cancelada
));
```

```sql
-- 6. Verificar que el constraint se cre√≥ correctamente
SELECT conname, pg_get_constraintdef(oid) as definition
FROM pg_constraint
WHERE conrelid = 'public.kits_cirugia'::regclass
  AND conname = 'kits_cirugia_estado_check';
```

### Paso 2: Archivo database.sql Actualizado
Ya actualic√© el archivo `database.sql` para incluir:
- ‚úÖ Los 4 nuevos campos para validaci√≥n de cliente
- ‚úÖ El constraint CHECK con los 9 estados permitidos

## üìã Estados Permitidos del Kit (Flujo de 7 Fases)

| Estado | Fase | Descripci√≥n |
|--------|------|-------------|
| `solicitado` | FASE 1 | Comercial cre√≥ la cirug√≠a y solicit√≥ el kit |
| `preparando` | FASE 2 | Log√≠stica est√° preparando los productos del kit |
| `listo_envio` | FASE 2 | Kit completo, listo para enviar al cliente |
| `en_transito` | FASE 3 | Kit en camino hacia el hospital/cliente |
| `entregado` | FASE 3 | Cliente valid√≥ recepci√≥n del kit con QR |
| `en_uso` | FASE 4 | T√©cnico est√° usando el kit en la cirug√≠a |
| `devuelto` | FASE 5-6 | Kit devuelto a log√≠stica post-cirug√≠a |
| `finalizado` | FASE 7 | Proceso completo, kit inventariado, listo para facturar |
| `cancelado` | Cualquiera | Cirug√≠a/kit cancelado |

## üîß Campos Nuevos Agregados a kits_cirugia

```typescript
cliente_receptor_nombre: string | null   // Nombre del empleado del hospital
cliente_receptor_cedula: string | null   // C√©dula del receptor
cliente_validacion_fecha: timestamp | null  // Cu√°ndo se valid√≥ la entrega
cliente_validacion_qr: string | null     // QR code usado para validar
```

## üöÄ Pr√≥ximos Pasos

Despu√©s de corregir este error:

1. **Actualizar componente kit-builder** para usar los nuevos estados
2. **Implementar QR de validaci√≥n de entrega** (FASE 3)
3. **Actualizar transiciones de estado** en el flujo del negocio

## ‚ö†Ô∏è Prevenci√≥n Futura

Para evitar este error en el futuro:
- Siempre mant√©n `database.sql` sincronizado con Supabase
- Usa migraciones versionadas para cambios de schema
- Valida datos antes de agregar constraints
- Documenta todos los cambios de schema
