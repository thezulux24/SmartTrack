-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- SCRIPT DE DIAGNรSTICO: Listar todos los triggers y funciones
-- Fecha: 2025-10-13
-- Descripciรณn: Muestra todos los triggers, funciones y sus definiciones
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 1. FUNCIONES (FUNCTIONS)
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

DO $$
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
  RAISE NOTICE '๐ FUNCIONES DEFINIDAS EN EL SCHEMA PUBLIC';
  RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
  RAISE NOTICE '';
END $$;

SELECT 
  p.proname AS "Nombre de la Funciรณn",
  pg_get_function_identity_arguments(p.oid) AS "Argumentos",
  CASE 
    WHEN p.prorettype = 'trigger'::regtype THEN 'TRIGGER'
    ELSE pg_catalog.format_type(p.prorettype, NULL)
  END AS "Tipo de Retorno",
  l.lanname AS "Lenguaje",
  CASE p.provolatile
    WHEN 'i' THEN 'IMMUTABLE'
    WHEN 's' THEN 'STABLE'
    WHEN 'v' THEN 'VOLATILE'
  END AS "Volatilidad"
FROM pg_proc p
LEFT JOIN pg_namespace n ON n.oid = p.pronamespace
LEFT JOIN pg_language l ON l.oid = p.prolang
WHERE n.nspname = 'public'
  AND p.prokind = 'f'  -- Solo funciones (no procedimientos)
ORDER BY p.proname;

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 2. TRIGGERS
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

DO $$
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
  RAISE NOTICE 'โก TRIGGERS DEFINIDOS EN EL SCHEMA PUBLIC';
  RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
  RAISE NOTICE '';
END $$;

SELECT 
  tgname AS "Nombre del Trigger",
  tgrelid::regclass AS "Tabla",
  CASE 
    WHEN tgtype & 2 = 2 THEN 'BEFORE'
    WHEN tgtype & 64 = 64 THEN 'INSTEAD OF'
    ELSE 'AFTER'
  END AS "Timing",
  CASE 
    WHEN tgtype & 4 = 4 THEN 'INSERT'
    WHEN tgtype & 8 = 8 THEN 'DELETE'
    WHEN tgtype & 16 = 16 THEN 'UPDATE'
    WHEN tgtype & 32 = 32 THEN 'TRUNCATE'
  END AS "Evento",
  CASE 
    WHEN tgtype & 1 = 1 THEN 'ROW'
    ELSE 'STATEMENT'
  END AS "Nivel",
  p.proname AS "Funciรณn Asociada",
  tgenabled AS "Habilitado"
FROM pg_trigger t
JOIN pg_class c ON t.tgrelid = c.oid
JOIN pg_namespace n ON c.relnamespace = n.oid
JOIN pg_proc p ON t.tgfoid = p.oid
WHERE n.nspname = 'public'
  AND NOT t.tgisinternal  -- Excluir triggers internos de sistema
ORDER BY tgrelid::regclass::text, tgname;

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 3. DEFINICIONES COMPLETAS DE FUNCIONES
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

DO $$
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
  RAISE NOTICE '๐ CรDIGO FUENTE DE FUNCIONES';
  RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
  RAISE NOTICE '';
END $$;

-- Mostrar el cรณdigo de cada funciรณn
DO $$
DECLARE
  func_record RECORD;
  func_definition TEXT;
BEGIN
  FOR func_record IN 
    SELECT 
      p.oid,
      p.proname,
      pg_get_function_identity_arguments(p.oid) AS args
    FROM pg_proc p
    LEFT JOIN pg_namespace n ON n.oid = p.pronamespace
    WHERE n.nspname = 'public'
      AND p.prokind = 'f'
    ORDER BY p.proname
  LOOP
    -- Obtener la definiciรณn completa
    SELECT pg_get_functiondef(func_record.oid) INTO func_definition;
    
    RAISE NOTICE '';
    RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
    RAISE NOTICE '๐ง FUNCIรN: %(%)', func_record.proname, func_record.args;
    RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
    RAISE NOTICE '%', func_definition;
    RAISE NOTICE '';
  END LOOP;
END $$;

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 4. RESUMEN EJECUTIVO
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

DO $$
DECLARE
  total_funciones INTEGER;
  total_triggers INTEGER;
  funciones_trigger INTEGER;
BEGIN
  -- Contar funciones
  SELECT COUNT(*) INTO total_funciones
  FROM pg_proc p
  LEFT JOIN pg_namespace n ON n.oid = p.pronamespace
  WHERE n.nspname = 'public'
    AND p.prokind = 'f';
  
  -- Contar triggers
  SELECT COUNT(*) INTO total_triggers
  FROM pg_trigger t
  JOIN pg_class c ON t.tgrelid = c.oid
  JOIN pg_namespace n ON c.relnamespace = n.oid
  WHERE n.nspname = 'public'
    AND NOT t.tgisinternal;
  
  -- Contar funciones de tipo TRIGGER
  SELECT COUNT(*) INTO funciones_trigger
  FROM pg_proc p
  LEFT JOIN pg_namespace n ON n.oid = p.pronamespace
  WHERE n.nspname = 'public'
    AND p.prokind = 'f'
    AND p.prorettype = 'trigger'::regtype;
  
  RAISE NOTICE '';
  RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
  RAISE NOTICE '๐ RESUMEN';
  RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
  RAISE NOTICE '๐ Total de Funciones: %', total_funciones;
  RAISE NOTICE 'โ๏ธ  Funciones de Trigger: %', funciones_trigger;
  RAISE NOTICE 'โก Total de Triggers: %', total_triggers;
  RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
  RAISE NOTICE '';
END $$;

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- 5. TRIGGERS RELACIONADOS CON COTIZACIONES (ESPECรFICO)
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

DO $$
BEGIN
  RAISE NOTICE '';
  RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
  RAISE NOTICE '๐ฐ TRIGGERS Y FUNCIONES DE COTIZACIONES';
  RAISE NOTICE 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ';
  RAISE NOTICE '';
END $$;

SELECT 
  t.tgname AS "Trigger",
  t.tgrelid::regclass AS "Tabla",
  p.proname AS "Funciรณn",
  CASE 
    WHEN t.tgtype & 2 = 2 THEN 'BEFORE'
    ELSE 'AFTER'
  END || ' ' ||
  CASE 
    WHEN t.tgtype & 4 = 4 THEN 'INSERT'
    WHEN t.tgtype & 8 = 8 THEN 'DELETE'
    WHEN t.tgtype & 16 = 16 THEN 'UPDATE'
  END AS "Tipo"
FROM pg_trigger t
JOIN pg_class c ON t.tgrelid = c.oid
JOIN pg_namespace n ON c.relnamespace = n.oid
JOIN pg_proc p ON t.tgfoid = p.oid
WHERE n.nspname = 'public'
  AND NOT t.tgisinternal
  AND (
    c.relname LIKE '%cotizacion%' OR 
    p.proname LIKE '%cotizacion%'
  )
ORDER BY c.relname, t.tgname;

-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
-- FIN DEL SCRIPT DE DIAGNรSTICO
-- โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
