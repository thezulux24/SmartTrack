# üîß Scripts de Migraci√≥n para Cotizaciones

## ‚ö° SOLUCI√ìN R√ÅPIDA (Empieza aqu√≠)

**¬øTu problema?** Las cotizaciones se guardan con IVA cuando NO deber√≠an.

**Soluci√≥n en 2 pasos:**
1. Ejecuta: `006_fix_iva_en_calculate_totals.sql` ‚≠ê
2. Verifica: `007_verificar_correccion_iva.sql` ‚úÖ

üìñ **Gu√≠a completa**: Ver `SOLUCION_RAPIDA_IVA.md`

---

## üîç Scripts de Diagn√≥stico (Ejecutar primero)

Antes de aplicar las migraciones, puedes ejecutar estos scripts para ver el estado actual:

### üìä Script 000a: Listar todos los triggers y funciones (completo)
**Archivo**: `000_list_all_triggers_and_functions.sql`
**Qu√© hace**:
- Lista todas las funciones definidas
- Lista todos los triggers activos
- Muestra el c√≥digo fuente completo de cada funci√≥n
- Genera un resumen ejecutivo
- Filtra espec√≠ficamente triggers de cotizaciones

**Cu√°ndo usar**: Para diagn√≥stico completo y detallado

### üìã Script 000b: Listar triggers (versi√≥n simple)
**Archivo**: `000_list_triggers_simple.sql`
**Qu√© hace**:
- Consultas SQL simples y r√°pidas
- Lista funciones, triggers y su c√≥digo
- M√°s f√°cil de leer y ejecutar

**Cu√°ndo usar**: Para verificaci√≥n r√°pida

---

## ÔøΩüìã Orden de Ejecuci√≥n - Migraciones

Ejecuta estos scripts **en orden** en el SQL Editor de Supabase:

### 1Ô∏è‚É£ Script 003: Corregir pol√≠ticas RLS
**Archivo**: `003_fix_cotizaciones_rls_policies.sql`
**Problema que resuelve**: 
- ‚ùå Error 403 Forbidden al insertar en `cotizacion_historial`
- ‚ùå Error 403 Forbidden al actualizar `cotizaciones` desde triggers

**Qu√© hace**:
- Permite que los triggers autom√°ticos funcionen
- Mantiene la seguridad para usuarios normales

---

### 2Ô∏è‚É£ Script 004: Agregar tipos de notificaci√≥n
**Archivo**: `004_add_cotizacion_notification_types.sql`
**Problema que resuelve**:
- ‚ùå Error 400: "invalid input value for enum notification_type: 'cambio_estado_cotizacion'"

**Qu√© hace**:
- Agrega los valores al enum: `cotizacion_aprobada`, `cotizacion_rechazada`, `cotizacion_proxima_vencer`, `cotizacion_vencida`

---

### 3Ô∏è‚É£ Script 006: Corregir funci√≥n de c√°lculo (ELIMINAR IVA) ‚≠ê‚≠ê EJECUTAR ESTE
**Archivo**: `006_fix_iva_en_calculate_totals.sql`
**Problema que resuelve**:
- ‚ùå Las cotizaciones se guardan con IVA incluido (NO DEBE TENER IVA)
- ‚ùå La funci√≥n `calculate_cotizacion_totals` incluye IVA en el c√°lculo

**Qu√© hace**:
- Reemplaza la funci√≥n existente `calculate_cotizacion_totals()` SIN IVA
- Crea trigger adicional `trigger_recalculate_on_costs_change` para recalcular al cambiar costos
- Actualiza todas las cotizaciones existentes: `iva = 0`
- F√≥rmula final: `Total = Subtotal + Transporte - Descuento`
- Muestra tabla de verificaci√≥n al final

**Por qu√© este y no el 005**: Este script trabaja con los triggers EXISTENTES en tu base de datos

---

## ‚ö° Ejecuci√≥n R√°pida

1. Abre **Supabase Dashboard** ‚Üí **SQL Editor**
2. Copia y pega cada script **en orden** (003 ‚Üí 004 ‚Üí 005)
3. Presiona **Run** o `Ctrl+Enter` despu√©s de cada uno
4. Verifica el mensaje de √©xito: `‚úÖ ...`

---

## üéØ Resultado Esperado

Despu√©s de ejecutar los 3 scripts:

‚úÖ Las cotizaciones se crean correctamente  
‚úÖ El historial de cambios se registra autom√°ticamente  
‚úÖ Los totales se calculan autom√°ticamente  
‚úÖ Las notificaciones se env√≠an sin errores  
‚úÖ **NO SE INCLUYE IVA** en ning√∫n c√°lculo  
‚úÖ F√≥rmula correcta: `Total = Subtotal + Transporte - Descuento`

---

## üîç Verificaci√≥n

Despu√©s de ejecutar los scripts:

```sql
-- Verificar que IVA = 0 en todas las cotizaciones
SELECT numero_cotizacion, subtotal, iva, total 
FROM cotizaciones 
ORDER BY created_at DESC 
LIMIT 5;

-- Verificar tipos de notificaci√≥n
SELECT unnest(enum_range(NULL::notification_type))::text 
WHERE unnest(enum_range(NULL::notification_type))::text LIKE 'cotizacion%';
```

---

## üìù Notas Importantes

- **NO** ejecutes estos scripts m√°s de una vez (tienen protecci√≥n `IF EXISTS`)
- Los scripts son **idempotentes** (puedes ejecutarlos de nuevo sin romper nada)
- Si ya ejecutaste el script 003 anteriormente, puedes saltarlo
- El script 005 es el **M√ÅS IMPORTANTE** para eliminar el IVA

---

**√öltima actualizaci√≥n**: 2025-10-13
