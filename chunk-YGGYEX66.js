import{p as w,v as b}from"./chunk-3OSVPALZ.js";import{M as $,S as v,Yb as h,la as p}from"./chunk-MBDN4FSM.js";import{a as y,b as m,i as s}from"./chunk-ODN5LVDJ.js";var S=class N{supabase=v(b);router=v(w);notifications=p([]);toasts=p([]);channel=null;userId=null;config=p({showToast:!0,playSound:!0,vibrate:!0,duration:5e3});unreadCount=h(()=>this.notifications().filter(i=>!i.read).length);allNotifications=h(()=>this.notifications().sort((i,t)=>new Date(t.created_at).getTime()-new Date(i.created_at).getTime()));unreadNotifications=h(()=>this.allNotifications().filter(i=>!i.read));activeToasts=h(()=>this.toasts());stats=h(()=>{let i=this.notifications(),t={total:i.length,unread:i.filter(r=>!r.read).length,by_type:{nuevo_mensaje:0,cambio_estado_cirugia:0,cambio_estado_kit:0,alerta_stock:0,alerta_vencimiento:0,asignacion_cirugia:0,cambio_agenda:0,asignacion_mensajero:0,cambio_estado_envio:0,retraso_envio:0,error_logistico:0,solicitud_urgente:0,cambio_estado_hoja_gasto:0,aprobacion_pendiente:0,incidente_cirugia:0,cirugia_cancelada:0,sistema:0,cotizacion_aprobada:0,cotizacion_rechazada:0,cotizacion_proxima_vencer:0,cotizacion_vencida:0}};return i.forEach(r=>{t.by_type[r.type]!==void 0&&t.by_type[r.type]++}),t});constructor(){this.initializeService()}initializeService(){return s(this,null,function*(){try{let i=yield this.supabase.getSession();i?.user&&(this.userId=i.user.id,yield this.loadNotifications(),this.subscribeToNotifications())}catch(i){console.error("\u274C Error initializing notification service:",i)}})}initialize(i){return s(this,null,function*(){this.userId=i,yield this.loadNotifications(),this.subscribeToNotifications()})}loadNotifications(){return s(this,null,function*(){if(!this.userId){console.warn("\u26A0\uFE0F NotificationService: No userId set, skipping load");return}try{let{data:i,error:t}=yield this.supabase.client.from("notificaciones").select("*").eq("user_id",this.userId).order("created_at",{ascending:!1}).limit(50);if(t)throw console.error("\u274C NotificationService: Error loading notifications:",t),t;i&&this.notifications.set(i)}catch(i){console.error("\u274C NotificationService: Exception loading notifications:",i)}})}subscribeToNotifications(){if(!this.userId){console.warn("\u26A0\uFE0F NotificationService: No userId, skipping realtime subscription");return}this.channel&&this.supabase.client.removeChannel(this.channel),this.channel=this.supabase.client.channel(`notifications:${this.userId}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notificaciones",filter:`user_id=eq.${this.userId}`},i=>{let t=i.new;this.handleNewNotification(t)}).subscribe((i,t)=>{t&&console.error("\u274C NotificationService: Subscription error:",t),i==="CHANNEL_ERROR"&&console.error("\u274C NotificationService: Channel error - Realtime may not be enabled"),i==="TIMED_OUT"&&console.error("\u274C NotificationService: Subscription timed out")})}handleNewNotification(i){this.notifications.update(t=>[i,...t]),this.config().showToast&&this.showToast(i),this.config().playSound&&this.playNotificationSound(),this.config().vibrate&&"vibrate"in navigator&&navigator.vibrate(200)}createNotification(i,t,r,e,a="medium",n,g){return s(this,null,function*(){try{let o={user_id:i,type:t,priority:a,title:r,message:e,icon:this.getIconForType(t),icon_color:this.getColorForPriority(a),link:g,data:n||{},read:!1},{data:c,error:l}=yield this.supabase.client.from("notificaciones").insert(o).select().single();if(l)throw l;return c}catch{return null}})}notifyUsers(i,t,r,e,a="medium",n,g){return s(this,null,function*(){let o=i.map(c=>this.createNotification(c,t,r,e,a,n,g));yield Promise.allSettled(o)})}notifyNewMessage(i,t,r,e,a){return s(this,null,function*(){try{yield this.notifyUsers(i,"nuevo_mensaje",`Nuevo mensaje en ${r}`,`${e}: ${a.substring(0,50)}${a.length>50?"...":""}`,"medium",{cirugia_id:t,remitente_nombre:e},`/internal/chat/${t}`)}catch(n){console.error("\u274C NotificationService.notifyNewMessage: Error:",n)}})}notifyCirugiaStatusChange(i,t,r,e,a){return s(this,null,function*(){yield this.notifyUsers(i,"cambio_estado_cirugia",`${r} cambi\xF3 de estado`,`De "${e}" a "${a}"`,"high",{cirugia_id:t,numero_cirugia:r,estado_anterior:e,estado_nuevo:a},"/internal/agenda")})}notifyKitStatusChange(i,t,r,e,a){return s(this,null,function*(){yield this.notifyUsers(i,"cambio_estado_kit",`Kit de ${r} actualizado`,`Estado: ${a}`,"medium",{kit_id:t,numero_cirugia:r,estado_anterior:e,estado_nuevo:a},"/internal/logistica")})}notifyLowStock(i,t,r,e,a){return s(this,null,function*(){yield this.notifyUsers(i,"alerta_stock","\u26A0\uFE0F Stock bajo",`${r}: ${e} unidades (m\xEDnimo: ${a})`,"high",{producto_id:t,producto_nombre:r,cantidad_actual:e,cantidad_minima:a},"/internal/inventario")})}notifyExpiringProduct(i,t,r,e,a){return s(this,null,function*(){yield this.notifyUsers(i,"alerta_vencimiento","\u23F0 Producto pr\xF3ximo a vencer",`${r} vence en ${a} d\xEDas (${e})`,"urgent",{producto_id:t,producto_nombre:r,fecha_vencimiento:e},"/internal/inventario")})}notifyAssignedToSurgery(i,t,r,e,a){return s(this,null,function*(){yield this.createNotification(i,"asignacion_cirugia","\u{1F3E5} Nueva cirug\xEDa asignada",`${r} - ${a} el ${e}`,"high",{cirugia_id:t,numero_cirugia:r,fecha_programada:e},"/internal/agenda")})}notifyNewCirugia(i,t,r,e,a,n,g){return s(this,null,function*(){try{let o={cirugia_id:t,numero_cirugia:r,medico_cirujano:e,fecha_programada:a,hospital_nombre:n},c=yield this.getLogisticaUsers();i&&(yield this.createNotification(i,"asignacion_cirugia","\u{1F3E5} Nueva cirug\xEDa asignada",`${r} - ${e} en ${n}`,"high",o,`/internal/agenda/${t}`)),c.length>0&&(yield this.notifyUsers(c,"asignacion_cirugia","\u{1F4CB} Nueva cirug\xEDa programada",`${r} - ${e} (creada por ${g})`,"medium",o,`/internal/agenda/${t}`))}catch(o){console.error("\u274C NotificationService.notifyNewCirugia: Error:",o)}})}notifyAgendaChange(i,t,r,e,a,n,g,o,c,l=!1){return s(this,null,function*(){try{let f=[r];e&&e!==a&&f.push(e),a&&f.push(a);let d=l?"urgent":"high",u=l?"\u{1F6A8}":"\u{1F4C5}";yield this.notifyUsers(f.filter((C,E,T)=>T.indexOf(C)===E),"cambio_estado_cirugia",`${u} Cambio en agenda - ${t}`,`${g} en ${c}. Motivo: ${n}`,d,{cirugia_id:i,numero_cirugia:t,fecha_programada:o,hospital_nombre:c,motivo_cambio:n,tecnico_anterior_id:e||void 0,tecnico_nuevo_id:a||void 0},`/internal/agenda/${i}`)}catch(f){console.error("\u274C NotificationService.notifyAgendaChange: Error:",f)}})}notifyMensajeroAssigned(i,t,r,e,a,n,g){return s(this,null,function*(){try{let o=yield this.getLogisticaUsers();o.length>0&&(yield this.notifyUsers(o,"asignacion_mensajero","\u{1F69A} Mensajero asignado",`${a} asignado para entregar ${r} en ${n}`,"medium",{envio_id:i,kit_id:t,numero_kit:r,mensajero_id:e,mensajero_nombre:a,direccion_destino:n,fecha_programada:g},`/internal/logistica/envios/${i}`))}catch(o){console.error("\u274C NotificationService.notifyMensajeroAssigned: Error:",o)}})}notifyDeliveryStatusChange(i,t,r,e,a,n,g){return s(this,null,function*(){try{let o=[],c=yield this.getLogisticaUsers();o.push(...c),n&&o.push(n);let l={programado:"Programado",en_camino:"En camino",entregado:"Entregado",devuelto:"Devuelto",cancelado:"Cancelado"};yield this.notifyUsers(o.filter((f,d,u)=>u.indexOf(f)===d),"cambio_estado_envio","\u{1F4CD} Estado de env\xEDo actualizado",`${r}: ${l[e]||e} \u2192 ${l[a]||a}`,"medium",{envio_id:i,kit_id:t,numero_kit:r,estado_anterior:e,estado_nuevo:a,direccion_destino:g},`/internal/logistica/envios/${i}`)}catch(o){console.error("\u274C NotificationService.notifyDeliveryStatusChange: Error:",o)}})}notifyDeliveryDelay(i,t,r,e,a){return s(this,null,function*(){try{let n=yield this.getLogisticaUsers();n.length>0&&(yield this.notifyUsers(n,"retraso_envio","\u23F1\uFE0F Retraso en env\xEDo",`${r} retrasado. ${e}. Nueva fecha estimada: ${a}`,"high",{envio_id:i,kit_id:t,numero_kit:r,motivo_retraso:e,fecha_programada:a},`/internal/logistica/envios/${i}`))}catch(n){console.error("\u274C NotificationService.notifyDeliveryDelay: Error:",n)}})}notifyDeliveryError(i,t,r,e,a){return s(this,null,function*(){try{let n=yield this.getLogisticaUsers();n.length>0&&(yield this.notifyUsers(n,"error_logistico","\u274C Error en env\xEDo",`${r}: ${e}. ${a}`,"urgent",{envio_id:i,kit_id:t,numero_kit:r,tipo_incidente:e,descripcion_incidente:a},`/internal/logistica/envios/${i}`))}catch(n){console.error("\u274C NotificationService.notifyDeliveryError: Error:",n)}})}notifyUrgentRequest(i,t,r,e,a){return s(this,null,function*(){try{let n=yield this.getLogisticaUsers();n.length>0&&(yield this.notifyUsers(n,"solicitud_urgente","\u{1F6A8} SOLICITUD URGENTE",`${t} - ${r}: ${e} (por ${a})`,"urgent",{cirugia_id:i,numero_cirugia:t,tipo_incidente:r,descripcion_incidente:e},`/internal/agenda/${i}`))}catch(n){console.error("\u274C NotificationService.notifyUrgentRequest: Error:",n)}})}notifyHojaGastoStatusChange(i,t,r,e,a,n,g){return s(this,null,function*(){try{let o=[r],c={borrador:"Borrador",pendiente_aprobacion:"Pendiente de aprobaci\xF3n",aprobada:"Aprobada",rechazada:"Rechazada",pagada:"Pagada"},l=a==="rechazada"?"high":"medium",f=`${t}: ${c[e]||e} \u2192 ${c[a]||a}`;n&&(f+=` (por ${n})`),g&&(f+=`. ${g}`),yield this.notifyUsers(o,"cambio_estado_hoja_gasto","\u{1F4B0} Estado de hoja de gasto",f,l,{hoja_gasto_id:i,numero_hoja:t,estado_anterior:e,estado_nuevo:a},`/internal/hojas-gasto/${i}`)}catch(o){console.error("\u274C NotificationService.notifyHojaGastoStatusChange: Error:",o)}})}notifyHojaGastoNeedsApproval(i,t,r,e,a){return s(this,null,function*(){try{let{data:n,error:g}=yield this.supabase.client.from("profiles").select("id").in("role",["admin","comercial"]).eq("is_active",!0);if(g||!n||n.length===0)return;let o=n.map(l=>l.id),c=`${t} por ${r} - Monto: $${e.toLocaleString()}`;a&&(c+=` (${a})`),yield this.notifyUsers(o,"aprobacion_pendiente","\u270D\uFE0F Aprobaci\xF3n pendiente",c,"high",{hoja_gasto_id:i,numero_hoja:t,monto_total:e},`/internal/hojas-gasto/${i}`)}catch(n){console.error("\u274C NotificationService.notifyHojaGastoNeedsApproval: Error:",n)}})}notifyCirugiaIncident(i,t,r,e,a,n,g){return s(this,null,function*(){try{let o=[g];n&&o.push(n);let c=yield this.getLogisticaUsers();o.push(...c),yield this.notifyUsers(o.filter((l,f,d)=>d.indexOf(l)===f),"incidente_cirugia","\u2695\uFE0F Incidente en cirug\xEDa",`${t} - ${r}: ${e} (reportado por ${a})`,"urgent",{cirugia_id:i,numero_cirugia:t,tipo_incidente:r,descripcion_incidente:e},`/internal/agenda/${i}`)}catch(o){console.error("\u274C NotificationService.notifyCirugiaIncident: Error:",o)}})}notifyCirugiaCanceled(i,t,r,e,a,n,g,o){return s(this,null,function*(){try{let c=[g];n&&c.push(n);let l=yield this.getLogisticaUsers();c.push(...l),yield this.notifyUsers(c.filter((f,d,u)=>u.indexOf(f)===d),"cirugia_cancelada","\u{1F6AB} Cirug\xEDa cancelada",`${t} en ${a} (${e}) cancelada. Motivo: ${r}. Por: ${o}`,"urgent",{cirugia_id:i,numero_cirugia:t,fecha_programada:e,hospital_nombre:a,motivo_cambio:r},`/internal/agenda/${i}`)}catch(c){console.error("\u274C NotificationService.notifyCirugiaCanceled: Error:",c)}})}markAsRead(i){return s(this,null,function*(){try{let{error:t}=yield this.supabase.client.from("notificaciones").update({read:!0}).eq("id",i);if(t)throw t;this.notifications.update(r=>r.map(e=>e.id===i?m(y({},e),{read:!0}):e))}catch(t){console.error("Error marking notification as read:",t)}})}markAllAsRead(){return s(this,null,function*(){if(this.userId)try{let{error:i}=yield this.supabase.client.from("notificaciones").update({read:!0}).eq("user_id",this.userId).eq("read",!1);if(i)throw i;this.notifications.update(t=>t.map(r=>m(y({},r),{read:!0})))}catch(i){console.error("Error marking all as read:",i)}})}deleteNotification(i){return s(this,null,function*(){try{let{error:t}=yield this.supabase.client.from("notificaciones").delete().eq("id",i);if(t)throw t;this.notifications.update(r=>r.filter(e=>e.id!==i))}catch(t){console.error("Error deleting notification:",t)}})}clearAll(){return s(this,null,function*(){if(this.userId)try{let{error:i}=yield this.supabase.client.from("notificaciones").delete().eq("user_id",this.userId);if(i)throw i;this.notifications.set([])}catch(i){console.error("Error clearing notifications:",i)}})}showToast(i){this.toasts.update(t=>[...t,i]),setTimeout(()=>{this.removeToast(i.id)},this.config().duration)}removeToast(i){this.toasts.update(t=>t.filter(r=>r.id!==i))}navigateToNotification(i){return s(this,null,function*(){yield this.markAsRead(i.id),i.link&&this.router.navigate([i.link])})}getLogisticaUsers(){return s(this,null,function*(){try{let{data:i,error:t}=yield this.supabase.client.from("profiles").select("id").eq("role","logistica").eq("is_active",!0);return t?(console.error("\u274C Error fetching logistica users:",t),[]):(i||[]).map(e=>e.id)}catch(i){return console.error("\u274C Exception getting logistica users:",i),[]}})}getIconForType(i){return{nuevo_mensaje:"\u{1F4AC}",cambio_estado_cirugia:"\u{1F3E5}",cambio_estado_kit:"\u{1F4E6}",alerta_stock:"\u26A0\uFE0F",alerta_vencimiento:"\u23F0",asignacion_cirugia:"\u{1F4CB}",cambio_agenda:"\u{1F4C5}",asignacion_mensajero:"\u{1F69A}",cambio_estado_envio:"\u{1F4CD}",retraso_envio:"\u23F1\uFE0F",error_logistico:"\u274C",solicitud_urgente:"\u{1F6A8}",cambio_estado_hoja_gasto:"\u{1F4B0}",aprobacion_pendiente:"\u270D\uFE0F",incidente_cirugia:"\u2695\uFE0F",cirugia_cancelada:"\u{1F6AB}",cotizacion_aprobada:"\u2705",cotizacion_rechazada:"\u274C",cotizacion_proxima_vencer:"\u23F0",cotizacion_vencida:"\u23F1\uFE0F",sistema:"\u2139\uFE0F"}[i]||"\u2139\uFE0F"}getColorForPriority(i){return{low:"text-gray-500",medium:"text-blue-500",high:"text-orange-500",urgent:"text-red-500"}[i]}playNotificationSound(){let i=new(window.AudioContext||window.webkitAudioContext),t=i.createOscillator(),r=i.createGain();t.connect(r),r.connect(i.destination),t.frequency.value=800,t.type="sine",r.gain.setValueAtTime(.3,i.currentTime),r.gain.exponentialRampToValueAtTime(.01,i.currentTime+.1),t.start(i.currentTime),t.stop(i.currentTime+.1)}updateConfig(i){this.config.update(t=>y(y({},t),i))}destroy(){this.channel&&(this.supabase.client.removeChannel(this.channel),this.channel=null)}static \u0275fac=function(t){return new(t||N)};static \u0275prov=$({token:N,factory:N.\u0275fac,providedIn:"root"})};export{S as a};
