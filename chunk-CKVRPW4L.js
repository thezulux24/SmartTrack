import{a as g}from"./chunk-WUZJU462.js";import{v as h}from"./chunk-WKDYGGS7.js";import{M as b,S as f,h as d,i as l,n as z,v as u}from"./chunk-D2JNWC2G.js";import{i as c}from"./chunk-ODN5LVDJ.js";var v=class _{supabase=f(h);notificationService=f(g);getCotizaciones(i){return d(c(this,null,function*(){try{let e=this.supabase.client.from("cotizaciones").select(`
              *,
              cliente:clientes(nombre, apellido, email, telefono, ciudad),
              tipo_cirugia:tipos_cirugia(nombre, descripcion),
              hospital:hospitales(nombre, ciudad),
              items:cotizacion_items(
                *,
                producto:productos(codigo, nombre, categoria)
              )
            `).order("created_at",{ascending:!1});i?.estado&&(e=e.eq("estado",i.estado)),i?.cliente_id&&(e=e.eq("cliente_id",i.cliente_id)),i?.created_by&&(e=e.eq("created_by",i.created_by)),i?.fecha_inicio&&(e=e.gte("fecha_emision",i.fecha_inicio)),i?.fecha_fin&&(e=e.lte("fecha_emision",i.fecha_fin)),i?.search&&(e=e.or(`numero_cotizacion.ilike.%${i.search}%`));let{data:a,error:o}=yield e;if(o)throw console.error("\u274C Error obteniendo cotizaciones:",o),o;return console.log(`\u2705 ${a?.length||0} cotizaciones cargadas`),a||[]}catch(e){return console.error("\u274C Error en getCotizaciones:",e),[]}})).pipe(u(e=>(console.error("\u274C Error final en getCotizaciones:",e),l([]))))}getCotizacionesProximasAVencer(){return d(c(this,null,function*(){let i=new Date,e=new Date;e.setDate(i.getDate()+3);let{data:a,error:o}=yield this.supabase.client.from("cotizaciones").select(`
            *,
            cliente:clientes(nombre, apellido, email, telefono),
            comercial:profiles!cotizaciones_created_by_fkey(full_name, email)
          `).eq("estado","enviada").gte("fecha_vencimiento",i.toISOString().split("T")[0]).lte("fecha_vencimiento",e.toISOString().split("T")[0]).order("fecha_vencimiento",{ascending:!0});if(o)throw o;return a||[]})).pipe(u(i=>(console.error("Error obteniendo cotizaciones pr\xF3ximas a vencer:",i),l([]))))}getCotizacionById(i){return d(c(this,null,function*(){try{let{data:e,error:a}=yield this.supabase.client.from("cotizaciones").select(`
              *,
              cliente:clientes(nombre, apellido, email, telefono, ciudad, documento_numero),
              tipo_cirugia:tipos_cirugia(nombre, descripcion, duracion_promedio),
              hospital:hospitales(nombre, ciudad, direccion, telefono),
              items:cotizacion_items(
                *,
                producto:productos(codigo, nombre, categoria, precio)
              )
            `).eq("id",i).single();if(a)throw console.error("\u274C Error obteniendo cotizaci\xF3n:",a),a;if(e&&e.created_by){let{data:o}=yield this.supabase.client.from("profiles").select("full_name, email, phone").eq("id",e.created_by).single();o&&(e.comercial=o)}return console.log("\u2705 Cotizaci\xF3n cargada:",e?.numero_cotizacion),e}catch(e){return console.error("\u274C Error en getCotizacionById:",e),null}})).pipe(u(e=>(console.error("\u274C Error final en getCotizacionById:",e),l(null))))}getById(i){return this.getCotizacionById(i)}delete(i){return d(c(this,null,function*(){try{if(!(yield this.supabase.getSession())?.user?.id)return{exito:!1,mensaje:"Usuario no autenticado"};let{data:a,error:o}=yield this.supabase.client.from("cotizaciones").select("estado, numero_cotizacion").eq("id",i).single();if(o||!a)return{exito:!1,mensaje:"Cotizaci\xF3n no encontrada"};if(a.estado!=="borrador")return{exito:!1,mensaje:"Solo se pueden eliminar cotizaciones en estado borrador"};yield this.supabase.client.from("cotizacion_items").delete().eq("cotizacion_id",i),yield this.supabase.client.from("cotizacion_historial").delete().eq("cotizacion_id",i);let{error:t}=yield this.supabase.client.from("cotizaciones").delete().eq("id",i);return t?(console.error("Error eliminando cotizaci\xF3n:",t),{exito:!1,mensaje:"Error al eliminar la cotizaci\xF3n"}):(console.log(`\u2705 Cotizaci\xF3n ${a.numero_cotizacion} eliminada exitosamente`),{exito:!0,mensaje:"Cotizaci\xF3n eliminada exitosamente"})}catch(e){return console.error("Error en delete:",e),{exito:!1,mensaje:"Error inesperado al eliminar la cotizaci\xF3n"}}}))}createCotizacion(i){return c(this,null,function*(){try{let e=yield this.supabase.getSession();if(!e?.user?.id)return{exito:!1,mensaje:"Usuario no autenticado"};let{data:a,error:o}=yield this.supabase.client.from("cotizaciones").insert({cliente_id:i.cliente_id,tipo_cirugia_id:i.tipo_cirugia_id,hospital_id:i.hospital_id,medico_cirujano:i.medico_cirujano,fecha_programada:i.fecha_programada,fecha_vencimiento:i.fecha_vencimiento,costo_transporte:i.costo_transporte||0,descuento:i.descuento||0,porcentaje_descuento:i.porcentaje_descuento||0,observaciones:i.observaciones,terminos_condiciones:i.terminos_condiciones,notas_internas:i.notas_internas,created_by:e.user.id,estado:"borrador"}).select().single();if(o)return console.error("Error creando cotizaci\xF3n:",o),{exito:!1,mensaje:"Error al crear la cotizaci\xF3n"};if(i.items&&i.items.length>0){let t=i.items.map((n,s)=>({cotizacion_id:a.id,producto_id:n.producto_id,descripcion:n.descripcion,cantidad:n.cantidad,precio_unitario:n.precio_unitario,precio_total:n.cantidad*n.precio_unitario,observaciones:n.observaciones,orden:n.orden??s})),{error:r}=yield this.supabase.client.from("cotizacion_items").insert(t);if(r)return console.error("Error creando items:",r),yield this.supabase.client.from("cotizaciones").delete().eq("id",a.id),{exito:!1,mensaje:"Error al crear los items de la cotizaci\xF3n"}}return yield this.supabase.client.from("cotizacion_historial").insert({cotizacion_id:a.id,estado_nuevo:"borrador",usuario_id:e.user.id,comentario:"Cotizaci\xF3n creada"}),console.log("\u2705 Cotizaci\xF3n creada exitosamente:",a.numero_cotizacion),{exito:!0,cotizacion:a,mensaje:`Cotizaci\xF3n ${a.numero_cotizacion} creada exitosamente`}}catch(e){return console.error("Error en createCotizacion:",e),{exito:!1,mensaje:"Error inesperado al crear la cotizaci\xF3n"}}})}updateCotizacion(i,e){return c(this,null,function*(){try{let a={};e.cliente_id!==void 0&&(a.cliente_id=e.cliente_id),e.tipo_cirugia_id!==void 0&&(a.tipo_cirugia_id=e.tipo_cirugia_id),e.hospital_id!==void 0&&(a.hospital_id=e.hospital_id),e.medico_cirujano!==void 0&&(a.medico_cirujano=e.medico_cirujano),e.fecha_programada!==void 0&&(a.fecha_programada=e.fecha_programada),e.fecha_vencimiento!==void 0&&(a.fecha_vencimiento=e.fecha_vencimiento),e.costo_transporte!==void 0&&(a.costo_transporte=e.costo_transporte),e.descuento!==void 0&&(a.descuento=e.descuento),e.porcentaje_descuento!==void 0&&(a.porcentaje_descuento=e.porcentaje_descuento),e.observaciones!==void 0&&(a.observaciones=e.observaciones),e.terminos_condiciones!==void 0&&(a.terminos_condiciones=e.terminos_condiciones),e.notas_internas!==void 0&&(a.notas_internas=e.notas_internas);let{error:o}=yield this.supabase.client.from("cotizaciones").update(a).eq("id",i);if(o)return console.error("Error actualizando cotizaci\xF3n:",o),{exito:!1,mensaje:"Error al actualizar la cotizaci\xF3n"};if(e.items&&(yield this.supabase.client.from("cotizacion_items").delete().eq("cotizacion_id",i),e.items.length>0)){let t=e.items.map((n,s)=>({cotizacion_id:i,producto_id:n.producto_id,descripcion:n.descripcion,cantidad:n.cantidad,precio_unitario:n.precio_unitario,precio_total:n.cantidad*n.precio_unitario,observaciones:n.observaciones,orden:n.orden??s})),{error:r}=yield this.supabase.client.from("cotizacion_items").insert(t);if(r)return console.error("Error actualizando items:",r),{exito:!1,mensaje:"Error al actualizar los items"}}return console.log("\u2705 Cotizaci\xF3n actualizada exitosamente"),{exito:!0,mensaje:"Cotizaci\xF3n actualizada exitosamente"}}catch(a){return console.error("Error en updateCotizacion:",a),{exito:!1,mensaje:"Error inesperado al actualizar la cotizaci\xF3n"}}})}cambiarEstado(i,e,a){return c(this,null,function*(){try{let o=yield this.supabase.getSession();if(!o?.user?.id)return{exito:!1,mensaje:"Usuario no autenticado"};let t;typeof e=="string"?t={estado:e,comentario:a||`Estado cambiado a ${e}`}:t=e;let{data:r,error:n}=yield this.supabase.client.from("cotizaciones").select(`
          *,
          cliente:clientes(nombre, apellido, email),
          comercial:profiles!cotizaciones_created_by_fkey(full_name, email)
        `).eq("id",i).single();if(n||!r)return{exito:!1,mensaje:"Cotizaci\xF3n no encontrada"};let s=r.estado,m={estado:t.estado};t.estado==="rechazada"?(m.motivo_rechazo=t.motivo_rechazo,m.fecha_rechazo=new Date().toISOString()):t.estado==="aprobada"&&(m.fecha_aprobacion=new Date().toISOString(),m.aprobada_por=o.user.id);let{error:p}=yield this.supabase.client.from("cotizaciones").update(m).eq("id",i);return p?(console.error("Error actualizando estado:",p),{exito:!1,mensaje:"Error al cambiar el estado"}):(yield this.supabase.client.from("cotizacion_historial").insert({cotizacion_id:i,estado_anterior:s,estado_nuevo:t.estado,usuario_id:o.user.id,comentario:t.comentario}),yield this.enviarNotificacionCambioEstado(r,s,t.estado),console.log(`\u2705 Estado de cotizaci\xF3n ${r.numero_cotizacion} cambiado: ${s} \u2192 ${t.estado}`),{exito:!0,mensaje:`Estado cambiado a ${t.estado}`})}catch(o){return console.error("Error en cambiarEstado:",o),{exito:!1,mensaje:"Error inesperado al cambiar el estado"}}})}convertirACirugia(i,e){return c(this,null,function*(){try{let a=yield this.supabase.getSession();if(!a?.user?.id)return{exito:!1,mensaje:"Usuario no autenticado"};let{data:o,error:t}=yield this.supabase.client.from("cotizaciones").select("*, cliente:clientes(*)").eq("id",i).single();if(t||!o)return{exito:!1,mensaje:"Cotizaci\xF3n no encontrada"};if(o.estado!=="aprobada")return{exito:!1,mensaje:"Solo se pueden convertir cotizaciones aprobadas"};if(o.convertida_a_cirugia)return{exito:!1,mensaje:"Esta cotizaci\xF3n ya fue convertida en cirug\xEDa"};let{data:r,error:n}=yield this.supabase.client.from("cirugias").insert({cliente_id:o.cliente_id,tipo_cirugia_id:o.tipo_cirugia_id,hospital_id:o.hospital_id,medico_cirujano:e.medico_cirujano,fecha_programada:e.fecha_programada,hora_inicio:e.hora_inicio,tecnico_asignado_id:e.tecnico_asignado_id,prioridad:e.prioridad||"normal",notas:e.notas||`Creada desde cotizaci\xF3n ${o.numero_cotizacion}`,usuario_creador_id:a.user.id,estado:"programada"}).select().single();return n?(console.error("Error creando cirug\xEDa:",n),{exito:!1,mensaje:"Error al crear la cirug\xEDa"}):(yield this.supabase.client.from("cotizaciones").update({convertida_a_cirugia:!0,cirugia_id:r.id}).eq("id",i),yield this.supabase.client.from("cotizacion_historial").insert({cotizacion_id:i,estado_anterior:"aprobada",estado_nuevo:"aprobada",usuario_id:a.user.id,comentario:`Convertida en cirug\xEDa ${r.numero_cirugia}`}),yield this.notificarCirugiaCreada(o,r),console.log(`\u2705 Cotizaci\xF3n ${o.numero_cotizacion} convertida en cirug\xEDa ${r.numero_cirugia}`),{exito:!0,cirugia:r,mensaje:`Cirug\xEDa ${r.numero_cirugia} creada exitosamente`})}catch(a){return console.error("Error en convertirACirugia:",a),{exito:!1,mensaje:"Error inesperado al convertir la cotizaci\xF3n"}}})}deleteCotizacion(i){return c(this,null,function*(){try{let{data:e,error:a}=yield this.supabase.client.from("cotizaciones").select("estado, numero_cotizacion").eq("id",i).single();if(a||!e)return{exito:!1,mensaje:"Cotizaci\xF3n no encontrada"};if(e.estado!=="borrador")return{exito:!1,mensaje:"Solo se pueden eliminar cotizaciones en borrador"};let{error:o}=yield this.supabase.client.from("cotizaciones").delete().eq("id",i);return o?(console.error("Error eliminando cotizaci\xF3n:",o),{exito:!1,mensaje:"Error al eliminar la cotizaci\xF3n"}):(console.log(`\u2705 Cotizaci\xF3n ${e.numero_cotizacion} eliminada`),{exito:!0,mensaje:"Cotizaci\xF3n eliminada exitosamente"})}catch(e){return console.error("Error en deleteCotizacion:",e),{exito:!1,mensaje:"Error inesperado al eliminar la cotizaci\xF3n"}}})}getEstadisticas(i){return d(c(this,null,function*(){let e=this.supabase.client.from("cotizaciones").select("estado, total");i&&(e=e.eq("created_by",i));let{data:a,error:o}=yield e;if(o)throw o;let t={total:a.length,borradores:a.filter(r=>r.estado==="borrador").length,enviadas:a.filter(r=>r.estado==="enviada").length,aprobadas:a.filter(r=>r.estado==="aprobada").length,rechazadas:a.filter(r=>r.estado==="rechazada").length,vencidas:a.filter(r=>r.estado==="vencida").length,canceladas:a.filter(r=>r.estado==="cancelada").length,valor_total_aprobadas:a.filter(r=>r.estado==="aprobada").reduce((r,n)=>r+Number(n.total||0),0),valor_total_enviadas:a.filter(r=>r.estado==="enviada").reduce((r,n)=>r+Number(n.total||0),0),tasa_conversion:0};return t.enviadas>0&&(t.tasa_conversion=t.aprobadas/t.enviadas*100),t})).pipe(u(e=>(console.error("Error obteniendo estad\xEDsticas:",e),l({total:0,borradores:0,enviadas:0,aprobadas:0,rechazadas:0,vencidas:0,canceladas:0,valor_total_aprobadas:0,valor_total_enviadas:0,tasa_conversion:0}))))}getHistorial(i){return d(this.supabase.client.from("cotizacion_historial").select(`
          *,
          usuario:profiles(full_name, email)
        `).eq("cotizacion_id",i).order("timestamp",{ascending:!1})).pipe(z(e=>e.data||[]),u(e=>(console.error("Error obteniendo historial:",e),l([]))))}enviarNotificacionCambioEstado(i,e,a){return c(this,null,function*(){try{let o=i.created_by,t="",r="medium",n="sistema";switch(a){case"enviada":n="sistema",t=`Cotizaci\xF3n ${i.numero_cotizacion} enviada al cliente ${i.cliente?.nombre} ${i.cliente?.apellido}`,r="medium";break;case"aprobada":n="cotizacion_aprobada",t=`\xA1Cotizaci\xF3n ${i.numero_cotizacion} APROBADA por ${i.cliente?.nombre} ${i.cliente?.apellido}! \u{1F389}`,r="high";break;case"rechazada":n="cotizacion_rechazada",t=`Cotizaci\xF3n ${i.numero_cotizacion} rechazada por ${i.cliente?.nombre} ${i.cliente?.apellido}`,r="medium";break;case"vencida":n="cotizacion_vencida",t=`Cotizaci\xF3n ${i.numero_cotizacion} ha vencido sin respuesta del cliente`,r="low";break;default:return}yield this.notificationService.notifyUsers([o],n,`\u{1F4B0} ${a.toUpperCase()}`,t,r,{cotizacion_id:i.id,numero_cotizacion:i.numero_cotizacion,estado_anterior:e,estado_nuevo:a,cliente_nombre:`${i.cliente?.nombre} ${i.cliente?.apellido}`,total:i.total},`/internal/cotizaciones/${i.id}`),console.log(`\u{1F4E2} Notificaci\xF3n enviada: Cotizaci\xF3n ${a}`)}catch(o){console.error("Error enviando notificaci\xF3n de cambio de estado:",o)}})}notificarCirugiaCreada(i,e){return c(this,null,function*(){try{yield this.notificationService.notifyUsers([i.created_by],"nueva_cirugia","\u{1F3E5} Cirug\xEDa Programada",`Cirug\xEDa ${e.numero_cirugia} creada desde cotizaci\xF3n ${i.numero_cotizacion}`,"high",{cirugia_id:e.id,numero_cirugia:e.numero_cirugia,cotizacion_id:i.id},`/internal/agenda/cirugia/${e.id}`)}catch(a){console.error("Error notificando cirug\xEDa creada:",a)}})}verificarCotizacionesVencidas(){return c(this,null,function*(){try{let i=new Date().toISOString().split("T")[0],{data:e,error:a}=yield this.supabase.client.from("cotizaciones").select("*").eq("estado","enviada").lt("fecha_vencimiento",i);if(a)throw a;if(e&&e.length>0){for(let o of e)yield this.cambiarEstado(o.id,{estado:"vencida",comentario:"Cotizaci\xF3n vencida autom\xE1ticamente por sistema"});console.log(`\u2705 ${e.length} cotizaciones marcadas como vencidas`)}}catch(i){console.error("Error verificando cotizaciones vencidas:",i)}})}static \u0275fac=function(e){return new(e||_)};static \u0275prov=b({token:_,factory:_.\u0275fac,providedIn:"root"})};export{v as a};
