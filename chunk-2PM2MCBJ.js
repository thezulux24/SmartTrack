import{a as $,c as B,g as H,x as U}from"./chunk-ZJDURMG7.js";import{$ as f,Aa as S,E as x,G as l,J as M,Ja as L,Ma as q,N as h,Oa as z,Q as D,T as I,U as _,Ua as R,X as N,Y as P,Z as n,_ as i,aa as K,ba as v,ca as s,ha as o,ia as m,ja as w,ka as A,ma as j,na as G,oa as O,u as y,w as g,x as b,y as C,z as T}from"./chunk-OA5U47VA.js";import"./chunk-LJ5XHLMQ.js";import{a as k,b as E,h as V}from"./chunk-FK42CRUA.js";var Y=(c,t)=>t.id;function Z(c,t){c&1&&(n(0,"div",7),f(1,"div",10),n(2,"p",11),o(3,"Cargando kit..."),i()())}function ee(c,t){if(c&1&&(n(0,"div",8),o(1),i()),c&2){let e=s();l(),w(" ",e.error()," ")}}function te(c,t){if(c&1&&(n(0,"p",46),o(1),i()),c&2){let e=s().$implicit;l(),w("Lote: ",e.lote,"")}}function ie(c,t){if(c&1&&o(0),c&2){let e=s().$implicit,r=s(2);w(" +",r.getDiferencia(e)," ")}}function ne(c,t){if(c&1&&o(0),c&2){let e=s().$implicit,r=s(2);w(" ",r.getDiferencia(e)," ")}}function oe(c,t){c&1&&o(0," \u2713 ")}function ae(c,t){c&1&&(C(),n(0,"svg",52),f(1,"path",55),i())}function re(c,t){c&1&&(C(),n(0,"svg",53),f(1,"path",56),i())}function de(c,t){if(c&1){let e=K();n(0,"tr",38)(1,"td",44)(2,"div")(3,"p",16),o(4),i(),n(5,"p",45),o(6),i(),h(7,te,2,1,"p",46),i()(),n(8,"td",47)(9,"span",48),o(10),i()(),n(11,"td",47)(12,"input",49),v("input",function(a){let d=g(e).$implicit,u=s(2);return b(u.actualizarCantidad(d.id,+a.target.value))}),i()(),n(13,"td",47)(14,"span",50),h(15,ie,1,1)(16,ne,1,1)(17,oe,1,0),i()(),n(18,"td",47)(19,"button",51),v("click",function(){let a=g(e).$implicit,d=s(2);return b(d.toggleConforme(a.id))}),h(20,ae,2,0,":svg:svg",52)(21,re,2,0,":svg:svg",53),i()(),n(22,"td",44)(23,"input",54),v("input",function(a){let d=g(e).$implicit,u=s(2);return b(u.actualizarObservaciones(d.id,a.target.value))}),i()()()}if(c&2){let e=t.$implicit,r=s(2);l(4),m(e.nombre),l(2),m(e.codigo),l(),_(e.lote?7:-1),l(3),w(" ",e.cantidad_preparada," "),l(2),D("value",e.cantidad_recibida),l(2),I(r.getDiferenciaClass(r.getDiferencia(e))),l(),_(r.getDiferencia(e)>0?15:r.getDiferencia(e)<0?16:17),l(4),I(e.conforme?"bg-green-500/20 border-green-500":"bg-red-500/20 border-red-500"),l(),_(e.conforme?20:21),l(3),D("value",e.observaciones)}}function ce(c,t){c&1&&(f(0,"div",57),n(1,"span"),o(2,"Procesando..."),i())}function le(c,t){c&1&&(C(),n(0,"svg",58),f(1,"path",30),i(),T(),n(2,"span"),o(3,"Confirmar Validaci\xF3n"),i())}function se(c,t){c&1&&(n(0,"p",43),o(1," \u26A0\uFE0F Por favor complete la cantidad recibida de todos los productos "),i())}function me(c,t){if(c&1){let e=K();n(0,"div",9)(1,"div",12)(2,"div",13)(3,"div")(4,"p",14),o(5,"N\xFAmero de Kit"),i(),n(6,"p",15),o(7),i()(),n(8,"div")(9,"p",14),o(10,"Cirug\xEDa"),i(),n(11,"p",16),o(12),i(),n(13,"p",17),o(14),i()(),n(15,"div")(16,"p",14),o(17,"Hospital"),i(),n(18,"p",16),o(19),i(),n(20,"p",17),o(21),i()(),n(22,"div")(23,"p",14),o(24,"Cliente"),i(),n(25,"p",16),o(26),i()()()(),n(27,"div",18)(28,"div",19)(29,"p",20),o(30,"Total Productos"),i(),n(31,"p",21),o(32),i()(),n(33,"div",22)(34,"p",23),o(35,"Conformes"),i(),n(36,"p",24),o(37),i()(),n(38,"div",25)(39,"p",26),o(40,"Con Anomal\xEDas"),i(),n(41,"p",27),o(42),i()()(),n(43,"div",28)(44,"button",29),v("click",function(){g(e);let a=s();return b(a.marcarTodosConformes())}),C(),n(45,"svg",3),f(46,"path",30),i(),o(47," Marcar Todos Conformes "),i()(),T(),n(48,"div",31)(49,"div",32)(50,"table",33)(51,"thead",34)(52,"tr")(53,"th",35),o(54," Producto "),i(),n(55,"th",36),o(56," Preparada "),i(),n(57,"th",36),o(58," Recibida "),i(),n(59,"th",36),o(60," Diferencia "),i(),n(61,"th",36),o(62," Conforme "),i(),n(63,"th",35),o(64," Observaciones "),i()()(),n(65,"tbody",37),N(66,de,24,12,"tr",38,Y),i()()()(),n(68,"div",12)(69,"label",39),o(70," Observaciones Generales (Opcional) "),i(),n(71,"textarea",40),O("ngModelChange",function(a){g(e);let d=s();return G(d.observacionesGenerales,a)||(d.observacionesGenerales=a),b(a)}),o(72,"        "),i()(),n(73,"div",41)(74,"button",42),v("click",function(){g(e);let a=s();return b(a.confirmarValidacion())}),h(75,ce,3,0)(76,le,4,0),i()(),h(77,se,2,0,"p",43),i()}if(c&2){let e=s();l(7),m(e.kit().numero_kit),l(5),m(e.kit().cirugia.numero_cirugia),l(2),m(e.formatearFecha(e.kit().cirugia.fecha_programada)),l(5),m(e.kit().cirugia.hospital.nombre),l(2),m(e.kit().cirugia.hospital.ciudad),l(5),A("",e.kit().cirugia.cliente.nombre," ",e.kit().cirugia.cliente.apellido,""),l(6),m(e.totalProductos()),l(5),m(e.productosConformes()),l(5),m(e.productosNoConformes()),l(24),P(e.productos()),l(5),j("ngModel",e.observacionesGenerales),l(3),D("disabled",!e.todosValidados()||e.procesando()),l(),_(e.procesando()?75:76),l(2),_(e.todosValidados()?-1:77)}}var W=class c{router=y(z);route=y(q);supabase=y(R);kitId=x("");kit=x(null);productos=x([]);cargando=x(!0);procesando=x(!1);error=x(null);observacionesGenerales=x("");totalProductos=S(()=>this.productos().length);productosConformes=S(()=>this.productos().filter(t=>t.conforme).length);productosNoConformes=S(()=>this.productos().filter(t=>!t.conforme).length);todosValidados=S(()=>{let t=this.productos();return t.length>0&&t.every(e=>e.cantidad_recibida!==null&&e.cantidad_recibida!==void 0)});ngOnInit(){return V(this,null,function*(){let t=this.route.snapshot.paramMap.get("id");t&&(this.kitId.set(t),yield this.cargarKit())})}cargarKit(){return V(this,null,function*(){this.cargando.set(!0),this.error.set(null);try{let t=this.kitId(),{data:e,error:r}=yield this.supabase.client.from("kits_cirugia").select(`
          id,
          numero_kit,
          estado,
          fecha_recepcion,
          cirugias!inner (
            numero_cirugia,
            fecha_programada,
            medico_cirujano,
            hospitales (
              nombre,
              ciudad,
              direccion
            ),
            clientes (
              nombre,
              apellido
            )
          )
        `).eq("id",t).single();if(r)throw r;let a=e.cirugias,d=a.hospitales,u=a.clientes,J={id:e.id,numero_kit:e.numero_kit,estado:e.estado,fecha_recepcion:e.fecha_recepcion,cirugia:{numero_cirugia:a.numero_cirugia,fecha_programada:a.fecha_programada,medico_cirujano:a.medico_cirujano,hospital:{nombre:d?.nombre||"N/A",ciudad:d?.ciudad||"N/A",direccion:d?.direccion||"N/A"},cliente:{nombre:u?.nombre||"N/A",apellido:u?.apellido||""}}};this.kit.set(J);let{data:Q,error:F}=yield this.supabase.client.from("kit_productos").select(`
          id,
          producto_id,
          cantidad_solicitada,
          cantidad_preparada,
          cantidad_enviada,
          lote,
          fecha_vencimiento,
          observaciones,
          productos (
            nombre,
            codigo
          )
        `).eq("kit_id",t).order("productos(nombre)");if(F)throw F;let X=(Q||[]).map(p=>({id:p.id,producto_id:p.producto_id,nombre:p.productos?.nombre||"N/A",codigo:p.productos?.codigo||"N/A",cantidad_solicitada:p.cantidad_solicitada||0,cantidad_preparada:p.cantidad_preparada||0,cantidad_recibida:p.cantidad_enviada||p.cantidad_preparada||0,conforme:!0,observaciones:"",lote:p.lote,fecha_vencimiento:p.fecha_vencimiento}));this.productos.set(X)}catch(t){console.error("Error cargando kit:",t),this.error.set("Error al cargar los datos del kit")}finally{this.cargando.set(!1)}})}actualizarCantidad(t,e){let r=this.productos(),a=r.findIndex(d=>d.id===t);if(a!==-1){let d=[...r];d[a]=E(k({},d[a]),{cantidad_recibida:e,conforme:e===d[a].cantidad_preparada}),this.productos.set(d)}}toggleConforme(t){let e=this.productos(),r=e.findIndex(a=>a.id===t);if(r!==-1){let a=[...e];a[r]=E(k({},a[r]),{conforme:!a[r].conforme}),this.productos.set(a)}}actualizarObservaciones(t,e){let r=this.productos(),a=r.findIndex(d=>d.id===t);if(a!==-1){let d=[...r];d[a]=E(k({},d[a]),{observaciones:e}),this.productos.set(d)}}marcarTodosConformes(){let t=this.productos().map(e=>E(k({},e),{cantidad_recibida:e.cantidad_preparada,conforme:!0}));this.productos.set(t)}confirmarValidacion(){return V(this,null,function*(){if(!this.todosValidados()){alert("Por favor valide la cantidad recibida de todos los productos");return}if(confirm(`\xBFConfirmar validaci\xF3n de recepci\xF3n?
Esto marcar\xE1 el kit como validado y listo para usar.`)){this.procesando.set(!0);try{let t=this.kitId(),{data:{user:e}}=yield this.supabase.client.auth.getUser();if(!e)throw new Error("Usuario no autenticado");for(let d of this.productos()){let{error:u}=yield this.supabase.client.from("kit_productos").update({cantidad_enviada:d.cantidad_recibida,observaciones:d.observaciones||null}).eq("id",d.id);if(u)throw u}let{error:r}=yield this.supabase.client.from("kits_cirugia").update({estado:"validado",updated_at:new Date().toISOString()}).eq("id",t);if(r)throw r;let a=this.productos().filter(d=>!d.conforme);yield this.supabase.client.from("kit_trazabilidad").insert({kit_id:t,accion:"Recepci\xF3n validada por t\xE9cnico",estado_anterior:"entregado",estado_nuevo:"validado",usuario_id:e.id,timestamp:new Date().toISOString(),observaciones:this.observacionesGenerales()||"Recepci\xF3n validada sin observaciones",metadata:{productos_conformes:this.productosConformes(),productos_no_conformes:this.productosNoConformes(),total_productos:this.totalProductos(),anomalias:a.map(d=>({producto:d.nombre,cantidad_esperada:d.cantidad_preparada,cantidad_recibida:d.cantidad_recibida,observaciones:d.observaciones}))}}),alert("\u2705 Validaci\xF3n completada exitosamente"),this.router.navigate(["/internal/tecnico"])}catch(t){console.error("Error validando kit:",t),alert("Error al validar el kit. Por favor intente nuevamente.")}finally{this.procesando.set(!1)}}})}volver(){this.router.navigate(["/internal/tecnico"])}formatearFecha(t){return t?new Date(t).toLocaleDateString("es-CO",{day:"2-digit",month:"short",year:"numeric"}):"N/A"}getDiferencia(t){return t.cantidad_recibida-t.cantidad_preparada}getDiferenciaClass(t){return t===0?"text-green-400":t>0?"text-blue-400":"text-red-400"}static \u0275fac=function(e){return new(e||c)};static \u0275cmp=M({type:c,selectors:[["app-tecnico-validacion-kit"]],decls:13,vars:3,consts:[[1,"min-h-screen","bg-gradient-to-br","from-[#10284C]","via-[#1a3a5c]","to-[#0f1f38]","p-4","md:p-8"],[1,"mb-8"],[1,"mb-4","flex","items-center","gap-2","text-white","hover:text-[#C8D900]","transition-colors",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M10 19l-7-7m0 0l7-7m-7 7h18"],[1,"text-3xl","md:text-4xl","font-bold","text-white","mb-2"],[1,"text-gray-300"],[1,"text-center","py-12"],[1,"bg-red-500/20","border","border-red-500","text-red-100","p-4","rounded-lg","text-center","mb-6"],[1,"space-y-6"],[1,"inline-block","animate-spin","rounded-full","h-12","w-12","border-4","border-[#C8D900]","border-t-transparent"],[1,"text-white","mt-4"],[1,"bg-white/5","backdrop-blur-sm","rounded-2xl","border","border-white/10","p-6"],[1,"grid","grid-cols-1","md:grid-cols-2","lg:grid-cols-4","gap-6"],[1,"text-gray-400","text-sm","mb-1"],[1,"text-2xl","font-bold","text-white"],[1,"text-white","font-medium"],[1,"text-gray-400","text-xs"],[1,"grid","grid-cols-1","md:grid-cols-3","gap-4"],[1,"bg-blue-500/10","border","border-blue-500/30","rounded-xl","p-4"],[1,"text-blue-300/80","text-sm","mb-1"],[1,"text-3xl","font-bold","text-blue-300"],[1,"bg-green-500/10","border","border-green-500/30","rounded-xl","p-4"],[1,"text-green-300/80","text-sm","mb-1"],[1,"text-3xl","font-bold","text-green-300"],[1,"bg-red-500/10","border","border-red-500/30","rounded-xl","p-4"],[1,"text-red-300/80","text-sm","mb-1"],[1,"text-3xl","font-bold","text-red-300"],[1,"flex","justify-end"],[1,"px-4","py-2","bg-white/10","hover:bg-white/20","text-white","rounded-lg","transition-all","flex","items-center","gap-2",3,"click"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"],[1,"bg-white/5","backdrop-blur-sm","rounded-2xl","border","border-white/10","overflow-hidden"],[1,"overflow-x-auto"],[1,"w-full"],[1,"bg-white/5"],[1,"px-4","py-3","text-left","text-xs","font-medium","text-gray-400","uppercase","tracking-wider"],[1,"px-4","py-3","text-center","text-xs","font-medium","text-gray-400","uppercase","tracking-wider"],[1,"divide-y","divide-white/10"],[1,"hover:bg-white/5","transition-colors"],[1,"block","text-white","font-medium","mb-2"],["rows","4","placeholder","Ingrese cualquier observaci\xF3n adicional sobre la recepci\xF3n del kit...",1,"w-full","px-4","py-3","bg-white/10","border","border-white/20","rounded-lg","text-white","focus:outline-none","focus:border-[#C8D900]","transition-colors","placeholder-gray-500","resize-none",3,"ngModelChange","ngModel"],[1,"flex","justify-center","pt-4"],[1,"px-12","py-4","bg-gradient-to-r","from-[#C8D900]","to-[#d4e820]","text-[#10284C]","rounded-xl","hover:shadow-lg","hover:shadow-[#C8D900]/50","disabled:opacity-50","disabled:cursor-not-allowed","transition-all","font-bold","text-lg","flex","items-center","gap-3","active:scale-95",3,"click","disabled"],[1,"text-center","text-yellow-300","text-sm"],[1,"px-4","py-4"],[1,"text-gray-400","text-sm"],[1,"text-[#C8D900]","text-xs","mt-1"],[1,"px-4","py-4","text-center"],[1,"text-white","font-bold","text-lg"],["type","number","min","0",1,"w-20","px-3","py-2","bg-white/10","border","border-white/20","rounded-lg","text-white","text-center","font-bold","focus:outline-none","focus:border-[#C8D900]","transition-colors",3,"input","value"],[1,"font-bold","text-lg"],[1,"w-10","h-10","rounded-lg","border-2","flex","items-center","justify-center","transition-all","hover:scale-110",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6","text-green-300"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6","text-red-300"],["type","text","placeholder","Agregar observaciones...",1,"w-full","px-3","py-2","bg-white/10","border","border-white/20","rounded-lg","text-white","text-sm","focus:outline-none","focus:border-[#C8D900]","transition-colors","placeholder-gray-500",3,"input","value"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","3","d","M5 13l4 4L19 7"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","3","d","M6 18L18 6M6 6l12 12"],[1,"w-6","h-6","border-3","border-[#10284C]","border-t-transparent","rounded-full","animate-spin"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6"]],template:function(e,r){e&1&&(n(0,"div",0)(1,"div",1)(2,"button",2),v("click",function(){return r.volver()}),C(),n(3,"svg",3),f(4,"path",4),i(),o(5," Volver al Dashboard "),i(),T(),n(6,"h1",5),o(7," Validaci\xF3n de Recepci\xF3n "),i(),n(8,"p",6),o(9," Verifique que todos los productos fueron recibidos correctamente "),i()(),h(10,Z,4,0,"div",7)(11,ee,2,1,"div",8)(12,me,78,14,"div",9),i()),e&2&&(l(10),_(r.cargando()?10:-1),l(),_(r.error()?11:-1),l(),_(!r.cargando()&&r.kit()?12:-1))},dependencies:[L,U,$,B,H],encapsulation:2})};export{W as TecnicoValidacionKitComponent};
