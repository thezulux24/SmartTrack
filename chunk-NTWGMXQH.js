import{o as m}from"./chunk-ZSGB5YWW.js";import{E as u,J as p,O as f,h as o,j as c,m as s,u as n}from"./chunk-YUCVBBHU.js";import{a as l,b as _}from"./chunk-FK42CRUA.js";var h=class d{constructor(i){this.supabase=i}getCirugias(){return o(this.supabase.client.from("cirugias").select(`
          *,
          tecnico_asignado:profiles!cirugias_tecnico_asignado_id_fkey(
            id,
            full_name,
            email,
            area
          ),
          hospital_data:hospitales!cirugias_hospital_id_fkey(
            id,
            nombre,
            direccion,
            ciudad,
            telefono,
            contacto_principal
          ),
          tipo_cirugia_data:tipos_cirugia!cirugias_tipo_cirugia_id_fkey(
            id,
            nombre,
            descripcion,
            duracion_promedio,
            especialidad
          )
        `).order("fecha_programada",{ascending:!0})).pipe(s(i=>{if(i.error)throw console.error("Error fetching cirugias:",i.error),new Error(i.error.message||"Error al cargar cirug\xEDas");return i.data||[]}),n(i=>(console.error("Service error:",i),c(()=>i))))}getCirugiaById(i){return o(this.supabase.client.from("cirugias").select(`
          *,
          tecnico_asignado:profiles!cirugias_tecnico_asignado_id_fkey(
            id,
            full_name,
            email,
            area
          ),
          hospital_data:hospitales!cirugias_hospital_id_fkey(
            id,
            nombre,
            direccion,
            ciudad,
            telefono,
            contacto_principal
          ),
          tipo_cirugia_data:tipos_cirugia!cirugias_tipo_cirugia_id_fkey(
            id,
            nombre,
            descripcion,
            duracion_promedio,
            especialidad
          )
        `).eq("id",i).single()).pipe(s(r=>{if(r.error)throw new Error(r.error.message||"Error al cargar cirug\xEDa");return r.data}),n(r=>(console.error("Error loading cirugia:",r),c(()=>r))))}createCirugia(i){return o(this.supabase.client.auth.getUser()).pipe(u(r=>{let t=r.data.user;if(!t)throw new Error("Usuario no autenticado");let a=_(l({},i),{usuario_creador_id:t.id});return o(this.supabase.client.from("cirugias").insert([a]).select(`
              *,
              tecnico_asignado:profiles!cirugias_tecnico_asignado_id_fkey(
                id,
                full_name,
                email
              ),
              hospital_data:hospitales!cirugias_hospital_id_fkey(
                id,
                nombre,
                ciudad
              ),
              tipo_cirugia_data:tipos_cirugia!cirugias_tipo_cirugia_id_fkey(
                id,
                nombre
              )
            `).single())}),s(r=>{if(r.error)throw console.error("Error creating cirugia:",r.error),new Error(r.error.message||"Error al crear cirug\xEDa");return r.data}),n(r=>(console.error("Service error creating cirugia:",r),c(()=>r))))}updateCirugia(i,r){let t=_(l({},r),{updated_at:new Date().toISOString()});return o(this.supabase.client.from("cirugias").update(t).eq("id",i).select(`
          *,
          tecnico_asignado:profiles!cirugias_tecnico_asignado_id_fkey(
            id,
            full_name,
            email
          ),
          hospital_data:hospitales!cirugias_hospital_id_fkey(
            id,
            nombre,
            ciudad
          ),
          tipo_cirugia_data:tipos_cirugia!cirugias_tipo_cirugia_id_fkey(
            id,
            nombre
          )
        `).single()).pipe(s(a=>{if(a.error)throw console.error("Error updating cirugia:",a.error),new Error(a.error.message||"Error al actualizar cirug\xEDa");return a.data}),n(a=>(console.error("Service error updating cirugia:",a),c(()=>a))))}updateEstado(i,r,t){return o(this.supabase.client.auth.getUser()).pipe(u(a=>{let e=a.data.user;return o(this.supabase.client.from("cirugias").select("estado").eq("id",i).single()).pipe(u(g=>{if(g.error)throw new Error("Error al obtener estado actual");let b=g.data.estado;return o(this.supabase.client.from("cirugias").update({estado:r,updated_at:new Date().toISOString()}).eq("id",i)).pipe(u(E=>{if(E.error)throw new Error("Error al actualizar estado");return o(this.supabase.client.from("cirugia_seguimiento").insert([{cirugia_id:i,estado_anterior:b,estado_nuevo:r,comentario:t||`Estado cambiado a ${r}`,usuario_id:e?.id||null}]))}))}))}),s(a=>{if(a.error)throw console.error("Error updating estado:",a.error),new Error(a.error.message||"Error al actualizar estado")}),n(a=>(console.error("Service error updating estado:",a),c(()=>a))))}deleteCirugia(i){return o(this.supabase.client.from("cirugias").delete().eq("id",i)).pipe(s(r=>{if(r.error)throw console.error("Error deleting cirugia:",r.error),new Error(r.error.message||"Error al eliminar cirug\xEDa")}),n(r=>(console.error("Service error deleting cirugia:",r),c(()=>r))))}getCirugiasByTecnico(i){return o(this.supabase.client.from("cirugias").select(`
          *,
          hospital_data:hospitales!cirugias_hospital_id_fkey(
            id,
            nombre,
            ciudad
          ),
          tipo_cirugia_data:tipos_cirugia!cirugias_tipo_cirugia_id_fkey(
            id,
            nombre
          )
        `).eq("tecnico_asignado_id",i).order("fecha_programada",{ascending:!0})).pipe(s(r=>{if(r.error)throw console.error("Error fetching cirugias by tecnico:",r.error),new Error(r.error.message||"Error al cargar cirug\xEDas del t\xE9cnico");return r.data||[]}),n(r=>(console.error("Service error loading tecnico cirugias:",r),c(()=>r))))}getCirugiasByDateRange(i,r){return o(this.supabase.client.from("cirugias").select(`
          *,
          tecnico_asignado:profiles!cirugias_tecnico_asignado_id_fkey(
            id,
            full_name,
            email
          ),
          hospital_data:hospitales!cirugias_hospital_id_fkey(
            id,
            nombre,
            ciudad
          ),
          tipo_cirugia_data:tipos_cirugia!cirugias_tipo_cirugia_id_fkey(
            id,
            nombre
          )
        `).gte("fecha_programada",i).lte("fecha_programada",r).order("fecha_programada",{ascending:!0})).pipe(s(t=>{if(t.error)throw console.error("Error fetching cirugias by date range:",t.error),new Error(t.error.message||"Error al cargar cirug\xEDas por fecha");return t.data||[]}),n(t=>(console.error("Service error loading date range cirugias:",t),c(()=>t))))}getSeguimientoCirugia(i){return o(this.supabase.client.from("cirugia_seguimiento").select(`
          *,
          usuario:profiles!cirugia_seguimiento_usuario_id_fkey(
            id,
            full_name
          )
        `).eq("cirugia_id",i).order("fecha_cambio",{ascending:!1})).pipe(s(r=>{if(r.error)throw console.error("Error fetching seguimiento:",r.error),new Error(r.error.message||"Error al cargar seguimiento");return r.data||[]}),n(r=>(console.error("Service error loading seguimiento:",r),c(()=>r))))}getCirugiaStats(){return o(this.supabase.client.from("cirugias").select("estado, prioridad, fecha_programada, tecnico_asignado_id")).pipe(s(i=>{if(i.error)throw new Error(i.error.message||"Error al cargar estad\xEDsticas");let r=i.data||[],t=new Date,a=new Date(t);return a.setDate(t.getDate()+1),{total:r.length,programadas:r.filter(e=>e.estado==="programada").length,en_curso:r.filter(e=>e.estado==="en_curso").length,completadas:r.filter(e=>e.estado==="completada").length,canceladas:r.filter(e=>e.estado==="cancelada").length,urgencias:r.filter(e=>e.estado==="urgencia"||e.prioridad==="urgencia").length,sin_tecnico:r.filter(e=>!e.tecnico_asignado_id&&e.estado==="programada").length,hoy:r.filter(e=>new Date(e.fecha_programada).toDateString()===t.toDateString()).length,manana:r.filter(e=>new Date(e.fecha_programada).toDateString()===a.toDateString()).length}}),n(i=>(console.error("Service error loading stats:",i),c(()=>i))))}static \u0275fac=function(r){return new(r||d)(f(m))};static \u0275prov=p({token:d,factory:d.\u0275fac,providedIn:"root"})};export{h as a};
