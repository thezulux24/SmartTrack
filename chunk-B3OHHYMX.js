import{a as K}from"./chunk-DBTWTZYU.js";import"./chunk-C4VFUW4K.js";import{x as R}from"./chunk-V2VKRV3B.js";import{j as q,n as U,p as O,v as B}from"./chunk-3OSVPALZ.js";import{$ as x,Ab as _,Bb as E,Cb as N,Ia as o,S as k,Sa as F,Xa as I,Y as y,Yb as M,Z as z,_ as h,cb as T,db as L,ib as w,la as j,lb as $,mb as A,nb as e,ob as t,pb as g,qb as V,tb as D,ub as b,zb as a}from"./chunk-MBDN4FSM.js";import"./chunk-X5YLR3NI.js";import{a as G,b as P,i as S}from"./chunk-ODN5LVDJ.js";var Q=(r,n)=>n.id;function W(r,n){r&1&&(e(0,"div",1),g(1,"div",4),e(2,"p",5),a(3,"Cargando informaci\xF3n de la cirug\xEDa..."),t()())}function X(r,n){if(r&1&&(e(0,"div",2),a(1),t()),r&2){let i=b();o(),E(" ",i.error()," ")}}function Y(r,n){if(r&1&&(e(0,"p",52),a(1),t()),r&2){let i=b().$implicit;o(),E("Lote: ",i.lote,"")}}function Z(r,n){r&1&&(e(0,"span",65),a(1," Completo "),t())}function ee(r,n){r&1&&(e(0,"span",66),a(1," En uso "),t())}function te(r,n){r&1&&(e(0,"span",67),a(1," Sin usar "),t())}function ie(r,n){if(r&1){let i=V();e(0,"tr",48)(1,"td",51)(2,"div")(3,"p",22),a(4),t(),e(5,"p",37),a(6),t(),I(7,Y,2,1,"p",52),t()(),e(8,"td",53)(9,"span",54),a(10),t()(),e(11,"td",51)(12,"div",55)(13,"button",56),D("click",function(){let d=y(i).$implicit,s=b(2);return z(s.actualizarConsumo(d,s.Math.max(0,d.cantidad_utilizada-1)))}),h(),e(14,"svg",57),g(15,"path",58),t()(),x(),e(16,"span",59),a(17),t(),e(18,"button",60),D("click",function(){let d=y(i).$implicit,s=b(2);return z(s.actualizarConsumo(d,s.Math.min(d.cantidad_enviada,d.cantidad_utilizada+1)))}),h(),e(19,"svg",61),g(20,"path",62),t()()()(),x(),e(21,"td",53)(22,"span",63),a(23),t()(),e(24,"td",51)(25,"div",64),I(26,Z,2,0,"span",65)(27,ee,2,0,"span",66)(28,te,2,0,"span",67),t()()()}if(r&2){let i=n.$implicit;o(4),_(i.nombre),o(2),_(i.codigo),o(),w(i.lote?7:-1),o(3),_(i.cantidad_enviada),o(3),T("disabled",i.cantidad_utilizada===0),o(4),E(" ",i.cantidad_utilizada," "),o(),T("disabled",i.cantidad_utilizada>=i.cantidad_enviada),o(5),E(" ",i.cantidad_enviada-i.cantidad_utilizada," "),o(3),w(i.cantidad_utilizada===i.cantidad_enviada?26:i.cantidad_utilizada>0?27:28)}}function ae(r,n){r&1&&(g(0,"div",68),e(1,"span"),a(2,"Finalizando..."),t())}function ne(r,n){r&1&&(h(),e(0,"svg",69),g(1,"path",70),t(),x(),e(2,"span"),a(3,"Finalizar Cirug\xEDa"),t())}function oe(r,n){if(r&1){let i=V();e(0,"div",3)(1,"div",6)(2,"button",7),D("click",function(){y(i);let d=b();return z(d.regresar())}),h(),e(3,"svg",8),g(4,"path",9),t(),x(),e(5,"span",10),a(6,"Regresar"),t()(),e(7,"div",11)(8,"div",12)(9,"p",13),a(10,"Cirug\xEDa en Curso"),t()()()(),e(11,"div",14)(12,"h1",15),a(13),t(),e(14,"div",16)(15,"div",17)(16,"div",18),h(),e(17,"svg",19),g(18,"path",20),t()(),x(),e(19,"div")(20,"p",21),a(21,"M\xE9dico Cirujano"),t(),e(22,"p",22),a(23),t()()(),e(24,"div",17)(25,"div",23),h(),e(26,"svg",24),g(27,"path",25),t()(),x(),e(28,"div")(29,"p",21),a(30,"Hospital"),t(),e(31,"p",22),a(32),t(),e(33,"p",21),a(34),t()()(),e(35,"div",17)(36,"div",26),h(),e(37,"svg",27),g(38,"path",20),t()(),x(),e(39,"div")(40,"p",21),a(41,"Cliente"),t(),e(42,"p",22),a(43),t()()(),e(44,"div",17)(45,"div",28),h(),e(46,"svg",29),g(47,"path",30),t()(),x(),e(48,"div")(49,"p",21),a(50,"Kit"),t(),e(51,"p",22),a(52),t()()()()(),e(53,"div",14)(54,"div",31)(55,"h2",32),a(56,"Progreso de Consumo"),t(),e(57,"span",33),a(58),t()(),e(59,"div",34),g(60,"div",35),t(),e(61,"div",36)(62,"div")(63,"p",37),a(64,"Total Productos"),t(),e(65,"p",38),a(66),t()(),e(67,"div")(68,"p",37),a(69,"Utilizados"),t(),e(70,"p",39),a(71),t()(),e(72,"div")(73,"p",37),a(74,"Pendientes"),t(),e(75,"p",40),a(76),t()()()(),e(77,"div",14)(78,"h2",41),h(),e(79,"svg",19),g(80,"path",42),t(),a(81," Registro de Consumo "),t(),x(),e(82,"div",43)(83,"table",44)(84,"thead")(85,"tr",45)(86,"th",46),a(87,"Producto"),t(),e(88,"th",47),a(89,"Disponible"),t(),e(90,"th",47),a(91,"Utilizado"),t(),e(92,"th",47),a(93,"Restante"),t(),e(94,"th",47),a(95,"Acciones"),t()()(),e(96,"tbody"),$(97,ie,29,9,"tr",48,Q),t()()()(),e(99,"div",49)(100,"button",50),D("click",function(){y(i);let d=b();return z(d.finalizarCirugia())}),I(101,ae,3,0)(102,ne,4,0),t()()()}if(r&2){let i,c,d,s,u,f,l=b();o(13),E(" ",(i=l.cirugia())==null?null:i.numero_cirugia," "),o(10),_((c=l.cirugia())==null?null:c.medico_cirujano),o(9),_((d=l.cirugia())==null||d.hospital==null?null:d.hospital.nombre),o(2),_((s=l.cirugia())==null||s.hospital==null?null:s.hospital.ciudad),o(9),N("",(u=l.cirugia())==null||u.cliente==null?null:u.cliente.nombre," ",(u=l.cirugia())==null||u.cliente==null?null:u.cliente.apellido,""),o(9),_((f=l.cirugia())==null||f.kit==null?null:f.kit.numero_kit),o(6),E("",l.porcentajeProgreso(),"%"),o(2),L("width",l.porcentajeProgreso(),"%"),o(6),_(l.totalProductos()),o(5),_(l.productosUtilizados()),o(5),_(l.totalProductos()-l.productosUtilizados()),o(21),A(l.productos()),o(3),T("disabled",l.procesando()),o(),w(l.procesando()?101:102)}}var J=class r{router=k(O);route=k(U);supabase=k(B);hojaGastoService=k(K);cirugia=j(null);productos=j([]);cargando=j(!0);error=j(null);procesando=j(!1);cirugiaId=M(()=>this.route.snapshot.params.cirugiaId);totalProductos=M(()=>this.productos().length);productosUtilizados=M(()=>this.productos().filter(n=>n.cantidad_utilizada>0).length);porcentajeProgreso=M(()=>{let n=this.totalProductos();return n===0?0:Math.round(this.productosUtilizados()/n*100)});Math=Math;ngOnInit(){return S(this,null,function*(){yield this.cargarDatosCirugia()})}cargarDatosCirugia(){return S(this,null,function*(){this.cargando.set(!0),this.error.set(null);try{let n=this.cirugiaId(),{data:i,error:c}=yield this.supabase.client.from("cirugias").select(`
          id,
          numero_cirugia,
          medico_cirujano,
          fecha_programada,
          estado,
          hospitales (
            nombre,
            ciudad
          ),
          clientes (
            nombre,
            apellido
          )
        `).eq("id",n).single();if(c)throw c;let{data:d,error:s}=yield this.supabase.client.from("kits_cirugia").select("id, numero_kit, estado").eq("cirugia_id",n).single();if(s)throw s;let u=i.hospitales,f=i.clientes,l={id:i.id,numero_cirugia:i.numero_cirugia,medico_cirujano:i.medico_cirujano,fecha_programada:i.fecha_programada,estado:i.estado,hospital:{nombre:u?.nombre||"N/A",ciudad:u?.ciudad||"N/A"},cliente:{nombre:f?.nombre||"N/A",apellido:f?.apellido||""},kit:{id:d.id,numero_kit:d.numero_kit,estado:d.estado}};this.cirugia.set(l);let{data:v,error:H}=yield this.supabase.client.from("kit_productos").select(`
          id,
          producto_id,
          cantidad_preparada,
          cantidad_enviada,
          cantidad_utilizada,
          lote,
          fecha_vencimiento,
          productos (
            nombre,
            codigo
          )
        `).eq("kit_id",d.id).order("productos(nombre)");if(H)throw H;let m=(v||[]).map(p=>({id:p.id,producto_id:p.producto_id,nombre:p.productos?.nombre||"N/A",codigo:p.productos?.codigo||"N/A",cantidad_preparada:p.cantidad_preparada||0,cantidad_enviada:p.cantidad_enviada||0,cantidad_utilizada:p.cantidad_utilizada||0,lote:p.lote,fecha_vencimiento:p.fecha_vencimiento}));this.productos.set(m)}catch(n){console.error("Error cargando datos de cirug\xEDa:",n),this.error.set("Error al cargar los datos de la cirug\xEDa")}finally{this.cargando.set(!1)}})}actualizarConsumo(n,i){return S(this,null,function*(){try{let{error:c}=yield this.supabase.client.from("kit_productos").update({cantidad_utilizada:i}).eq("id",n.id);if(c)throw c;let d=this.productos(),s=d.findIndex(u=>u.id===n.id);if(s!==-1){let u=[...d];u[s]=P(G({},u[s]),{cantidad_utilizada:i}),this.productos.set(u)}}catch(c){console.error("Error actualizando consumo:",c),alert("Error al actualizar el consumo")}})}finalizarCirugia(){return S(this,null,function*(){if(confirm(`\xBFFinalizar cirug\xEDa?

Esto marcar\xE1 la cirug\xEDa como completada, el kit quedar\xE1 listo para devoluci\xF3n y se crear\xE1 autom\xE1ticamente la hoja de gasto con los productos utilizados.`)){this.procesando.set(!0);try{let n=yield this.supabase.getCurrentUserId();if(!n)throw new Error("Usuario no autenticado");let i=this.cirugia();if(!i)throw new Error("No hay datos de cirug\xEDa");let{error:c}=yield this.supabase.client.from("cirugias").update({estado:"completada",updated_at:new Date().toISOString()}).eq("id",i.id);if(c)throw c;let{error:d}=yield this.supabase.client.from("kits_cirugia").update({estado:"devuelto",fecha_devolucion:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",i.kit.id);if(d)throw d;let s=this.productos().filter(v=>v.cantidad_utilizada>0),u=!1;if(s.length>0){console.log("\u{1F4DD} Creando hoja de gasto autom\xE1tica con productos utilizados:",s);try{let v=yield Promise.all(s.map(m=>S(this,null,function*(){let{data:p}=yield this.supabase.client.from("productos").select("precio").eq("id",m.producto_id).single(),C=p?.precio||0;return{producto_id:m.producto_id,categoria:"productos",descripcion:`${m.nombre} (${m.codigo})`,cantidad:m.cantidad_utilizada,precio_unitario:C,precio_total:C*m.cantidad_utilizada,observaciones:`Lote: ${m.lote||"N/A"}${m.fecha_vencimiento?" - Venc: "+m.fecha_vencimiento:""}`}}))),H={cirugia_id:i.id,tecnico_id:n,fecha_cirugia:new Date(i.fecha_programada).toISOString().split("T")[0],observaciones:`Hoja de gasto generada autom\xE1ticamente al finalizar la cirug\xEDa ${i.numero_cirugia}`,items:v};yield new Promise((m,p)=>{this.hojaGastoService.createHojaGasto(H).subscribe({next:C=>{console.log("\u2705 Hoja de gasto creada autom\xE1ticamente:",C),u=!0,m()},error:C=>{console.error("\u26A0\uFE0F Error al crear hoja de gasto autom\xE1tica:",C),p(C)}})})}catch(v){console.error("\u274C Error cr\xEDtico al crear hoja de gasto:",v),alert(`\u26A0\uFE0F Advertencia: La cirug\xEDa se complet\xF3 pero hubo un error al crear la hoja de gasto.

Error: `+(v.message||"Error desconocido")+`

Deber\xE1 crear la hoja de gasto manualmente.`)}}else console.log("\u26A0\uFE0F No hay productos utilizados, no se crear\xE1 hoja de gasto");let{error:f}=yield this.supabase.client.from("cirugia_trazabilidad").insert({cirugia_id:i.id,accion:"finalizacion_cirugia",estado_anterior:"en_curso",estado_nuevo:"completada",usuario_id:n,observaciones:`Cirug\xEDa finalizada - Kit listo para devoluci\xF3n - Hoja de gasto ${u?"creada autom\xE1ticamente":"NO creada"} con ${s.length} productos utilizados`,metadata:{kit_id:i.kit.id,productos_utilizados:this.productosUtilizados(),total_productos:this.totalProductos(),hoja_gasto_creada:u}});if(f)throw f;let l=`\u2705 Cirug\xEDa finalizada correctamente

`;u?l+=`\u{1F4CB} Hoja de gasto creada autom\xE1ticamente con ${s.length} producto(s) utilizado(s)

`:s.length===0&&(l+=`\u26A0\uFE0F No se cre\xF3 hoja de gasto (no hay productos utilizados)

`),l+=`\uFFFD Pr\xF3ximos pasos:
1. Validar devoluci\xF3n del kit
2. Separar productos usados/sin usar
3. Enviar productos reutilizables a limpieza/esterilizaci\xF3n
4. Actualizar inventario

`,u&&(l+="El personal log\xEDstico puede agregar gastos adicionales (transporte, etc.) en el m\xF3dulo de Hojas de Gasto."),alert(l),this.router.navigate(["/internal/tecnico"])}catch(n){console.error("Error finalizando cirug\xEDa:",n),alert("Error al finalizar la cirug\xEDa: "+(n.message||"Error desconocido"))}finally{this.procesando.set(!1)}}})}regresar(){this.router.navigate(["/internal/tecnico"])}formatearFecha(n){return new Date(n).toLocaleDateString("es-CO",{day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}static \u0275fac=function(i){return new(i||r)};static \u0275cmp=F({type:r,selectors:[["app-cirugia-ejecucion"]],decls:4,vars:3,consts:[[1,"min-h-screen","bg-gradient-to-br","from-[#10284C]","via-[#1a3a5c]","to-[#0f1f38]","p-4","md:p-8"],[1,"text-center","py-12"],[1,"bg-red-500/20","border","border-red-500","text-red-100","p-4","rounded-lg","text-center","mb-8"],[1,"space-y-6"],[1,"inline-block","animate-spin","rounded-full","h-12","w-12","border-4","border-[#C8D900]","border-t-transparent"],[1,"text-white","mt-4"],[1,"flex","items-center","justify-between","mb-6"],[1,"group","flex","items-center","gap-2","px-4","py-2","bg-white/10","hover:bg-white/20","rounded-lg","transition-all","border","border-white/20","hover:border-[#C8D900]/50",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5","text-white","group-hover:text-[#C8D900]","transition-colors"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M10 19l-7-7m0 0l7-7m-7 7h18"],[1,"text-white","group-hover:text-[#C8D900]","transition-colors","font-medium"],[1,"flex","items-center","gap-3"],[1,"px-4","py-2","bg-blue-500/20","border","border-blue-500","rounded-lg"],[1,"text-blue-300","text-sm","font-medium"],[1,"bg-white/5","backdrop-blur-sm","rounded-2xl","border","border-white/10","p-6"],[1,"text-3xl","font-bold","text-white","mb-6"],[1,"grid","grid-cols-1","md:grid-cols-2","lg:grid-cols-4","gap-6"],[1,"flex","items-start","gap-3"],[1,"w-10","h-10","bg-[#C8D900]/20","rounded-lg","flex","items-center","justify-center","flex-shrink-0"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6","text-[#C8D900]"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"],[1,"text-gray-400","text-xs"],[1,"text-white","font-medium"],[1,"w-10","h-10","bg-[#0098A8]/20","rounded-lg","flex","items-center","justify-center","flex-shrink-0"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6","text-[#0098A8]"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"],[1,"w-10","h-10","bg-purple-500/20","rounded-lg","flex","items-center","justify-center","flex-shrink-0"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6","text-purple-400"],[1,"w-10","h-10","bg-green-500/20","rounded-lg","flex","items-center","justify-center","flex-shrink-0"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6","text-green-400"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"],[1,"flex","items-center","justify-between","mb-4"],[1,"text-xl","font-bold","text-white"],[1,"text-2xl","font-bold","text-[#C8D900]"],[1,"w-full","bg-white/10","rounded-full","h-4","mb-4"],[1,"bg-gradient-to-r","from-[#C8D900]","to-[#d4e820]","h-4","rounded-full","transition-all","duration-500"],[1,"grid","grid-cols-3","gap-4","text-center"],[1,"text-gray-400","text-sm"],[1,"text-white","text-2xl","font-bold"],[1,"text-[#C8D900]","text-2xl","font-bold"],[1,"text-yellow-400","text-2xl","font-bold"],[1,"text-2xl","font-bold","text-white","mb-6","flex","items-center","gap-2"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"],[1,"overflow-x-auto"],[1,"w-full"],[1,"border-b","border-white/20"],[1,"text-left","text-gray-400","font-medium","py-3","px-4"],[1,"text-center","text-gray-400","font-medium","py-3","px-4"],[1,"border-b","border-white/10","hover:bg-white/5","transition-colors"],[1,"flex","justify-end"],[1,"px-8","py-4","bg-gradient-to-r","from-red-500","to-red-600","hover:from-red-600","hover:to-red-700","text-white","rounded-lg","font-bold","text-lg","flex","items-center","gap-3","disabled:opacity-50","disabled:cursor-not-allowed","transition-all","hover:shadow-lg","hover:shadow-red-500/50",3,"click","disabled"],[1,"py-4","px-4"],[1,"text-gray-500","text-xs"],[1,"py-4","px-4","text-center"],[1,"text-white","font-bold","text-lg"],[1,"flex","items-center","justify-center","gap-2"],[1,"w-8","h-8","bg-red-500/20","hover:bg-red-500/30","disabled:opacity-50","disabled:cursor-not-allowed","rounded-lg","flex","items-center","justify-center","transition-colors",3,"click","disabled"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4","text-red-400"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M20 12H4"],[1,"text-[#C8D900]","font-bold","text-xl","min-w-[40px]","text-center"],[1,"w-8","h-8","bg-green-500/20","hover:bg-green-500/30","disabled:opacity-50","disabled:cursor-not-allowed","rounded-lg","flex","items-center","justify-center","transition-colors",3,"click","disabled"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-4","h-4","text-green-400"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 4v16m8-8H4"],[1,"text-gray-300","font-medium"],[1,"flex","justify-center"],[1,"px-3","py-1","bg-green-500/20","text-green-300","rounded-full","text-xs","font-medium"],[1,"px-3","py-1","bg-yellow-500/20","text-yellow-300","rounded-full","text-xs","font-medium"],[1,"px-3","py-1","bg-gray-500/20","text-gray-400","rounded-full","text-xs","font-medium"],[1,"w-5","h-5","border-2","border-white","border-t-transparent","rounded-full","animate-spin"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-6","h-6"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"]],template:function(i,c){i&1&&(e(0,"div",0),I(1,W,4,0,"div",1)(2,X,2,1,"div",2)(3,oe,103,15,"div",3),t()),i&2&&(o(),w(c.cargando()?1:-1),o(),w(c.error()?2:-1),o(),w(!c.cargando()&&!c.error()&&c.cirugia()?3:-1))},dependencies:[q,R],encapsulation:2})};export{J as CirugiaEjecucionComponent};
